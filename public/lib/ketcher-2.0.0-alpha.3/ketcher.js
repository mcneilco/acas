/****************************************************************************
 * Copyright (C) 2009-2017. EPAM Systems.
 *
 * This file may be distributed and/or modified under the terms of the
 * GNU Affero General Public License version 3 as published by the Free
 * Software Foundation and appearing in the file LICENSE included in
 * the packaging of this file.
 *
 * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 ***************************************************************************/

(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.ketcher = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/* FileSaver.js
 * A saveAs() FileSaver implementation.
 * 1.1.20150716
 *
 * By Eli Grey, http://eligrey.com
 * License: X11/MIT
 *   See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
 */

/*global self */
/*jslint bitwise: true, indent: 4, laxbreak: true, laxcomma: true, smarttabs: true, plusplus: true */

/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */

var saveAs = saveAs || (function(view) {
	"use strict";
	// IE <10 is explicitly unsupported
	if (typeof navigator !== "undefined" && /MSIE [1-9]\./.test(navigator.userAgent)) {
		return;
	}
	var
		  doc = view.document
		  // only get URL when necessary in case Blob.js hasn't overridden it yet
		, get_URL = function() {
			return view.URL || view.webkitURL || view;
		}
		, save_link = doc.createElementNS("http://www.w3.org/1999/xhtml", "a")
		, can_use_save_link = "download" in save_link
		, click = function(node) {
			var event = new MouseEvent("click");
			node.dispatchEvent(event);
		}
		, webkit_req_fs = view.webkitRequestFileSystem
		, req_fs = view.requestFileSystem || webkit_req_fs || view.mozRequestFileSystem
		, throw_outside = function(ex) {
			(view.setImmediate || view.setTimeout)(function() {
				throw ex;
			}, 0);
		}
		, force_saveable_type = "application/octet-stream"
		, fs_min_size = 0
		// See https://code.google.com/p/chromium/issues/detail?id=375297#c7 and
		// https://github.com/eligrey/FileSaver.js/commit/485930a#commitcomment-8768047
		// for the reasoning behind the timeout and revocation flow
		, arbitrary_revoke_timeout = 500 // in ms
		, revoke = function(file) {
			var revoker = function() {
				if (typeof file === "string") { // file is an object URL
					get_URL().revokeObjectURL(file);
				} else { // file is a File
					file.remove();
				}
			};
			if (view.chrome) {
				revoker();
			} else {
				setTimeout(revoker, arbitrary_revoke_timeout);
			}
		}
		, dispatch = function(filesaver, event_types, event) {
			event_types = [].concat(event_types);
			var i = event_types.length;
			while (i--) {
				var listener = filesaver["on" + event_types[i]];
				if (typeof listener === "function") {
					try {
						listener.call(filesaver, event || filesaver);
					} catch (ex) {
						throw_outside(ex);
					}
				}
			}
		}
		, auto_bom = function(blob) {
			// prepend BOM for UTF-8 XML and text/* types (including HTML)
			if (/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) {
				return new Blob(["\ufeff", blob], {type: blob.type});
			}
			return blob;
		}
		, FileSaver = function(blob, name, no_auto_bom) {
			if (!no_auto_bom) {
				blob = auto_bom(blob);
			}
			// First try a.download, then web filesystem, then object URLs
			var
				  filesaver = this
				, type = blob.type
				, blob_changed = false
				, object_url
				, target_view
				, dispatch_all = function() {
					dispatch(filesaver, "writestart progress write writeend".split(" "));
				}
				// on any filesys errors revert to saving with object URLs
				, fs_error = function() {
					// don't create more object URLs than needed
					if (blob_changed || !object_url) {
						object_url = get_URL().createObjectURL(blob);
					}
					if (target_view) {
						target_view.location.href = object_url;
					} else {
						var new_tab = view.open(object_url, "_blank");
						if (new_tab == undefined && typeof safari !== "undefined") {
							//Apple do not allow window.open, see http://bit.ly/1kZffRI
							view.location.href = object_url
						}
					}
					filesaver.readyState = filesaver.DONE;
					dispatch_all();
					revoke(object_url);
				}
				, abortable = function(func) {
					return function() {
						if (filesaver.readyState !== filesaver.DONE) {
							return func.apply(this, arguments);
						}
					};
				}
				, create_if_not_found = {create: true, exclusive: false}
				, slice
			;
			filesaver.readyState = filesaver.INIT;
			if (!name) {
				name = "download";
			}
			if (can_use_save_link) {
				object_url = get_URL().createObjectURL(blob);
				save_link.href = object_url;
				save_link.download = name;
				setTimeout(function() {
					click(save_link);
					dispatch_all();
					revoke(object_url);
					filesaver.readyState = filesaver.DONE;
				});
				return;
			}
			// Object and web filesystem URLs have a problem saving in Google Chrome when
			// viewed in a tab, so I force save with application/octet-stream
			// http://code.google.com/p/chromium/issues/detail?id=91158
			// Update: Google errantly closed 91158, I submitted it again:
			// https://code.google.com/p/chromium/issues/detail?id=389642
			if (view.chrome && type && type !== force_saveable_type) {
				slice = blob.slice || blob.webkitSlice;
				blob = slice.call(blob, 0, blob.size, force_saveable_type);
				blob_changed = true;
			}
			// Since I can't be sure that the guessed media type will trigger a download
			// in WebKit, I append .download to the filename.
			// https://bugs.webkit.org/show_bug.cgi?id=65440
			if (webkit_req_fs && name !== "download") {
				name += ".download";
			}
			if (type === force_saveable_type || webkit_req_fs) {
				target_view = view;
			}
			if (!req_fs) {
				fs_error();
				return;
			}
			fs_min_size += blob.size;
			req_fs(view.TEMPORARY, fs_min_size, abortable(function(fs) {
				fs.root.getDirectory("saved", create_if_not_found, abortable(function(dir) {
					var save = function() {
						dir.getFile(name, create_if_not_found, abortable(function(file) {
							file.createWriter(abortable(function(writer) {
								writer.onwriteend = function(event) {
									target_view.location.href = file.toURL();
									filesaver.readyState = filesaver.DONE;
									dispatch(filesaver, "writeend", event);
									revoke(file);
								};
								writer.onerror = function() {
									var error = writer.error;
									if (error.code !== error.ABORT_ERR) {
										fs_error();
									}
								};
								"writestart progress write abort".split(" ").forEach(function(event) {
									writer["on" + event] = filesaver["on" + event];
								});
								writer.write(blob);
								filesaver.abort = function() {
									writer.abort();
									filesaver.readyState = filesaver.DONE;
								};
								filesaver.readyState = filesaver.WRITING;
							}), fs_error);
						}), fs_error);
					};
					dir.getFile(name, {create: false}, abortable(function(file) {
						// delete file if it already exists
						file.remove();
						save();
					}), abortable(function(ex) {
						if (ex.code === ex.NOT_FOUND_ERR) {
							save();
						} else {
							fs_error();
						}
					}));
				}), fs_error);
			}), fs_error);
		}
		, FS_proto = FileSaver.prototype
		, saveAs = function(blob, name, no_auto_bom) {
			return new FileSaver(blob, name, no_auto_bom);
		}
	;
	// IE 10+ (native saveAs)
	if (typeof navigator !== "undefined" && navigator.msSaveOrOpenBlob) {
		return function(blob, name, no_auto_bom) {
			if (!no_auto_bom) {
				blob = auto_bom(blob);
			}
			return navigator.msSaveOrOpenBlob(blob, name || "download");
		};
	}

	FS_proto.abort = function() {
		var filesaver = this;
		filesaver.readyState = filesaver.DONE;
		dispatch(filesaver, "abort");
	};
	FS_proto.readyState = FS_proto.INIT = 0;
	FS_proto.WRITING = 1;
	FS_proto.DONE = 2;

	FS_proto.error =
	FS_proto.onwritestart =
	FS_proto.onprogress =
	FS_proto.onwrite =
	FS_proto.onabort =
	FS_proto.onerror =
	FS_proto.onwriteend =
		null;

	return saveAs;
}(
	   typeof self !== "undefined" && self
	|| typeof window !== "undefined" && window
	|| this.content
));
// `self` is undefined in Firefox for Android content script context
// while `this` is nsIContentFrameMessageManager
// with an attribute `content` that corresponds to the window

if (typeof module !== "undefined" && module.exports) {
  module.exports.saveAs = saveAs;
} else if ((typeof define !== "undefined" && define !== null) && (define.amd != null)) {
  define([], function() {
    return saveAs;
  });
}

},{}],2:[function(require,module,exports){
/// keymage.js - Javascript keyboard bindings handling
/// http://github.com/piranha/keymage
///
/// (c) 2012-2016 Alexander Solovyov under terms of ISC License

(function(define, undefined) {
define(function() {
    var VERSION = '1.1.3';
    var isOsx = typeof navigator !== 'undefined' &&
        ~navigator.userAgent.indexOf('Mac OS X');

    // Defining all keys
    var MODPROPS = ['shiftKey', 'ctrlKey', 'altKey', 'metaKey'];
    var MODS = {
        'shift': 'shift',
        'ctrl': 'ctrl', 'control': 'ctrl',
        'alt': 'alt', 'option': 'alt',
        'win': 'meta', 'cmd': 'meta', 'super': 'meta',
                          'meta': 'meta',
        // default modifier for os x is cmd and for others is ctrl
        'defmod':  isOsx ? 'meta' : 'ctrl'
        };
    var MODORDER = ['shift', 'ctrl', 'alt', 'meta'];
    var MODNUMS = [16, 17, 18, 91];

    var KEYS = {
        'backspace': 8,
        'tab': 9,
        'enter': 13, 'return': 13,
        'pause': 19,
        'caps': 20, 'capslock': 20,
        'escape': 27, 'esc': 27,
        'space': 32,
        'pgup': 33, 'pageup': 33,
        'pgdown': 34, 'pagedown': 34,
        'end': 35,
        'home': 36,
        'ins': 45, 'insert': 45,
        'del': 46, 'delete': 46,

        'left': 37,
        'up': 38,
        'right': 39,
        'down': 40,

        '*': 106,
        '+': 107, 'plus': 107,
        'minus': 109,
        ';': 186,
        '=': 187,
        ',': 188,
        '-': 189,
        '.': 190,
        '/': 191,
        '`': 192,
        '[': 219,
        '\\': 220,
        ']': 221,
        "'": 222
    };

    var i;
    // numpad
    for (i = 0; i < 10; i++) {
        KEYS['num-' + i] = i + 95;
    }
    // top row 0-9
    for (i = 0; i < 10; i++) {
        KEYS[i.toString()] = i + 48;
    }
    // f1-f24
    for (i = 1; i < 25; i++) {
        KEYS['f' + i] = i + 111;
    }
    // alphabet
    for (i = 65; i < 91; i++) {
        KEYS[String.fromCharCode(i).toLowerCase()] = i;
    }

    // Reverse key codes
    var KEYREV = {};
    for (var k in KEYS) {
        var val = KEYS[k];
        if (!KEYREV[val] || KEYREV[val].length < k.length) {
            KEYREV[val] = k;
        }
    }

    // -----------------------
    // Actual work is done here

    var currentScope = '';
    var allChains = {};

    function parseKeyString(keystring) {
        var bits = keystring.split(/-(?!$)/);
        var button = bits[bits.length - 1];
        var key = {code: KEYS[button]};

        if (!key.code) {
            throw 'Unknown key "' + button + '" in keystring "' +
                keystring + '"';
        }

        var mod;
        for (var i = 0; i < bits.length - 1; i++) {
            button = bits[i];
            mod = MODS[button];
            if (!mod) {
                    throw 'Unknown modifier "' + button + '" in keystring "' +
                        keystring + '"';
            }
            key[mod] = true;
        }

        return key;
    }

    function stringifyKey(key) {
        var s = '';
        for (var i = 0; i < MODORDER.length; i++) {
            if (key[MODORDER[i]]) {
                s += MODORDER[i] + '-';
            }
        }
        s += KEYREV[key.code];
        return s;
    }

    function normalizeKeyChain(keychainString) {
        var keychain = [];
        var keys = keychainString.split(' ');

        for (var i = 0; i < keys.length; i++) {
            var key = parseKeyString(keys[i]);
            key = stringifyKey(key);
            keychain.push(key);
        }

        keychain.original = keychainString;
        return keychain;
    }

    function eventKeyString(e) {
        var key = {code: e.keyCode};
        for (var i = 0; i < MODPROPS.length; i++) {
            var mod = MODPROPS[i];
            if (e[mod]) {
                key[mod.slice(0, mod.length - 3)] = true;
            }
        }
        return stringifyKey(key);
    }

    function getNestedChains(chains, scope) {
        for (var i = 0; i < scope.length; i++) {
            var bit = scope[i];

            if (bit) {
                chains = chains[bit];
            }

            if (!chains) {
                break;
            }
        }
        return chains;
    }

    var sequence = [];
    function dispatch(e) {
        // Skip all modifiers
        if (~MODNUMS.indexOf(e.keyCode)) {
            return;
        }

        var seq = sequence.slice();
        seq.push(eventKeyString(e));
        var scope = currentScope.split('.');
        var matched, chains, key;

        for (var i = scope.length; i >= 0; i--) {
            chains = getNestedChains(allChains, scope.slice(0, i));
            if (!chains) {
                continue;
            }
            matched = true;
            for (var j = 0; j < seq.length; j++) {
                key = seq[j];
                if (!chains[key]) {
                    matched = false;
                    break;
                }
                chains = chains[key];
            }

            if (matched) {
                break;
            }
        }

        var definitionScope = scope.slice(0, i).join('.');
        var preventDefault = chains.preventDefault;

        // partial match, save the sequence
        if (matched && !chains.handlers) {
            sequence = seq;
            if (preventDefault) {
                e.preventDefault();
            }
            return;
        }

        if (matched) {
            for (i = 0; i < chains.handlers.length; i++) {
                var handler = chains.handlers[i];
                var options = handler._keymage;

                var res = handler.call(options.context, e, {
                    shortcut: options.original,
                    scope: currentScope,
                    definitionScope: definitionScope
                });

                if (res === false || preventDefault) {
                    e.preventDefault();
                }
            }
        }

        // either matched or not, drop the sequence
        sequence = [];
    }

    function getHandlers(scope, keychain, fn) {
        var bits = scope.split('.');
        var chains = allChains;
        bits = bits.concat(keychain);

        for (var i = 0, l = bits.length; i < l; i++) {
            var bit = bits[i];
            if (!bit) continue;

            chains = chains[bit] || (chains[bit] = {});
            if (fn && fn._keymage.preventDefault) {
                chains.preventDefault = true;
            }

            if (i === l - 1) {
                var handlers = chains.handlers || (chains.handlers = []);
                return handlers;
            }
        }
    }

    function assignKey(scope, keychain, fn) {
        var handlers = getHandlers(scope, keychain, fn);
        handlers.push(fn);
    }

    function unassignKey(scope, keychain, fn) {
        var handlers = getHandlers(scope, keychain);
        var idx = handlers.indexOf(fn);
        if (~idx) {
            handlers.splice(idx, 1);
        }
    }

    function parsed(scope, keychain, fn, options) {
        if (keychain === undefined && fn === undefined) {
            return function(keychain, fn) {
                return keymage(scope, keychain, fn);
            };
        }

        if (typeof keychain === 'function') {
            options = fn;
            fn = keychain;
            keychain = scope;
            scope = '';
        }

        var normalized = normalizeKeyChain(keychain);

        return [scope, normalized, fn, options];
    }

    // optional arguments: scope, options.
    function keymage(scope, keychain, fn, options) {
        var args = parsed(scope, keychain, fn, options);
        fn = args[2];
        options = args[3];
        fn._keymage = options || {};
        fn._keymage.original = keychain;
        assignKey.apply(null, args);

        return function () {
            unassignKey.apply(null, args);
        };
    }

    keymage.unbind = function(scope, keychain, fn) {
        var args = parsed(scope, keychain, fn);
        unassignKey.apply(null, args);
    };

    keymage.parse = parseKeyString;
    keymage.stringify = stringifyKey;

    keymage.bindings = allChains;

    keymage.setScope = function(scope) {
        currentScope = scope ? scope : '';
    };

    keymage.getScope = function() { return currentScope; };

    keymage.pushScope = function(scope) {
        currentScope = (currentScope ? currentScope + '.' : '') + scope;
        return currentScope;
    };

    keymage.popScope = function(scope) {
        var i;

        if (!scope) {
            i = currentScope.lastIndexOf('.');
            scope = currentScope.slice(i + 1);
            currentScope = i == -1 ? '' : currentScope.slice(0, i);
            return scope;
        }

        currentScope = currentScope.replace(
            new RegExp('(^|\\.)' + scope + '(\\.|$).*'), '');
        return scope;
    };

    keymage.version = VERSION;

    window.addEventListener('keydown', dispatch, false);

    return keymage;
});
})(typeof define !== 'undefined' ? define : function(factory) {
    if (typeof module !== 'undefined') {
        module.exports = factory();
    } else {
        window.keymage = factory();
    }
});

},{}],3:[function(require,module,exports){
(function(root) {

	// Use polyfill for setImmediate for performance gains
	var asap = (typeof setImmediate === 'function' && setImmediate) ||
		function(fn) { setTimeout(fn, 1); };

	// Polyfill for Function.prototype.bind
	function bind(fn, thisArg) {
		return function() {
			fn.apply(thisArg, arguments);
		}
	}

	var isArray = Array.isArray || function(value) { return Object.prototype.toString.call(value) === "[object Array]" };

	function Promise(fn) {
		if (typeof this !== 'object') throw new TypeError('Promises must be constructed via new');
		if (typeof fn !== 'function') throw new TypeError('not a function');
		this._state = null;
		this._value = null;
		this._deferreds = []

		doResolve(fn, bind(resolve, this), bind(reject, this))
	}

	function handle(deferred) {
		var me = this;
		if (this._state === null) {
			this._deferreds.push(deferred);
			return
		}
		asap(function() {
			var cb = me._state ? deferred.onFulfilled : deferred.onRejected
			if (cb === null) {
				(me._state ? deferred.resolve : deferred.reject)(me._value);
				return;
			}
			var ret;
			try {
				ret = cb(me._value);
			}
			catch (e) {
				deferred.reject(e);
				return;
			}
			deferred.resolve(ret);
		})
	}

	function resolve(newValue) {
		try { //Promise Resolution Procedure: https://github.com/promises-aplus/promises-spec#the-promise-resolution-procedure
			if (newValue === this) throw new TypeError('A promise cannot be resolved with itself.');
			if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
				var then = newValue.then;
				if (typeof then === 'function') {
					doResolve(bind(then, newValue), bind(resolve, this), bind(reject, this));
					return;
				}
			}
			this._state = true;
			this._value = newValue;
			finale.call(this);
		} catch (e) { reject.call(this, e); }
	}

	function reject(newValue) {
		this._state = false;
		this._value = newValue;
		finale.call(this);
	}

	function finale() {
		for (var i = 0, len = this._deferreds.length; i < len; i++) {
			handle.call(this, this._deferreds[i]);
		}
		this._deferreds = null;
	}

	function Handler(onFulfilled, onRejected, resolve, reject){
		this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;
		this.onRejected = typeof onRejected === 'function' ? onRejected : null;
		this.resolve = resolve;
		this.reject = reject;
	}

	/**
	 * Take a potentially misbehaving resolver function and make sure
	 * onFulfilled and onRejected are only called once.
	 *
	 * Makes no guarantees about asynchrony.
	 */
	function doResolve(fn, onFulfilled, onRejected) {
		var done = false;
		try {
			fn(function (value) {
				if (done) return;
				done = true;
				onFulfilled(value);
			}, function (reason) {
				if (done) return;
				done = true;
				onRejected(reason);
			})
		} catch (ex) {
			if (done) return;
			done = true;
			onRejected(ex);
		}
	}

	Promise.prototype['catch'] = function (onRejected) {
		return this.then(null, onRejected);
	};

	Promise.prototype.then = function(onFulfilled, onRejected) {
		var me = this;
		return new Promise(function(resolve, reject) {
			handle.call(me, new Handler(onFulfilled, onRejected, resolve, reject));
		})
	};

	Promise.all = function () {
		var args = Array.prototype.slice.call(arguments.length === 1 && isArray(arguments[0]) ? arguments[0] : arguments);

		return new Promise(function (resolve, reject) {
			if (args.length === 0) return resolve([]);
			var remaining = args.length;
			function res(i, val) {
				try {
					if (val && (typeof val === 'object' || typeof val === 'function')) {
						var then = val.then;
						if (typeof then === 'function') {
							then.call(val, function (val) { res(i, val) }, reject);
							return;
						}
					}
					args[i] = val;
					if (--remaining === 0) {
						resolve(args);
					}
				} catch (ex) {
					reject(ex);
				}
			}
			for (var i = 0; i < args.length; i++) {
				res(i, args[i]);
			}
		});
	};

	Promise.resolve = function (value) {
		if (value && typeof value === 'object' && value.constructor === Promise) {
			return value;
		}

		return new Promise(function (resolve) {
			resolve(value);
		});
	};

	Promise.reject = function (value) {
		return new Promise(function (resolve, reject) {
			reject(value);
		});
	};

	Promise.race = function (values) {
		return new Promise(function (resolve, reject) {
			for(var i = 0, len = values.length; i < len; i++) {
				values[i].then(resolve, reject);
			}
		});
	};

	/**
	 * Set the immediate function to execute callbacks
	 * @param fn {function} Function to execute
	 * @private
	 */
	Promise._setImmediateFn = function _setImmediateFn(fn) {
		asap = fn;
	};

	if (typeof module !== 'undefined' && module.exports) {
		module.exports = Promise;
	} else if (!root.Promise) {
		root.Promise = Promise;
	}

})(this);
},{}],4:[function(require,module,exports){
'use strict';
var strictUriEncode = require('strict-uri-encode');

exports.extract = function (str) {
	return str.split('?')[1] || '';
};

exports.parse = function (str) {
	if (typeof str !== 'string') {
		return {};
	}

	str = str.trim().replace(/^(\?|#|&)/, '');

	if (!str) {
		return {};
	}

	return str.split('&').reduce(function (ret, param) {
		var parts = param.replace(/\+/g, ' ').split('=');
		// Firefox (pre 40) decodes `%3D` to `=`
		// https://github.com/sindresorhus/query-string/pull/37
		var key = parts.shift();
		var val = parts.length > 0 ? parts.join('=') : undefined;

		key = decodeURIComponent(key);

		// missing `=` should be `null`:
		// http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
		val = val === undefined ? null : decodeURIComponent(val);

		if (!ret.hasOwnProperty(key)) {
			ret[key] = val;
		} else if (Array.isArray(ret[key])) {
			ret[key].push(val);
		} else {
			ret[key] = [ret[key], val];
		}

		return ret;
	}, {});
};

exports.stringify = function (obj) {
	return obj ? Object.keys(obj).sort().map(function (key) {
		var val = obj[key];

		if (Array.isArray(val)) {
			return val.sort().map(function (val2) {
				return strictUriEncode(key) + '=' + strictUriEncode(val2);
			}).join('&');
		}

		return strictUriEncode(key) + '=' + strictUriEncode(val);
	}).filter(function (x) {
		return x.length > 0;
	}).join('&') : '';
};

},{"strict-uri-encode":5}],5:[function(require,module,exports){
'use strict';
module.exports = function (str) {
	return encodeURIComponent(str).replace(/[!'()*]/g, function (c) {
		return '%' + c.charCodeAt(0).toString(16).toUpperCase();
	});
};

},{}],6:[function(require,module,exports){
var xhrFactory = (function getXHRfactory (factories) {
  for (var i=0, xhr, X, len=factories.length; i<len; i++) {
    try {
      X = factories[i]
      xhr = X()
      return window.XMLHttpRequest ? X : window.XMLHttpRequest = X
    } catch (e) { continue }
  }
})([
  function () {return new XMLHttpRequest()}, // IE10+,FF,Chrome,Opera,Safari
  function () {return new ActiveXObject("Msxml3.")},            // IE9
  function () {return new ActiveXObject("Msxml2.XMLHTTP.6.0")}, // IE8
  function () {return new ActiveXObject("Msxml2.XMLHTTP.3.0")}, // IE7
  function () {return new ActiveXObject("Msxml2.XMLHTTP")},     // IE6
  function () {return new ActiveXObject("Microsoft.XMLHTTP")},  // IE5
  function () {return null}
])
module.exports = function getXHR() { return xhrFactory() }

},{}],7:[function(require,module,exports){
function formEncodeString(e){return e.replace(/[^ !'()~\*]*/g,encodeURIComponent).replace(/ /g,"+").replace(/[!'()~\*]/g,function(e){return"%"+("0"+e.charCodeAt(0).toString(16)).slice(-2).toUpperCase()})}function formEncode(e){var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push(encodeURIComponent(n)+"="+formEncodeString(e[n]));return r.join("&")}function unwrap(e){var r=e.responseText,n=r.substring(r.indexOf("\n")+1);if(r.startsWith("Ok."))return n;throw Error("Unknown server error: "+r)}function api(e){function r(r,n){function o(e,n,o){return{method:r,url:t.url,sync:o,params:n,data:e&&formEncode(e),headers:e&&{"Content-Type":"application/x-www-form-urlencoded"}}}var t=function(e,r){return ajax(o(e,r)).then(unwrap)};return t.sync=function(e,r){return unwrap(ajax(o(e,r,!0)))},t.url=e+n,t}return{inchi:r("POST","getinchi"),molfile:r("POST","getmolfile"),aromatize:r("POST","aromatize"),dearomatize:r("POST","dearomatize"),calculateCip:r("POST","calculate_cip"),automap:r("POST","automap"),layout_smiles:r("GET","layout"),layout:r("POST","layout"),smiles:r("POST","smiles"),save:r("POST","save"),knocknock:function(){return ajax(e+"knocknock").then(function(e){if("You are welcome!"!==e.responseText)throw Error("Server is not compatible")})}}}var ajax=require("./util/ajax.js");module.exports=api;

},{"./util/ajax.js":37}],8:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Vec2=require("../util/vec2");require("./element"),require("./struct");var chem=global.chem=global.chem||{};chem.CisTrans=function(e,t,s){this.molecule=e,this.bonds=new Map,this.getNeighbors=t,this.context=s},chem.CisTrans.PARITY={NONE:0,CIS:1,TRANS:2},chem.CisTrans.prototype.each=function(e,t){this.bonds.each(e,t)},chem.CisTrans.prototype.getParity=function(e){return this.bonds.get(e).parity},chem.CisTrans.prototype.getSubstituents=function(e){return this.bonds.get(e).substituents},chem.CisTrans.prototype.sameside=function(e,t,s,i){var r=Vec2.diff(e,t),n=new Vec2(-r.y,r.x);if(!n.normalize())return 0;var o=Vec2.diff(s,e),u=Vec2.diff(i,t);if(!o.normalize())return 0;if(!u.normalize())return 0;var a=Vec2.dot(o,n),h=Vec2.dot(u,n);return Math.abs(a)<.001||Math.abs(h)<.001?0:a*h>0?1:-1},chem.CisTrans.prototype._sameside=function(e,t,s,i){return this.sameside(this.molecule.atoms.get(e).pp,this.molecule.atoms.get(t).pp,this.molecule.atoms.get(s).pp,this.molecule.atoms.get(i).pp)},chem.CisTrans.prototype._sortSubstituents=function(e){var t=this.molecule.atoms.get(e[0]).pureHydrogen(),s=e[1]<0||this.molecule.atoms.get(e[1]).pureHydrogen(),i=this.molecule.atoms.get(e[2]).pureHydrogen(),r=e[3]<0||this.molecule.atoms.get(e[3]).pureHydrogen();return(!t||!s)&&((!i||!r)&&(s?e[1]=-1:t?(e[0]=e[1],e[1]=-1):e[0]>e[1]&&e.swap(0,1),r?e[3]=-1:i?(e[2]=e[3],e[3]=-1):e[2]>e[3]&&e.swap(2,3),!0))},chem.CisTrans.prototype.isGeomStereoBond=function(e,t){var s=this.molecule.bonds.get(e);if(s.type!=chem.Struct.BOND.TYPE.DOUBLE)return!1;var i=this.molecule.atoms.get(s.begin).label,r=this.molecule.atoms.get(s.end).label;if("C"!=i&&"N"!=i&&"Si"!=i&&"Ge"!=i)return!1;if("C"!=r&&"N"!=r&&"Si"!=r&&"Ge"!=r)return!1;var n=this.getNeighbors.call(this.context,s.begin),o=this.getNeighbors.call(this.context,s.end);if(n.length<2||n.length>3||o.length<2||o.length>3)return!1;t[0]=-1,t[1]=-1,t[2]=-1,t[3]=-1;var u,a;for(u=0;u<n.length;u++)if(a=n[u],a.bid!=e){if(this.molecule.bonds.get(a.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==t[0]?t[0]=a.aid:t[1]=a.aid}for(u=0;u<o.length;u++)if(a=o[u],a.bid!=e){if(this.molecule.bonds.get(a.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==t[2]?t[2]=a.aid:t[3]=a.aid}return(-1==t[1]||-1==this._sameside(s.begin,s.end,t[0],t[1]))&&(-1==t[3]||-1==this._sameside(s.begin,s.end,t[2],t[3]))},chem.CisTrans.prototype.build=function(e){this.molecule.bonds.each(function(t,s){var i=this.bonds.set(t,{parity:0,substituents:new Array(4)});if((!Object.isArray(e)||!e[t])&&this.isGeomStereoBond(t,i.substituents)&&this._sortSubstituents(i.substituents)){var r=this._sameside(s.begin,s.end,i.substituents[0],i.substituents[2]);1==r?i.parity=chem.CisTrans.PARITY.CIS:-1==r&&(i.parity=chem.CisTrans.PARITY.TRANS)}},this)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util/map":40,"../util/vec2":43,"./element":10,"./struct":16}],9:[function(require,module,exports){
(function (global){
var Set=require("../util/set");require("../util/"),require("./element");var chem=global.chem=global.chem||{},util=global.util;chem.Dfs=function(e,t,s,i){this.molecule=e,this.atom_data=t,this.components=s,this.nComponentsInReactants=-1,this.nReactants=i,this.vertices=new Array(this.molecule.atoms.count()),this.molecule.atoms.each(function(e){this.vertices[e]=new chem.Dfs.VertexDesc},this),this.edges=new Array(this.molecule.bonds.count()),this.molecule.bonds.each(function(e){this.edges[e]=new chem.Dfs.EdgeDesc},this),this.v_seq=[]},chem.Dfs.VertexDesc=function(){this.dfs_state=0,this.parent_vertex=0,this.parent_edge=0,this.branches=0},chem.Dfs.EdgeDesc=function(){this.opening_cycles=0,this.closing_cycle=0},chem.Dfs.SeqElem=function(e,t,s){this.idx=e,this.parent_vertex=t,this.parent_edge=s},chem.Dfs.prototype.walk=function(){for(var e,t,s=[],i=0,n=0;;){if(s.length<1){for(var r=-1,c=function(e){return 0==this.vertices[e].dfs_state&&(r=e,!0)};i<this.components.length&&-1==r;)null===(r=Set.find(this.components[i],c,this))&&(r=-1,++i==this.nReactants&&(this.nComponentsInReactants=n));if(r<-1&&this.molecule.atoms.find(c,this),-1==r)break;this.vertices[r].parent_vertex=-1,this.vertices[r].parent_edge=-1,s.push(r),n++}var h=s.pop(),o=this.vertices[h].parent_vertex,a=new chem.Dfs.SeqElem(h,o,this.vertices[h].parent_edge);this.v_seq.push(a),this.vertices[h].dfs_state=2;var l=this.atom_data[h];for(e=0;e<l.neighbours.length;e++){var f=l.neighbours[e].aid,u=l.neighbours[e].bid;if(f!=o)if(2==this.vertices[f].dfs_state){for(this.edges[u].closing_cycle=1,t=h;-1!=t&&this.vertices[t].parent_vertex!=f;)t=this.vertices[t].parent_vertex;if(-1==t)throw new Error("cycle unwind error");this.edges[this.vertices[t].parent_edge].opening_cycles++,this.vertices[h].branches++,a=new chem.Dfs.SeqElem(f,h,u),this.v_seq.push(a)}else{if(1==this.vertices[f].dfs_state){if(-1==(t=s.indexOf(f)))throw new Error("internal: removing vertex from stack");s.splice(t,1);var v=this.vertices[f].parent_vertex;v>=0&&this.vertices[v].branches--}this.vertices[h].branches++,this.vertices[f].parent_vertex=h,this.vertices[f].parent_edge=u,this.vertices[f].dfs_state=1,s.push(f)}}}},chem.Dfs.prototype.edgeClosingCycle=function(e){return 0!=this.edges[e].closing_cycle},chem.Dfs.prototype.numBranches=function(e){return this.vertices[e].branches},chem.Dfs.prototype.numOpeningCycles=function(e){return this.edges[e].opening_cycles},chem.Dfs.prototype.toString=function(){var e="";return this.v_seq.each(function(t){e+=t.idx+" -> "}),e+="*"};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util/":39,"../util/set":42,"./element":10}],10:[function(require,module,exports){
function el(e,l,f,a,b){return{label:e,period:l,group:f,putHydrogenOnTheLeft:a,color:b||"#000000"}}var Map=require("../util/map"),element=new Map({1:el("H",1,1,!1,"#000000"),2:el("He",1,8,!1,"#d9ffff"),3:el("Li",2,1,!1,"#cc80ff"),4:el("Be",2,2,!1,"#c2ff00"),5:el("B",2,3,!1,"#ffb5b5"),6:el("C",2,4,!1,"#000000"),7:el("N",2,5,!1,"#304ff7"),8:el("O",2,6,!0,"#ff0d0d"),9:el("F",2,7,!0,"#8fe04f"),10:el("Ne",2,8,!1,"#b3e3f5"),11:el("Na",3,1,!1,"#ab5cf2"),12:el("Mg",3,2,!1,"#8aff00"),13:el("Al",3,3,!1,"#bfa6a6"),14:el("Si",3,4,!1,"#f0c7a1"),15:el("P",3,5,!1,"#ff8000"),16:el("S",3,6,!0,"#d9a61a"),17:el("Cl",3,7,!0,"#1fd01f"),18:el("Ar",3,8,!1,"#80d1e3"),19:el("K",4,1,!1,"#8f40d4"),20:el("Ca",4,2,!1,"#3dff00"),21:el("Sc",4,3,!1,"#e6e6e6"),22:el("Ti",4,4,!1,"#bfc2c7"),23:el("V",4,5,!1,"#a6a6ab"),24:el("Cr",4,6,!1,"#8a99c7"),25:el("Mn",4,7,!1,"#9c7ac7"),26:el("Fe",4,8,!1,"#e06633"),27:el("Co",4,8,!1,"#f08fa1"),28:el("Ni",4,8,!1,"#4fd14f"),29:el("Cu",4,1,!1,"#c78033"),30:el("Zn",4,2,!1,"#7d80b0"),31:el("Ga",4,3,!1,"#c28f8f"),32:el("Ge",4,4,!1,"#668f8f"),33:el("As",4,5,!1,"#bd80e3"),34:el("Se",4,6,!0,"#ffa100"),35:el("Br",4,7,!0,"#a62929"),36:el("Kr",4,8,!1,"#5cb8d1"),37:el("Rb",5,1,!1,"#702eb0"),38:el("Sr",5,2,!1,"#00ff00"),39:el("Y",5,3,!1,"#94ffff"),40:el("Zr",5,4,!1,"#94e0e0"),41:el("Nb",5,5,!1,"#73c2c9"),42:el("Mo",5,6,!1,"#54b5b5"),43:el("Tc",5,7,!1,"#3b9e9e"),44:el("Ru",5,8,!1,"#248f8f"),45:el("Rh",5,8,!1,"#0a7d8c"),46:el("Pd",5,8,!1,"#006985"),47:el("Ag",5,1,!1,"#bfbfbf"),48:el("Cd",5,2,!1,"#ffd98f"),49:el("In",5,3,!1,"#a67573"),50:el("Sn",5,4,!1,"#668080"),51:el("Sb",5,5,!1,"#9e63b5"),52:el("Te",5,6,!1,"#d47a00"),53:el("I",5,7,!0,"#940094"),54:el("Xe",5,8,!1,"#429eb0"),55:el("Cs",6,1,!1,"#57178f"),56:el("Ba",6,2,!1,"#00c900"),57:el("La",6,3,!1,"#70d4ff"),58:el("Ce",6,3,!1,"#ffffc7"),59:el("Pr",6,3,!1,"#d9ffc7"),60:el("Nd",6,3,!1,"#c7ffc7"),61:el("Pm",6,3,!1,"#a3ffc7"),62:el("Sm",6,3,!1,"#8fffc7"),63:el("Eu",6,3,!1,"#61ffc7"),64:el("Gd",6,3,!1,"#45ffc7"),65:el("Tb",6,3,!1,"#30ffc7"),66:el("Dy",6,3,!1,"#1fffc7"),67:el("Ho",6,3,!1,"#00ff9c"),68:el("Er",6,3,!1,"#00e675"),69:el("Tm",6,3,!1,"#00d452"),70:el("Yb",6,3,!1,"#00bf38"),71:el("Lu",6,3,!1,"#00ab24"),72:el("Hf",6,4,!1,"#4dc2ff"),73:el("Ta",6,5,!1,"#4da6ff"),74:el("W",6,6,!1,"#2194d6"),75:el("Re",6,7,!1,"#267dab"),76:el("Os",6,8,!1,"#266696"),77:el("Ir",6,8,!1,"#175487"),78:el("Pt",6,8,!1,"#d1d1e0"),79:el("Au",6,1,!1,"#ffd124"),80:el("Hg",6,2,!1,"#b8b8d1"),81:el("Tl",6,3,!1,"#a6544d"),82:el("Pb",6,4,!1,"#575961"),83:el("Bi",6,5,!1,"#9e4fb5"),84:el("Po",6,6,!1,"#ab5c00"),85:el("At",6,7,!1,"#754f45"),86:el("Rn",6,8,!1,"#428296"),87:el("Fr",7,1,!1,"#420066"),88:el("Ra",7,2,!1,"#007d00"),89:el("Ac",7,3,!1,"#70abfa"),90:el("Th",7,3,!1,"#00baff"),91:el("Pa",7,3,!1,"#00a1ff"),92:el("U",7,3,!1,"#008fff"),93:el("Np",7,3,!1,"#0080ff"),94:el("Pu",7,3,!1,"#006bff"),95:el("Am",7,3,!1,"#545cf2"),96:el("Cm",7,3,!1,"#785ce3"),97:el("Bk",7,3,!1,"#8a4fe3"),98:el("Cf",7,3,!1,"#a136d4"),99:el("Es",7,3,!1,"#b31fd4"),100:el("Fm",7,3,!1,"#000000"),101:el("Md",7,3,!1,"#000000"),102:el("No",7,3,!1,"#000000"),103:el("Lr",7,3,!1,"#000000"),104:el("Rf",7,4,!1,"#4dc2ff"),105:el("Db",7,5,!1,"#4da6ff"),106:el("Sg",7,6,!1,"#2194d6"),107:el("Bh",7,7,!1,"#267dab"),108:el("Hs",7,8,!1,"#266696"),109:el("Mt",7,8,!1,"#175487"),110:el("Ds",7,8,!1,"#d1d1e0"),111:el("Rg",7,1,!1,"#ffd124"),112:el("Cn",7,2,!1,"#b8b8d1"),113:el("Uut",7,3,!1),114:el("Fl",7,4,!1),115:el("Uup",7,5,!1),116:el("Lv",7,6,!1),117:el("Uus",7,7,!1),118:el("Uuo",7,8,!1)}),labelMap=null;element.getElementByLabel=function(e){return labelMap||(labelMap={},element.each(function(e,l){labelMap[l.label]=e-0})),labelMap[e]||null},module.exports=element;

},{"../util/map":40}],11:[function(require,module,exports){
(function (global){
require("./struct"),require("./cis_trans"),require("./dfs"),require("./molfile"),require("./sgroup"),require("./smiles"),require("./stereocenters"),require("./struct_valence"),global.chem=global.chem||{};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./cis_trans":8,"./dfs":9,"./molfile":12,"./sgroup":13,"./smiles":14,"./stereocenters":15,"./struct":16,"./struct_valence":17}],12:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Set=require("../util/set"),Vec2=require("../util/vec2"),element=require("./element"),util=require("../util"),chem=global.chem=global.chem||{};chem.Molfile=function(){},chem.Molfile.loadRGroupFragments=!0,chem.Molfile.parseDecimalInt=function(e){var t=parseInt(e,10);return isNaN(t)?0:t},chem.Molfile.partitionLine=function(e,t,r){for(var i=[],a=0,n=0;a<t.length;++a)i.push(e.slice(n,n+t[a])),r&&n++,n+=t[a];return i},chem.Molfile.partitionLineFixed=function(e,t,r){for(var i=[],a=0;a<e.length;a+=t)i.push(e.slice(a,a+t)),r&&a++;return i},chem.Molfile.parseCTFile=function(e){var t=Array.isArray(e)?e:util.splitNewlines(e),r=null;return r=0==t[0].search("\\$RXN")?chem.Molfile.parseRxn(t):chem.Molfile.parseMol(t),r.initHalfBonds(),r.initNeighbors(),r.markFragments(),r},chem.Molfile.fmtInfo={bondTypeMap:{1:chem.Struct.BOND.TYPE.SINGLE,2:chem.Struct.BOND.TYPE.DOUBLE,3:chem.Struct.BOND.TYPE.TRIPLE,4:chem.Struct.BOND.TYPE.AROMATIC,5:chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE,6:chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC,7:chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC,8:chem.Struct.BOND.TYPE.ANY},bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,4:chem.Struct.BOND.STEREO.EITHER,6:chem.Struct.BOND.STEREO.DOWN,3:chem.Struct.BOND.STEREO.CIS_TRANS},v30bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,2:chem.Struct.BOND.STEREO.EITHER,3:chem.Struct.BOND.STEREO.DOWN},bondTopologyMap:{0:chem.Struct.BOND.TOPOLOGY.EITHER,1:chem.Struct.BOND.TOPOLOGY.RING,2:chem.Struct.BOND.TOPOLOGY.CHAIN},countsLinePartition:[3,3,3,3,3,3,3,3,3,3,3,6],atomLinePartition:[10,10,10,1,3,2,3,3,3,3,3,3,3,3,3,3,3],bondLinePartition:[3,3,3,3,3,3,3],atomListHeaderPartition:[3,1,1,4,1,1],atomListHeaderLength:11,atomListHeaderItemLength:4,chargeMap:[0,3,2,1,0,-1,-2,-3],valenceMap:[void 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,0],implicitHydrogenMap:[void 0,0,1,2,3,4],v30atomPropMap:{CHG:"charge",RAD:"radical",MASS:"isotope",VAL:"explicitValence",HCOUNT:"hCount",INVRET:"invRet",SUBST:"substitutionCount",UNSAT:"unsaturatedAtom",RBCNT:"ringBondCount"},rxnItemsPartition:[3,3,3]},chem.Molfile.parseAtomLine=function(e){var t=chem.Molfile,r=t.partitionLine(e,t.fmtInfo.atomLinePartition),i={pp:new Vec2(parseFloat(r[0]),-parseFloat(r[1])),label:r[4].strip(),explicitValence:t.fmtInfo.valenceMap[t.parseDecimalInt(r[10])],massDifference:t.parseDecimalInt(r[5]),charge:t.fmtInfo.chargeMap[t.parseDecimalInt(r[6])],hCount:t.parseDecimalInt(t.parseDecimalInt(r[8])),stereoCare:0!=t.parseDecimalInt(r[9]),aam:t.parseDecimalInt(r[14]),invRet:t.parseDecimalInt(r[15]),exactChangeFlag:0!=t.parseDecimalInt(r[16])};return new chem.Struct.Atom(i)},chem.Molfile.stripV30=function(e){if("M  V30 "!=e.slice(0,7))throw Error("Prefix invalid");return e.slice(7)},chem.Molfile.parseAtomLineV3000=function(e){var t,r,i,a,n,l=chem.Molfile;t=l.spaceparsplit(e);var o={pp:new Vec2(parseFloat(t[2]),-parseFloat(t[3])),aam:t[5].strip()},s=t[1].strip();if('"'==s.charAt(0)&&'"'==s.charAt(s.length-1)&&(s=s.substr(1,s.length-2)),"]"==s.charAt(s.length-1)){s=s.substr(0,s.length-1);var c={};if(c.notList=!1,"NOT ["==s.substr(0,5))c.notList=!0,s=s.substr(5);else{if("["!=s.charAt(0))throw"Error: atom list expected, found '"+s+"'";s=s.substr(1)}c.ids=l.labelsListToIds(s.split(",")),o.atomList=new chem.Struct.AtomList(c),o.label="L#"}else o.label=s;for(t.splice(0,6),n=0;n<t.length;++n)if(r=l.splitonce(t[n],"="),i=r[0],a=r[1],i in l.fmtInfo.v30atomPropMap){var p=l.parseDecimalInt(a);if("VAL"==i){if(0==p)continue;-1==p&&(p=0)}o[l.fmtInfo.v30atomPropMap[i]]=p}else if("RGROUPS"==i){a=a.strip().substr(1,a.length-2);var h=a.split(" ").slice(1);o.rglabel=0;for(var u=0;u<h.length;++u)o.rglabel|=1<<h[u]-1}else"ATTCHPT"==i&&(o.attpnt=a.strip()-0);return new chem.Struct.Atom(o)},chem.Molfile.parseBondLineV3000=function(e){var t,r,i,a,n,l=chem.Molfile;t=l.spaceparsplit(e);var o={begin:l.parseDecimalInt(t[2])-1,end:l.parseDecimalInt(t[3])-1,type:l.fmtInfo.bondTypeMap[l.parseDecimalInt(t[1])]};for(t.splice(0,4),n=0;n<t.length;++n)r=l.splitonce(t[n],"="),i=r[0],a=r[1],"CFG"==i?(o.stereo=l.fmtInfo.v30bondStereoMap[l.parseDecimalInt(a)],o.type==chem.Struct.BOND.TYPE.DOUBLE&&o.stereo==chem.Struct.BOND.STEREO.EITHER&&(o.stereo=chem.Struct.BOND.STEREO.CIS_TRANS)):"TOPO"==i?o.topology=l.fmtInfo.bondTopologyMap[l.parseDecimalInt(a)]:"RXCTR"==i?o.reactingCenterStatus=l.parseDecimalInt(a):"STBOX"==i&&(o.stereoCare=l.parseDecimalInt(a));return new chem.Struct.Bond(o)},chem.Molfile.parseBondLine=function(e){var t=chem.Molfile,r=t.partitionLine(e,t.fmtInfo.bondLinePartition),i={begin:t.parseDecimalInt(r[0])-1,end:t.parseDecimalInt(r[1])-1,type:t.fmtInfo.bondTypeMap[t.parseDecimalInt(r[2])],stereo:t.fmtInfo.bondStereoMap[t.parseDecimalInt(r[3])],topology:t.fmtInfo.bondTopologyMap[t.parseDecimalInt(r[5])],reactingCenterStatus:t.parseDecimalInt(r[6])};return new chem.Struct.Bond(i)},chem.Molfile.parseAtomListLine=function(e){for(var t=chem.Molfile,r=t.partitionLine(e,t.fmtInfo.atomListHeaderPartition),i=t.parseDecimalInt(r[0])-1,a="T"==r[2].strip(),n=t.parseDecimalInt(r[4].strip()),l=e.slice(t.fmtInfo.atomListHeaderLength),o=[],s=t.fmtInfo.atomListHeaderItemLength,c=0;c<n;++c)o[c]=t.parseDecimalInt(l.slice(c*s,(c+1)*s-1));return{aid:i,atomList:new chem.Struct.AtomList({notList:a,ids:o})}},chem.Molfile.readKeyValuePairs=function(e,t){for(var r=chem.Molfile,i={},a=r.partitionLineFixed(e,3,!0),n=r.parseDecimalInt(a[0]),l=0;l<n;++l)i[r.parseDecimalInt(a[2*l+1])-1]=t?a[2*l+2].strip():r.parseDecimalInt(a[2*l+2]);return i},chem.Molfile.readKeyMultiValuePairs=function(e,t){for(var r=chem.Molfile,i=[],a=r.partitionLineFixed(e,3,!0),n=r.parseDecimalInt(a[0]),l=0;l<n;++l)i.push([r.parseDecimalInt(a[2*l+1])-1,t?a[2*l+2].strip():r.parseDecimalInt(a[2*l+2])]);return i},chem.Molfile.labelsListToIds=function(e){for(var t=[],r=0;r<e.length;++r)t.push(element.getElementByLabel(e[r].strip()));return t},chem.Molfile.parsePropertyLineAtomList=function(e,t){var r=chem.Molfile,i=r.parseDecimalInt(e[1])-1,a=r.parseDecimalInt(e[2]),n="T"==e[4].strip(),l=r.labelsListToIds(t.slice(0,a)),o={};return o[i]=new chem.Struct.AtomList({notList:n,ids:l}),o},chem.Molfile.initSGroup=function(e,t){var r=chem.Molfile,i=r.readKeyValuePairs(t,!0);for(var a in i){var n=i[a];if(!(n in chem.SGroup.TYPES))throw new Error("Unsupported S-group type");var l=new chem.SGroup(n);l.number=a,e[a]=l}},chem.Molfile.applySGroupProp=function(e,t,r,i,a){var n=chem.Molfile,l=n.readKeyValuePairs(r,!i);for(var o in l)(a?e[o]:e[o].data)[t]=l[o]},chem.Molfile.toIntArray=function(e){for(var t=chem.Molfile,r=[],i=0;i<e.length;++i)r[i]=t.parseDecimalInt(e[i]);return r},chem.Molfile.applySGroupArrayProp=function(e,t,r,i){var a=chem.Molfile,n=a.parseDecimalInt(r.slice(1,4))-1,l=a.parseDecimalInt(r.slice(4,8)),o=a.toIntArray(a.partitionLineFixed(r.slice(8),3,!0));if(o.length!=l)throw new Error("File format invalid");i&&util.apply(o,function(e){return e+i}),e[n][t]=e[n][t].concat(o)},chem.Molfile.applyDataSGroupName=function(e,t){e.data.fieldName=t},chem.Molfile.applyDataSGroupQuery=function(e,t){e.data.query=t},chem.Molfile.applyDataSGroupQueryOp=function(e,t){e.data.queryOp=t},chem.Molfile.applyDataSGroupDesc=function(e,t){var r=chem.Molfile,i=r.partitionLine(t,[4,31,2,20,2,3],!1),a=r.parseDecimalInt(i[0])-1,n=i[1].strip(),l=i[2].strip(),o=i[3].strip(),s=i[4].strip(),c=i[5].strip(),p=e[a];p.data.fieldType=l,p.data.fieldName=n,p.data.units=o,p.data.query=s,p.data.queryOp=c},chem.Molfile.applyDataSGroupInfo=function(e,t){var r=chem.Molfile,i=r.partitionLine(t,[10,10,4,1,1,1,3,3,3,3,2,3,2],!1),a=parseFloat(i[0]),n=parseFloat(i[1]),l="A"==i[3].strip(),o="A"==i[4].strip(),s="U"==i[5].strip(),c=i[7].strip();c="ALL"==c?-1:r.parseDecimalInt(c);var p=i[10].strip(),h=r.parseDecimalInt(i[11].strip());e.pp=new Vec2(a,-n),e.data.attached=l,e.data.absolute=o,e.data.showUnits=s,e.data.nCharsToDisplay=c,e.data.tagChar=p,e.data.daspPos=h},chem.Molfile.applyDataSGroupInfoLine=function(e,t){var r=chem.Molfile,i=r.parseDecimalInt(t.substr(0,4))-1,a=e[i];r.applyDataSGroupInfo(a,t.substr(5))},chem.Molfile.applyDataSGroupData=function(e,t,r){e.data.fieldValue=(e.data.fieldValue||"")+t,r&&(e.data.fieldValue=util.stripRight(e.data.fieldValue),e.data.fieldValue.startsWith('"')&&e.data.fieldValue.endsWith('"')&&(e.data.fieldValue=e.data.fieldValue.substr(1,e.data.fieldValue.length-2)))},chem.Molfile.applyDataSGroupDataLine=function(e,t,r){var i=chem.Molfile,a=i.parseDecimalInt(t.substr(0,5))-1,n=t.substr(5),l=e[a];i.applyDataSGroupData(l,n,r)},chem.Molfile.parsePropertyLines=function(e,t,r,i,a,n){for(var l=chem.Molfile,o=new Map;r<i;){var s=t[r];if("A"==s.charAt(0))o.get("label")||o.set("label",new Map),o.get("label").set(l.parseDecimalInt(s.slice(3,6))-1,t[++r]);else if("M"==s.charAt(0)){var c=s.slice(3,6),p=s.slice(6);if("END"==c)break;if("CHG"==c)o.get("charge")||o.set("charge",new Map),o.get("charge").update(l.readKeyValuePairs(p));else if("RAD"==c)o.get("radical")||o.set("radical",new Map),o.get("radical").update(l.readKeyValuePairs(p));else if("ISO"==c)o.get("isotope")||o.set("isotope",new Map),o.get("isotope").update(l.readKeyValuePairs(p));else if("RBC"==c)o.get("ringBondCount")||o.set("ringBondCount",new Map),o.get("ringBondCount").update(l.readKeyValuePairs(p));else if("SUB"==c)o.get("substitutionCount")||o.set("substitutionCount",new Map),o.get("substitutionCount").update(l.readKeyValuePairs(p));else if("UNS"==c)o.get("unsaturatedAtom")||o.set("unsaturatedAtom",new Map),o.get("unsaturatedAtom").update(l.readKeyValuePairs(p));else if("RGP"==c){o.get("rglabel")||o.set("rglabel",new Map);for(var h=o.get("rglabel"),u=l.readKeyMultiValuePairs(p),m=0;m<u.length;m++){var f=u[m];h.set(f[0],(h.get(f[0])||0)|1<<f[1]-1)}}else if("LOG"==c){p=p.slice(4);var d=l.parseDecimalInt(p.slice(0,3).strip()),g=l.parseDecimalInt(p.slice(4,7).strip()),w=l.parseDecimalInt(p.slice(8,11).strip()),S=p.slice(12).strip(),M={};g>0&&(M.ifthen=g),M.resth=1==w,M.range=S,n[d]=M}else if("APO"==c)o.get("attpnt")||o.set("attpnt",new Map),o.get("attpnt").update(l.readKeyValuePairs(p));else if("ALS"==c){o.get("atomList")||o.set("atomList",new Map);var v=l.parsePropertyLineAtomList(l.partitionLine(p,[1,3,3,1,1,1]),l.partitionLineFixed(p.slice(10),4,!1));o.get("atomList").update(v),o.get("label")||o.set("label",new Map);for(var D in v)o.get("label").set(D,"L#")}else if("STY"==c)l.initSGroup(a,p);else if("SST"==c)l.applySGroupProp(a,"subtype",p);else if("SLB"==c)l.applySGroupProp(a,"label",p,!0);else if("SPL"==c)l.applySGroupProp(a,"parent",p,!0,!0);else if("SCN"==c)l.applySGroupProp(a,"connectivity",p);else if("SAL"==c)l.applySGroupArrayProp(a,"atoms",p,-1);else if("SBL"==c)l.applySGroupArrayProp(a,"bonds",p,-1);else if("SPA"==c)l.applySGroupArrayProp(a,"patoms",p,-1);else if("SMT"==c){var b=l.parseDecimalInt(p.slice(0,4))-1;a[b].data.subscript=p.slice(4).strip()}else"SDT"==c?l.applyDataSGroupDesc(a,p):"SDD"==c?l.applyDataSGroupInfoLine(a,p):"SCD"==c?l.applyDataSGroupDataLine(a,p,!1):"SED"==c&&l.applyDataSGroupDataLine(a,p,!0)}++r}return o},chem.Molfile.applyAtomProp=function(e,t,r,i){t.each(function(t,i){e.get(t)[r]=i})},chem.Molfile.parseCTabV2000=function(e,t){var r,i=new chem.Struct,a=chem.Molfile,n=a.parseDecimalInt(t[0]),l=a.parseDecimalInt(t[1]),o=a.parseDecimalInt(t[2]);i.isChiral=0!=a.parseDecimalInt(t[4]);var s=a.parseDecimalInt(t[5]),c=a.parseDecimalInt(t[10]),p=0,h=e.slice(p,p+n);p+=n;var u=e.slice(p,p+l);p+=l;var m=e.slice(p,p+o);p+=o+s;var f=h.map(a.parseAtomLine);for(r=0;r<f.length;++r)i.atoms.add(f[r]);var d=u.map(a.parseBondLine);for(r=0;r<d.length;++r)i.bonds.add(d[r]);m.map(a.parseAtomListLine).each(function(e){i.atoms.get(e.aid).atomList=e.atomList,i.atoms.get(e.aid).label="L#"});var g={},w={};a.parsePropertyLines(i,e,p,Math.min(e.length,p+c),g,w).each(function(e,t){a.applyAtomProp(i.atoms,t,e)});var S,M={};for(S in g){var v=g[S];if("DAT"===v.type&&0===v.atoms.length){var D=g[S].parent;if(D>=0){var b=g[D-1];"GEN"===b.type&&(v.atoms=util.array(b.atoms))}}}for(S in g)chem.SGroup.addGroup(i,g[S],M);var N=[];for(S in g)chem.SGroup.filter(i,g[S],M),0!=g[S].atoms.length||g[S].allAtoms||N.push(S);for(r=0;r<N.length;++r)i.sGroupForest.remove(N[r]),i.sgroups.remove(N[r]);for(var P in w)i.rgroups.set(P,new chem.Struct.RGroup(w[P]));return i},chem.Molfile.spaceparsplit=function(e){var t,r,i=[],a=0,n=-1,l=e.toArray(),o=!1;for(r=0;r<e.length;++r)t=l[r],"("==t?a++:")"==t&&a--,'"'==t&&(o=!o),o||" "!=l[r]||0!=a||(r>n+1&&i.push(e.slice(n+1,r)),n=r);return r>n+1&&i.push(e.slice(n+1,r)),n=r,i},chem.Molfile.splitonce=function(e,t){var r=e.indexOf(t);return[e.slice(0,r),e.slice(r+1)]},chem.Molfile.splitSGroupDef=function(e){for(var t=[],r=0,i=!1,a=0;a<e.length;++a){var n=e.charAt(a);'"'==n?i=!i:i||("("==n?r++:")"==n?r--:" "==n&&0==r&&(t.push(e.slice(0,a)),e=e.slice(a+1).strip(),a=0))}if(0!=r)throw"Brace balance broken. S-group properies invalid!";return e.length>0&&t.push(e.strip()),t},chem.Molfile.parseBracedNumberList=function(e,t){if(!e)return null;var r=[];e=e.strip(),e=e.substr(1,e.length-2);var i=e.split(" ");t=t||0;for(var a=1;a<i.length;++a)r.push(i[a]-0+t);return r},chem.Molfile.v3000parseCollection=function(e,t,r){for(r++;"M  V30 END COLLECTION"!=t[r].strip();)r++;return++r},chem.Molfile.v3000parseSGroup=function(e,t,r,i,a){var n=chem.Molfile,l="";for(a++;a<t.length;){if(l=n.stripV30(t[a++]).strip(),"END SGROUP"==l.strip())return a;for(;"-"==l.charAt(l.length-1);)l=(l.substr(0,l.length-1)+n.stripV30(t[a++])).strip();var o=n.splitSGroupDef(l),s=o[1],c=new chem.SGroup(s);c.number=o[0]-0,c.type=s,c.label=o[2]-0,r[c.number]=c;for(var p={},h=3;h<o.length;++h){var u=n.splitonce(o[h],"=");if(2!=u.length)throw"A record of form AAA=BBB or AAA=(...) expected, got '"+o[h]+"'";var m=u[0];m in p||(p[m]=[]),p[m].push(u[1])}c.atoms=n.parseBracedNumberList(p.ATOMS[0],-1),p.PATOMS&&(c.patoms=n.parseBracedNumberList(p.PATOMS[0],-1)),c.bonds=p.BONDS?n.parseBracedNumberList(p.BONDS[0],-1):[];var f=p.BRKXYZ;if(c.brkxyz=[],f)for(var d=0;d<f.length;++d)c.brkxyz.push(n.parseBracedNumberList(f[d]));p.MULT&&(c.data.subscript=p.MULT[0]-0),p.LABEL&&(c.data.subscript=p.LABEL[0].strip()),p.CONNECT&&(c.data.connectivity=p.CONNECT[0].toLowerCase()),p.FIELDDISP&&n.applyDataSGroupInfo(c,util.stripQuotes(p.FIELDDISP[0])),p.FIELDDATA&&n.applyDataSGroupData(c,p.FIELDDATA[0],!0),p.FIELDNAME&&n.applyDataSGroupName(c,p.FIELDNAME[0]),p.QUERYTYPE&&n.applyDataSGroupQuery(c,p.QUERYTYPE[0]),p.QUERYOP&&n.applyDataSGroupQueryOp(c,p.QUERYOP[0]),chem.SGroup.addGroup(e,c,i)}throw new Error("S-group declaration incomplete.")},chem.Molfile.parseCTabV3000=function(e,t){var r=new chem.Struct,i=chem.Molfile,a=0;if("M  V30 BEGIN CTAB"!=e[a++].strip())throw Error("CTAB V3000 invalid");if("M  V30 COUNTS"!=e[a].slice(0,13))throw Error("CTAB V3000 invalid");var n=e[a].slice(14).split(" ");if(r.isChiral=1==i.parseDecimalInt(n[4]),a++,"M  V30 BEGIN ATOM"==e[a].strip()){a++;for(var l;a<e.length&&"END ATOM"!=(l=i.stripV30(e[a++]).strip());){for(;"-"==l.charAt(l.length-1);)l=(l.substring(0,l.length-1)+i.stripV30(e[a++])).strip();r.atoms.add(i.parseAtomLineV3000(l))}if("M  V30 BEGIN BOND"==e[a].strip())for(a++;a<e.length&&"END BOND"!=(l=i.stripV30(e[a++]).strip());){for(;"-"==l.charAt(l.length-1);)l=(l.substring(0,l.length-1)+i.stripV30(e[a++])).strip();r.bonds.add(i.parseBondLineV3000(l))}for(var o={},s={};"M  V30 END CTAB"!=e[a].strip();)if("M  V30 BEGIN COLLECTION"==e[a].strip())a=i.v3000parseCollection(r,e,a);else{if("M  V30 BEGIN SGROUP"!=e[a].strip())throw Error("CTAB V3000 invalid");a=i.v3000parseSGroup(r,e,o,s,a)}}if("M  V30 END CTAB"!=e[a++].strip())throw Error("CTAB V3000 invalid");return t||i.readRGroups3000(r,e.slice(a)),r},chem.Molfile.readRGroups3000=function(e,t){for(var r={},i={},a=0,n=chem.Molfile;a<t.length&&0==t[a].search("M  V30 BEGIN RGROUP");){var l=t[a++].split(" ").pop();for(r[l]=[],i[l]={};;){var o=t[a].strip();if(0!=o.search("M  V30 RLOGIC")){if("M  V30 BEGIN CTAB"!=o)throw Error("CTAB V3000 invalid");for(var s=0;s<t.length&&"M  V30 END CTAB"!=t[a+s].strip();++s);var c=t.slice(a,a+s+1),p=this.parseCTabV3000(c,!0);if(r[l].push(p),a=a+s+1,"M  V30 END RGROUP"==t[a].strip()){a++;break}}else{o=o.slice(13);var h=o.strip().split(/\s+/g),u=n.parseDecimalInt(h[0]),m=n.parseDecimalInt(h[1]),f=h.slice(2).join(" "),d={};u>0&&(d.ifthen=u),d.resth=1==m,d.range=f,i[l]=d,a++}}}for(var g in r)for(var w=0;w<r[g].length;++w){var S=r[g][w];S.rgroups.set(g,new chem.Struct.RGroup(i[g]));var M=S.frags.add(new chem.Struct.Fragment);S.rgroups.get(g).frags.add(M),S.atoms.each(function(e,t){t.fragment=M}),S.mergeInto(e)}},chem.Molfile.parseMol=function(e){if(0==e[0].search("\\$MDL"))return this.parseRg2000(e);var t=this.parseCTab(e.slice(3));return t.name=e[0].strip(),t},chem.Molfile.parseCTab=function(e){var t=chem.Molfile,r=t.partitionLine(e[0],t.fmtInfo.countsLinePartition),i=r[11].strip();if(e=e.slice(1),"V2000"==i)return this.parseCTabV2000(e,r);if("V3000"==i)return this.parseCTabV3000(e,!chem.Molfile.loadRGroupFragments);throw Error("Molfile version unknown: "+i)},chem.MolfileSaver=function(e){this.molecule=null,this.molfile=null,this.v3000=e||!1},chem.MolfileSaver.prototype.prepareSGroups=function(e,t){var r=this.molecule,i=(r.sgroups,[]),a=0;util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(n){var l=r.sgroups.get(n),o=!1;try{l.prepareForSaving(r)}catch(t){if(!e||"number"!=typeof t.id)throw t;o=!0}(o||!t&&/^INDIGO_.+_DESC$/i.test(l.data.fieldName))&&(a+=o,i.push(l.id))},this),a&&alert("WARNING: "+a+" invalid S-groups were detected. They will be omitted.");for(var n=0;n<i.length;++n)r.sGroupDelete(i[n]);return r},chem.MolfileSaver.getComponents=function(e){var t=e.findConnectedComponents(!0),r=[],i=null;e.rxnArrows.each(function(e,t){i=t.pp.x}),e.rxnPluses.each(function(e,t){r.push(t.pp.x)}),null!=i&&r.push(i),r.sort(function(e,t){return e-t});var a,n=[];for(a=0;a<t.length;++a){for(var l=e.getCoordBoundingBox(t[a]),o=Vec2.lc2(l.min,.5,l.max,.5),s=0;o.x>r[s];)++s;n[s]=n[s]||{},Set.mergeIn(n[s],t[a])}var c=[],p=[],h=[];for(a=0;a<n.length;++a)n[a]?(l=e.getCoordBoundingBox(n[a]),o=Vec2.lc2(l.min,.5,l.max,.5),o.x<i?p.push(n[a]):h.push(n[a])):c.push("");return{reactants:p,products:h}},chem.MolfileSaver.prototype.getCTab=function(e,t){return this.molecule=e.clone(),this.molfile="",this.writeCTab2000(t),this.molfile},chem.MolfileSaver.prototype.saveMolecule=function(e,t,r,i){if(this.reaction=e.rxnArrows.count()>0,e.rxnArrows.count()>1)throw new Error("Reaction may not contain more than one arrow");if(this.molfile="",this.reaction){if(e.rgroups.count()>0)throw new Error("Unable to save the structure - reactions with r-groups are not supported at the moment");var a=chem.MolfileSaver.getComponents(e),n=a.reactants,l=a.products,o=n.concat(l);this.molfile="$RXN\n\n\n\n"+util.paddedInt(n.length,3)+util.paddedInt(l.length,3)+util.paddedInt(0,3)+"\n";for(var s=0;s<o.length;++s){var c=new chem.MolfileSaver(!1),p=e.clone(o[s],null,!0),h=c.saveMolecule(p,!1,!0);this.molfile+="$MOL\n"+h}return this.molfile}if(e.rgroups.count()>0){if(!r){var u=new chem.MolfileSaver(!1).getCTab(e.getScaffold(),e.rgroups);return this.molfile="$MDL  REV  1\n$MOL\n$HDR\n\n\n\n$END HDR\n",this.molfile+="$CTAB\n"+u+"$END CTAB\n",e.rgroups.each(function(t,r){this.molfile+="$RGP\n",this.writePaddedNumber(t,3),this.molfile+="\n",r.frags.each(function(t,r){var i=new chem.MolfileSaver(!1).getCTab(e.getFragment(r));this.molfile+="$CTAB\n"+i+"$END CTAB\n"},this),this.molfile+="$END RGP\n"},this),this.molfile+="$END MOL\n",this.molfile}e=e.getScaffold()}return this.molecule=e.clone(),this.prepareSGroups(t,i),this.writeHeader(),this.writeCTab2000(),this.molfile},chem.MolfileSaver.prototype.writeHeader=function(){var e=new Date;this.writeCR(),this.writeWhiteSpace(2),this.write("Ketcher"),this.writeWhiteSpace(),this.writeCR((e.getMonth()+1).toPaddedString(2)+e.getDate().toPaddedString(2)+(e.getFullYear()%100).toPaddedString(2)+e.getHours().toPaddedString(2)+e.getMinutes().toPaddedString(2)+"2D 1   1.00000     0.00000     0"),this.writeCR()},chem.MolfileSaver.prototype.write=function(e){this.molfile+=e},chem.MolfileSaver.prototype.writeCR=function(e){0==arguments.length&&(e=""),this.molfile+=e+"\n"},chem.MolfileSaver.prototype.writeWhiteSpace=function(e){0==arguments.length&&(e=1),e.times(function(){this.write(" ")},this)},chem.MolfileSaver.prototype.writePadded=function(e,t){this.write(e),this.writeWhiteSpace(t-e.length)},chem.MolfileSaver.prototype.writePaddedNumber=function(e,t){var r=(e-0).toString();this.writeWhiteSpace(t-r.length),this.write(r)},chem.MolfileSaver.prototype.writePaddedFloat=function(e,t,r){this.write(util.paddedFloat(e,t,r))},chem.MolfileSaver.prototype.writeCTab2000Header=function(){this.writePaddedNumber(this.molecule.atoms.count(),3),this.writePaddedNumber(this.molecule.bonds.count(),3),this.writePaddedNumber(0,3),this.writeWhiteSpace(3),this.writePaddedNumber(this.molecule.isChiral?1:0,3),this.writePaddedNumber(0,3),this.writeWhiteSpace(12),this.writePaddedNumber(999,3),this.writeCR(" V2000")},chem.MolfileSaver.prototype.writeCTab2000=function(e){this.writeCTab2000Header(),this.mapping={};var t=1,r=[],i=[];for(this.molecule.atoms.each(function(e,a){this.writePaddedFloat(a.pp.x,10,4),this.writePaddedFloat(-a.pp.y,10,4),this.writePaddedFloat(0,10,4),this.writeWhiteSpace();var n=a.label;null!=a.atomList?(n="L",r.push(e)):null==element.getElementByLabel(n)&&-1==["A","Q","X","*","R#"].indexOf(n)&&(n="C",i.push(e)),this.writePadded(n,3),this.writePaddedNumber(0,2),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(a.hCount)&&(a.hCount=0),this.writePaddedNumber(a.hCount,3),Object.isUndefined(a.stereoCare)&&(a.stereoCare=0),this.writePaddedNumber(a.stereoCare,3),this.writePaddedNumber(a.explicitValence<0?0:0==a.explicitValence?15:a.explicitValence,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(a.aam)&&(a.aam=0),this.writePaddedNumber(a.aam,3),Object.isUndefined(a.invRet)&&(a.invRet=0),this.writePaddedNumber(a.invRet,3),Object.isUndefined(a.exactChangeFlag)&&(a.exactChangeFlag=0),this.writePaddedNumber(a.exactChangeFlag,3),this.writeCR(),this.mapping[e]=t,t++},this),this.bondMapping={},t=1,this.molecule.bonds.each(function(e,r){this.bondMapping[e]=t++,this.writePaddedNumber(this.mapping[r.begin],3),this.writePaddedNumber(this.mapping[r.end],3),this.writePaddedNumber(r.type,3),Object.isUndefined(r.stereo)&&(r.stereo=0),this.writePaddedNumber(r.stereo,3),this.writeWhiteSpace(3),Object.isUndefined(r.topology)&&(r.topology=0),this.writePaddedNumber(r.topology,3),Object.isUndefined(r.reactingCenterStatus)&&(r.reactingCenterStatus=0),this.writePaddedNumber(r.reactingCenterStatus,3),this.writeCR()},this);i.length>0;)this.write("A  "),this.writePaddedNumber(i[0]+1,3),this.writeCR(),this.writeCR(this.molecule.atoms.get(i[0]).label),i.splice(0,1);var a=new Array,n=new Array,l=new Array,o=new Array,s=new Array,c=new Array,p=new Array,h=new Array,u=new Array;this.molecule.atoms.each(function(e,t){if(0!=t.charge&&a.push([e,t.charge]),0!=t.isotope&&n.push([e,t.isotope]),0!=t.radical&&l.push([e,t.radical]),null!=t.rglabel&&"R#"==t.label)for(var r=0;r<32;r++)t.rglabel&1<<r&&o.push([e,r+1]);null!=t.attpnt&&c.push([e,t.attpnt]),0!=t.ringBondCount&&p.push([e,t.ringBondCount]),0!=t.substitutionCount&&u.push([e,t.substitutionCount]),0!=t.unsaturatedAtom&&h.push([e,t.unsaturatedAtom])}),e&&e.each(function(e,t){if(t.resth||t.ifthen>0||t.range.length>0){var r="  1 "+util.paddedInt(e,3)+" "+util.paddedInt(t.ifthen,3)+" "+util.paddedInt(t.resth?1:0,3)+"   "+t.range;s.push(r)}});var m=function(e,t){for(;t.length>0;){for(var r=new Array;t.length>0&&r.length<8;)r.push(t[0]),t.splice(0,1);this.write(e),this.writePaddedNumber(r.length,3),r.each(function(e){this.writeWhiteSpace(),this.writePaddedNumber(this.mapping[e[0]],3),this.writeWhiteSpace(),this.writePaddedNumber(e[1],3)},this),this.writeCR()}};m.call(this,"M  CHG",a),m.call(this,"M  ISO",n),m.call(this,"M  RAD",l),m.call(this,"M  RGP",o);for(var f=0;f<s.length;++f)this.write("M  LOG"+s[f]+"\n");if(m.call(this,"M  APO",c),m.call(this,"M  RBC",p),m.call(this,"M  SUB",u),m.call(this,"M  UNS",h),r.length>0)for(f=0;f<r.length;++f){var d=r[f],g=this.molecule.atoms.get(d).atomList;this.write("M  ALS"),this.writePaddedNumber(d+1,4),this.writePaddedNumber(g.ids.length,3),this.writeWhiteSpace(),this.write(g.notList?"T":"F");for(var w=g.labelList(),S=0;S<w.length;++S)this.writeWhiteSpace(),this.writePadded(w[S],3);this.writeCR()}var M={},v=1,D={},b=this.molecule.sGroupForest.getSGroupsBFS();util.each(b,function(e){D[v]=e,M[e]=v++},this);for(var N=1;N<v;++N){var P=D[N],A=this.molecule.sgroups.get(P);this.write("M  STY"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(N,3),this.writeWhiteSpace(1),this.writePadded(A.type,3),this.writeCR(),this.write("M  SLB"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(N,3),this.writeWhiteSpace(1),this.writePaddedNumber(N,3),this.writeCR();var T=this.molecule.sGroupForest.parent.get(P);if(T>=0&&(this.write("M  SPL"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(N,3),this.writeWhiteSpace(1),this.writePaddedNumber(M[T],3),this.writeCR()),"SRU"==A.type&&A.data.connectivity){var C="";C+=" ",C+=util.stringPadded(N.toString(),3),C+=" ",C+=util.stringPadded(A.data.connectivity,3,!0),this.write("M  SCN"),this.writePaddedNumber(1,3),this.write(C.toUpperCase()),this.writeCR()}"SRU"==A.type&&(this.write("M  SMT "),this.writePaddedNumber(N,3),this.writeWhiteSpace(),this.write(A.data.subscript||"n"),this.writeCR()),this.writeCR(A.saveToMolfile(this.molecule,M,this.mapping,this.bondMapping))}this.writeCR("M  END")},chem.Molfile.parseRxn=function(e){var t=chem.Molfile,r=e[0].strip().split(" ");return r.length>1&&"V3000"==r[1]?t.parseRxn3000(e):t.parseRxn2000(e)},chem.Molfile.parseRxn2000=function(e){var t=chem.Molfile;e=e.slice(4);var r=t.partitionLine(e[0],t.fmtInfo.rxnItemsPartition),i=r[0]-0,a=r[1]-0,n=r[2]-0;e=e.slice(1);for(var l=[];e.length>0&&"$MOL"==e[0].substr(0,4);){e=e.slice(1);for(var o=0;o<e.length&&"$MOL"!=e[o].substr(0,4);)o++;l.push(chem.Molfile.parseMol(e.slice(0,o))),e=e.slice(o)}return t.rxnMerge(l,i,a,n)},chem.Molfile.parseRxn3000=function(e){var t=chem.Molfile;e=e.slice(4);for(var r=e[0].split(/\s+/g).slice(3),i=r[0]-0,a=r[1]-0,n=r.length>2?r[2]-0:0,l=function(e){util.assert(e,"CTab format invalid")},o=[],s=[],c=null,p=[],h=0;h<e.length;++h){var u=e[h].strip();if(u.startsWith("M  V30 COUNTS"));else{if("M  END"==u)break;if("M  V30 BEGIN PRODUCT"==u)l(null==c),c=s;else if("M  V30 END PRODUCT"==u)l(c===s),c=null;else if("M  V30 BEGIN REACTANT"==u)l(null==c),c=o;else if("M  V30 END REACTANT"==u)l(c===o),c=null;else if(u.startsWith("M  V30 BEGIN RGROUP")){l(null==c);var m=function(t){for(var r=t;r<e.length;++r)if("M  V30 END RGROUP"==e[r].strip())return r;l(!1)}(h);p.push(e.slice(h,m+1)),h=m}else{if("M  V30 BEGIN CTAB"!=u)throw new Error("line unrecognized: "+u);var m=function(t){for(var r=t;r<e.length;++r)if("M  V30 END CTAB"==e[r].strip())return r;l(!1)}(h);c.push(e.slice(h,m+1)),h=m}}}for(var f=[],d=o.concat(s),m=0;m<d.length;++m){var g=chem.Molfile.parseCTabV3000(d[m],r);f.push(g)}var w=t.rxnMerge(f,i,a,n);return t.readRGroups3000(w,function(e){for(var t=[],r=0;r<e.length;++r)t=t.concat(e[r]);return t}(p)),w},chem.Molfile.rxnMerge=function(e,t,r,i){var a,n=(chem.Molfile,new chem.Struct),l=[],o=[],s=[],c=[],p=[],h=[],u={cnt:0,totalLength:0};for(a=0;a<e.length;++a){var m=e[a],f=m.getBondLengthData();u.cnt+=f.cnt,u.totalLength+=f.totalLength}var d=1/(0==u.cnt?1:u.totalLength/u.cnt);for(a=0;a<e.length;++a)m=e[a],m.scale(d);for(a=0;a<e.length;++a){m=e[a];var g=m.getCoordBoundingBoxObj();if(g){var w=a<t?chem.Struct.FRAGMENT.REACTANT:a<t+r?chem.Struct.FRAGMENT.PRODUCT:chem.Struct.FRAGMENT.AGENT;w==chem.Struct.FRAGMENT.REACTANT?(l.push(g),c.push(m)):w==chem.Struct.FRAGMENT.AGENT?(o.push(g),p.push(m)):w==chem.Struct.FRAGMENT.PRODUCT&&(s.push(g),h.push(m)),m.atoms.each(function(e,t){t.rxnFragmentType=w})}}var S=0,M=function(e,t,r,i,a){var n=new Vec2(i-r.min.x,a?1-r.min.y:-(r.min.y+r.max.y)/2);return t.atoms.each(function(e,t){t.pp.add_(n)}),t.sgroups.each(function(e,t){t.pp&&t.pp.add_(n)}),r.min.add_(n),r.max.add_(n),t.mergeInto(e),r.max.x-r.min.x};for(a=0;a<c.length;++a)S+=M(n,c[a],l[a],S,!1)+2;for(S+=2,a=0;a<p.length;++a)S+=M(n,p[a],o[a],S,!0)+2;for(S+=2,a=0;a<h.length;++a)S+=M(n,h[a],s[a],S,!1)+2;var v,D,b,N,P=null,A=null;for(a=0;a<l.length-1;++a)v=l[a],D=l[a+1],b=(v.max.x+D.min.x)/2,N=(v.max.y+v.min.y+D.max.y+D.min.y)/4,n.rxnPluses.add(new chem.Struct.RxnPlus({pp:new Vec2(b,N)}));for(a=0;a<l.length;++a)0==a?(P={},P.max=new Vec2(l[a].max),P.min=new Vec2(l[a].min)):(P.max=Vec2.max(P.max,l[a].max),P.min=Vec2.min(P.min,l[a].min));for(a=0;a<s.length-1;++a)v=s[a],D=s[a+1],b=(v.max.x+D.min.x)/2,N=(v.max.y+v.min.y+D.max.y+D.min.y)/4,n.rxnPluses.add(new chem.Struct.RxnPlus({pp:new Vec2(b,N)}));for(a=0;a<s.length;++a)0==a?(A={},A.max=new Vec2(s[a].max),A.min=new Vec2(s[a].min)):(A.max=Vec2.max(A.max,s[a].max),A.min=Vec2.min(A.min,s[a].min));if(v=P,D=A,v||D){var T=v?new Vec2(v.max.x,(v.max.y+v.min.y)/2):null,C=D?new Vec2(D.min.x,(D.max.y+D.min.y)/2):null;T||(T=new Vec2(C.x-3,C.y)),C||(C=new Vec2(T.x+3,T.y)),n.rxnArrows.add(new chem.Struct.RxnArrow({pp:Vec2.lc2(T,.5,C,.5)}))}else n.rxnArrows.add(new chem.Struct.RxnArrow({pp:new Vec2(0,0)}));return n.isReaction=!0,n},chem.Molfile.rgMerge=function(e,t){var r=new chem.Struct;e.mergeInto(r,null,null,!1,!0);for(var i in t)for(var a=0;a<t[i].length;++a){var n=t[i][a];n.rgroups.set(i,new chem.Struct.RGroup);var l=n.frags.add(new chem.Struct.Fragment);n.rgroups.get(i).frags.add(l),n.atoms.each(function(e,t){t.fragment=l}),n.mergeInto(r)}return r},chem.Molfile.parseRg2000=function(e){var t=chem.Molfile;if(e=e.slice(7),"$CTAB"!=e[0].strip())throw new Error("RGFile format invalid");for(var r=1;"$"!=e[r].charAt(0);)r++;if("$END CTAB"!=e[r].strip())throw new Error("RGFile format invalid");var i=e.slice(1,r);e=e.slice(r+1);for(var a={};;){if(0==e.length)throw new Error("Unexpected end of file");var n=e[0].strip();if("$END MOL"==n){e=e.slice(1);break}if("$RGP"!=n)throw new Error("RGFile format invalid");var l=e[1].strip()-0;for(a[l]=[],e=e.slice(2);;){if(0==e.length)throw new Error("Unexpected end of file");if("$END RGP"==(n=e[0].strip())){e=e.slice(1);break}if("$CTAB"!=n)throw new Error("RGFile format invalid");for(r=1;"$"!=e[r].charAt(0);)r++;if("$END CTAB"!=e[r].strip())throw new Error("RGFile format invalid");a[l].push(e.slice(1,r)),e=e.slice(r+1)}}var o=chem.Molfile.parseCTab(i),s={};if(chem.Molfile.loadRGroupFragments)for(var c in a){s[c]=[];for(var p=0;p<a[c].length;++p)s[c].push(chem.Molfile.parseCTab(a[c][p]))}return t.rgMerge(o,s)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/map":40,"../util/set":42,"../util/vec2":43,"./element":10}],13:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Map=require("../util/map"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util");require("./element"),require("../rnd/restruct_rendering");var chem=global.chem=global.chem||{},rnd=global.rnd;chem.SGroup=function(t){if(!(t&&t in chem.SGroup.TYPES))throw new Error("Invalid or unsupported s-group type");this.type=t,this.id=-1,chem.SGroup.equip(this,t),this.label=-1,this.bracketBox=null,this.bracketDir=new Vec2(1,0),this.areas=[],this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null,this.atoms=[],this.patoms=[],this.bonds=[],this.xBonds=[],this.neiAtoms=[],this.pp=null,this.data={mul:1,connectivity:"ht",name:"",subscript:"n",attached:!1,absolute:!0,showUnits:!1,nCharsToDisplay:-1,tagChar:"",daspPos:1,fieldType:"F",fieldName:"",fieldValue:"",units:"",query:"",queryOp:""}},chem.SGroup.prototype.getAttr=function(t){return this.data[t]},chem.SGroup.prototype.getAttrs=function(){var t={};for(var e in this.data)t[e]=this.data[e];return t},chem.SGroup.prototype.setAttr=function(t,e){var s=this.data[t];return this.data[t]=e,s},chem.SGroup.prototype.checkAttr=function(t,e){return this.data[t]==e},chem.SGroup.equip=function(t,e){var s=chem.SGroup.TYPES[e];for(var r in s)t[r]=s[r]},chem.SGroup.numberArrayToString=function(t,e){for(var s=util.stringPadded(t.length,3),r=0;r<t.length;++r)s+=" "+util.stringPadded(e[t[r]],3);return s},chem.SGroup.addGroup=function(t,e,s){e.id=t.sgroups.add(e),e.postLoad(t,s);for(var r=0;r<e.atoms.length;++r)t.atoms.has(e.atoms[r])&&Set.add(t.atoms.get(e.atoms[r]).sgs,e.id);return t.sGroupForest.insert(e.id),e.id},chem.SGroup.bracketsToMolfile=function(t,e,s){var r=[],o=[],i=Set.fromList(e.atoms);chem.SGroup.getCrossBonds(r,o,t,i),chem.SGroup.bracketPos(e,null,t,o);for(var n=e.bracketBox,a=e.bracketDir,h=a.rotateSC(1,0),u=chem.SGroup.getBracketParameters(t,o,i,n,a,h,null,e.id),c=[],d=0;d<u.length;++d){for(var l=u[d],p=l.c.addScaled(l.n,-.5*l.h).yComplement(),m=l.c.addScaled(l.n,.5*l.h).yComplement(),g="M  SDI "+s+util.paddedInt(4,3),f=[p.x,p.y,m.x,m.y],S=0;S<f.length;++S)g+=util.paddedFloat(f[S],10,4);c.push(g)}return c},chem.SGroup.filterAtoms=function(t,e){for(var s=[],r=0;r<t.length;++r){var o=t[r];"number"!=typeof e[o]?s.push(o):e[o]>=0?s.push(e[o]):s.push(-1)}return s},chem.SGroup.removeNegative=function(t){for(var e=[],s=0;s<t.length;++s)t[s]>=0&&e.push(t[s]);return e},chem.SGroup.filter=function(t,e,s){e.atoms=chem.SGroup.removeNegative(chem.SGroup.filterAtoms(e.atoms,s))},chem.SGroup.clone=function(t,e,s){var r=new chem.SGroup(t.type);for(var o in t.data)r.data[o]=t.data[o];return r.atoms=util.mapArray(t.atoms,e),r.pp=t.pp,r.bracketBox=t.bracketBox,r.patoms=null,r.bonds=null,r.allAtoms=t.allAtoms,r},chem.SGroup.addAtom=function(t,e){t.atoms.push(e)},chem.SGroup.removeAtom=function(t,e){for(var s=0;s<t.atoms.length;++s)if(t.atoms[s]===e)return void t.atoms.splice(s,1);throw new Error("The atom is not found in the given s-group")},chem.SGroup.getCrossBonds=function(t,e,s,r){s.bonds.each(function(s,o){Set.contains(r,o.begin)&&Set.contains(r,o.end)?util.isNull(t)||t.push(s):(Set.contains(r,o.begin)||Set.contains(r,o.end))&&(util.isNull(e)||e.push(s))},this)},chem.SGroup.bracketPos=function(t,e,s,r){var o=t.atoms;if(r&&2===r.length){var i=s.bonds.get(r[0]),n=s.bonds.get(r[1]),a=i.getCenter(s),h=n.getCenter(s);t.bracketDir=Vec2.diff(h,a).normalized()}else t.bracketDir=new Vec2(1,0);var u=t.bracketDir,c=u.rotateSC(1,0),d=null,l=[];util.each(o,function(t){var r=s.atoms.get(t),o=e?e.ctab.atoms.get(t).visel.boundingBox:null,i=new Vec2(r.pp);if(util.isNull(o)){o=new Box2Abs(i,i);var n=new Vec2(.05*3,.05*3);o=o.extend(n,n)}else o=o.translate((e.offset||new Vec2).negated()).transform(e.scaled2obj,e);l.push(o)},this),util.each(s.sGroupForest.children.get(t.id),function(t){var s=e?e.ctab.sgroups.get(t).visel.boundingBox:null;util.isNull(s)||(s=s.translate((e.offset||new Vec2).negated()).transform(e.scaled2obj,e),l.push(s))},this),util.each(l,function(t){var e=null;util.each([t.p0.x,t.p1.x],function(s){util.each([t.p0.y,t.p1.y],function(t){var r=new Vec2(s,t),o=new Vec2(Vec2.dot(r,u),Vec2.dot(r,c));e=util.isNull(e)?new Box2Abs(o,o):e.include(o)},this)},this),d=util.isNull(d)?e:Box2Abs.union(d,e)},this);var p=new Vec2(.2,.4);util.isNull(d)||(d=d.extend(p,p)),t.bracketBox=d},chem.SGroup.drawBrackets=function(t,e,s,r,o,i,n,a,h,u,c){for(var d=chem.SGroup.getBracketParameters(e.ctab.molecule,r,o,i,n,a,e,s.id),l=-1,p=0;p<d.length;++p){var m=d[p],g=chem.SGroup.drawBracket(e,e.paper,e.styles,m.d,m.n,m.c,m.w,m.h);t.push(g),(l<0||d[l].d.x<m.d.x||d[l].d.x==m.d.x&&d[l].d.y>m.d.y)&&(l=p)}var f=d[l],S=function(s,r){var o=e.ps(f.c.addScaled(f.n,r*f.h)),i=e.paper.text(o.x,o.y,s).attr({font:e.settings.font,"font-size":e.settings.fontszsub});c&&i.attr(c);var n=Box2Abs.fromRelBox(rnd.relBox(i.getBBox())),a=Math.max(Vec2.shiftRayBox(o,f.d.negated(),n),3)+2;i.translateAbs(a*f.d.x,a*f.d.y),t.push(i)};h&&S(h,.5),u&&S(u,-.5)},chem.SGroup.drawBracket=function(t,e,s,r,o,i,n,a){n=n||.25,a=a||1;var h=i.addScaled(o,-.5*a),u=i.addScaled(o,.5*a),c=h.addScaled(r,-n),d=u.addScaled(r,-n);return h=t.obj2scaled(h),u=t.obj2scaled(u),c=t.obj2scaled(c),d=t.obj2scaled(d),e.path("M {0}, {1} L {2} , {3} L {4} , {5} L {6} , {7}",c.x,c.y,h.x,h.y,u.x,u.y,d.x,d.y).attr(s.sgroupBracketStyle)},chem.SGroup.getBracketParameters=function(t,e,s,r,o,i,n,a){var h=function(t,e,s,r){this.c=t,this.d=e,this.n=e.rotateSC(1,0),this.w=s,this.h=r},u=[];return e.length<2?function(){o=o||new Vec2(1,0),i=i||o.rotateSC(1,0);var t=Math.min(.25,.3*r.sz().x),e=Vec2.lc2(o,r.p0.x,i,.5*(r.p0.y+r.p1.y)),s=Vec2.lc2(o,r.p1.x,i,.5*(r.p0.y+r.p1.y)),n=r.sz().y;u.push(new h(e,o.negated(),t,n),new h(s,o,t,n))}():2===e.length?function(){var s=t.bonds.get(e[0]),r=t.bonds.get(e[1]),o=s.getCenter(t),i=r.getCenter(t),c=-1,d=-1,l=-1,p=-1,m=Vec2.centre(o,i),g=Vec2.diff(i,o).normalized(),f=g.negated(),S=g.rotateSC(1,0),v=S.negated();util.each(t.sGroupForest.children.get(a),function(t){var e=n?n.ctab.sgroups.get(t).visel.boundingBox:null;util.isNull(e)||(e=e.translate((n.offset||new Vec2).negated()).transform(n.scaled2obj,n),c=Math.max(c,Vec2.shiftRayBox(o,f,e)),d=Math.max(d,Vec2.shiftRayBox(i,g,e)),l=Math.max(l,Vec2.shiftRayBox(m,S,e)),p=Math.max(p,Vec2.shiftRayBox(m,v,e)))},this),c=Math.max(c+.2,0),d=Math.max(d+.2,0),l=Math.max(Math.max(l,p)+.1,0);var b=1.5+l;u.push(new h(o.addScaled(f,c),f,.25,b),new h(i.addScaled(g,d),g,.25,b))}():function(){for(var r=0;r<e.length;++r){var o=t.bonds.get(e[r]),i=o.getCenter(t),n=Set.contains(s,o.begin)?o.getDir(t):o.getDir(t).negated();u.push(new h(i,n,.2,1))}}(),u},chem.SGroup.getObjBBox=function(t,e){if(0==t.length)throw new Error("Atom list is empty");for(var s=e.atoms.get(t[0]).pp,r=new Box2Abs(s,s),o=1;o<t.length;++o){var i=t[o],n=e.atoms.get(i),a=n.pp;r=r.include(a)}return r},chem.SGroup.makeAtomBondLines=function(t,e,s,r){if(!s)return[];for(var o=[],i=0;i<Math.floor((s.length+14)/15);++i){for(var n=Math.min(s.length-15*i,15),a="M  "+t+" "+e+" "+util.paddedInt(n,2),h=0;h<n;++h)a+=" "+util.paddedInt(r[s[15*i+h]],3);o.push(a)}return o},chem.SGroup.getAtoms=function(t,e){if(!e.allAtoms)return e.atoms;var s=[];return t.atoms.each(function(t){s.push(t)}),s},chem.SGroup.getBonds=function(t,e){var s=chem.SGroup.getAtoms(t,e),r=[];return t.bonds.each(function(t,e){s.indexOf(e.begin)>=0&&s.indexOf(e.end)>=0&&r.push(t)}),r},chem.SGroup.GroupMul={draw:function(t){var e=t.render,s=e.paper.set(),r=[],o=[],i=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(r,o,t.molecule,i),chem.SGroup.bracketPos(this,e,t.molecule,o);var n=this.bracketBox,a=this.bracketDir,h=a.rotateSC(1,0);return this.areas=[n],chem.SGroup.drawBrackets(s,e,this,o,i,n,a,h,this.data.mul),s},saveToMolfile:function(t,e,s,r){var o=util.stringPadded(e[this.id],3),i=[];i=i.concat(chem.SGroup.makeAtomBondLines("SAL",o,util.idList(this.atomSet),s)),i=i.concat(chem.SGroup.makeAtomBondLines("SPA",o,util.idList(this.parentAtomSet),s)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",o,this.bonds,r));var n="M  SMT "+o+" "+this.data.mul;return i.push(n),i=i.concat(chem.SGroup.bracketsToMolfile(t,this,o)),i.join("\n")},prepareForSaving:function(t){var e;this.atoms.sort(),this.atomSet=Set.fromList(this.atoms),this.parentAtomSet=Set.clone(this.atomSet);var s=[],r=[];if(t.bonds.each(function(t,e){Set.contains(this.parentAtomSet,e.begin)&&Set.contains(this.parentAtomSet,e.end)?s.push(t):(Set.contains(this.parentAtomSet,e.begin)||Set.contains(this.parentAtomSet,e.end))&&r.push(t)},this),0!=r.length&&2!=r.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};var o=-1,i=-1,n=null;if(2==r.length){var a=t.bonds.get(r[0]);o=Set.contains(this.parentAtomSet,a.begin)?a.begin:a.end;var h=t.bonds.get(r[1]);i=Set.contains(this.parentAtomSet,h.begin)?h.begin:h.end,n=h}var u=null,c=o,d=[];for(e=0;e<this.data.mul-1;++e)if(u={},util.each(this.atoms,function(e){var s=t.atoms.get(e),r=t.atoms.add(new chem.Struct.Atom(s));d.push(r),this.atomSet[r]=1,u[e]=r},this),util.each(s,function(e){var s=t.bonds.get(e),r=new chem.Struct.Bond(s);r.begin=u[r.begin],r.end=u[r.end],t.bonds.add(r)},this),null!=n){var l=new chem.Struct.Bond(n);l.begin=c,l.end=u[i],t.bonds.add(l),c=u[o]}if(util.each(d,function(e){util.each(t.sGroupForest.getPathToRoot(this.id).reverse(),function(s){t.atomAddToSGroup(s,e)},this)},this),c>=0){var p=t.bonds.get(r[0]);p.begin==o?p.begin=c:p.end=c}this.bonds=r},postLoad:function(t,e){this.data.mul=this.data.subscript-0;var s={};this.atoms=chem.SGroup.filterAtoms(this.atoms,e),this.patoms=chem.SGroup.filterAtoms(this.patoms,e);for(var r=1;r<this.data.mul;++r)for(var o=0;o<this.patoms.length;++o){var i=this.atoms[r*this.patoms.length+o];if(!(i<0)){if(this.patoms[o]<0)throw new Error("parent atom missing");s[i]=this.patoms[o]}}this.patoms=chem.SGroup.removeNegative(this.patoms);var n=util.identityMap(this.patoms),a=[];t.bonds.each(function(t,e){var r=e.begin in s,o=e.end in s;r&&o||r&&e.end in n||o&&e.begin in n?a.push(t):r?e.begin=s[e.begin]:o&&(e.end=s[e.end])},this);for(var h=0;h<a.length;++h)t.bonds.remove(a[h]);for(var u in s)t.atoms.remove(u),e[u]=-1;this.atoms=this.patoms,this.patoms=null}},chem.SGroup.GroupSru={draw:function(t){var e=t.render,s=e.paper.set(),r=[],o=[],i=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(r,o,t.molecule,i),chem.SGroup.bracketPos(this,e,t.molecule,o);var n=this.bracketBox,a=this.bracketDir,h=a.rotateSC(1,0);this.areas=[n];var u=this.data.connectivity||"eu";"ht"==u&&(u="");var c=this.data.subscript||"n";return chem.SGroup.drawBrackets(s,e,this,o,i,n,a,h,c,u),s},saveToMolfile:function(t,e,s,r){var o=util.stringPadded(e[this.id],3),i=[];return i=i.concat(chem.SGroup.makeAtomBondLines("SAL",o,this.atoms,s)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",o,this.bonds,r)),i=i.concat(chem.SGroup.bracketsToMolfile(t,this,o)),i.join("\n")},prepareForSaving:function(t){var e=[];if(t.bonds.each(function(s,r){var o=t.atoms.get(r.begin),i=t.atoms.get(r.end);(Set.contains(o.sgs,this.id)&&!Set.contains(i.sgs,this.id)||Set.contains(i.sgs,this.id)&&!Set.contains(o.sgs,this.id))&&e.push(s)},this),0!=e.length&&2!=e.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};this.bonds=e},postLoad:function(t,e){this.data.connectivity=(this.data.connectivity||"EU").strip().toLowerCase()}},chem.SGroup.GroupSup={draw:function(t){var e=t.render,s=e.paper.set(),r=[],o=[],i=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(r,o,t.molecule,i),chem.SGroup.bracketPos(this,e,t.molecule,o);var n=this.bracketBox,a=this.bracketDir,h=a.rotateSC(1,0);return this.areas=[n],chem.SGroup.drawBrackets(s,e,this,o,i,n,a,h,this.data.name,null,{"font-style":"italic"}),s},saveToMolfile:function(t,e,s,r){var o=util.stringPadded(e[this.id],3),i=[];return i=i.concat(chem.SGroup.makeAtomBondLines("SAL",o,this.atoms,s)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",o,this.bonds,r)),this.data.name&&""!=this.data.name&&i.push("M  SMT "+o+" "+this.data.name),i.join("\n")},prepareForSaving:function(t){var e=[];t.bonds.each(function(s,r){var o=t.atoms.get(r.begin),i=t.atoms.get(r.end);(Set.contains(o.sgs,this.id)&&!Set.contains(i.sgs,this.id)||Set.contains(i.sgs,this.id)&&!Set.contains(o.sgs,this.id))&&e.push(s)},this),this.bonds=e},postLoad:function(t,e){this.data.name=(this.data.subscript||"").strip(),this.data.subscript=""}},chem.SGroup.GroupGen={draw:function(t){var e=t.render,s=(e.settings,e.styles,e.paper),r=s.set(),o=[],i=[],n=Set.fromList(this.atoms);chem.SGroup.getCrossBonds(o,i,t.molecule,n),chem.SGroup.bracketPos(this,e,t.molecule,i);var a=this.bracketBox,h=this.bracketDir,u=h.rotateSC(1,0);return this.areas=[a],chem.SGroup.drawBrackets(r,e,this,i,n,a,h,u),r},saveToMolfile:function(t,e,s,r){var o=util.stringPadded(e[this.id],3),i=[];return i=i.concat(chem.SGroup.makeAtomBondLines("SAL",o,this.atoms,s)),i=i.concat(chem.SGroup.makeAtomBondLines("SBL",o,this.bonds,r)),i=i.concat(chem.SGroup.bracketsToMolfile(t,this,o)),i.join("\n")},prepareForSaving:function(t){},postLoad:function(t,e){}},chem.SGroup.getMassCentre=function(t,e){for(var s=new Vec2,r=0;r<e.length;++r)s=s.addScaled(t.atoms.get(e[r]).pp,1/e.length);return s},chem.SGroup.setPos=function(t,e,s){e.pp=s},chem.SGroup.GroupDat={showValue:function(t,e,s,r){var o=t.text(e.x,e.y,s.data.fieldValue).attr({font:r.font,"font-size":r.fontsz}),i=o.getBBox(),n=t.rect(i.x-1,i.y-1,i.width+2,i.height+2,3,3).attr({fill:"#fff",stroke:"#fff"}),a=t.set();return a.push(n,o.toFront()),a},draw:function(t){var e,s=t.render,r=s.settings,o=s.paper,i=o.set(),n=chem.SGroup.getAtoms(t,this);chem.SGroup.bracketPos(this,s,t.molecule),this.areas=this.bracketBox?[this.bracketBox]:[],null==this.pp&&chem.SGroup.setPos(t,this,this.bracketBox.p1.add(new Vec2(.5,.5)));var a=this.pp.scaled(r.scaleFactor);if(this.data.attached)for(e=0;e<n.length;++e){var h=t.atoms.get(n[e]),u=s.ps(h.a.pp),c=h.visel.boundingBox;null!=c&&(u.x=Math.max(u.x,c.p1.x)),u.x+=r.lineWidth;var d=this.showValue(o,u,this,r),l=rnd.relBox(d.getBBox());d.translateAbs(.5*l.width,-.3*l.height),i.push(d);var p=Box2Abs.fromRelBox(rnd.relBox(d.getBBox()));p=p.transform(s.scaled2obj,s),this.areas.push(p)}else{var m=this.showValue(o,a,this,r),g=rnd.relBox(m.getBBox());m.translateAbs(.5*g.width,-.5*g.height),i.push(m);var f=Box2Abs.fromRelBox(rnd.relBox(m.getBBox()));this.dataArea=f.transform(s.scaled2obj,s),t.sgroupData.has(this.id)||t.sgroupData.set(this.id,new rnd.ReDataSGroupData(this))}return i},saveToMolfile:function(t,e,s,r){var o=util.stringPadded(e[this.id],3),i=this.data,n=this.pp;i.absolute||(n=n.sub(chem.SGroup.getMassCentre(t,this.atoms)));var a=[];a=a.concat(chem.SGroup.makeAtomBondLines("SAL",o,this.atoms,s));var h="M  SDT "+o+" "+util.stringPadded(i.fieldName,30,!0)+util.stringPadded(i.fieldType,2)+util.stringPadded(i.units,20,!0)+util.stringPadded(i.query,2)+util.stringPadded(i.queryOp,3);a.push(h);var u="M  SDD "+o+" "+util.paddedFloat(n.x,10,4)+util.paddedFloat(-n.y,10,4)+"    "+(i.attached?"A":"D")+(i.absolute?"A":"R")+(i.showUnits?"U":" ")+"   "+(i.nCharnCharsToDisplay>=0?util.paddedInt(i.nCharnCharsToDisplay,3):"ALL")+"  1   "+util.stringPadded(i.tagChar,1)+"  "+util.paddedInt(i.daspPos,1)+"  ";a.push(u);var c=util.normalizeNewlines(i.fieldValue).replace(/\n*$/,"");return c.split("\n").each(function(t){for(;t.length>69;)a.push("M  SCD "+o+" "+t.slice(0,69)),t=t.slice(69);a.push("M  SED "+o+" "+t)}),a.join("\n")},prepareForSaving:function(t){this.atoms=chem.SGroup.getAtoms(t,this)},postLoad:function(t,e){this.data.absolute||(this.pp=this.pp.add(chem.SGroup.getMassCentre(t,this.atoms)))}},chem.SGroup.TYPES={MUL:chem.SGroup.GroupMul,SRU:chem.SGroup.GroupSru,SUP:chem.SGroup.GroupSup,DAT:chem.SGroup.GroupDat,GEN:chem.SGroup.GroupGen},chem.SGroupForest=function(t){this.parent=new Map,this.children=new Map,this.children.set(-1,[]),this.molecule=t},chem.SGroupForest.prototype.getSGroupsBFS=function(){var t=[],e=[],s=-1;for(e=util.array(this.children.get(-1));e.length>0;){var s=e.shift();e=e.concat(this.children.get(s)),t.push(s)}return t},chem.SGroupForest.prototype.getAtomSets=function(){return this.molecule.sgroups.map(function(t,e){return Set.fromList(e.atoms)})},chem.SGroupForest.prototype.getAtomSetRelations=function(t,e,s){var r=new Map,o=new Map,s=this.getAtomSets();s.unset(t),s.each(function(t,s){o.set(t,Set.subset(e,s)),r.set(t,Set.subset(s,e)&&!Set.eq(s,e))},this);var i=s.findAll(function(t){return!!o.get(t)&&!(util.findIndex(this.children.get(t),function(t){return o.get(t)},this)>=0)},this);return util.assert(i.length<=1),{children:s.findAll(function(t,e){return r.get(t)&&!r.get(this.parent.get(t))},this),parent:0===i.length?-1:i[0]}},chem.SGroupForest.prototype.getPathToRoot=function(t){for(var e=[],s=t;s>=0;s=this.parent.get(s))util.assert(e.indexOf(s)<0,"SGroupForest: loop detected"),e.push(s);return e},chem.SGroupForest.prototype.validate=function(){var t=this.getAtomSets();this.molecule.sgroups.each(function(t){this.getPathToRoot(t)},this);var e=!0;return this.parent.each(function(s,r){r>=0&&!Set.subset(t.get(s),t.get(r))&&(e=!1)},this),this.children.each(function(s){for(var r=this.children.get(s),o=0;o<r.length;++o)for(var i=o+1;i<r.length;++i)Set.disjoint(t.get(r[o]),t.get(r[i]))||(e=!1)},this),e},chem.SGroupForest.prototype.insert=function(t,e,s){util.assert(!this.parent.has(t),"sgid already present in the forest"),util.assert(!this.children.has(t),"sgid already present in the forest"),util.assert(this.validate(),"s-group forest invalid");var r=this.getAtomSets(),o=Set.fromList(this.molecule.sgroups.get(t).atoms);if(util.isUndefined(e)||util.isUndefined(s)){var i=this.getAtomSetRelations(t,o,r);e=i.parent,s=i.children}return util.each(s,function(e){util.assert(1===util.arrayRemoveByValue(this.children.get(this.parent.get(e)),e)),this.parent.set(e,t)},this),this.children.set(t,s),this.parent.set(t,e),this.children.get(e).push(t),util.assert(this.validate(),"s-group forest invalid"),{parent:e,children:s}},chem.SGroupForest.prototype.remove=function(t){util.assert(this.parent.has(t),"sgid is not in the forest"),util.assert(this.children.has(t),"sgid is not in the forest"),util.assert(this.validate(),"s-group forest invalid");var e=this.parent.get(t);util.each(this.children.get(t),function(t){this.parent.set(t,e),this.children.get(e).push(t)},this),util.assert(1===util.arrayRemoveByValue(this.children.get(e),t)),this.children.unset(t),this.parent.unset(t),util.assert(this.validate(),"s-group forest invalid")};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../rnd/restruct_rendering":24,"../util":39,"../util/box2abs":38,"../util/map":40,"../util/set":42,"../util/vec2":43,"./element":10}],14:[function(require,module,exports){
(function (global){
var Set=require("../util/set");require("./struct");var util=require("../util"),chem=global.chem=global.chem||{};chem.SmilesSaver=function(){this.smiles="",this._written_atoms=[],this._written_components=0,this.ignore_errors=!1},chem.SmilesSaver._Atom=function(t){this.neighbours=[],this.aromatic=!1,this.lowercase=!1,this.chirality=0,this.branch_cnt=0,this.paren_written=!1,this.h_count=t,this.parent=-1},chem.SmilesSaver.prototype.isBondInRing=function(t){if(util.isUndefined(this.inLoop)||util.isNull(this.inLoop))throw new Error("Init this.inLoop prior to calling this method");return this.inLoop[t]},chem.SmilesSaver.prototype.saveMolecule=function(t,e){var s,i,n;Object.isUndefined(e)||(this.ignore_errors=e),t=t.clone(),t.initHalfBonds(),t.initNeighbors(),t.sortNeighbors(),t.setImplicitHydrogen(),t.sgroups.each(function(e,s){if("MUL"==s.type)try{s.prepareForSaving(t)}catch(t){throw{message:"Bad s-group ("+t.message+")"}}else if(!this.ignore_errors)throw new Error("SMILES data format doesn't support s-groups")},this),this.atoms=new Array(t.atoms.count()),t.atoms.each(function(t,e){this.atoms[t]=new chem.SmilesSaver._Atom(e.implicitH)},this);var o=["B","C","N","O","P","S","Se","As"];t.bonds.each(function(e,s){s.type==chem.Struct.BOND.TYPE.AROMATIC&&(this.atoms[s.begin].aromatic=!0,-1!=o.indexOf(t.atoms.get(s.begin).label)&&(this.atoms[s.begin].lowercase=!0),this.atoms[s.end].aromatic=!0,-1!=o.indexOf(t.atoms.get(s.end).label)&&(this.atoms[s.end].lowercase=!0)),this.atoms[s.begin].neighbours.push({aid:s.end,bid:e}),this.atoms[s.end].neighbours.push({aid:s.begin,bid:e})},this),this.inLoop=function(){t.prepareLoopStructure();var e=Set.empty();t.loops.each(function(s,i){i.hbs.length<=6&&Set.mergeIn(e,Set.fromList(util.map(i.hbs,function(e){return t.halfBonds.get(e).bid},this)))},this);var s={};return Set.each(e,function(t){s[t]=1},this),s}(),this._touched_cistransbonds=0,this._markCisTrans(t);var r=chem.MolfileSaver.getComponents(t),a=r.reactants.concat(r.products),h=new chem.Dfs(t,this.atoms,a,r.reactants.length);for(h.walk(),this.atoms.each(function(t){t.neighbours.clear()},this),s=0;s<h.v_seq.length;s++){var d=h.v_seq[s],c=d.idx,b=d.parent_edge,m=d.parent_vertex;if(b>=0){var l=this.atoms[c],g=h.numOpeningCycles(b);for(i=0;i<g;i++)this.atoms[m].neighbours.push({aid:-1,bid:-1});if(h.edgeClosingCycle(b)){for(n=0;n<l.neighbours.length;n++)if(-1==l.neighbours[n].aid){l.neighbours[n].aid=m,l.neighbours[n].bid=b;break}if(n==l.neighbours.length)throw new Error("internal: can not put closing bond to its place")}else l.neighbours.push({aid:m,bid:b}),l.parent=m;this.atoms[m].neighbours.push({aid:c,bid:b})}}try{var u=new chem.Stereocenters(t,function(t){return this.atoms[t].neighbours},this);u.buildFromBonds(this.ignore_errors),u.each(function(t,e){var s=-1;-1==e.pyramid[3]&&(s=3);var o=new Array(4),r=0,a=this.atoms[t];if(-1!=a.parent)for(n=0;n<4;n++)if(e.pyramid[n]==a.parent){o[r++]=n;break}for(-1!=s&&(o[r++]=s),i=0;i!=a.neighbours.length;i++)if(a.neighbours[i].aid!=a.parent)for(n=0;n<4;n++)if(a.neighbours[i].aid==e.pyramid[n]){if(r>=4)throw new Error("internal: pyramid overflow");o[r++]=n;break}if(4==r)r=o[0],o[0]=o[1],o[1]=o[2],o[2]=o[3],o[3]=r;else if(3!=r)throw new Error("cannot calculate chirality");chem.Stereocenters.isPyramidMappingRigid(o)?this.atoms[t].chirality=1:this.atoms[t].chirality=2},this)}catch(t){alert("Warning: "+t.message)}var _=[];_.push(0);var p=!0;for(s=0;s<h.v_seq.length;s++){d=h.v_seq[s],c=d.idx,b=d.parent_edge,m=d.parent_vertex;var f=!0;if(m>=0){for(h.numBranches(m)>1&&this.atoms[m].branch_cnt>0&&this.atoms[m].paren_written&&(this.smiles+=")"),g=h.numOpeningCycles(b),i=0;i<g;i++){for(n=1;n<_.length&&-1!=_[n];n++);n==_.length?_.push(m):_[n]=m,this._writeCycleNumber(n)}if(m>=0){var v=h.numBranches(m);if(v>1&&this.atoms[m].branch_cnt<v-1&&(h.edgeClosingCycle(b)?this.atoms[m].paren_written=!1:(this.smiles+="(",this.atoms[m].paren_written=!0)),++this.atoms[m].branch_cnt>v)throw new Error("unexpected branch")}var S=t.bonds.get(b),w=0;if(S.type==chem.Struct.BOND.TYPE.SINGLE&&(w=this._calcBondDirection(t,b,m)),1==w&&c==S.end||2==w&&c==S.begin?this.smiles+="/":2==w&&c==S.end||1==w&&c==S.begin?this.smiles+="\\":S.type==chem.Struct.BOND.TYPE.ANY?this.smiles+="~":S.type==chem.Struct.BOND.TYPE.DOUBLE?this.smiles+="=":S.type==chem.Struct.BOND.TYPE.TRIPLE?this.smiles+="#":S.type!=chem.Struct.BOND.TYPE.AROMATIC||this.atoms[S.begin].lowercase&&this.atoms[S.end].lowercase&&this.isBondInRing(b)?S.type==chem.Struct.BOND.TYPE.SINGLE&&this.atoms[S.begin].aromatic&&this.atoms[S.end].aromatic?this.smiles+="-":!1:this.smiles+=":",h.edgeClosingCycle(b)){for(i=1;i<_.length&&_[i]!=c;i++);if(i==_.length)throw new Error("cycle number not found");this._writeCycleNumber(i),_[i]=-1,f=!1}}else p||(this.smiles+=this._written_components==h.nComponentsInReactants?">>":"."),p=!1,this._written_components++;f&&(this._writeAtom(t,c,this.atoms[c].aromatic,this.atoms[c].lowercase,this.atoms[c].chirality),this._written_atoms.push(d.idx))}return this.comma=!1,this._writeRadicals(t),this.comma&&(this.smiles+="|"),this.smiles},chem.SmilesSaver.prototype._writeCycleNumber=function(t){if(t>0&&t<10)this.smiles+=t;else if(t>=10&&t<100)this.smiles+="%"+t;else{if(!(t>=100&&t<1e3))throw new Error("bad cycle number: "+t);this.smiles+="%%"+t}},chem.SmilesSaver.prototype._writeAtom=function(t,e,s,i,n){var o=t.atoms.get(e),r=!1,a=-1,h=0;if("A"==o.label)return void(this.smiles+="*");if("R"==o.label||"R#"==o.label)return void(this.smiles+="[*]");h=o.aam,"C"!=o.label&&"P"!=o.label&&"N"!=o.label&&"S"!=o.label&&"O"!=o.label&&"Cl"!=o.label&&"F"!=o.label&&"Br"!=o.label&&"B"!=o.label&&"I"!=o.label&&(r=!0),(o.explicitValence>=0||0!=o.radical||n>0||s&&"C"!=o.label&&"O"!=o.label||s&&"C"==o.label&&this.atoms[e].neighbours.length<3&&0==this.atoms[e].h_count)&&(a=this.atoms[e].h_count);var d=o.label;if(o.atomList&&!o.atomList.notList?(d=o.atomList.label(),r=!1):o.isPseudo()||o.atomList&&o.atomList.notList?(d="*",r=!0):(n||0!=o.charge||o.isotope>0||a>=0||h>0)&&(r=!0),r&&(-1==a&&(a=this.atoms[e].h_count),this.smiles+="["),o.isotope>0&&(this.smiles+=o.isotope),this.smiles+=i?d.toLowerCase():d,n>0&&(this.smiles+=1==n?"@":"@@",o.implicitH>1))throw new Error(o.implicitH+" implicit H near stereocenter");"H"!=o.label&&(a>1||0==a&&!r?this.smiles+="H"+a:1==a&&(this.smiles+="H")),o.charge>1?this.smiles+="+"+o.charge:o.charge<-1?this.smiles+=o.charge:1==o.charge?this.smiles+="+":-1==o.charge&&(this.smiles+="-"),h>0&&(this.smiles+=":"+h),r&&(this.smiles+="]")},chem.SmilesSaver.prototype._markCisTrans=function(t){this.cis_trans=new chem.CisTrans(t,function(t){return this.atoms[t].neighbours},this),this.cis_trans.build(),this._dbonds=new Array(t.bonds.count()),t.bonds.each(function(t){this._dbonds[t]={ctbond_beg:-1,ctbond_end:-1,saved:0}},this),this.cis_trans.each(function(e,s){var i=t.bonds.get(e);if(0!=s.parity&&!this.isBondInRing(e)){var n=this.atoms[i.begin].neighbours,o=this.atoms[i.end].neighbours,r=!0,a=!0;if(n.each(function(s){s.bid!=e&&t.bonds.get(s.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(r=!1)},this),o.each(function(s){s.bid!=e&&t.bonds.get(s.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(a=!1)},this),r||a)return;n.each(function(s){s.bid!=e&&(t.bonds.get(s.bid).begin==i.begin?this._dbonds[s.bid].ctbond_beg=e:this._dbonds[s.bid].ctbond_end=e)},this),o.each(function(s){s.bid!=e&&(t.bonds.get(s.bid).begin==i.end?this._dbonds[s.bid].ctbond_beg=e:this._dbonds[s.bid].ctbond_end=e)},this)}},this)},chem.SmilesSaver.prototype._updateSideBonds=function(t,e){var s=t.bonds.get(e),i=this.cis_trans.getSubstituents(e),n=this.cis_trans.getParity(e),o=[-1,-1,-1,-1];o[0]=t.findBondId(i[0],s.begin),-1!=i[1]&&(o[1]=t.findBondId(i[1],s.begin)),o[2]=t.findBondId(i[2],s.end),-1!=i[3]&&(o[3]=t.findBondId(i[3],s.end));var r=0,a=0,h=0,d=0;if(0!=this._dbonds[o[0]].saved&&(1==this._dbonds[o[0]].saved&&t.bonds.get(o[0]).begin==s.begin||2==this._dbonds[o[0]].saved&&t.bonds.get(o[0]).end==s.begin?r++:a++),-1!=o[1]&&0!=this._dbonds[o[1]].saved&&(2==this._dbonds[o[1]].saved&&t.bonds.get(o[1]).begin==s.begin||1==this._dbonds[o[1]].saved&&t.bonds.get(o[1]).end==s.begin?r++:a++),0!=this._dbonds[o[2]].saved&&(1==this._dbonds[o[2]].saved&&t.bonds.get(o[2]).begin==s.end||2==this._dbonds[o[2]].saved&&t.bonds.get(o[2]).end==s.end?h++:d++),-1!=o[3]&&0!=this._dbonds[o[3]].saved&&(2==this._dbonds[o[3]].saved&&t.bonds.get(o[3]).begin==s.end||1==this._dbonds[o[3]].saved&&t.bonds.get(o[3]).end==s.end?h++:d++),n==chem.CisTrans.PARITY.CIS?(r+=h,a+=d):(r+=d,a+=h),r>0&&a>0)throw new Error("incompatible cis-trans configuration");return(0!=r||0!=a)&&(r>0&&(this._dbonds[o[0]].saved=t.bonds.get(o[0]).begin==s.begin?1:2,-1!=o[1]&&(this._dbonds[o[1]].saved=t.bonds.get(o[1]).begin==s.begin?2:1),this._dbonds[o[2]].saved=t.bonds.get(o[2]).begin==s.end==(n==chem.CisTrans.PARITY.CIS)?1:2,-1!=o[3]&&(this._dbonds[o[3]].saved=t.bonds.get(o[3]).begin==s.end==(n==chem.CisTrans.PARITY.CIS)?2:1)),a>0&&(this._dbonds[o[0]].saved=t.bonds.get(o[0]).begin==s.begin?2:1,-1!=o[1]&&(this._dbonds[o[1]].saved=t.bonds.get(o[1]).begin==s.begin?1:2),this._dbonds[o[2]].saved=t.bonds.get(o[2]).begin==s.end==(n==chem.CisTrans.PARITY.CIS)?2:1,-1!=o[3]&&(this._dbonds[o[3]].saved=t.bonds.get(o[3]).begin==s.end==(n==chem.CisTrans.PARITY.CIS)?1:2)),!0)},chem.SmilesSaver.prototype._calcBondDirection=function(t,e,s){var i;if(-1==this._dbonds[e].ctbond_beg&&-1==this._dbonds[e].ctbond_end)return 0;if(t.bonds.get(e).type!=chem.Struct.BOND.TYPE.SINGLE)throw new Error("internal: directed bond type "+t.bonds.get(e).type);for(;;){if(i=0,this.cis_trans.each(function(e,s){0==s.parity||this.isBondInRing(e)||this._updateSideBonds(t,e)&&i++},this),i==this._touched_cistransbonds)break;this._touched_cistransbonds=i}return 0==this._dbonds[e].saved&&(s==t.bonds.get(e).begin?this._dbonds[e].saved=1:this._dbonds[e].saved=2),this._dbonds[e].saved},chem.SmilesSaver.prototype._writeRadicals=function(t){var e,s,i=new Array(this._written_atoms.length);for(e=0;e<this._written_atoms.size();e++)if(!i[e]){var n=t.atoms.get(this._written_atoms[e]).radical;if(0!=n)for(this.comma?this.smiles+=",":(this.smiles+=" |",this.comma=!0),n==chem.Struct.ATOM.RADICAL.SINGLET?this.smiles+="^3:":n==chem.Struct.ATOM.RADICAL.DOUPLET?this.smiles+="^1:":this.smiles+="^4:",this.smiles+=e,s=e+1;s<this._written_atoms.length;s++)t.atoms.get(this._written_atoms[s]).radical==n&&(i[s]=!0,this.smiles+=","+s)}};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/set":42,"./struct":16}],15:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util");require("./struct");var chem=global.chem=global.chem||{};chem.Stereocenters=function(e,r,t){this.molecule=e,this.atoms=new Map,this.getNeighbors=r,this.context=t},chem.Stereocenters.prototype.each=function(e,r){this.atoms.each(e,r)},chem.Stereocenters.prototype.buildFromBonds=function(e){var r=this.molecule.atoms,t=this.molecule.bonds,n=Set.empty();r.each(function(e,i){var o=this.getNeighbors.call(this.context,e);if(2!=o.length)return!1;var c=o[0],d=o[1];if(util.findIndex([e,c.aid,d.aid],function(e){return["C","Si"].indexOf(r.get(e).label)<0},this)>=0)return!1;if(util.findIndex([c.bid,d.bid],function(e){return t.get(e).type!=chem.Struct.BOND.TYPE.DOUBLE},this)>=0)return!1;var a=util.findAll(this.getNeighbors.call(this.context,c.aid),function(r){return r.aid!=e},this),s=util.findAll(this.getNeighbors.call(this.context,d.aid),function(r){return r.aid!=e},this);return!(a.length<1||a.length>2||s.length<1||s.length>2)&&(!(util.findIndex(a.concat(s),function(e){return t.get(e.bid).type!=chem.Struct.BOND.TYPE.SINGLE},this)>=0)&&(!(util.findIndex(a.concat(s),function(e){return t.get(e.bid).stereo==chem.Struct.BOND.STEREO.EITHER},this)>=0)&&(Set.add(n,c.aid),void Set.add(n,d.aid))))},this),Set.size(n)>0&&alert("This structure may contain allenes, which cannot be represented in the SMILES notation. Relevant stereo-information will be discarded."),r.each(function(e){if(!Set.contains(n,e)){var r=this.getNeighbors.call(this.context,e),t=!1;r.find(function(r){var n=this.molecule.bonds.get(r.bid);return n.type==chem.Struct.BOND.TYPE.SINGLE&&n.begin==e&&(n.stereo==chem.Struct.BOND.STEREO.UP||n.stereo==chem.Struct.BOND.STEREO.DOWN)&&(t=!0,!0)},this),t&&this._buildOneCenter(e)}},this)},chem.Stereocenters.allowed_stereocenters=[{elem:"C",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"C",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:4,n_double_bonds:2,implicit_degree:4},{elem:"S",charge:1,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:3,n_double_bonds:1,implicit_degree:3},{elem:"P",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"P",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"P",charge:0,degree:4,n_double_bonds:1,implicit_degree:4}],chem.Stereocenters.prototype._buildOneCenter=function(e){var r=this.molecule.atoms.get(e),t=this.getNeighbors.call(this.context,e),n=t.length,i=-1,o={group:0,type:0,pyramid:new Array(4)},c=0,d=new Array(4),a=0,s=0;o.pyramid[0]=-1,o.pyramid[1]=-1,o.pyramid[2]=-1,o.pyramid[3]=-1;var h=0;if(n>4)throw new Error("stereocenter with %d bonds are not supported"+n);if(t.each(function(e){var t=this.molecule.atoms.get(e.aid),n=this.molecule.bonds.get(e.bid);if(d[c]={edge_idx:e.bid,nei_idx:e.aid,rank:e.aid,vec:Vec2.diff(t.pp,r.pp).yComplement()},t.pureHydrogen()?(h++,d[c].rank=1e4):"H"==t.label&&(d[c].rank=5e3),!d[c].vec.normalize())throw new Error("zero bond length");if(n.type==chem.Struct.BOND.TYPE.TRIPLE)throw new Error("non-single bonds not allowed near stereocenter");if(n.type==chem.Struct.BOND.TYPE.AROMATIC)throw new Error("aromatic bonds not allowed near stereocenter");n.type==chem.Struct.BOND.TYPE.DOUBLE&&s++,c++},this),chem.Stereocenters.allowed_stereocenters.find(function(e){return e.elem==r.label&&e.charge==r.charge&&e.degree==n&&e.n_double_bonds==s&&(i=e.implicit_degree,!0)},this),-1==i)throw new Error("unknown stereocenter configuration: "+r.label+", charge "+r.charge+", "+n+" bonds ("+s+" double)");if(4==n&&h>1)throw new Error(h+" hydrogens near stereocenter");if(3==n&&4==i&&h>0)throw new Error("have hydrogen(s) besides implicit hydrogen near stereocenter");if(4==n){d[0].rank>d[1].rank&&d.swap(0,1),d[1].rank>d[2].rank&&d.swap(1,2),d[2].rank>d[3].rank&&d.swap(2,3),d[1].rank>d[2].rank&&d.swap(1,2),d[0].rank>d[1].rank&&d.swap(0,1),d[1].rank>d[2].rank&&d.swap(1,2);var m=-1,l=-1,u=-1,g=-1,S=0;for(c=0;c<4;c++){var p=this._getBondStereo(e,d[c].edge_idx);if(p==chem.Struct.BOND.STEREO.UP||p==chem.Struct.BOND.STEREO.DOWN){m=c,S=p;break}}if(-1==m)throw new Error("none of 4 bonds going from stereocenter is stereobond");var _,E;if(-1==l&&(_=chem.Stereocenters._xyzzy(d[m].vec,d[(m+1)%4].vec,d[(m+2)%4].vec),E=chem.Stereocenters._xyzzy(d[m].vec,d[(m+1)%4].vec,d[(m+3)%4].vec),_+E!=3&&_+E!=12||(l=(m+1)%4,u=(m+2)%4,g=(m+3)%4)),-1==l&&(_=chem.Stereocenters._xyzzy(d[m].vec,d[(m+2)%4].vec,d[(m+1)%4].vec),E=chem.Stereocenters._xyzzy(d[m].vec,d[(m+2)%4].vec,d[(m+3)%4].vec),_+E!=3&&_+E!=12||(l=(m+2)%4,u=(m+1)%4,g=(m+3)%4)),-1==l&&(_=chem.Stereocenters._xyzzy(d[m].vec,d[(m+3)%4].vec,d[(m+1)%4].vec),E=chem.Stereocenters._xyzzy(d[m].vec,d[(m+3)%4].vec,d[(m+2)%4].vec),_+E!=3&&_+E!=12||(l=(m+3)%4,u=(m+2)%4,g=(m+1)%4)),-1==l)throw new Error("internal error: can not find opposite bond");if(S==chem.Struct.BOND.STEREO.UP&&this._getBondStereo(e,d[l].edge_idx)==chem.Struct.BOND.STEREO.DOWN)throw new Error("stereo types of the opposite bonds mismatch");if(S==chem.Struct.BOND.STEREO.DOWN&&this._getBondStereo(e,d[l].edge_idx)==chem.Struct.BOND.STEREO.UP)throw new Error("stereo types of the opposite bonds mismatch");if(S==this._getBondStereo(e,d[u].edge_idx))throw new Error("stereo types of non-opposite bonds match");if(S==this._getBondStereo(e,d[g].edge_idx))throw new Error("stereo types of non-opposite bonds match");a=3==m||3==l?S:S==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP,N=chem.Stereocenters._sign(d[0].vec,d[1].vec,d[2].vec),a==chem.Struct.BOND.STEREO.UP&&N>0||a==chem.Struct.BOND.STEREO.DOWN&&N<0?(o.pyramid[0]=d[0].nei_idx,o.pyramid[1]=d[1].nei_idx,o.pyramid[2]=d[2].nei_idx):(o.pyramid[0]=d[0].nei_idx,o.pyramid[1]=d[2].nei_idx,o.pyramid[2]=d[1].nei_idx),o.pyramid[3]=d[3].nei_idx}else if(3==n){d[0].rank>d[1].rank&&d.swap(0,1),d[1].rank>d[2].rank&&d.swap(1,2),d[0].rank>d[1].rank&&d.swap(0,1);var b=this._getBondStereo(e,d[0].edge_idx),O=this._getBondStereo(e,d[1].edge_idx),f=this._getBondStereo(e,d[2].edge_idx),w=0,y=0;if(w+=b==chem.Struct.BOND.STEREO.UP?1:0,w+=O==chem.Struct.BOND.STEREO.UP?1:0,w+=f==chem.Struct.BOND.STEREO.UP?1:0,y+=b==chem.Struct.BOND.STEREO.DOWN?1:0,y+=O==chem.Struct.BOND.STEREO.DOWN?1:0,y+=f==chem.Struct.BOND.STEREO.DOWN?1:0,4==i){if(3==w)throw new Error("all 3 bonds up near stereoatom");if(3==y)throw new Error("all 3 bonds down near stereoatom");if(0==w&&0==y)throw new Error("no up/down bonds near stereoatom -- indefinite case");if(1==w&&1==y)throw new Error("one bond up, one bond down -- indefinite case");if(S=0,2==w)a=chem.Struct.BOND.STEREO.DOWN;else if(2==y)a=chem.Struct.BOND.STEREO.UP;else{for(m=-1,u=-1,g=-1,c=0;c<3;c++)if((x=this._getBondStereo(e,d[c].edge_idx))==chem.Struct.BOND.STEREO.UP||x==chem.Struct.BOND.STEREO.DOWN){m=c,S=x,u=(c+1)%3,g=(c+2)%3;break}if(-1==m)throw new Error("internal error: can not find up or down bond");var v=chem.Stereocenters._xyzzy(d[u].vec,d[g].vec,d[m].vec);if(3==v||4==v)throw new Error("degenerate case for 3 bonds near stereoatom");a=1==v?S:S==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP}var N=chem.Stereocenters._sign(d[0].vec,d[1].vec,d[2].vec);a==chem.Struct.BOND.STEREO.UP&&N>0||a==chem.Struct.BOND.STEREO.DOWN&&N<0?(o.pyramid[0]=d[0].nei_idx,o.pyramid[1]=d[1].nei_idx,o.pyramid[2]=d[2].nei_idx):(o.pyramid[0]=d[0].nei_idx,o.pyramid[1]=d[2].nei_idx,o.pyramid[2]=d[1].nei_idx),o.pyramid[3]=-1}else{var x;if(y>0&&w>0)throw new Error("one bond up, one bond down -- indefinite case");if(0==y&&0==w)throw new Error("no up-down bonds attached to stereocenter");x=w>0?1:-1,1!=chem.Stereocenters._xyzzy(d[0].vec,d[1].vec,d[2].vec)&&1!=chem.Stereocenters._xyzzy(d[0].vec,d[2].vec,d[1].vec)&&1!=chem.Stereocenters._xyzzy(d[2].vec,d[1].vec,d[0].vec)||(x=-x),N=chem.Stereocenters._sign(d[0].vec,d[1].vec,d[2].vec),N==x?(o.pyramid[0]=d[0].nei_idx,o.pyramid[1]=d[2].nei_idx,o.pyramid[2]=d[1].nei_idx):(o.pyramid[0]=d[0].nei_idx,o.pyramid[1]=d[1].nei_idx,o.pyramid[2]=d[2].nei_idx),o.pyramid[3]=-1}}this.atoms.set(e,o)},chem.Stereocenters.prototype._getBondStereo=function(e,r){var t=this.molecule.bonds.get(r);return e!=t.begin?0:t.stereo},chem.Stereocenters._xyzzy=function(e,r,t){var n=Vec2.cross(e,r),i=Vec2.dot(e,r),o=Vec2.cross(e,t),c=Vec2.dot(e,t);if(Math.abs(n)<.001){if(Math.abs(o)<.001)throw new Error("degenerate case -- bonds overlap");return o>0?4:8}return n*o<-1e-6?2:c<i?2:1},chem.Stereocenters._sign=function(e,r,t){var n=(e.x-t.x)*(r.y-t.y)-(e.y-t.y)*(r.x-t.x);if(n>.001)return 1;if(n<-.001)return-1;throw new Error("degenerate triangle")},chem.Stereocenters.isPyramidMappingRigid=function(e){var r=e.clone(),t=!0;return r[0]>r[1]&&(r.swap(0,1),t=!t),r[1]>r[2]&&(r.swap(1,2),t=!t),r[2]>r[3]&&(r.swap(2,3),t=!t),r[1]>r[2]&&(r.swap(1,2),t=!t),r[0]>r[1]&&(r.swap(0,1),t=!t),r[1]>r[2]&&(r.swap(1,2),t=!t),t};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/map":40,"../util/set":42,"../util/vec2":43,"./struct":16}],16:[function(require,module,exports){
(function (global){
var Map=require("../util/map"),Pool=require("../util/pool"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),element=require("./element"),chem=global.chem=global.chem||{};chem.Struct=function(){this.atoms=new Pool,this.bonds=new Pool,this.sgroups=new Pool,this.halfBonds=new Map,this.loops=new Pool,this.isChiral=!1,this.isReaction=!1,this.rxnArrows=new Pool,this.rxnPluses=new Pool,this.frags=new Pool,this.rgroups=new Map,this.name="",this.sGroupForest=new chem.SGroupForest(this)},chem.Struct.prototype.hasRxnProps=function(){return this.atoms.find(function(t,e){return e.hasRxnProps()},this)>=0||this.bonds.find(function(t,e){return e.hasRxnProps()},this)>=0},chem.Struct.prototype.hasRxnArrow=function(){return this.rxnArrows.count()>0},chem.Struct.prototype.addRxnArrowIfNecessary=function(){var t=!this.hasRxnArrow()&&this.hasRxnProps();return t&&this.rxnArrows.add(new chem.Struct.RxnArrow),t},chem.Struct.prototype.getSGroupsInAtomSet=function(t){var e=new Hash;util.each(t,function(t){Set.list(this.atoms.get(t).sgs).each(function(t){var n=e.get(t);Object.isUndefined(n)?n=1:n++,e.set(t,n)},this)},this);var n=[];return e.each(function(t){var e=parseInt(t.key,10),i=this.sgroups.get(e),o=chem.SGroup.getAtoms(this,i);t.value==o.length&&n.push(e)},this),n},chem.Struct.prototype.isBlank=function(){return 0===this.atoms.count()&&0===this.rxnArrows.count()&&0===this.rxnPluses.count()&&!this.isChiral},chem.Struct.prototype.toLists=function(){var t={},e=[];this.atoms.each(function(n,i){t[n]=e.length,e.push(i)});var n=[];return this.bonds.each(function(e,i){var o=new chem.Struct.Bond(i);o.begin=t[i.begin],o.end=t[i.end],n.push(o)}),{atoms:e,bonds:n}},chem.Struct.prototype.clone=function(t,e,n,i){var o=new chem.Struct;return this.mergeInto(o,t,e,n,!1,i)},chem.Struct.prototype.getScaffold=function(){var t=Set.empty();return this.atoms.each(function(e){Set.add(t,e)},this),this.rgroups.each(function(e,n){n.frags.each(function(e,n){this.atoms.each(function(e,i){i.fragment==n&&Set.remove(t,e)},this)},this)},this),this.clone(t)},chem.Struct.prototype.getFragmentIds=function(t){var e=Set.empty();return this.atoms.each(function(n,i){i.fragment==t&&Set.add(e,n)},this),e},chem.Struct.prototype.getFragment=function(t){return this.clone(this.getFragmentIds(t))},chem.Struct.prototype.mergeInto=function(t,e,n,i,o,s){e=e||Set.keySetInt(this.atoms),n=n||Set.keySetInt(this.bonds),n=Set.filter(n,function(t){var n=this.bonds.get(t);return Set.contains(e,n.begin)&&Set.contains(e,n.end)},this);var r={};this.atoms.each(function(t,n){Set.contains(e,t)&&(r[n.fragment]=1)});var h={};this.frags.each(function(e,n){r[e]&&(h[e]=t.frags.add(n.clone()))}),this.rgroups.each(function(e,n){var i=o;if(i||(n.frags.each(function(t,e){r[e]&&(i=!0)}),i)){var s=t.rgroups.get(e);s?n.frags.each(function(t,e){r[e]&&s.frags.add(h[e])}):t.rgroups.set(e,n.clone(h))}}),void 0!==s&&null!==s||(s={}),this.atoms.each(function(n,i){Set.contains(e,n)&&(s[n]=t.atoms.add(i.clone(h)))});var c={};return this.bonds.each(function(e,i){Set.contains(n,e)&&(c[e]=t.bonds.add(i.clone(s)))}),this.sgroups.each(function(n,i){var o;for(o=0;o<i.atoms.length;++o)if(!Set.contains(e,i.atoms[o]))return;i=chem.SGroup.clone(i,s,c);var r=t.sgroups.add(i);for(i.id=r,o=0;o<i.atoms.length;++o)Set.add(t.atoms.get(i.atoms[o]).sgs,r);t.sGroupForest.insert(i.id)}),t.isChiral=this.isChiral,i||(t.isReaction=this.isReaction,this.rxnArrows.each(function(e,n){t.rxnArrows.add(n.clone())}),this.rxnPluses.each(function(e,n){t.rxnPluses.add(n.clone())})),t},chem.Struct.prototype.findBondId=function(t,e){var n=-1;return this.bonds.find(function(i,o){return(o.begin==t&&o.end==e||o.begin==e&&o.end==t)&&(n=i,!0)},this),n},chem.Struct.ATOM={RADICAL:{NONE:0,SINGLET:1,DOUPLET:2,TRIPLET:3}},chem.Struct.radicalElectrons=function(t){if((t-=0)==chem.Struct.ATOM.RADICAL.NONE)return 0;if(t==chem.Struct.ATOM.RADICAL.DOUPLET)return 1;if(t==chem.Struct.ATOM.RADICAL.SINGLET||t==chem.Struct.ATOM.RADICAL.TRIPLET)return 2;throw new Error("Unknown radical value")},chem.Struct.BOND={TYPE:{SINGLE:1,DOUBLE:2,TRIPLE:3,AROMATIC:4,SINGLE_OR_DOUBLE:5,SINGLE_OR_AROMATIC:6,DOUBLE_OR_AROMATIC:7,ANY:8},STEREO:{NONE:0,UP:1,EITHER:4,DOWN:6,CIS_TRANS:3},TOPOLOGY:{EITHER:0,RING:1,CHAIN:2},REACTING_CENTER:{NOT_CENTER:-1,UNMARKED:0,CENTER:1,UNCHANGED:2,MADE_OR_BROKEN:4,ORDER_CHANGED:8,MADE_OR_BROKEN_AND_CHANGED:12}},chem.Struct.FRAGMENT={NONE:0,REACTANT:1,PRODUCT:2,AGENT:3},chem.Struct.Atom=function(t){var e=chem.Struct.Atom.attrGetDefault;if(!(t&&"label"in t))throw new Error("label must be specified!");this.label=t.label,this.fragment=Object.isUndefined(t.fragment)?-1:t.fragment,util.ifDef(this,t,"isotope",e("isotope")),util.ifDef(this,t,"radical",e("radical")),util.ifDef(this,t,"charge",e("charge")),util.ifDef(this,t,"rglabel",e("rglabel")),util.ifDef(this,t,"attpnt",e("attpnt")),util.ifDef(this,t,"explicitValence",e("explicitValence")),this.valence=0,this.implicitH=0,Object.isUndefined(t.pp)?this.pp=new Vec2:this.pp=new Vec2(t.pp),this.sgs={},util.ifDef(this,t,"ringBondCount",e("ringBondCount")),util.ifDef(this,t,"substitutionCount",e("substitutionCount")),util.ifDef(this,t,"unsaturatedAtom",e("unsaturatedAtom")),util.ifDef(this,t,"hCount",e("hCount")),util.ifDef(this,t,"aam",e("aam")),util.ifDef(this,t,"invRet",e("invRet")),util.ifDef(this,t,"exactChangeFlag",e("exactChangeFlag")),util.ifDef(this,t,"rxnFragmentType",-1),this.atomList=Object.isUndefined(t.atomList)||null==t.atomList?null:new chem.Struct.AtomList(t.atomList),this.neighbors=[],this.badConn=!1},chem.Struct.Atom.getAttrHash=function(t){var e=new Hash;for(var n in chem.Struct.Atom.attrlist)void 0!==t[n]&&e.set(n,t[n]);return e},chem.Struct.Atom.attrGetDefault=function(t){if(t in chem.Struct.Atom.attrlist)return chem.Struct.Atom.attrlist[t];throw new Error("Attribute unknown")},chem.Struct.Atom.attrlist={label:"C",isotope:0,radical:0,charge:0,explicitValence:-1,ringBondCount:0,substitutionCount:0,unsaturatedAtom:0,hCount:0,atomList:null,invRet:0,exactChangeFlag:0,rglabel:null,attpnt:null,aam:0},chem.Struct.Atom.prototype.clone=function(t){var e=new chem.Struct.Atom(this);return t&&this.fragment in t&&(e.fragment=t[this.fragment]),e},chem.Struct.Atom.prototype.isQuery=function(){return null!=this.atomList||"A"==this.label||this.attpnt||this.hCount},chem.Struct.Atom.prototype.pureHydrogen=function(){return"H"==this.label&&0==this.isotope},chem.Struct.Atom.prototype.isPlainCarbon=function(){return"C"==this.label&&0==this.isotope&&0==this.radical&&0==this.charge&&this.explicitValence<0&&0==this.ringBondCount&&0==this.substitutionCount&&0==this.unsaturatedAtom&&0==this.hCount&&!this.atomList},chem.Struct.Atom.prototype.isPseudo=function(){return!this.atomList&&!this.rglabel&&!element.getElementByLabel(this.label)},chem.Struct.Atom.prototype.hasRxnProps=function(){return!(!this.invRet&&!this.exactChangeFlag&&util.isNull(this.attpnt)&&!this.aam)},chem.Struct.AtomList=function(t){if(!(t&&"notList"in t&&"ids"in t))throw new Error("'notList' and 'ids' must be specified!");this.notList=t.notList,this.ids=t.ids},chem.Struct.AtomList.prototype.labelList=function(){for(var t=[],e=0;e<this.ids.length;++e)t.push(element.get(this.ids[e]).label);return t},chem.Struct.AtomList.prototype.label=function(){var t="["+this.labelList().join(",")+"]";return this.notList&&(t="!"+t),t},chem.Struct.AtomList.prototype.equals=function(t){return this.notList==t.notList&&(this.ids||[]).sort().toString()==(t.ids||[]).sort().toString()},chem.Struct.Bond=function(t){if(!(t&&"begin"in t&&"end"in t&&"type"in t))throw new Error("'begin', 'end' and 'type' properties must be specified!");this.begin=t.begin,this.end=t.end,this.type=t.type,util.ifDef(this,t,"stereo",chem.Struct.BOND.STEREO.NONE),util.ifDef(this,t,"topology",chem.Struct.BOND.TOPOLOGY.EITHER),util.ifDef(this,t,"reactingCenterStatus",0),this.hb1=null,this.hb2=null,this.len=0,this.center=new Vec2,this.sb=0,this.sa=0,this.angle=0},chem.Struct.Bond.attrlist={type:chem.Struct.BOND.TYPE.SINGLE,stereo:chem.Struct.BOND.STEREO.NONE,topology:chem.Struct.BOND.TOPOLOGY.EITHER,reactingCenterStatus:0},chem.Struct.Bond.getAttrHash=function(t){var e=new Hash;for(var n in chem.Struct.Bond.attrlist)void 0!==t[n]&&e.set(n,t[n]);return e},chem.Struct.Bond.attrGetDefault=function(t){if(t in chem.Struct.Bond.attrlist)return chem.Struct.Bond.attrlist[t];throw new Error("Attribute unknown")},chem.Struct.Bond.prototype.hasRxnProps=function(){return!!this.reactingCenterStatus},chem.Struct.Bond.prototype.getCenter=function(t){var e=t.atoms.get(this.begin).pp,n=t.atoms.get(this.end).pp;return Vec2.lc2(e,.5,n,.5)},chem.Struct.Bond.prototype.getDir=function(t){var e=t.atoms.get(this.begin).pp;return t.atoms.get(this.end).pp.sub(e).normalized()},chem.Struct.Bond.prototype.clone=function(t){var e=new chem.Struct.Bond(this);return t&&(e.begin=t[e.begin],e.end=t[e.end]),e},chem.Struct.Bond.prototype.findOtherEnd=function(t){if(t==this.begin)return this.end;if(t==this.end)return this.begin;throw new Error("bond end not found")},chem.HalfBond=function(t,e,n){if(3!=arguments.length)throw new Error("Invalid parameter number!");this.begin=t-0,this.end=e-0,this.bid=n-0,this.dir=new Vec2,this.norm=new Vec2,this.ang=0,this.p=new Vec2,this.loop=-1,this.contra=-1,this.next=-1,this.leftSin=0,this.leftCos=0,this.leftNeighbor=0,this.rightSin=0,this.rightCos=0,this.rightNeighbor=0},chem.Struct.prototype.initNeighbors=function(){this.atoms.each(function(t,e){e.neighbors=[]}),this.bonds.each(function(t,e){var n=this.atoms.get(e.begin),i=this.atoms.get(e.end);n.neighbors.push(e.hb1),i.neighbors.push(e.hb2)},this)},chem.Struct.prototype.bondInitHalfBonds=function(t,e){e=e||this.bonds.get(t),e.hb1=2*t,e.hb2=2*t+1,this.halfBonds.set(e.hb1,new chem.HalfBond(e.begin,e.end,t)),this.halfBonds.set(e.hb2,new chem.HalfBond(e.end,e.begin,t));var n=this.halfBonds.get(e.hb1),i=this.halfBonds.get(e.hb2);n.contra=e.hb2,i.contra=e.hb1},chem.Struct.prototype.halfBondUpdate=function(t){var e=this.halfBonds.get(t),n=this.atoms.get(e.begin).pp,i=this.atoms.get(e.end).pp,o=Vec2.diff(i,n).normalized();e.dir=Vec2.dist(i,n)>1e-4?o:new Vec2(1,0),e.norm=e.dir.turnLeft(),e.ang=e.dir.oxAngle(),e.loop<0&&(e.loop=-1)},chem.Struct.prototype.initHalfBonds=function(){this.halfBonds.clear(),this.bonds.each(this.bondInitHalfBonds,this)},chem.Struct.prototype.setHbNext=function(t,e){this.halfBonds.get(this.halfBonds.get(t).contra).next=e},chem.Struct.prototype.halfBondSetAngle=function(t,e){var n=this.halfBonds.get(t),i=this.halfBonds.get(e);i.rightCos=n.leftCos=Vec2.dot(i.dir,n.dir),i.rightSin=n.leftSin=Vec2.cross(i.dir,n.dir),n.leftNeighbor=e,i.rightNeighbor=t},chem.Struct.prototype.atomAddNeighbor=function(t){var e=this.halfBonds.get(t),n=this.atoms.get(e.begin),i=0;for(i=0;i<n.neighbors.length&&!(this.halfBonds.get(n.neighbors[i]).ang>e.ang);++i);n.neighbors.splice(i,0,t);var o=n.neighbors[(i+1)%n.neighbors.length],s=n.neighbors[(i+n.neighbors.length-1)%n.neighbors.length];this.setHbNext(s,t),this.setHbNext(t,o),this.halfBondSetAngle(t,s),this.halfBondSetAngle(o,t)},chem.Struct.prototype.atomSortNeighbors=function(t){var e=this.atoms.get(t);e.neighbors=e.neighbors.sortBy(function(t){return this.halfBonds.get(t).ang},this);var n;for(n=0;n<e.neighbors.length;++n)this.halfBonds.get(this.halfBonds.get(e.neighbors[n]).contra).next=e.neighbors[(n+1)%e.neighbors.length];for(n=0;n<e.neighbors.length;++n)this.halfBondSetAngle(e.neighbors[(n+1)%e.neighbors.length],e.neighbors[n])},chem.Struct.prototype.sortNeighbors=function(t){var e=function(t){this.atomSortNeighbors(t)};util.isNullOrUndefined(t)?this.atoms.each(e,this):util.each(t,e,this)},chem.Struct.prototype.atomUpdateHalfBonds=function(t){for(var e=this.atoms.get(t).neighbors,n=0;n<e.length;++n){var i=e[n];this.halfBondUpdate(i),this.halfBondUpdate(this.halfBonds.get(i).contra)}},chem.Struct.prototype.updateHalfBonds=function(t){var e=function(t){this.atomUpdateHalfBonds(t)};util.isNullOrUndefined(t)?this.atoms.each(e,this):util.each(t,e,this)},chem.Struct.prototype.sGroupsRecalcCrossBonds=function(){this.sgroups.each(function(t,e){e.xBonds=[],e.neiAtoms=[]},this),this.bonds.each(function(t,e){var n=this.atoms.get(e.begin),i=this.atoms.get(e.end);Set.each(n.sgs,function(n){if(!Set.contains(i.sgs,n)){var o=this.sgroups.get(n);o.xBonds.push(t),util.arrayAddIfMissing(o.neiAtoms,e.end)}},this),Set.each(i.sgs,function(i){if(!Set.contains(n.sgs,i)){var o=this.sgroups.get(i);o.xBonds.push(t),util.arrayAddIfMissing(o.neiAtoms,e.begin)}},this)},this)},chem.Struct.prototype.sGroupDelete=function(t){for(var e=this.sgroups.get(t),n=0;n<e.atoms.length;++n)Set.remove(this.atoms.get(e.atoms[n]).sgs,t);this.sGroupForest.remove(t),this.sgroups.remove(t)},chem.Struct.itemSetPos=function(t,e){t.pp=e},chem.Struct.prototype._itemSetPos=function(t,e,n,i){chem.Struct.itemSetPos(this[t].get(e),n,i)},chem.Struct.prototype._atomSetPos=function(t,e,n){this._itemSetPos("atoms",t,e,n)},chem.Struct.prototype._rxnPlusSetPos=function(t,e,n){this._itemSetPos("rxnPluses",t,e,n)},chem.Struct.prototype._rxnArrowSetPos=function(t,e,n){this._itemSetPos("rxnArrows",t,e,n)},chem.Struct.prototype.getCoordBoundingBox=function(t){var e=null,n=function(t){e?(e.min=Vec2.min(e.min,t),e.max=Vec2.max(e.max,t)):e={min:t,max:t}},i=void 0===t;return this.atoms.each(function(e,o){(i||Set.contains(t,e))&&n(o.pp)}),i&&(this.rxnPluses.each(function(t,e){n(e.pp)}),this.rxnArrows.each(function(t,e){n(e.pp)})),!e&&i&&(e={min:new Vec2(0,0),max:new Vec2(1,1)}),e},chem.Struct.prototype.getCoordBoundingBoxObj=function(){var t=null,e=function(e){t?(t.min=Vec2.min(t.min,e),t.max=Vec2.max(t.max,e)):t={min:new Vec2(e),max:new Vec2(e)}};return this.atoms.each(function(t,n){e(n.pp)}),t},chem.Struct.prototype.getBondLengthData=function(){var t=0,e=0;return this.bonds.each(function(n,i){t+=Vec2.dist(this.atoms.get(i.begin).pp,this.atoms.get(i.end).pp),e++},this),{cnt:e,totalLength:t}},chem.Struct.prototype.getAvgBondLength=function(){var t=this.getBondLengthData();return t.cnt>0?t.totalLength/t.cnt:-1},chem.Struct.prototype.getAvgClosestAtomDistance=function(){var t,e,n,i=0,o=0,s=this.atoms.keys();for(e=0;e<s.length;++e){for(t=-1,n=0;n<s.length;++n)n!=e&&(o=Vec2.dist(this.atoms.get(s[n]).pp,this.atoms.get(s[e]).pp),(t<0||t>o)&&(t=o));i+=t}return s.length>0?i/s.length:-1},chem.Struct.prototype.checkBondExists=function(t,e){var n=!1;return this.bonds.each(function(i,o){(o.begin==t&&o.end==e||o.end==t&&o.begin==e)&&(n=!0)},this),n},chem.Loop=function(t,e,n){this.hbs=t,this.dblBonds=0,this.aromatic=!0,this.convex=n||!1,t.each(function(t){var n=e.bonds.get(e.halfBonds.get(t).bid);n.type!=chem.Struct.BOND.TYPE.AROMATIC&&(this.aromatic=!1),n.type==chem.Struct.BOND.TYPE.DOUBLE&&this.dblBonds++},this)},chem.Struct.RxnPlus=function(t){t=t||{},this.pp=t.pp?new Vec2(t.pp):new Vec2},chem.Struct.RxnPlus.prototype.clone=function(){return new chem.Struct.RxnPlus(this)},chem.Struct.RxnArrow=function(t){t=t||{},this.pp=t.pp?new Vec2(t.pp):new Vec2},chem.Struct.RxnArrow.prototype.clone=function(){return new chem.Struct.RxnArrow(this)},chem.Struct.prototype.findConnectedComponent=function(t){for(var e={},n=[t],i=Set.empty();n.length>0;)(function(){var t=n.pop();e[t]=1,Set.add(i,t);for(var o=this.atoms.get(t),s=0;s<o.neighbors.length;++s){var r=this.halfBonds.get(o.neighbors[s]).end;Set.contains(i,r)||n.push(r)}}).apply(this);return i},chem.Struct.prototype.findConnectedComponents=function(t){this.halfBonds.count()||(this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()));var e={};this.atoms.each(function(t){e[t]=-1},this);var n=[];return this.atoms.each(function(i,o){if((t||o.fragment<0)&&e[i]<0){var s=this.findConnectedComponent(i);n.push(s),Set.each(s,function(t){e[t]=1},this)}},this),n},chem.Struct.prototype.markFragment=function(t){var e=this.frags.add(new chem.Struct.Fragment);Set.each(t,function(t){this.atoms.get(t).fragment=e},this)},chem.Struct.prototype.markFragmentByAtomId=function(t){this.markFragment(this.findConnectedComponent(t))},chem.Struct.prototype.markFragments=function(){for(var t=this.findConnectedComponents(),e=0;e<t.length;++e)this.markFragment(t[e])},chem.Struct.Fragment=function(){},chem.Struct.Fragment.prototype.clone=function(){return Object.clone(this)},chem.Struct.Fragment.getAtoms=function(t,e){var n=[];return t.atoms.each(function(t,i){i.fragment==e&&n.push(t)},this),n},chem.Struct.RGroup=function(t){t=t||{},this.frags=new Pool,this.resth=t.resth||!1,this.range=t.range||"",this.ifthen=t.ifthen||0},chem.Struct.RGroup.prototype.getAttrs=function(){return{resth:this.resth,range:this.range,ifthen:this.ifthen}},chem.Struct.RGroup.findRGroupByFragment=function(t,e){var n;return t.each(function(t,i){Object.isUndefined(i.frags.keyOf(e))||(n=t)}),n},chem.Struct.RGroup.prototype.clone=function(t){var e=new chem.Struct.RGroup(this);return this.frags.each(function(n,i){e.frags.add(t?t[i]:i)}),e},chem.Struct.prototype.scale=function(t){1!=t&&(this.atoms.each(function(e,n){n.pp=n.pp.scaled(t)},this),this.rxnPluses.each(function(e,n){n.pp=n.pp.scaled(t)},this),this.rxnArrows.each(function(e,n){n.pp=n.pp.scaled(t)},this),this.sgroups.each(function(e,n){n.pp=n.pp?n.pp.scaled(t):null},this))},chem.Struct.prototype.rescale=function(){var t=this.getAvgBondLength();t<0&&!this.isReaction&&(t=this.getAvgClosestAtomDistance()),t<.001&&(t=1);var e=1/t;this.scale(e)},chem.Struct.prototype.loopHasSelfIntersections=function(t){for(var e=0;e<t.length;++e)for(var n=this.halfBonds.get(t[e]),i=this.atoms.get(n.begin).pp,o=this.atoms.get(n.end).pp,s=Set.fromList([n.begin,n.end]),r=e+2;r<t.length;++r){var h=this.halfBonds.get(t[r]);if(!Set.contains(s,h.begin)&&!Set.contains(s,h.end)){var c=this.atoms.get(h.begin).pp,a=this.atoms.get(h.end).pp;if(Vec2.segmentIntersection(i,o,c,a))return!0}}return!1},chem.Struct.prototype.partitionLoop=function(t){var e=[],n=!0;t:for(;n;){for(var i={},o=0;o<t.length;++o){var s=t[o],r=this.halfBonds.get(s).begin,h=this.halfBonds.get(s).end;if(h in i){var c=i[h],a=t.slice(c,o+1);e.push(a),o<t.length&&t.splice(c,o-c+1);continue t}i[r]=o}n=!1,e.push(t)}return e},chem.Struct.prototype.halfBondAngle=function(t,e){var n=this.halfBonds.get(t),i=this.halfBonds.get(e);return Math.atan2(Vec2.cross(n.dir,i.dir),Vec2.dot(n.dir,i.dir))},chem.Struct.prototype.loopIsConvex=function(t){for(var e=0;e<t.length;++e){if(this.halfBondAngle(t[e],t[(e+1)%t.length])>0)return!1}return!0},chem.Struct.prototype.loopIsInner=function(t){for(var e=2*Math.PI,n=0;n<t.length;++n){var i=t[n],o=t[(n+1)%t.length],s=this.halfBonds.get(o),r=this.halfBondAngle(i,o);s.contra==t[n]?e+=Math.PI:e+=r}return Math.abs(e)<Math.PI},chem.Struct.prototype.findLoops=function(){var t,e,n,i,o=[],s=Set.empty();return this.halfBonds.each(function(r,h){if(-1==h.loop)for(t=r,e=0,n=[];e<=this.halfBonds.count();t=this.halfBonds.get(t).next,++e){if(e>0&&t==r){var c=this.partitionLoop(n);util.each(c,function(t){this.loopIsInner(t)&&!this.loopHasSelfIntersections(t)?(i=util.arrayMin(t),this.loops.set(i,new chem.Loop(t,this,this.loopIsConvex(t)))):i=-2,t.each(function(t){this.halfBonds.get(t).loop=i,Set.add(s,this.halfBonds.get(t).bid)},this),i>=0&&o.push(i)},this);break}n.push(t)}},this),{newLoops:o,bondsToMark:Set.list(s)}},chem.Struct.prototype.prepareLoopStructure=function(){this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()),this.findLoops()},chem.Struct.prototype.atomAddToSGroup=function(t,e){chem.SGroup.addAtom(this.sgroups.get(t),e),Set.add(this.atoms.get(e).sgs,t)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"../util/map":40,"../util/pool":41,"../util/set":42,"../util/vec2":43,"./element":10}],17:[function(require,module,exports){
(function (global){
var util=require("../util"),element=require("./element");require("./struct");var chem=global.chem=global.chem||{};chem.Struct.prototype.calcConn=function(e){for(var t=0,i=this.atoms.get(e),r=!1,l=0;l<i.neighbors.length;++l){var c=this.halfBonds.get(i.neighbors[l]);switch(this.bonds.get(c.bid).type){case chem.Struct.BOND.TYPE.SINGLE:t+=1;break;case chem.Struct.BOND.TYPE.DOUBLE:t+=2;break;case chem.Struct.BOND.TYPE.TRIPLE:t+=3;break;case chem.Struct.BOND.TYPE.AROMATIC:t+=1,r=!0;break;default:return-1}}return r&&(t+=1),t},chem.Struct.Atom.prototype.calcValence=function(e){var t=this,i=t.charge,r=t.label;if(t.isQuery())return this.implicitH=0,!0;var l=element.getElementByLabel(r);if(null==l)return this.implicitH=0,!0;var c=element.get(l).group,n=chem.Struct.radicalElectrons(t.radical),a=e,u=0,s=Math.abs(i);return 1==c?"H"!=r&&"Li"!=r&&"Na"!=r&&"K"!=r&&"Rb"!=r&&"Cs"!=r&&"Fr"!=r||(a=1,u=1-n-e-s):3==c?"B"==r||"Al"==r||"Ga"==r||"In"==r?-1==i?(a=4,u=4-n-e):(a=3,u=3-n-e-s):"Tl"==r&&(-1==i?n+e<=2?(a=2,u=2-n-e):(a=4,u=4-n-e):-2==i?n+e<=3?(a=3,u=3-n-e):(a=5,u=5-n-e):n+e+s<=1?(a=1,u=1-n-e-s):(a=3,u=3-n-e-s)):4==c?"C"==r||"Si"==r||"Ge"==r?(a=4,u=4-n-e-s):"Sn"!=r&&"Pb"!=r||(e+n+s<=2?(a=2,u=2-n-e-s):(a=4,u=4-n-e-s)):5==c?"N"==r||"P"==r?1==i?(a=4,u=4-n-e):2==i?(a=3,u=3-n-e):"N"==r||n+e+s<=3?(a=3,u=3-n-e-s):(a=5,u=5-n-e-s):"Bi"!=r&&"Sb"!=r&&"As"!=r||(1==i?n+e<=2&&"As"!=r?(a=2,u=2-n-e):(a=4,u=4-n-e):2==i?(a=3,u=3-n-e):n+e<=3?(a=3,u=3-n-e-s):(a=5,u=5-n-e-s)):6==c?"O"==r?i>=1?(a=3,u=3-n-e):(a=2,u=2-n-e-s):"S"==r||"Se"==r||"Po"==r?1==i?e<=3?(a=3,u=3-n-e):(a=5,u=5-n-e):e+n+s<=2?(a=2,u=2-n-e-s):e+n+s<=4?(a=4,u=4-n-e-s):(a=6,u=6-n-e-s):"Te"==r&&(-1==i?e<=2&&(a=2,u=2-n-e-s):0!=i&&2!=i||(e<=2?(a=2,u=2-n-e-s):e<=4?(a=4,u=4-n-e-s):0==i&&e<=6?(a=6,u=6-n-e-s):u=-1)):7==c&&("F"==r?(a=1,u=1-n-e-s):"Cl"!=r&&"Br"!=r&&"I"!=r&&"At"!=r||(1==i?e<=2?(a=2,u=2-n-e):(3==e||5==e||e>=7)&&(u=-1):0==i&&(e<=1?(a=1,u=1-n-e):2==e||4==e||6==e?1==n?(a=e,u=0):u=-1:e>7&&(u=-1)))),this.valence=a,this.implicitH=u,!(this.implicitH<0)||(this.valence=e,this.implicitH=0,this.badConn=!0,!1)},chem.Struct.Atom.prototype.calcValenceMinusHyd=function(e){var t=this,i=t.charge,r=t.label,l=element.getElementByLabel(r);if(null==l)throw new Error("Element "+r+" unknown");if(l<0)return this.implicitH=0,null;var c=element.get(l).group,n=chem.Struct.radicalElectrons(t.radical);if(3==c){if(("B"==r||"Al"==r||"Ga"==r||"In"==r)&&-1==i&&n+e<=4)return n+e}else if(5==c){if("N"==r||"P"==r){if(1==i)return n+e;if(2==i)return n+e}else if("Sb"==r||"Bi"==r||"As"==r){if(1==i)return n+e;if(2==i)return n+e}}else if(6==c){if("O"==r){if(i>=1)return n+e}else if(("S"==r||"Se"==r||"Po"==r)&&1==i)return n+e}else if(7==c&&("Cl"==r||"Br"==r||"I"==r||"At"==r)&&1==i)return n+e;return n+e+Math.abs(i)},chem.Struct.prototype.calcImplicitHydrogen=function(e){var t=this.calcConn(e),i=this.atoms.get(e);if(i.badConn=!1,t<0||i.isQuery())return void(i.implicitH=0);if(i.explicitValence>=0){var r=element.getElementByLabel(i.label);i.implicitH=0,null!=r&&(i.implicitH=i.explicitValence-i.calcValenceMinusHyd(t),i.implicitH<0&&(i.implicitH=0,i.badConn=!0))}else i.calcValence(t)},chem.Struct.prototype.setImplicitHydrogen=function(e){var t=function(e){this.calcImplicitHydrogen(e)};util.isNullOrUndefined(e)?this.atoms.each(t,this):util.each(e,t,this)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util":39,"./element":10,"./struct":16}],18:[function(require,module,exports){
(function (global){
function getSmiles(e){var t=ui.standalone||e,i=t?new chem.SmilesSaver:new chem.MolfileSaver,r=i.saveMolecule(ui.ctab,!0);return t?r:ketcher.server.smiles.sync({moldata:r})}function getMolfile(){return(new chem.MolfileSaver).saveMolecule(ui.ctab,!0)}function setMolecule(e){Object.isString(e)&&ui.loadMolecule(e)}function addFragment(e){Object.isString(e)&&ui.loadFragment(e)}function showMolfile(e,t,i){var r=util.extend({bondLength:75,showSelectionRegions:!1,showBondIds:!1,showHalfBondIds:!1,showLoopIds:!1,showAtomIds:!1,autoScale:!1,autoScaleMargin:4,hideImplicitHydrogen:!1},i),l=new rnd.Render(e,r.bondLength,r);if(t){var n=chem.Molfile.parseCTFile(t);l.setMolecule(n)}return l.update(),l}function onStructChange(e){util.assert(e),ui.render.addStructChangeHandler(e)}var queryString=require("query-string"),util=require("./util"),api=require("./api.js");require("./ui"),require("./chem"),require("./rnd");var ui=global.ui,chem=global.chem,rnd=global.rnd;window.onload=function(){var e=queryString.parse(document.location.search);e.api_path&&(ketcher.api_path=e.api_path),ketcher.server=api(ketcher.api_path),ui.init(util.extend({},e),ketcher.server)};var ketcher=module.exports={version:"2.0.0-alpha.3",api_path:"",build_date:"2017-06-28 16-34-14",build_number:null,build_options:"__BUILD_NUMBER__",getSmiles:getSmiles,getMolfile:getMolfile,setMolecule:setMolecule,addFragment:addFragment,showMolfile:showMolfile,onStructChange:onStructChange};
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./api.js":7,"./chem":11,"./rnd":21,"./ui":34,"./util":39,"query-string":4}],19:[function(require,module,exports){
(function (global){
var Raphael=(typeof window !== "undefined" ? window['Raphael'] : typeof global !== "undefined" ? global['Raphael'] : null),Vec2=require("./util/vec2");Raphael.el.translateAbs=function(t,a){this.delta=this.delta||new Vec2,this.delta.x+=t-0,this.delta.y+=a-0,this.transform("t"+this.delta.x.toString()+","+this.delta.y.toString())},Raphael.st.translateAbs=function(t,a){this.forEach(function(e){e.translateAbs(t,a)})},module.exports=Raphael;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./util/vec2":43}],20:[function(require,module,exports){
(function (global){
function bondFlipRequired(t,e){return e.type==chem.Struct.BOND.TYPE.SINGLE&&t.stereo==chem.Struct.BOND.STEREO.NONE&&e.stereo!=chem.Struct.BOND.STEREO.NONE&&ui.ctab.atoms.get(t.begin).neighbors.length<ui.ctab.atoms.get(t.end).neighbors.length}var Set=require("../util/set"),Vec2=require("../util/vec2"),Action=require("../ui/action"),element=require("../chem/element"),util=require("../util");require("../chem"),require("./restruct"),require("../ui");var rnd=global.rnd=global.rnd||{},chem=global.chem=global.chem||{},ui=global.ui;rnd.Editor=function(t){this.render=t,this._selectionHelper=new rnd.Editor.SelectionHelper(this)},rnd.Editor.prototype.selectAll=function(){var t={};for(var e in rnd.ReStruct.maps)t[e]=ui.render.ctab[e].ikeys();this._selectionHelper.setSelection(t)},rnd.Editor.prototype.deselectAll=function(){this._selectionHelper.setSelection()},rnd.Editor.prototype.hasSelection=function(t){if("selection"in this._selectionHelper)for(var e in this._selectionHelper.selection)if(this._selectionHelper.selection[e].length>0&&(!t||"sgroupData"!==e))return!0;return!1},rnd.Editor.prototype.getSelection=function(t){var e={};if("selection"in this._selectionHelper)for(var o in this._selectionHelper.selection)e[o]=this._selectionHelper.selection[o].slice(0);if(t){var i=this.render.ctab.molecule;"bonds"in e&&e.bonds.each(function(t){var o=i.bonds.get(t);e.atoms=e.atoms||[],e.atoms.indexOf(o.begin)<0&&e.atoms.push(o.begin),e.atoms.indexOf(o.end)<0&&e.atoms.push(o.end)},this),"atoms"in e&&"bonds"in e&&i.bonds.each(function(t){if(!("bonds"in e)||e.bonds.indexOf(t)<0){var o=i.bonds.get(t);e.atoms.indexOf(o.begin)>=0&&e.atoms.indexOf(o.end)>=0&&(e.bonds=e.bonds||[],e.bonds.push(t))}},this)}return e},rnd.Editor.prototype.getSelectionStruct=function(){console.assert(ui.ctab==this.render.ctab.molecule,"Another ctab");var t=ui.ctab,e=this.getSelection(!0),o=t.clone(Set.fromList(e.atoms),Set.fromList(e.bonds),!0);return t.rxnArrows.each(function(t,i){-1!=e.rxnArrows.indexOf(t)&&o.rxnArrows.add(i.clone())}),t.rxnPluses.each(function(t,i){-1!=e.rxnPluses.indexOf(t)&&o.rxnPluses.add(i.clone())}),o.isReaction=t.isReaction&&(o.rxnArrows.count()||o.rxnPluses.count()),o},rnd.Editor.SelectionHelper=function(t){this.editor=t},rnd.Editor.SelectionHelper.prototype.setSelection=function(t,e){if(!("selection"in this&&e)){this.selection={};for(var o in rnd.ReStruct.maps)this.selection[o]=[]}if(t&&"id"in t&&"map"in t&&(t[t.map]=t[t.map]||[]).push(t.id),t)for(var i in this.selection)if(i in t)for(var r=0;r<t[i].length;r++)this.selection[i].indexOf(t[i][r])<0&&this.selection[i].push(t[i][r]);this.editor.render.setSelection(this.selection),this.editor.render.update(),ui.updateClipboardButtons()},rnd.Editor.SelectionHelper.prototype.isSelected=function(t){var e=this.editor.render,o=e.ctab;if("frags"==t.map||"rgroups"==t.map){var i="frags"==t.map?o.frags.get(t.id).fragGetAtoms(e,t.id):o.rgroups.get(t.id).getAtoms(e);return!Object.isUndefined(this.selection.atoms)&&Set.subset(Set.fromList(i),Set.fromList(this.selection.atoms))}return"selection"in this&&!Object.isUndefined(this.selection[t.map])&&this.selection[t.map].indexOf(t.id)>-1},rnd.Editor.EditorTool=function(t){this.editor=t},rnd.Editor.EditorTool.prototype.processEvent=function(t,e,o){if("touches"in e&&1!=e.touches.length){if("lastEvent"in this.OnMouseDown0)return this.OnMouseUp0(e,o)}else{if(t+"0"in this)return this[t+"0"](e,o);if(t in this)return this[t](e,o);console.log("EditorTool.dispatchEvent: event '"+t+"' is not handled.")}},rnd.Editor.EditorTool.prototype.OnMouseDown=function(){},rnd.Editor.EditorTool.prototype.OnMouseMove=function(){},rnd.Editor.EditorTool.prototype.OnMouseUp=function(){},rnd.Editor.EditorTool.prototype.OnClick=function(){},rnd.Editor.EditorTool.prototype.OnDblClick=function(){},rnd.Editor.EditorTool.prototype.OnMouseLeave=function(){this.OnCancel()},rnd.Editor.EditorTool.prototype.OnKeyPress=function(){},rnd.Editor.EditorTool.prototype.OnCancel=function(){},rnd.Editor.EditorTool.prototype.OnMouseDown0=function(t){return!!ui.hideBlurredControls()||(this.OnMouseDown0.lastEvent=t,this.OnMouseMove0.lastEvent=t,"OnMouseDown"in this?this.OnMouseDown(t):void 0)},rnd.Editor.EditorTool.prototype.OnMouseMove0=function(t){if(this.OnMouseMove0.lastEvent=t,"OnMouseMove"in this)return this.OnMouseMove(t)},rnd.Editor.EditorTool.prototype.OnMouseUp0=function(t){if(!("lastEvent"in this.OnMouseDown0))return!0;"lastEvent"in this.OnMouseMove0&&(t=Object.clone(t),t.pageX=this.OnMouseMove0.lastEvent.pageX,t.pageY=this.OnMouseMove0.lastEvent.pageY);try{if("OnMouseUp"in this)return this.OnMouseUp(t)}finally{delete this.OnMouseDown0.lastEvent}},rnd.Editor.EditorTool.atom_label_map={atom_tool_any:"A",atom_tool_h:"H",atom_tool_c:"C",atom_tool_n:"N",atom_tool_o:"O",atom_tool_s:"S",atom_tool_p:"P",atom_tool_f:"F",atom_tool_br:"Br",atom_tool_cl:"Cl",atom_tool_i:"I"},rnd.Editor.EditorTool.prototype.OnKeyPress0=function(t,e){if("rgroup_tool_label"===e&&"lastEvent"in this.OnMouseMove0)return rnd.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,this.OnMouseMove0.lastEvent);if(e in rnd.Editor.EditorTool.atom_label_map){var o=rnd.Editor.EditorTool.atom_label_map[e],i=this.editor.getSelection();if(i&&"atoms"in i&&i.atoms.length>0)return ui.addUndoAction(Action.fromAtomsAttrs(i.atoms,{label:o},!0),!0),ui.render.update(),!0;var r=this.editor.render.findItem(this.OnMouseMove0.lastEvent);if(r)return r.label={label:o},"atoms"===r.map?ui.addUndoAction(Action.fromAtomsAttrs(r.id,r.label,!0),!0):-1==r.id&&ui.addUndoAction(Action.fromAtomAddition(ui.page2obj(this.OnMouseMove0.lastEvent),r.label),!0),ui.render.update(),!0}return"OnKeyPress"in this&&this.OnKeyPress(t)},rnd.Editor.EditorTool.prototype._calcAngle=function(t,e){var o=Vec2.diff(e,t),i=Math.atan2(o.y,o.x),r=i<0?-1:1,n=Math.floor(Math.abs(i)/(Math.PI/12))*(Math.PI/12);return i=r*(n+(Math.abs(i)-n<Math.PI/24?0:Math.PI/12))},rnd.Editor.EditorTool.prototype._calcNewAtomPos=function(t,e){var o=new Vec2(1,0).rotate(this._calcAngle(t,e));return o.add_(t),o},rnd.Editor.EditorTool.HoverHelper=function(t){this.editorTool=t},rnd.Editor.EditorTool.HoverHelper.prototype.hover=function(t){t&&"Canvas"==t.type&&(t=null),"ci"in this&&(!t||this.ci.type!=t.type||this.ci.id!=t.id)&&(this.editorTool.editor.render.highlightObject(this.ci,!1),delete this.ci),t&&this.editorTool.editor.render.highlightObject(t,!0)&&(this.ci=t)},rnd.Editor.LassoTool=function(t,e,o){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(e||0,t,o),this._sGroupHelper=new rnd.Editor.SGroupTool.SGroupHelper(t)},rnd.Editor.LassoTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.LassoTool.prototype.OnMouseDown=function(t){var e=this.editor.render,o=e.ctab,i=o.molecule;this._hoverHelper.hover(null);var r=this._lassoHelper.fragment||t.ctrlKey,n=this.editor.render.findItem(t,r?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]);if(n&&"Canvas"!=n.type){if(this._hoverHelper.hover(null),"onShowLoupe"in this.editor.render&&this.editor.render.onShowLoupe(!0),!this.editor._selectionHelper.isSelected(n))if("frags"==n.map){var s=o.frags.get(n.id);this.editor._selectionHelper.setSelection({atoms:s.fragGetAtoms(e,n.id),bonds:s.fragGetBonds(e,n.id)},t.shiftKey)}else if("sgroups"==n.map){var d=o.sgroups.get(n.id).item;this.editor._selectionHelper.setSelection({atoms:chem.SGroup.getAtoms(i,d),bonds:chem.SGroup.getBonds(i,d)},t.shiftKey)}else if("rgroups"==n.map){var a=o.rgroups.get(n.id);this.editor._selectionHelper.setSelection({atoms:a.getAtoms(e),bonds:a.getBonds(e)},t.shiftKey)}else this.editor._selectionHelper.setSelection(n,t.shiftKey);if(this.dragCtx={item:n,xy0:ui.page2obj(t)},"atoms"==n.map&&!ui.is_touch){var l=this;this.dragCtx.timeout=setTimeout(function(){delete l.dragCtx,l.editor._selectionHelper.setSelection(null),ui.showLabelEditor(n.id)},750),this.dragCtx.stopTapping=function(){"timeout"in l.dragCtx&&(clearTimeout(l.dragCtx.timeout),delete l.dragCtx.timeout)}}}else this._lassoHelper.fragment||this._lassoHelper.begin(t);return!0},rnd.Editor.LassoTool.prototype.OnMouseMove=function(t){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),this.dragCtx.action&&(this.dragCtx.action.perform(),this.editor.render.update()),this.dragCtx.action=Action.fromMultipleMove(this.editor.getSelection(!0),ui.page2obj(t).sub(this.dragCtx.xy0)),["atoms"].indexOf(this.dragCtx.item.map)>=0){var e=this.editor.render.findItem(t,[this.dragCtx.item.map],this.dragCtx.item);this._hoverHelper.hover(e.map==this.dragCtx.item.map?e:null)}this.editor.render.update()}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t),t.shiftKey):this._hoverHelper.hover(this.editor.render.findItem(t,this._lassoHelper.fragment||t.ctrlKey?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]));return!0},rnd.Editor.LassoTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),["atoms"].indexOf(this.dragCtx.item.map)>=0){var e=this.editor.render.findItem(t,[this.dragCtx.item.map],this.dragCtx.item);e.map==this.dragCtx.item.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(),this.dragCtx.action=this.dragCtx.action?Action.fromAtomMerge(this.dragCtx.item.id,e.id).mergeWith(this.dragCtx.action):Action.fromAtomMerge(this.dragCtx.item.id,e.id))}ui.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.end(),t.shiftKey):this._lassoHelper.fragment&&this.editor._selectionHelper.setSelection();return!0},rnd.Editor.LassoTool.prototype.OnDblClick=function(t){var e=this.editor.render.findItem(t);if("atoms"==e.map){this.editor._selectionHelper.setSelection(e);var o=ui.ctab.atoms.get(e.id);"R#"==o.label?rnd.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,t):"L#"==o.label?ui.showElemTable({selection:o,onOk:function(t){return o.label==t.label&&o.atomList.equals(t.atomList)||(ui.addUndoAction(Action.fromAtomsAttrs(e.id,t)),ui.render.update()),!0}.bind(this)}):(element.getElementByLabel(o.label)||121)<120?ui.showAtomProperties(e.id):ui.showReaGenericsTable({values:[o.label],onOk:function(t){var i=t.values[0];return o.label!=i&&(ui.addUndoAction(Action.fromAtomsAttrs(e.id,{label:i})),ui.render.update()),!0}.bind(this)})}else"bonds"==e.map?(this.editor._selectionHelper.setSelection(e),ui.showBondProperties(e.id)):"sgroups"==e.map&&(this.editor._selectionHelper.setSelection(e),this._sGroupHelper.showPropertiesDialog(e.id));return!0},rnd.Editor.LassoTool.prototype.OnCancel=function(){"dragCtx"in this?("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),ui.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx):this._lassoHelper.running()&&this.editor._selectionHelper.setSelection(this._lassoHelper.end()),this._hoverHelper.hover(null)},rnd.Editor.LassoTool.LassoHelper=function(t,e,o){this.mode=t,this.fragment=o,this.editor=e},rnd.Editor.LassoTool.LassoHelper.prototype.getSelection=function(){if(0==this.mode)return ui.render.getElementsInPolygon(this.points);if(1==this.mode)return ui.render.getElementsInRectangle(this.points[0],this.points[1]);throw new Error("Selector mode unknown")},rnd.Editor.LassoTool.LassoHelper.prototype.begin=function(t){this.points=[ui.page2obj(t)],1==this.mode&&this.points.push(this.points[0])},rnd.Editor.LassoTool.LassoHelper.prototype.running=function(){return"points"in this},rnd.Editor.LassoTool.LassoHelper.prototype.addPoint=function(t){return!!this.running()&&(0==this.mode?(this.points.push(ui.page2obj(t)),this.editor.render.drawSelectionPolygon(this.points)):1==this.mode&&(this.points=[this.points[0],ui.page2obj(t)],this.editor.render.drawSelectionRectangle(this.points[0],this.points[1])),this.getSelection())},rnd.Editor.LassoTool.LassoHelper.prototype.end=function(){var t=this.getSelection();return"points"in this&&(this.editor.render.drawSelectionPolygon(null),delete this.points),t},rnd.Editor.EraserTool=function(t,e){this.editor=t,this.maps=["atoms","bonds","rxnArrows","rxnPluses","sgroups","sgroupData","chiralFlags"],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(e||0,t)},rnd.Editor.EraserTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.EraserTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,this.maps);e&&"Canvas"!=e.type||this._lassoHelper.begin(t)},rnd.Editor.EraserTool.prototype.OnMouseMove=function(t){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t)):this._hoverHelper.hover(this.editor.render.findItem(t,this.maps))},rnd.Editor.EraserTool.prototype.OnMouseUp=function(t){if(this._lassoHelper.running())ui.addUndoAction(Action.fromFragmentDeletion(this._lassoHelper.end(t))),this.editor.deselectAll(),ui.render.update();else{var e=this.editor.render.findItem(t,this.maps);if(e&&"Canvas"!=e.type){if(this._hoverHelper.hover(null),"atoms"==e.map)ui.addUndoAction(Action.fromAtomDeletion(e.id));else if("bonds"==e.map)ui.addUndoAction(Action.fromBondDeletion(e.id));else if("sgroups"==e.map||"sgroupData"==e.map)ui.addUndoAction(Action.fromSgroupDeletion(e.id));else if("rxnArrows"==e.map)ui.addUndoAction(Action.fromArrowDeletion(e.id));else if("rxnPluses"==e.map)ui.addUndoAction(Action.fromPlusDeletion(e.id));else{if("chiralFlags"!=e.map)return void console.log("EraserTool: unable to delete the object "+e.map+"["+e.id+"]");ui.addUndoAction(Action.fromChiralFlagDeletion())}this.editor.deselectAll(),ui.render.update()}}},rnd.Editor.AtomTool=function(t,e){this.editor=t,this.atomProps=e,this.bondProps={type:1,stereo:chem.Struct.BOND.STEREO.NONE},this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.AtomTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.AtomTool.prototype.OnMouseDown=function(t){this._hoverHelper.hover(null);var e=this.editor.render.findItem(t,["atoms"]);e&&"Canvas"!=e.type?"atoms"==e.map&&(this.dragCtx={item:e,xy0:ui.page2obj(t)}):this.dragCtx={xy0:ui.page2obj(t)}},rnd.Editor.AtomTool.prototype.OnMouseMove=function(t){var e=this.editor,o=e.render;if("dragCtx"in this&&"item"in this.dragCtx){var i=this.dragCtx,r=this._calcNewAtomPos(o.atomGetPos(i.item.id),ui.page2obj(t));"action"in i&&i.action.perform();var n=Action.fromBondAddition(this.bondProps,i.item.id,Object.clone(this.atomProps),r,r);i.action=n[0],i.aid2=n[2],o.update()}else this._hoverHelper.hover(o.findItem(t,["atoms"]))},rnd.Editor.AtomTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){var e=this.dragCtx;ui.addUndoAction("action"in e?e.action:"item"in e?Action.fromAtomsAttrs(e.item.id,this.atomProps,!0):Action.fromAtomAddition(ui.page2obj(t),this.atomProps),!0),this.editor.render.update(),delete this.dragCtx}},rnd.Editor.BondTool=function(t,e){this.editor=t,this.atomProps={label:"C"},this.bondProps=e,this.plainBondTypes=[chem.Struct.BOND.TYPE.SINGLE,chem.Struct.BOND.TYPE.DOUBLE,chem.Struct.BOND.TYPE.TRIPLE],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.BondTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.BondTool.prototype.OnMouseDown=function(t){return this._hoverHelper.hover(null),this.dragCtx={xy0:ui.page2obj(t),item:this.editor.render.findItem(t,["atoms","bonds"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},rnd.Editor.BondTool.prototype.OnMouseMove=function(t){var e=this.editor,o=e.render;if("dragCtx"in this){var i=this.dragCtx;if(!("item"in i)||"atoms"==i.item.map){"action"in i&&i.action.perform();var r,n,s,d;"item"in i&&"atoms"==i.item.map?(r=i.item.id,n=o.findItem(t,["atoms"],i.item)):(r=this.atomProps,s=i.xy0,n=o.findItem(t,["atoms"]));var a=Number.MAX_VALUE;if(n&&"atoms"==n.map)n=n.id;else{n=this.atomProps;var l=ui.page2obj(t);a=Vec2.dist(i.xy0,l),s?d=this._calcNewAtomPos(s,l):s=this._calcNewAtomPos(o.atomGetPos(r),l)}return a>.3?i.action=Action.fromBondAddition(this.bondProps,r,n,s,d)[0]:delete i.action,o.update(),!0}}return this._hoverHelper.hover(o.findItem(t,["atoms","bonds"])),!0},rnd.Editor.BondTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){var e=this.dragCtx;if("action"in e)ui.addUndoAction(e.action);else if("item"in e){if("atoms"==e.item.map)ui.addUndoAction(Action.fromBondAddition(this.bondProps,e.item.id)[0]);else if("bonds"==e.item.map){var o=Object.clone(this.bondProps),i=ui.ctab.bonds.get(e.item.id);if(o.stereo!=chem.Struct.BOND.STEREO.NONE&&i.type==chem.Struct.BOND.TYPE.SINGLE&&o.type==chem.Struct.BOND.TYPE.SINGLE&&i.stereo==o.stereo)ui.addUndoAction(Action.fromBondFlipping(e.item.id));else{if(o.type===chem.Struct.BOND.TYPE.SINGLE&&i.stereo===chem.Struct.BOND.STEREO.NONE&&o.stereo===chem.Struct.BOND.STEREO.NONE){var r=this.plainBondTypes.indexOf(o.type)>=0?this.plainBondTypes:null;r&&(o.type=r[(r.indexOf(i.type)+1)%r.length])}ui.addUndoAction(Action.fromBondAttrs(e.item.id,o,bondFlipRequired(i,o)),!0)}}}else{var n=ui.page2obj(t),s=new Vec2(.5,0).rotate(this.bondProps.type==chem.Struct.BOND.TYPE.SINGLE?-Math.PI/6:0),d=Action.fromBondAddition(this.bondProps,{label:"C"},{label:"C"},{x:n.x-s.x,y:n.y-s.y},{x:n.x+s.x,y:n.y+s.y});ui.addUndoAction(d[0])}this.editor.render.update(),delete this.dragCtx}return!0},rnd.Editor.ChainTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ChainTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ChainTool.prototype.OnMouseDown=function(t){return this._hoverHelper.hover(null),this.dragCtx={xy0:ui.page2obj(t),item:this.editor.render.findItem(t,["atoms"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},rnd.Editor.ChainTool.prototype.OnMouseMove=function(t){var e=this.editor,o=e.render;if("dragCtx"in this){var i=this.dragCtx;"action"in i&&i.action.perform();var r="item"in i?o.atomGetPos(i.item.id):i.xy0,n=ui.page2obj(t);return i.action=Action.fromChain(r,this._calcAngle(r,n),Math.ceil(Vec2.diff(n,r).length()),"item"in i?i.item.id:null),o.update(),!0}return this._hoverHelper.hover(o.findItem(t,["atoms"])),!0},rnd.Editor.ChainTool.prototype.OnMouseUp=function(){return"dragCtx"in this&&("action"in this.dragCtx&&ui.addUndoAction(this.dragCtx.action),delete this.dragCtx),!0},rnd.Editor.ChainTool.prototype.OnCancel=function(){this.OnMouseUp()},rnd.Editor.TemplateTool=function(t,e){if(this.editor=t,this.template=e,!this.template.molecule){var o=chem.Molfile.parseCTFile(this.template.molfile);o.rescale();var i=new Vec2;o.atoms.each(function(t,e){i.add_(e.pp)}),this.template.molecule=o,this.template.xy0=i.scaled(1/o.atoms.count()),this.template.angle0=this._calcAngle(o.atoms.get(this.template.aid).pp,this.template.xy0);var r=o.bonds.get(this.template.bid);this.template.sign=this._getSign(o,r,this.template.xy0)}this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.TemplateTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.TemplateTool.prototype._getSign=function(t,e,o){var i=t.atoms.get(e.begin).pp,r=t.atoms.get(e.end).pp,n=Vec2.cross(Vec2.diff(i,r),Vec2.diff(o,r));return n>0?1:n<0?-1:0},rnd.Editor.TemplateTool.prototype.OnMouseDown=function(t){var e=this.editor,o=e.render;this._hoverHelper.hover(null),this.dragCtx={xy0:ui.page2obj(t),item:o.findItem(t,["atoms","bonds"])};var i=this.dragCtx,r=i.item;if(r&&"Canvas"!=r.type){if("bonds"==r.map){var n=o.ctab.molecule,s=new Vec2,d=n.bonds.get(r.id),a=o.atomGetAttr(d.begin,"fragment"),l=n.getFragmentIds(a),h=0,p=n.halfBonds.get(d.hb1).loop;if(p<0&&(p=n.halfBonds.get(d.hb2).loop),p>=0){var u=n.loops.get(p).hbs;u.each(function(t){s.add_(n.atoms.get(n.halfBonds.get(t).begin).pp),h++})}else Set.each(l,function(t){s.add_(n.atoms.get(t).pp),h++});i.v0=s.scaled(1/h);var c=this._getSign(n,d,i.v0);i.sign1=c||1,i.sign2=this.template.sign}}else delete i.item;return!0},rnd.Editor.TemplateTool.prototype.OnMouseMove=function(t){var e=this.editor,o=e.render;if("dragCtx"in this){var i,r,n,s=this.dragCtx,d=s.item,a=ui.page2obj(t);if(s.mouse_moved=!0,d&&"Canvas"!=d.type){if("atoms"==d.map)i=o.atomGetPos(d.id),n=Vec2.dist(i,a)>1;else if("bonds"==d.map){var l=o.ctab.molecule,h=l.bonds.get(d.id),p=this._getSign(l,h,a);return s.sign1*this.template.sign>0&&(p=-p),p==s.sign2&&s.action||("action"in s&&s.action.perform(),s.sign2=p,s.action=Action.fromTemplateOnBond(d.id,this.template,this._calcAngle,s.sign1*s.sign2>0),o.update()),!0}}else i=s.xy0;r=this._calcAngle(i,a);var u=Math.round(180/Math.PI*r);if("angle"in s&&s.angle==u){if(!("extra_bond"in s))return!0;if(s.extra_bond==n)return!0}return"action"in s&&s.action.perform(),s.angle=u,d&&"Canvas"!=d.type?"atoms"==d.map&&(s.action=Action.fromTemplateOnAtom(d.id,r,n,this.template,this._calcAngle),s.extra_bond=n):s.action=Action.fromTemplateOnCanvas(i,r,this.template),o.update(),!0}return this._hoverHelper.hover(o.findItem(t,["atoms","bonds"])),!0},rnd.Editor.TemplateTool.prototype.OnMouseUp=function(t){var e=this.editor,o=e.render;if("dragCtx"in this){var i=this.dragCtx,r=i.item;if(!i.action){if(r&&"Canvas"!=r.type)if("atoms"==r.map){var n=o.atomGetDegree(r.id);if(n>1)i.action=Action.fromTemplateOnAtom(r.id,null,!0,this.template,this._calcAngle);else if(1==n){var s=o.ctab.molecule,d=s.halfBonds.get(s.atoms.get(r.id).neighbors[0]).end,a=s.atoms.get(r.id),l=s.atoms.get(d);i.action=Action.fromTemplateOnAtom(r.id,this._calcAngle(l.pp,a.pp),!1,this.template,this._calcAngle)}else i.action=Action.fromTemplateOnAtom(r.id,0,!1,this.template,this._calcAngle)}else"bonds"==r.map&&(i.action=Action.fromTemplateOnBond(r.id,this.template,this._calcAngle,i.sign1*i.sign2>0));else i.action=Action.fromTemplateOnCanvas(i.xy0,0,this.template);o.update()}"action"in this.dragCtx&&(this.dragCtx.action.isDummy()||ui.addUndoAction(this.dragCtx.action)),delete this.dragCtx}},rnd.Editor.TemplateTool.prototype.OnCancel=function(){this.OnMouseUp()},rnd.Editor.ChargeTool=function(t,e){this.editor=t,this.charge=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ChargeTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ChargeTool.prototype.OnMouseMove=function(t){var e=this.editor.render.findItem(t,["atoms"]);return e&&"atoms"==e.map&&null!=element.getElementByLabel(ui.ctab.atoms.get(e.id).label)?this._hoverHelper.hover(e):this._hoverHelper.hover(null),!0},rnd.Editor.ChargeTool.prototype.OnMouseUp=function(t){var e=this.editor,o=e.render,i=o.findItem(t,["atoms"]);return i&&"atoms"==i.map&&null!=element.getElementByLabel(ui.ctab.atoms.get(i.id).label)&&(this._hoverHelper.hover(null),ui.addUndoAction(Action.fromAtomsAttrs(i.id,{charge:o.ctab.molecule.atoms.get(i.id).charge+this.charge})),o.update()),!0},rnd.Editor.RGroupAtomTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.RGroupAtomTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RGroupAtomTool.prototype.OnMouseMove=function(t){this._hoverHelper.hover(this.editor.render.findItem(t,["atoms"]))},rnd.Editor.RGroupAtomTool.prototype.OnMouseUp=function(t){function e(t){var e=0;return t.values.forEach(function(t){var o=t.substr(1)-1;e|=1<<o}),e}var o=this.editor.render.findItem(t,["atoms"]);if(!o||"Canvas"==o.type)return this._hoverHelper.hover(null),ui.showRGroupTable({mode:"multiple",onOk:function(t){(t=e(t))&&(ui.addUndoAction(Action.fromAtomAddition(ui.page2obj(this.OnMouseMove0.lastEvent),{label:"R#",rglabel:t}),!0),ui.render.update())}.bind(this)}),!0;if(o&&"atoms"==o.map){this._hoverHelper.hover(null);var i=this.editor.render.ctab.molecule.atoms.get(o.id),r=i.label,n=i.rglabel;return ui.showRGroupTable({mode:"multiple",values:function(t){for(var e=[],o=0;o<32;o++)if(t&1<<o){var i="R"+(o+1);e.push(i)}return e}(n),onOk:function(t){if(t=e(t),n!=t||"R#"!=r){var s=Object.clone(chem.Struct.Atom.attrlist);t?(s.label="R#",s.rglabel=t,s.aam=i.aam):(s.label="C",s.aam=i.aam),ui.addUndoAction(Action.fromAtomsAttrs(o.id,s),!0),ui.render.update()}}.bind(this)}),!0}},rnd.Editor.RGroupFragmentTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.RGroupFragmentTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RGroupFragmentTool.prototype.OnMouseMove=function(t){this._hoverHelper.hover(this.editor.render.findItem(t,["frags","rgroups"]))},rnd.Editor.RGroupFragmentTool.prototype.OnMouseUp=function(t){var e=this.editor.render.findItem(t,["frags","rgroups"]);if(e&&"frags"==e.map){this._hoverHelper.hover(null);var o=chem.Struct.RGroup.findRGroupByFragment(this.editor.render.ctab.molecule.rgroups,e.id);return ui.showRGroupTable({values:o&&["R"+o],onOk:function(t){console.assert(t.values.length<=1,"Too much elements"),t=t.values.length?t.values[0].substr(1)-0:0,o!=t&&(ui.addUndoAction(Action.fromRGroupFragment(t,e.id),!0),ui.render.update())}.bind(this)}),!0}if(e&&"rgroups"==e.map){this._hoverHelper.hover(null);var i=this.editor.render.ctab.molecule.rgroups.get(e.id),r=0;this.editor.render.ctab.molecule.rgroups.each(function(t){r|=1<<t-1});var n={occurrence:i.range,resth:i.resth,ifthen:i.ifthen};return ui.showRLogicTable({rgid:e.id,rlogic:n,rgmask:r,onOk:function(t){var o={};if(n.occurrence!=t.occurrence){if(!t.occurrence.split(",").all(function(t){return t.match(/^[>,<,=]?[0-9]+$/g)||t.match(/^[0-9]+\-[0-9]+$/g)}))return alert("Bad occurrence value"),!1;o.range=t.occurrence}return n.resth!=t.resth&&(o.resth=t.resth),n.ifthen!=t.ifthen&&(o.ifthen=t.ifthen),("range"in o||"resth"in o||"ifthen"in o)&&(ui.addUndoAction(Action.fromRGroupAttrs(e.id,o)),this.editor.render.update()),!0}.bind(this)}),!0}},rnd.Editor.APointTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.APointTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.APointTool.prototype.OnMouseMove=function(t){this._hoverHelper.hover(this.editor.render.findItem(t,["atoms"]))},rnd.Editor.APointTool.prototype.OnMouseUp=function(t){var e=this.editor.render.findItem(t,["atoms"]);if(e&&"atoms"==e.map){this._hoverHelper.hover(null);var o=this.editor.render.ctab.molecule.atoms.get(e.id).attpnt;return ui.showAtomAttachmentPoints({selection:o,onOk:function(t){o!=t&&(ui.addUndoAction(Action.fromAtomsAttrs(e.id,{attpnt:t}),!0),ui.render.update())}.bind(this)}),!0}},rnd.Editor.ReactionArrowTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ReactionArrowTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionArrowTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,["rxnArrows"]);e&&"rxnArrows"==e.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(e),this.dragCtx={xy0:ui.page2obj(t)})},rnd.Editor.ReactionArrowTool.prototype.OnMouseMove=function(t){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=Action.fromMultipleMove(this.editor._selectionHelper.selection,ui.page2obj(t).sub(this.dragCtx.xy0)),ui.render.update()):this._hoverHelper.hover(this.editor.render.findItem(t,["rxnArrows"]))},rnd.Editor.ReactionArrowTool.prototype.OnMouseUp=function(t){"dragCtx"in this?(ui.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):this.editor.render.ctab.molecule.rxnArrows.count()<1&&(ui.addUndoAction(Action.fromArrowAddition(ui.page2obj(t))),this.editor.render.update())},rnd.Editor.ReactionPlusTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ReactionPlusTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionPlusTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,["rxnPluses"]);e&&"rxnPluses"==e.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(e),this.dragCtx={xy0:ui.page2obj(t)})},rnd.Editor.ReactionPlusTool.prototype.OnMouseMove=function(t){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=Action.fromMultipleMove(this.editor._selectionHelper.selection,ui.page2obj(t).sub(this.dragCtx.xy0)),ui.render.update()):this._hoverHelper.hover(this.editor.render.findItem(t,["rxnPluses"]))},rnd.Editor.ReactionPlusTool.prototype.OnMouseUp=function(t){"dragCtx"in this?(ui.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):(ui.addUndoAction(Action.fromPlusAddition(ui.page2obj(t))),this.editor.render.update())},rnd.Editor.ReactionMapTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null),this.rcs=chem.MolfileSaver.getComponents(this.editor.render.ctab.molecule)},rnd.Editor.ReactionMapTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionMapTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,["atoms"]);e&&"atoms"==e.map&&(this._hoverHelper.hover(null),this.dragCtx={item:e,xy0:ui.page2obj(t)})},rnd.Editor.ReactionMapTool.prototype.OnMouseMove=function(t){var e=this.editor.render;if("dragCtx"in this){var o=e.findItem(t,["atoms"],this.dragCtx.item);o&&"atoms"==o.map&&this._isValidMap(this.dragCtx.item.id,o.id)?(this._hoverHelper.hover(o),e.drawSelectionLine(e.atomGetPos(this.dragCtx.item.id),e.atomGetPos(o.id))):(this._hoverHelper.hover(null),e.drawSelectionLine(e.atomGetPos(this.dragCtx.item.id),ui.page2obj(t)))}else this._hoverHelper.hover(e.findItem(t,["atoms"]))},rnd.Editor.ReactionMapTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){var e=this.editor.render,o=e.findItem(t,["atoms"],this.dragCtx.item);if(o&&"atoms"==o.map&&this._isValidMap(this.dragCtx.item.id,o.id)){var i=new Action,r=e.ctab.molecule.atoms,n=r.get(this.dragCtx.item.id),s=r.get(o.id),d=n.aam,a=s.aam;if(!d||d!=a){if((d&&d!=a||!d&&a)&&r.each(function(t,e){t!=this.dragCtx.item.id&&(d&&e.aam==d||a&&e.aam==a)&&i.mergeWith(Action.fromAtomsAttrs(t,{aam:0}))},this),d)i.mergeWith(Action.fromAtomsAttrs(o.id,{aam:d}));else{var l=0;r.each(function(t,e){l=Math.max(l,e.aam||0)}),i.mergeWith(Action.fromAtomsAttrs(this.dragCtx.item.id,{aam:l+1})),i.mergeWith(Action.fromAtomsAttrs(o.id,{aam:l+1}))}ui.addUndoAction(i,!0),e.update()}}e.drawSelectionLine(null),delete this.dragCtx}this._hoverHelper.hover(null)},rnd.Editor.ReactionMapTool.prototype._isValidMap=function(t,e){for(var o,i,r=0;(!o||!i)&&r<this.rcs.reactants.length;r++){var n=Set.list(this.rcs.reactants[r]);!o&&n.indexOf(t)>=0&&(o="r"),!i&&n.indexOf(e)>=0&&(i="r")}for(var s=0;(!o||!i)&&s<this.rcs.products.length;s++){var d=Set.list(this.rcs.products[s]);!o&&d.indexOf(t)>=0&&(o="p"),!i&&d.indexOf(e)>=0&&(i="p")}return o&&i&&o!=i},rnd.Editor.ReactionUnmapTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null)},rnd.Editor.ReactionUnmapTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionUnmapTool.prototype.OnMouseMove=function(t){var e=this.editor.render.findItem(t,["atoms"]);e&&"atoms"==e.map?this._hoverHelper.hover(this.editor.render.ctab.molecule.atoms.get(e.id).aam?e:null):this._hoverHelper.hover(null)},rnd.Editor.ReactionUnmapTool.prototype.OnMouseUp=function(t){var e=this.editor.render.findItem(t,["atoms"]),o=this.editor.render.ctab.molecule.atoms;if(e&&"atoms"==e.map&&o.get(e.id).aam){var i=new Action,r=o.get(e.id).aam;o.each(function(t,e){e.aam==r&&i.mergeWith(Action.fromAtomsAttrs(t,{aam:0}))},this),ui.addUndoAction(i,!0),this.editor.render.update()}this._hoverHelper.hover(null)},rnd.Editor.SGroupTool=function(t){this.editor=t,this.maps=["atoms","bonds","sgroups","sgroupData"],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(1,t),this._sGroupHelper=new rnd.Editor.SGroupTool.SGroupHelper(t)
;var e=this.editor.getSelection();e.atoms&&e.atoms.length>0?this._sGroupHelper.showPropertiesDialog(null,e):this.editor.deselectAll()},rnd.Editor.SGroupTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.SGroupTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,this.maps);e&&"Canvas"!=e.type||this._lassoHelper.begin(t)},rnd.Editor.SGroupTool.prototype.OnMouseMove=function(t){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t)):this._hoverHelper.hover(this.editor.render.findItem(t,this.maps))},rnd.Editor.SGroupTool.SGroupHelper=function(t){this.editor=t,this.selection=null},rnd.Editor.SGroupTool.SGroupHelper.prototype.showPropertiesDialog=function(t,e){this.selection=e;var o=this.editor.render;if(null==t){var i={},r={};if(e.atoms.each(function(t){r[t]=!0},this),!Object.isUndefined(e.atoms.detect(function(t){var n=o.atomGetSGroups(t);return!Object.isUndefined(n.detect(function(t){if(t in i)return!1;var n=o.sGroupGetAtoms(t);if(n.length<e.atoms.length){if(!Object.isUndefined(n.detect(function(t){return!(t in r)},this)))return!0}else if(!Object.isUndefined(e.atoms.detect(function(t){return-1==n.indexOf(t)},this)))return!0;return!1},this))},this)))return void alert("Partial S-group overlapping is not allowed.")}ui.showSGroupProperties({type:null!==t?ui.render.sGroupGetType(t):null,attrs:null!==t?ui.render.sGroupGetAttrs(t):{},onCancel:function(){this.editor.deselectAll()}.bind(this),onOk:function(e){null==t?(t=ui.render.ctab.molecule.sgroups.newId(),ui.addUndoAction(Action.fromSgroupAddition(e.type,this.selection.atoms,e.attrs,t),!0)):ui.addUndoAction(Action.fromSgroupType(t,e.type).mergeWith(Action.fromSgroupAttrs(t,e.attrs)),!0),this.editor.deselectAll(),this.editor.render.update()}.bind(this)})},rnd.Editor.SGroupTool.prototype.OnMouseUp=function(t){var e=null,o=null;if(this._lassoHelper.running())o=this._lassoHelper.end(t);else{var i=this.editor.render.findItem(t,this.maps);if(!i||"Canvas"==i.type)return;if(this._hoverHelper.hover(null),"atoms"==i.map)o={atoms:[i.id]};else if("bonds"==i.map){var r=this.editor.render.ctab.bonds.get(i.id);o={atoms:[r.b.begin,r.b.end]}}else{if("sgroups"!=i.map)return;e=i.id}}(null!=e||o&&o.atoms&&o.atoms.length>0)&&this._sGroupHelper.showPropertiesDialog(e,o)},rnd.Editor.PasteTool=function(t,e){this.editor=t,this.struct=e,this.action=Action.fromPaste(this.struct,"lastEvent"in this.OnMouseMove0?ui.page2obj(this.OnMouseMove0.lastEvent):void 0),this.editor.render.update()},rnd.Editor.PasteTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.PasteTool.prototype.OnMouseMove=function(t){"action"in this&&this.action.perform(this.editor),this.action=Action.fromPaste(this.struct,ui.page2obj(t)),this.editor.render.update()},rnd.Editor.PasteTool.prototype.OnMouseUp=function(){ui.addUndoAction(this.action),delete this.action,ui.selectAction(null)},rnd.Editor.PasteTool.prototype.OnCancel=function(){"action"in this&&(this.action.perform(this.editor),delete this.action)},rnd.Editor.RotateTool=function(t){this.editor=t,this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(1,t);var e=this.editor._selectionHelper.selection;e.atoms&&e.atoms.length||this.editor._selectionHelper.setSelection(null)},rnd.Editor.RotateTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RotateTool.prototype.OnMouseDown=function(t){var e=this.editor._selectionHelper.selection;if(e.atoms&&e.atoms.length){var o=this.editor.render.ctab.molecule,i=new Vec2;if(!e.atoms||!e.atoms.length)return!0;var r=null,n=!1;e.atoms.each(function(t){var s=o.atoms.get(t);i.add_(s.pp),n||s.neighbors.find(function(i){var s=o.halfBonds.get(i);if(-1==e.atoms.indexOf(s.end)){if(s.loop>=0){var d=o.atoms.get(t);if(!Object.isUndefined(d.neighbors.find(function(t){var i=o.halfBonds.get(t);return i.loop>=0&&-1!=e.atoms.indexOf(i.end)})))return n=!0,!0}if(null==r)r=t;else if(r!=t)return n=!0,!0}return!1})}),i=n||null==r?i.scaled(1/e.atoms.length):o.atoms.get(r).pp,this.dragCtx={xy0:i,angle1:this._calcAngle(i,ui.page2obj(t)),all:n}}else this._lassoHelper.begin(t);return!0},rnd.Editor.RotateTool.prototype.OnMouseMove=function(t){if(this._lassoHelper.running())this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t));else if("dragCtx"in this){var e=this.editor,o=e.render,i=this.dragCtx,r=ui.page2obj(t),n=this._calcAngle(i.xy0,r)-i.angle1,s=Math.round(n/Math.PI*180);if(s>180?s-=360:s<=-180&&(s+=360),"angle"in i&&i.angle==s)return!0;"action"in i&&i.action.perform(),i.angle=s,i.action=Action.fromRotate(i.all?o.ctab.molecule:this.editor.getSelection(),i.xy0,n),$("toolText").update(s+""),o.update()}return!0},rnd.Editor.RotateTool.prototype.OnMouseUp=function(t){return this._lassoHelper.running()?this._lassoHelper.end(t):"dragCtx"in this&&("action"in this.dragCtx?(ui.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")):this.editor._selectionHelper.setSelection(),delete this.dragCtx),!0},rnd.Editor.RotateTool.prototype.OnCancel=function(){"dragCtx"in this&&("action"in this.dragCtx&&(ui.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")),delete this.dragCtx)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../chem/element":10,"../ui":34,"../ui/action":26,"../util":39,"../util/set":42,"../util/vec2":43,"./restruct":23}],21:[function(require,module,exports){
(function (global){
require("./visel"),require("./restruct"),require("./editor"),require("./render"),require("./restruct_rendering"),global.rnd=global.rnd||{};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./editor":20,"./render":22,"./restruct":23,"./restruct_rendering":24,"./visel":25}],22:[function(require,module,exports){
(function (global){
var Raphael=require("../raphael-ext.js"),Box2Abs=require("../util/box2abs"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util");require("./restruct"),require("../ui"),require("../chem"),require("./restruct_rendering");var rnd=global.rnd=global.rnd||{},chem=global.chem=global.chem||{},ui=global.ui,tfx=util.tfx;rnd.DEBUG=!1,rnd.logcnt=0,rnd.logmouse=!1,rnd.hl=!1;var EventMap={mousemove:"mousemove",mousedown:"mousedown",mouseup:"mouseup"};rnd.logMethod=function(){},rnd.RenderDummy=function(t,e,o,s){this.clientArea=t=$(t),t.innerHTML="",this.paper=new Raphael(t),this.paper.rect(0,0,100,100).attr({fill:"#0F0",stroke:"none"}),this.setMolecule=function(){},this.update=function(){}},rnd.RenderOptions=function(t){t=t||{},this.showSelectionRegions=t.showSelectionRegions||!1,this.showAtomIds=t.showAtomIds||!1,this.showBondIds=t.showBondIds||!1,this.showHalfBondIds=t.showHalfBondIds||!1,this.showLoopIds=t.showLoopIds||!1,this.hideChiralFlag=t.hideChiralFlag||!1,this.showValenceWarnings=!!Object.isUndefined(t.showValenceWarnings)||t.showValenceWarnings,this.autoScale=t.autoScale||!1,this.autoScaleMargin=t.autoScaleMargin||0,this.maxBondLength=t.maxBondLength||0,this.atomColoring=t.atomColoring||0,this.hideImplicitHydrogen=t.hideImplicitHydrogen||!1,this.hideTerminalLabels=t.hideTerminalLabels||!1,this.ignoreMouseEvents=t.ignoreMouseEvents||!1,this.selectionDistanceCoefficient=(t.selectionDistanceCoefficient||.4)-0},rnd.Render=function(t,e,o,s){this.opt=new rnd.RenderOptions(o),this.useOldZoom=Prototype.Browser.IE,this.scale=e||100,this.baseScale=this.scale,this.offset=new Vec2,this.clientArea=t=$(t),t.innerHTML="",this.paper=new Raphael(t),this.size=new Vec2,this.viewSz=s||new Vec2(t.clientWidth||100,t.clientHeight||100),this.bb=new Box2Abs(new Vec2,this.viewSz),this.dirty=!0,this.selectionRect=null,this.rxnArrow=null,this.rxnMode=!1,this.zoom=1,this.structChangeHandlers=[];var n=this,i=0,r=0,a=t;do{i+=a.offsetTop||0,r+=a.offsetLeft||0,a=a.offsetParent}while(a);this.clientAreaPos=new Vec2(r,i);var h=this;h.longTapFlag=!1,h.longTapTimeout=null,h.longTapTouchstart=null,h.setLongTapTimeout=function(t){h.longTapFlag=!1,h.longTapTouchstart=t,h.longTapTimeout=setTimeout(function(){h.longTapFlag=!0,h.longTapTimeout=null},500)},h.resetLongTapTimeout=function(t){clearTimeout(h.longTapTimeout),h.longTapTimeout=null,t&&(h.longTapTouchstart=null,h.longTapFlag=!1)},"hiddenPaths"in rnd.ReStruct.prototype&&t.observe("touchend",function(t){if(0==t.touches.length)for(;rnd.ReStruct.prototype.hiddenPaths.length>0;)rnd.ReStruct.prototype.hiddenPaths.pop().remove()}),this.opt.ignoreMouseEvents||(t.observe("selectstart",function(t){return util.stopEventPropagation(t),util.preventDefault(t)}),t.observe("touchstart",function(t){h.resetLongTapTimeout(!0),2==t.touches.length?(this._tui=this._tui||{},this._tui.center={pageX:(t.touches[0].pageX+t.touches[1].pageX)/2,pageY:(t.touches[0].pageY+t.touches[1].pageY)/2},ui.setZoomStaticPointInit(ui.page2obj(this._tui.center))):1==t.touches.length&&h.setLongTapTimeout(t)}),t.observe("touchmove",function(t){h.resetLongTapTimeout(!0),"_tui"in this&&2==t.touches.length&&(this._tui.center={pageX:(t.touches[0].pageX+t.touches[1].pageX)/2,pageY:(t.touches[0].pageY+t.touches[1].pageY)/2})}),t.observe("gesturestart",function(t){this._tui=this._tui||{},this._tui.scale0=ui.render.zoom,t.preventDefault()}),t.observe("gesturechange",function(t){ui.setZoomStaticPoint(this._tui.scale0*t.scale,ui.page2canvas2(this._tui.center)),ui.render.update(),t.preventDefault()}),t.observe("gestureend",function(t){delete this._tui,t.preventDefault()}),t.observe("onresize",function(t){n.onResize()}),["Click","DblClick","MouseDown","MouseMove","MouseUp","MouseLeave"].each(function(e){var o=e.toLowerCase();o=EventMap[o]||o,t.observe(o,function(s){if(!("MouseLeave"==e||ui&&ui.is_touch)){var n=t.cumulativeOffset();n=new Vec2(n[0],n[1]);var i=new Vec2(s.clientX,s.clientY).sub(n),r=new Vec2(t.clientWidth,t.clientHeight);if(!(i.x>0&&i.y>0&&i.x<r.x&&i.y<r.y))return"MouseMove"==e&&ui.render.current_tool.processEvent("OnMouseLeave",s),util.preventDefault(s)}if(ui.render.current_tool.processEvent("On"+e,s),"MouseUp"!=e&&util.stopEventPropagation(s),"touchstart"!=o&&("touchmove"!=o||2!=s.touches.length))return util.preventDefault(s)})},this)),this.ctab=new rnd.ReStruct(new chem.Struct,this),this.settings=null,this.styles=null,this.onCanvasOffsetChanged=null,this.onCanvasSizeChanged=null},rnd.Render.prototype.addStructChangeHandler=function(t){if(t in this.structChangeHandlers)throw new Error("handler already present");this.structChangeHandlers.push(t)},rnd.Render.prototype.view2scaled=function(t,e){var o=ui.scrollPos();return this.useOldZoom||(t=t.scaled(1/this.zoom),o=o.scaled(1/this.zoom)),t=e?t:t.add(o).sub(this.offset)},rnd.Render.prototype.scaled2view=function(t,e){return t=e?t:t.add(this.offset).sub(ui.scrollPos().scaled(1/this.zoom)),this.useOldZoom||(t=t.scaled(this.zoom)),t},rnd.Render.prototype.scaled2obj=function(t){return t.scaled(1/this.settings.scaleFactor)},rnd.Render.prototype.obj2scaled=function(t){return t.scaled(this.settings.scaleFactor)},rnd.Render.prototype.view2obj=function(t,e){return this.scaled2obj(this.view2scaled(t,e))},rnd.Render.prototype.obj2view=function(t,e){return this.scaled2view(this.obj2scaled(t,e))},rnd.Render.prototype.findItem=function(t,e,o){var s=this.findClosestItem("ui"in window&&"page2obj"in ui?new Vec2(ui.page2obj(t)):new Vec2(t.pageX,t.pageY).sub(this.clientAreaPos),e,o);return"Atom"==s.type?s.map="atoms":"Bond"==s.type?s.map="bonds":"SGroup"==s.type?s.map="sgroups":"DataSGroupData"==s.type?s.map="sgroupData":"RxnArrow"==s.type?s.map="rxnArrows":"RxnPlus"==s.type?s.map="rxnPluses":"Fragment"==s.type?s.map="frags":"RGroup"==s.type?s.map="rgroups":"ChiralFlag"==s.type&&(s.map="chiralFlags"),s},rnd.Render.prototype.client2Obj=function(t){return new Vec2(t).sub(this.offset)},rnd.Render.prototype.setMolecule=function(t,e){rnd.logMethod("setMolecule"),this.paper.clear(),this.ctab=new rnd.ReStruct(t,this,e),this.offset=null,this.size=null,this.bb=null,this.rxnMode=t.isReaction},rnd.Render.prototype.atomGetAttr=function(t,e){return rnd.logMethod("atomGetAttr"),this.ctab.molecule.atoms.get(t)[e]},rnd.Render.prototype.invalidateAtom=function(t,e){var o=this.ctab.atoms.get(t);this.ctab.markAtom(t,e?1:0);for(var s=this.ctab.molecule.halfBonds,n=0;n<o.a.neighbors.length;++n){var i=o.a.neighbors[n];if(s.has(i)){var r=s.get(i);this.ctab.markBond(r.bid,1),this.ctab.markAtom(r.end,0),e&&this.invalidateLoop(r.bid)}}},rnd.Render.prototype.invalidateLoop=function(t){var e=this.ctab.bonds.get(t),o=this.ctab.molecule.halfBonds.get(e.b.hb1).loop,s=this.ctab.molecule.halfBonds.get(e.b.hb2).loop;o>=0&&this.ctab.loopRemove(o),s>=0&&this.ctab.loopRemove(s)},rnd.Render.prototype.invalidateBond=function(t){var e=this.ctab.bonds.get(t);this.invalidateLoop(t),this.invalidateAtom(e.b.begin,0),this.invalidateAtom(e.b.end,0)},rnd.Render.prototype.invalidateItem=function(t,e,o){"atoms"==t?this.invalidateAtom(e,o):"bonds"==t?(this.invalidateBond(e),o>0&&this.invalidateLoop(e)):this.ctab.markItem(t,e,o)},rnd.Render.prototype.atomGetDegree=function(t){return rnd.logMethod("atomGetDegree"),this.ctab.atoms.get(t).a.neighbors.length},rnd.Render.prototype.isBondInRing=function(t){var e=this.ctab.bonds.get(t);return this.ctab.molecule.halfBonds.get(e.b.hb1).loop>=0||this.ctab.molecule.halfBonds.get(e.b.hb2).loop>=0},rnd.Render.prototype.atomGetNeighbors=function(t){for(var e=this.ctab.atoms.get(t),o=[],s=0;s<e.a.neighbors.length;++s){var n=this.ctab.molecule.halfBonds.get(e.a.neighbors[s]);o.push({aid:n.end-0,bid:n.bid-0})}return o},rnd.Render.prototype.atomGetSGroups=function(t){rnd.logMethod("atomGetSGroups");var e=this.ctab.atoms.get(t);return Set.list(e.a.sgs)},rnd.Render.prototype.sGroupGetAttr=function(t,e){return rnd.logMethod("sGroupGetAttr"),this.ctab.sgroups.get(t).item.getAttr(e)},rnd.Render.prototype.sGroupGetAttrs=function(t){return rnd.logMethod("sGroupGetAttrs"),this.ctab.sgroups.get(t).item.getAttrs()},rnd.Render.prototype.sGroupGetAtoms=function(t){rnd.logMethod("sGroupGetAtoms");var e=this.ctab.sgroups.get(t).item;return chem.SGroup.getAtoms(this.ctab.molecule,e)},rnd.Render.prototype.sGroupGetType=function(t){return rnd.logMethod("sGroupGetType"),this.ctab.sgroups.get(t).item.type},rnd.Render.prototype.sGroupsFindCrossBonds=function(){rnd.logMethod("sGroupsFindCrossBonds"),this.ctab.molecule.sGroupsRecalcCrossBonds()},rnd.Render.prototype.sGroupGetNeighborAtoms=function(t){return rnd.logMethod("sGroupGetNeighborAtoms"),this.ctab.sgroups.get(t).item.neiAtoms},rnd.Render.prototype.atomIsPlainCarbon=function(t){return rnd.logMethod("atomIsPlainCarbon"),this.ctab.atoms.get(t).a.isPlainCarbon()},rnd.Render.prototype.highlightObject=function(t,e){if(!(["atoms","bonds","rxnArrows","rxnPluses","chiralFlags","frags","rgroups","sgroups","sgroupData"].indexOf(t.map)>-1))return!1;var o=this.ctab[t.map].get(t.id);if(null==o)return!0;if("sgroups"==t.map&&"DAT"==o.item.type||"sgroupData"==t.map){var s=this.ctab.sgroups.get(t.id),n=this.ctab.sgroupData.get(t.id);null!=s&&s.setHighlight(e,this),null!=n&&n.setHighlight(e,this)}else o.setHighlight(e,this);return!0},rnd.Render.prototype.itemGetPos=function(t,e){return this.ctab.molecule[t].get(e).pp},rnd.Render.prototype.atomGetPos=function(t){return rnd.logMethod("atomGetPos"),this.itemGetPos("atoms",t)},rnd.Render.prototype.rxnArrowGetPos=function(t){return rnd.logMethod("rxnArrowGetPos"),this.itemGetPos("rxnArrows",t)},rnd.Render.prototype.rxnPlusGetPos=function(t){return rnd.logMethod("rxnPlusGetPos"),this.itemGetPos("rxnPluses",t)},rnd.Render.prototype.getAdjacentBonds=function(t){for(var e=Set.fromList(t),o=Set.empty(),s=Set.empty(),n=0;n<t.length;++n)for(var i=t[n],r=this.ctab.atoms.get(i),a=0;a<r.a.neighbors.length;++a){var h=r.a.neighbors[a],l=this.ctab.molecule.halfBonds.get(h),d=l.end,c=Set.contains(e,d)?o:s;Set.add(c,l.bid)}return{inner:o,cross:s}},rnd.Render.prototype.bondGetAttr=function(t,e){return rnd.logMethod("bondGetAttr"),this.ctab.bonds.get(t).b[e]},rnd.Render.prototype.setSelection=function(t){rnd.logMethod("setSelection");for(var e in rnd.ReStruct.maps)if(rnd.ReStruct.maps[e].isSelectable()){var o=t?t[e]?util.identityMap(t[e]):{}:null;this.ctab[e].each(function(t,e){var s=o?o[t]===t:e.selected;e.selected=s,this.ctab.showItemSelection(t,e,s)},this)}},rnd.Render.prototype.initStyles=function(){var t=this.settings;this.styles={},this.styles.lineattr={stroke:"#000","stroke-width":t.lineWidth,"stroke-linecap":"round","stroke-linejoin":"round"},this.styles.selectionStyle={fill:"#7f7",stroke:"none"},this.styles.selectionZoneStyle={fill:"#000",stroke:"none",opacity:0},this.styles.highlightStyle={stroke:"#0c0","stroke-width":.6*t.lineWidth},this.styles.sGroupHighlightStyle={stroke:"#9900ff","stroke-width":.6*t.lineWidth},this.styles.sgroupBracketStyle={stroke:"darkgray","stroke-width":.5*t.lineWidth},this.styles.atomSelectionPlateRadius=1.2*t.labelFontSize},rnd.Render.prototype.initSettings=function(){var t=this.settings={};t.delta=this.ctab.molecule.getCoordBoundingBox(),t.margin=.1,t.scaleFactor=this.scale,t.lineWidth=t.scaleFactor/20,t.bondShift=t.scaleFactor/6,t.bondSpace=t.scaleFactor/7,t.labelFontSize=Math.ceil(t.scaleFactor/6*1.9),t.subFontSize=Math.ceil(.7*t.labelFontSize),t.font='30px "Arial"',t.fontsz=this.settings.labelFontSize,t.fontszsub=this.settings.subFontSize,t.fontRLabel=1.2*this.settings.labelFontSize,t.fontRLogic=.7*this.settings.labelFontSize},rnd.Render.prototype.getStructCenter=function(t){var e=this.ctab.getVBoxObj(t);return Vec2.lc2(e.p0,.5,e.p1,.5)},rnd.Render.prototype.onResize=function(){this.setViewSize(new Vec2(this.clientArea.clientWidth,this.clientArea.clientHeight))},rnd.Render.prototype.setViewSize=function(t){this.viewSz=new Vec2(t)},rnd.Render.prototype._setPaperSize=function(t){var e=this.zoom;this.paper.setSize(t.x*e,t.y*e),this.setViewBox(e)},rnd.Render.prototype.setPaperSize=function(t){rnd.logMethod("setPaperSize");var e=this.sz;this.sz=t,this._setPaperSize(t),this.onCanvasSizeChanged&&this.onCanvasSizeChanged(t,e)},rnd.Render.prototype.setOffset=function(t){rnd.logMethod("setOffset"),this.onCanvasOffsetChanged&&this.onCanvasOffsetChanged(t,this.offset),this.offset=t},rnd.Render.prototype.getElementPos=function(t){var e=0,o=0;if(t.offsetParent)do{e+=t.offsetLeft,o+=t.offsetTop}while(t=t.offsetParent);return new Vec2(e,o)},rnd.Render.prototype.drawSelectionLine=function(t,e){rnd.logMethod("drawSelectionLine"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&e&&(t=this.obj2scaled(t).add(this.offset),e=this.obj2scaled(e).add(this.offset),this.selectionRect=this.paper.path(rnd.ReStruct.makeStroke(t,e)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.drawSelectionRectangle=function(t,e){rnd.logMethod("drawSelectionRectangle"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&e&&(t=this.obj2scaled(t).add(this.offset),e=this.obj2scaled(e).add(this.offset),this.selectionRect=this.paper.rect(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.abs(e.x-t.x),Math.abs(e.y-t.y)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.getElementsInRectangle=function(t,e){rnd.logMethod("getElementsInRectangle");var o=[],s=[],n=Math.min(t.x,e.x),i=Math.max(t.x,e.x),r=Math.min(t.y,e.y),a=Math.max(t.y,e.y);this.ctab.bonds.each(function(t,e){var s=Vec2.lc2(this.ctab.atoms.get(e.b.begin).a.pp,.5,this.ctab.atoms.get(e.b.end).a.pp,.5);s.x>n&&s.x<i&&s.y>r&&s.y<a&&o.push(t)},this),this.ctab.atoms.each(function(t,e){e.a.pp.x>n&&e.a.pp.x<i&&e.a.pp.y>r&&e.a.pp.y<a&&s.push(t)},this);var h=[],l=[];this.ctab.rxnArrows.each(function(t,e){e.item.pp.x>n&&e.item.pp.x<i&&e.item.pp.y>r&&e.item.pp.y<a&&h.push(t)},this),this.ctab.rxnPluses.each(function(t,e){e.item.pp.x>n&&e.item.pp.x<i&&e.item.pp.y>r&&e.item.pp.y<a&&l.push(t)},this);var d=[];this.ctab.chiralFlags.each(function(t,e){e.pp.x>n&&e.pp.x<i&&e.pp.y>r&&e.pp.y<a&&d.push(t)},this);var c=[];return this.ctab.sgroupData.each(function(t,e){e.sgroup.pp.x>n&&e.sgroup.pp.x<i&&e.sgroup.pp.y>r&&e.sgroup.pp.y<a&&c.push(t)},this),{atoms:s,bonds:o,rxnArrows:h,rxnPluses:l,chiralFlags:d,sgroupData:c}},rnd.Render.prototype.drawSelectionPolygon=function(t){if(rnd.logMethod("drawSelectionPolygon"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&t.length>1){for(var e=this.obj2scaled(t[t.length-1]).add(this.offset),o="M"+tfx(e.x)+","+tfx(e.y),s=0;s<t.length;++s)e=this.obj2scaled(t[s]).add(this.offset),o+="L"+tfx(e.x)+","+tfx(e.y);this.selectionRect=this.paper.path(o).attr({stroke:"gray","stroke-width":"1px"})}},rnd.Render.prototype.isPointInPolygon=function(t,e){for(var o=new Vec2(0,1),s=o.rotate(Math.PI/2),n=Vec2.diff(t[t.length-1],e),i=Vec2.dot(s,n),r=Vec2.dot(o,n),a=null,h=0,l=!1,d=!1,c=0;c<t.length;++c){var u=Vec2.diff(t[c],e),p=Vec2.diff(u,n),g=Vec2.dot(s,u),f=Vec2.dot(o,u);l=!1,g*i<0&&(f*r>-1e-5?r>-1e-5&&(l=!0):(Math.abs(i)*Math.abs(f)-Math.abs(g)*Math.abs(r))*f>0&&(l=!0)),l&&d&&Vec2.dot(p,s)*Vec2(a,s)>=0&&(l=!1),l&&h++,n=u,i=g,r=f,a=p,d=l}return h%2!=0},rnd.Render.prototype.ps=function(t){return t.scaled(this.settings.scaleFactor)},rnd.Render.prototype.getElementsInPolygon=function(t){rnd.logMethod("getElementsInPolygon");for(var e=[],o=[],s=[],n=0;n<t.length;++n)s[n]=new Vec2(t[n].x,t[n].y);this.ctab.bonds.each(function(t,o){var n=Vec2.lc2(this.ctab.atoms.get(o.b.begin).a.pp,.5,this.ctab.atoms.get(o.b.end).a.pp,.5);this.isPointInPolygon(s,n)&&e.push(t)},this),this.ctab.atoms.each(function(t,e){this.isPointInPolygon(s,e.a.pp)&&o.push(t)},this);var i=[],r=[];this.ctab.rxnArrows.each(function(t,e){this.isPointInPolygon(s,e.item.pp)&&i.push(t)},this),this.ctab.rxnPluses.each(function(t,e){this.isPointInPolygon(s,e.item.pp)&&r.push(t)},this);var a=[];this.ctab.chiralFlags.each(function(t,e){this.isPointInPolygon(s,e.pp)&&a.push(t)},this);var h=[];return this.ctab.sgroupData.each(function(t,e){this.isPointInPolygon(s,e.sgroup.pp)&&h.push(t)},this),{atoms:o,bonds:e,rxnArrows:i,rxnPluses:r,chiralFlags:a,sgroupData:h}},rnd.Render.prototype.testPolygon=function(t){if(t=t||[{x:50,y:10},{x:20,y:90},{x:90,y:30},{x:10,y:30},{x:90,y:80}],!(t.length<3)){for(var e=t[0],o=t[0],s=1;s<t.length;++s)e=Vec2.min(e,t[s]),o=Vec2.max(o,t[s]);this.drawSelectionPolygon(t);for(var n=0;n<1e3;++n){var i=new Vec2(10*Math.random(),10*Math.random()),r=this.isPointInPolygon(t,i),a=r?"#0f0":"#f00";this.paper.circle(i.x,i.y,2).attr({fill:a,stroke:"none"})}this.drawSelectionPolygon(t)}},rnd.Render.prototype.update=function(t){if(rnd.logMethod("update"),!this.settings||this.dirty){if(this.opt.autoScale){var e=this.ctab.molecule.getCoordBoundingBox(),o=e.max.y-e.min.y>0?.8*this.viewSz.y/(e.max.y-e.min.y):100,s=e.max.x-e.min.x>0?.8*this.viewSz.x/(e.max.x-e.min.x):100;this.scale=Math.min(o,s),this.opt.maxBondLength>0&&this.scale>this.opt.maxBondLength&&(this.scale=this.opt.maxBondLength)}this.initSettings(),this.initStyles(),this.dirty=!1,t=!0}var n=(new Date).getTime(),i=this.ctab.update(t);this.setSelection(null);var r=(new Date).getTime()-n;if(t&&$("log")&&($("log").innerHTML=r.toString()+"\n"),i){var a=this.settings.scaleFactor,h=this.ctab.getVBoxObj().transform(this.obj2scaled,this).translate(this.offset||new Vec2);if(this.opt.autoScale){var l=h.sz(),d=this.opt.autoScaleMargin,c=new Vec2(d,d),u=this.viewSz;if(u.x<2*d+1||u.y<2*d+1)throw new Error("View box too small for the given margin");var p=Math.max(l.x/(u.x-2*d),l.y/(u.y-2*d));this.opt.maxBondLength/p>1&&(p=1);var g=l.add(c.scaled(2*p));this.paper.setViewBox(h.pos().x-d*p-(u.x*p-g.x)/2,h.pos().y-d*p-(u.y*p-g.y)/2,u.x*p,u.y*p)}else{var f=Vec2.UNIT.scaled(a),m=h.sz().length()>0?h.extend(f,f):h;console.assert(ui.zoom==this.zoom);var b=new Box2Abs(ui.scrollPos(),this.viewSz.scaled(1/ui.zoom).sub(Vec2.UNIT.scaled(20))),y=Box2Abs.union(b,m);this.oldCb||(this.oldCb=new Box2Abs);var v=y.sz().floor(),x=this.oldCb.p0.sub(y.p0).ceil();this.oldBb=h,this.sz&&v.x==this.sz.x&&v.y==this.sz.y||this.setPaperSize(v),this.offset=this.offset||new Vec2,0==x.x&&0==x.y||(this.setOffset(this.offset.add(x)),this.ctab.translate(x))}}},rnd.Render.prototype.checkBondExists=function(t,e){return this.ctab.molecule.checkBondExists(t,e)},rnd.Render.prototype.findClosestAtom=function(t,e,o){var s=null,n=this.opt.selectionDistanceCoefficient;return e=e||n,e=Math.min(e,n),this.ctab.atoms.each(function(n,i){if(n!=o){var r=Vec2.dist(t,i.a.pp);r<e&&(s=n,e=r)}},this),null!=s?{id:s,dist:e}:null},rnd.Render.prototype.findClosestBond=function(t,e){var o=null,s=null,n=this.opt.selectionDistanceCoefficient;e=e||n,e=Math.min(e,n);var i=e;return this.ctab.bonds.each(function(e,o){var n=this.ctab.atoms.get(o.b.begin).a.pp,r=this.ctab.atoms.get(o.b.end).a.pp,a=Vec2.lc2(n,.5,r,.5),h=Vec2.dist(t,a);h<i&&(i=h,s=e)},this),this.ctab.bonds.each(function(s,n){var i=this.ctab.molecule.halfBonds.get(n.b.hb1),r=i.dir,a=i.norm,h=this.ctab.atoms.get(n.b.begin).a.pp,l=this.ctab.atoms.get(n.b.end).a.pp;if(Vec2.dot(t.sub(h),r)*Vec2.dot(t.sub(l),r)<0){var d=Math.abs(Vec2.dot(t.sub(h),a));d<e&&(o=s,e=d)}},this),null!==o||null!==s?{id:o,dist:e,cid:s,cdist:i}:null},rnd.Render.prototype.findClosestItem=function(t,e,o){var s=null,n=function(t,e,o){null!=e&&(null==s||s.dist>e.dist||o)&&(s={type:t,id:e.id,dist:e.dist})};if(!e||e.indexOf("atoms")>=0){n("Atom",this.findClosestAtom(t,void 0,Object.isUndefined(o)||"atoms"!=o.map?void 0:o.id))}if(!e||e.indexOf("bonds")>=0){var i=this.findClosestBond(t);i&&(null!==i.cid&&n("Bond",{id:i.cid,dist:i.cdist}),(null==s||s.dist>.4*this.scale)&&n("Bond",i))}if(!e||e.indexOf("chiralFlags")>=0){n("ChiralFlag",rnd.ReChiralFlag.findClosest(this,t))}if(!e||e.indexOf("sgroupData")>=0){n("DataSGroupData",rnd.ReDataSGroupData.findClosest(this,t))}if(!e||e.indexOf("sgroups")>=0){n("SGroup",rnd.ReSGroup.findClosest(this,t))}if(!e||e.indexOf("rxnArrows")>=0){n("RxnArrow",rnd.ReRxnArrow.findClosest(this,t))}if(!e||e.indexOf("rxnPluses")>=0){n("RxnPlus",rnd.ReRxnPlus.findClosest(this,t))}if(!e||e.indexOf("frags")>=0){n("Fragment",rnd.ReFrag.findClosest(this,t,o&&"atoms"==o.map?o.id:void 0))}if(!e||e.indexOf("rgroups")>=0){n("RGroup",rnd.ReRGroup.findClosest(this,t))}return s=s||{type:"Canvas",id:-1}},rnd.Render.prototype.setZoom=function(t){this.zoom=t,this._setPaperSize(this.sz)},rnd.Render.prototype.extendCanvas=function(t,e,o,s){var n=0,i=0,r=0,a=0;t-=0,o-=0,e-=0,s-=0,t<0&&(n+=-t,r+=-t),e<0&&(i+=-e,a+=-e);var h=this.sz.x*this.zoom,l=this.sz.y*this.zoom;h<o&&(n+=o-h),l<s&&(i+=s-l);var d=new Vec2(r,a).scaled(1/this.zoom);if(i>0||n>0){var c=new Vec2(n,i).scaled(1/this.zoom),u=this.sz.add(c);this.setPaperSize(u),(d.x>0||d.y>0)&&(this.ctab.translate(d),this.setOffset(this.offset.add(d)))}return d},rnd.Render.prototype.setScale=function(t){this.offset&&(this.offset=this.offset.scaled(1/t).scaled(this.zoom)),this.scale=this.baseScale*this.zoom,this.settings=null,this.update(!0)},rnd.Render.prototype.setViewBox=function(t){this.useOldZoom?this.setScale(t):this.paper.canvas.setAttribute("viewBox","0 0 "+this.sz.x+" "+this.sz.y)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../raphael-ext.js":19,"../ui":34,"../util":39,"../util/box2abs":38,"../util/set":42,"../util/vec2":43,"./restruct":23,"./restruct_rendering":24}],23:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Map=require("../util/map"),Pool=require("../util/pool"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),element=require("../chem/element");require("../chem");var rnd=global.rnd=global.rnd||{},chem=global.chem,tfx=util.tfx;rnd.ReObject=function(){this.__ext=new Vec2(.05*3,.05*3)},rnd.ReObject.prototype.init=function(t){this.visel=new rnd.Visel(t),this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null},rnd.ReObject.prototype.getVBoxObj=function(t){var e=this.visel.boundingBox;return util.isNull(e)?null:(t.offset&&(e=e.translate(t.offset.negated())),e.transform(t.scaled2obj,t))},rnd.ReObject.prototype.drawHighlight=function(t){console.log("ReObject.drawHighlight is not overridden")},rnd.ReObject.prototype.setHighlight=function(t,e){if(t){var n="highlighting"in this&&null!=this.highlighting;n&&(n="set"==this.highlighting.type?!this.highlighting[0].removed:!this.highlighting.removed),n=n&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(this.highlighting)<0),n?this.highlighting.show():(e.paper.setStart(),this.drawHighlight(e),this.highlighting=e.paper.setFinish())}else this.highlighting&&this.highlighting.hide();this.highlight=t},rnd.ReObject.prototype.makeSelectionPlate=function(t){console.log("ReObject.makeSelectionPlate is not overridden")},rnd.ReAtom=function(t){this.init(rnd.Visel.TYPE.ATOM),this.a=t,this.showLabel=!1,this.hydrogenOnTheLeft=!1,this.component=-1},rnd.ReAtom.prototype=new rnd.ReObject,rnd.ReAtom.isSelectable=function(){return!0},rnd.ReAtom.prototype.getVBoxObj=function(t){return this.visel.boundingBox?rnd.ReObject.prototype.getVBoxObj.call(this,t):new Box2Abs(this.a.pp,this.a.pp)},rnd.ReAtom.prototype.drawHighlight=function(t){var e=this.makeHighlightPlate(t);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReAtom.prototype.makeHighlightPlate=function(t){var e=t.paper,n=t.styles,r=t.ps(this.a.pp);return e.circle(r.x,r.y,n.atomSelectionPlateRadius).attr(n.highlightStyle)},rnd.ReAtom.prototype.makeSelectionPlate=function(t,e,n){var r=t.render.ps(this.a.pp);return e.circle(r.x,r.y,n.atomSelectionPlateRadius).attr(n.selectionStyle)},rnd.ReBond=function(t){this.init(rnd.Visel.TYPE.BOND),this.b=t,this.doubleBondShift=0},rnd.ReBond.prototype=new rnd.ReObject,rnd.ReBond.isSelectable=function(){return!0},rnd.ReBond.prototype.drawHighlight=function(t){var e=this.makeHighlightPlate(t);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReBond.prototype.makeHighlightPlate=function(t){t.ctab.bondRecalc(t.settings,this);var e=t.ps(this.b.center);return t.paper.circle(e.x,e.y,.8*t.styles.atomSelectionPlateRadius).attr(t.styles.highlightStyle)},rnd.ReBond.prototype.makeSelectionPlate=function(t,e,n){t.bondRecalc(t.render.settings,this);var r=t.render.ps(this.b.center);return e.circle(r.x,r.y,.8*n.atomSelectionPlateRadius).attr(n.selectionStyle)},rnd.ReStruct=function(t,e,n){this.render=e,this.atoms=new Map,this.bonds=new Map,this.reloops=new Map,this.rxnPluses=new Map,this.rxnArrows=new Map,this.frags=new Map,this.rgroups=new Map,this.sgroups=new Map,this.sgroupData=new Map,this.chiralFlags=new Map,this.molecule=t||new chem.Struct,this.initialized=!1,this.layers=[],this.initLayers(),this.connectedComponents=new Pool,this.ccFragmentType=new Map;for(var r in rnd.ReStruct.maps)this[r+"Changed"]={};if(this.structChanged=!1,t.atoms.each(function(t,e){this.atoms.set(t,new rnd.ReAtom(e))},this),t.bonds.each(function(t,e){this.bonds.set(t,new rnd.ReBond(e))},this),t.loops.each(function(t,e){this.reloops.set(t,new rnd.ReLoop(e))},this),t.rxnPluses.each(function(t,e){this.rxnPluses.set(t,new rnd.ReRxnPlus(e))},this),t.rxnArrows.each(function(t,e){this.rxnArrows.set(t,new rnd.ReRxnArrow(e))},this),t.frags.each(function(t,e){this.frags.set(t,new rnd.ReFrag(e))},this),t.rgroups.each(function(t,e){this.rgroups.set(t,new rnd.ReRGroup(e))},this),t.sgroups.each(function(t,e){this.sgroups.set(t,new rnd.ReSGroup(e)),"DAT"!=e.type||e.data.attached||this.sgroupData.set(t,new rnd.ReDataSGroupData(e))},this),t.isChiral&&!this.render.opt.hideChiralFlag){var i=t.getCoordBoundingBox();this.chiralFlags.set(0,new rnd.ReChiralFlag(new Vec2(i.max.x,i.min.y-1)))}this.coordProcess(n)},rnd.ReStruct.prototype.connectedComponentRemoveAtom=function(t,e){if(e=e||this.atoms.get(t),!(e.component<0)){var n=this.connectedComponents.get(e.component);Set.remove(n,t),Set.size(n)<1&&this.connectedComponents.remove(e.component),e.component=-1}},rnd.ReStruct.prototype.printConnectedComponents=function(){var t=[];this.connectedComponents.each(function(e,n){t.push(" "+e+":["+Set.list(n).toString()+"]."+Set.size(n).toString())},this),console.log(t.toString())},rnd.ReStruct.prototype.clearConnectedComponents=function(){this.connectedComponents.clear(),this.atoms.each(function(t,e){e.component=-1})},rnd.ReStruct.prototype.getConnectedComponent=function(t,e){for(var n="number"==typeof t.length?util.array(t):[t],r=Set.empty();n.length>0;)(function(){var t=n.pop();Set.add(r,t);var i=this.atoms.get(t);i.component>=0&&Set.add(e,i.component);for(var o=0;o<i.a.neighbors.length;++o){var s=this.molecule.halfBonds.get(i.a.neighbors[o]).end;Set.contains(r,s)||n.push(s)}}).apply(this);return r},rnd.ReStruct.prototype.addConnectedComponent=function(t){var e=this.connectedComponents.add(t),n=Set.empty(),r=this.getConnectedComponent(Set.list(t),n);Set.remove(n,e);var i=-1;return Set.each(r,function(t){var n=this.atoms.get(t);if(n.component=e,-1!=n.a.rxnFragmentType){if(-1!=i&&n.a.rxnFragmentType!=i)throw new Error("reaction fragment type mismatch");i=n.a.rxnFragmentType}},this),this.ccFragmentType.set(e,i),e},rnd.ReStruct.prototype.removeConnectedComponent=function(t){return Set.each(this.connectedComponents.get(t),function(t){this.atoms.get(t).component=-1},this),this.connectedComponents.remove(t)},rnd.ReStruct.prototype.connectedComponentMergeIn=function(t,e){Set.each(e,function(e){this.atoms.get(e).component=t},this),Set.mergeIn(this.connectedComponents.get(t),e)},rnd.ReStruct.prototype.assignConnectedComponents=function(){this.atoms.each(function(t,e){if(!(e.component>=0)){var n=Set.empty(),r=this.getConnectedComponent(t,n);Set.each(n,function(t){this.removeConnectedComponent(t)},this),this.addConnectedComponent(r)}},this)},rnd.ReStruct.prototype.connectedComponentGetBoundingBox=function(t,e,n){return e=e||this.connectedComponents.get(t),n=n||{min:null,max:null},Set.each(e,function(t){var e=this.render.ps(this.atoms.get(t).a.pp);null==n.min?n.min=n.max=e:(n.min=n.min.min(e),n.max=n.max.max(e))},this),n},rnd.ReStruct.prototype.initLayers=function(){for(var t in rnd.ReStruct.layerMap)this.layers[rnd.ReStruct.layerMap[t]]=this.render.paper.rect(0,0,10,10).attr({fill:"#000",opacity:"0.0"}).toFront()},rnd.ReStruct.prototype.insertInLayer=function(t,e){e.insertBefore(this.layers[t])},rnd.ReStruct.prototype.clearMarks=function(){for(var t in rnd.ReStruct.maps)this[t+"Changed"]={};this.structChanged=!1},rnd.ReStruct.prototype.markItemRemoved=function(){this.structChanged=!0},rnd.ReStruct.prototype.markBond=function(t,e){this.markItem("bonds",t,e)},rnd.ReStruct.prototype.markAtom=function(t,e){this.markItem("atoms",t,e)},rnd.ReStruct.prototype.markItem=function(t,e,n){var r=this[t+"Changed"];r[e]=void 0!==r[e]?Math.max(n,r[e]):n,this[t].has(e)&&this.clearVisel(this[t].get(e).visel)},rnd.ReStruct.prototype.eachVisel=function(t,e){for(var n in rnd.ReStruct.maps)this[n].each(function(n,r){t.call(e,r.visel)},this)},rnd.ReStruct.prototype.getVBoxObj=function(t){if(t=t||{},this.selectionIsEmpty(t))for(var e in rnd.ReStruct.maps)t[e]=this[e].keys();var n=null;for(var e in rnd.ReStruct.maps)t[e]&&util.each(t[e],function(t){var r=this[e].get(t).getVBoxObj(this.render);r&&(n=n?Box2Abs.union(n,r):r.clone())},this);return n=n||new Box2Abs(0,0,0,0)},rnd.ReStruct.prototype.selectionIsEmpty=function(t){if(util.assert(!util.isUndefined(t),"'selection' is not defined"),util.isNull(t))return!0;for(var e in rnd.ReStruct.maps)if(t[e]&&t[e].length>0)return!1;return!0},rnd.ReStruct.prototype.translate=function(t){this.eachVisel(function(e){e.translate(t)},this)},rnd.ReStruct.prototype.scale=function(t){this.eachVisel(function(e){this.scaleVisel(e,t)},this)},rnd.ReStruct.prototype.scaleRPath=function(t,e){if("set"==t.type)for(var n=0;n<t.length;++n)this.scaleRPath(t[n],e);else Object.isUndefined(t.attrs)||("font-size"in t.attrs?t.attr("font-size",t.attrs["font-size"]*e):"stroke-width"in t.attrs&&t.attr("stroke-width",t.attrs["stroke-width"]*e)),t.scale(e,e,0,0)},rnd.ReStruct.prototype.scaleVisel=function(t,e){for(var n=0;n<t.paths.length;++n)this.scaleRPath(t.paths[n],e)},rnd.ReStruct.prototype.clearVisels=function(){this.eachVisel(function(t){this.clearVisel(t)},this)},rnd.ReStruct.prototype.findIncomingStereoUpBond=function(t,e,n){return util.findIndex(t.neighbors,function(t){var r=this.molecule.halfBonds.get(t),i=r.bid;if(i===e)return!1;var o=this.bonds.get(i);return o.b.type===chem.Struct.BOND.TYPE.SINGLE&&o.b.stereo===chem.Struct.BOND.STEREO.UP?o.b.end===r.begin||o.boldStereo&&n:!(o.b.type!==chem.Struct.BOND.TYPE.DOUBLE||o.b.stereo!==chem.Struct.BOND.STEREO.NONE||!n||!o.boldStereo)},this)},rnd.ReStruct.prototype.checkStereoBold=function(t,e){var n=util.map([e.b.begin,e.b.end],function(e){var n=this.molecule.atoms.get(e),r=this.findIncomingStereoUpBond(n,t,!1);return r<0?-1:n.neighbors[r]},this);util.assert(2===n.length),e.boldStereo=n[0]>=0&&n[1]>=0},rnd.ReStruct.prototype.findIncomingUpBonds=function(t,e){var n=util.map([e.b.begin,e.b.end],function(e){var n=this.molecule.atoms.get(e),r=this.findIncomingStereoUpBond(n,t,!0);return r<0?-1:n.neighbors[r]},this);util.assert(2===n.length),e.neihbid1=this.atoms.get(e.b.begin).showLabel?-1:n[0],e.neihbid2=this.atoms.get(e.b.end).showLabel?-1:n[1]},rnd.ReStruct.prototype.checkStereoBoldBonds=function(){this.bonds.each(this.checkStereoBold,this)},rnd.ReStruct.prototype.update=function(t){t=t||!this.initialized;var e;t?function(){for(var t in rnd.ReStruct.maps){var e=this[t+"Changed"];this[t].each(function(t){e[t]=1},this)}}.call(this):function(){for(var t in rnd.ReStruct.maps){var n=this[t+"Changed"];for(e in n)this[t].has(e)||delete n[e]}}.call(this);for(e in this.atomsChanged)this.connectedComponentRemoveAtom(e);for(var n=this.frags.findAll(function(t,e){return!e.calcBBox(this.render,t)},this),r=0;r<n.length;++r){var i=n[r];this.clearVisel(this.frags.get(i).visel),this.frags.unset(i),this.molecule.frags.remove(i)}(function(){for(var t in rnd.ReStruct.maps){var n=this[t+"Changed"];for(e in n)this.clearVisel(this[t].get(e).visel),this.structChanged|=n[e]>0}}).call(this),this.structChanged&&util.each(this.render.structChangeHandlers,function(t){t.call()}),this.sgroups.each(function(t,e){this.clearVisel(e.visel),e.highlighting=null,e.selectionPlate=null},this),this.frags.each(function(t,e){this.clearVisel(e.visel)},this),this.rgroups.each(function(t,e){this.clearVisel(e.visel)},this),t&&(this.clearConnectedComponents(),this.molecule.initHalfBonds(),this.molecule.initNeighbors()),this.molecule.updateHalfBonds(new Map(this.atomsChanged).findAll(function(t,e){return e>=0},this)),this.molecule.sortNeighbors(new Map(this.atomsChanged).findAll(function(t,e){return e>=1},this)),this.assignConnectedComponents(),this.setImplicitHydrogen(),this.setHydrogenPos(),this.initialized=!0,this.verifyLoops();var o=t||this.structChanged;return o&&this.updateLoops(),this.setDoubleBondShift(),this.checkLabelsToShow(),this.checkStereoBoldBonds(),this.showLabels(),this.showBonds(),o&&this.renderLoops(),this.drawReactionSymbols(),this.drawSGroups(),this.drawFragments(),this.drawRGroups(),this.chiralFlags.each(function(t,e){this.chiralFlagsChanged[t]>0&&e.draw(this.render)},this),this.clearMarks(),!0},rnd.ReStruct.prototype.drawReactionSymbols=function(){var t,e;for(e in this.rxnArrowsChanged)t=this.rxnArrows.get(e),this.drawReactionArrow(e,t);for(e in this.rxnPlusesChanged)t=this.rxnPluses.get(e),this.drawReactionPlus(e,t)},rnd.ReStruct.prototype.drawReactionArrow=function(t,e){var n=this.render.ps(e.item.pp),r=this.drawArrow(new Vec2(n.x-this.render.scale,n.y),new Vec2(n.x+this.render.scale,n.y));e.visel.add(r,Box2Abs.fromRelBox(rnd.relBox(r.getBBox())));var i=this.render.offset;null!=i&&r.translateAbs(i.x,i.y)},rnd.ReStruct.prototype.drawReactionPlus=function(t,e){var n=this.render.ps(e.item.pp),r=this.drawPlus(n);e.visel.add(r,Box2Abs.fromRelBox(rnd.relBox(r.getBBox())));var i=this.render.offset;null!=i&&r.translateAbs(i.x,i.y)},rnd.ReStruct.prototype.drawSGroups=function(){util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(t){var e=this.sgroups.get(t),n=e.draw(this.render);this.addReObjectPath("data",e.visel,n,null,!0),e.setHighlight(e.highlight,this.render)},this)},rnd.ReStruct.prototype.drawFragments=function(){this.frags.each(function(t,e){var n=e.draw(this.render,t);n&&this.addReObjectPath("data",e.visel,n,null,!0)},this)},rnd.ReStruct.prototype.drawRGroups=function(){this.rgroups.each(function(t,e){var n=e.draw(this.render);for(var r in n)for(;n[r].length>0;)this.addReObjectPath(r,e.visel,n[r].shift(),null,!0)},this)},rnd.ReStruct.prototype.eachCC=function(t,e,n){this.connectedComponents.each(function(r,i){e&&this.ccFragmentType.get(r)!=e||t.call(n||this,r,i)},this)},rnd.ReStruct.prototype.getGroupBB=function(t){var e={min:null,max:null};return this.eachCC(function(t,n){e=this.connectedComponentGetBoundingBox(t,n,e)},t,this),e},rnd.ReStruct.prototype.setHydrogenPos=function(){for(var t in this.atomsChanged){var e=this.atoms.get(t);if(0!=e.a.neighbors.length){for(var n=1,r=1,i=0,o=0,s=0;s<e.a.neighbors.length;++s){var a=this.molecule.halfBonds.get(e.a.neighbors[s]).dir;a.x<=0?(n=Math.min(n,Math.abs(a.y)),i++):(r=Math.min(r,Math.abs(a.y)),o++)}e.hydrogenOnTheLeft=n<.51||r<.51?r<n:o>i}else{var h=element.getElementByLabel(e.a.label);null!=h&&(e.hydrogenOnTheLeft=element.get(h).putHydrogenOnTheLeft)}}},rnd.ReStruct.prototype.setImplicitHydrogen=function(){this.molecule.setImplicitHydrogen(util.idList(this.atomsChanged))},rnd.ReLoop=function(t){this.loop=t,this.visel=new rnd.Visel(rnd.Visel.TYPE.LOOP),this.centre=new Vec2,this.radius=new Vec2},rnd.ReLoop.prototype=new rnd.ReObject,rnd.ReLoop.isSelectable=function(){return!1},rnd.ReStruct.prototype.coordProcess=function(t){t||this.molecule.rescale()},rnd.ReStruct.prototype.notifyAtomAdded=function(t){var e=new rnd.ReAtom(this.molecule.atoms.get(t));e.component=this.connectedComponents.add(Set.single(t)),this.atoms.set(t,e),this.markAtom(t,1)},rnd.ReStruct.prototype.notifyRxnPlusAdded=function(t){this.rxnPluses.set(t,new rnd.ReRxnPlus(this.molecule.rxnPluses.get(t)))},rnd.ReStruct.prototype.notifyRxnArrowAdded=function(t){this.rxnArrows.set(t,new rnd.ReRxnArrow(this.molecule.rxnArrows.get(t)))},rnd.ReStruct.prototype.notifyRxnArrowRemoved=function(t){this.markItemRemoved(),this.clearVisel(this.rxnArrows.get(t).visel),this.rxnArrows.unset(t)},rnd.ReStruct.prototype.notifyRxnPlusRemoved=function(t){this.markItemRemoved(),this.clearVisel(this.rxnPluses.get(t).visel),this.rxnPluses.unset(t)},rnd.ReStruct.prototype.notifyBondAdded=function(t){this.bonds.set(t,new rnd.ReBond(this.molecule.bonds.get(t))),this.markBond(t,1)},rnd.ReStruct.prototype.notifyAtomRemoved=function(t){var e=this.atoms.get(t),n=this.connectedComponents.get(e.component);Set.remove(n,t),0==Set.size(n)&&this.connectedComponents.remove(e.component),this.clearVisel(e.visel),this.atoms.unset(t),this.markItemRemoved()},rnd.ReStruct.prototype.notifyBondRemoved=function(t){var e=this.bonds.get(t);[e.b.hb1,e.b.hb2].each(function(t){var e=this.molecule.halfBonds.get(t);e.loop>=0&&this.loopRemove(e.loop)},this),this.clearVisel(e.visel),this.bonds.unset(t),this.markItemRemoved()},rnd.ReStruct.prototype.loopRemove=function(t){if(this.reloops.has(t)){var e=this.reloops.get(t);this.clearVisel(e.visel);for(var n=[],r=0;r<e.loop.hbs.length;++r){var i=e.loop.hbs[r];if(this.molecule.halfBonds.has(i)){var o=this.molecule.halfBonds.get(i);o.loop=-1,this.markBond(o.bid,1),this.markAtom(o.begin,1),n.push(o.bid)}}this.reloops.unset(t),this.molecule.loops.remove(t)}},rnd.ReStruct.prototype.loopIsValid=function(t,e){var n=this.molecule.halfBonds,r=e.loop,i=!1;return r.hbs.each(function(e){n.has(e)&&n.get(e).loop===t||(i=!0)},this),!i},rnd.ReStruct.prototype.verifyLoops=function(){var t=[];this.reloops.each(function(e,n){this.loopIsValid(e,n)||t.push(e)},this);for(var e=0;e<t.length;++e)this.loopRemove(t[e])},rnd.ReStruct.prototype.BFS=function(t,e,n){e-=0;var r=new Array,i={};for(r.push(e),i[e]=1;r.length>0;){var o=r.shift();t.call(n,o);for(var s=this.atoms.get(o),a=0;a<s.a.neighbors.length;++a){var h=s.a.neighbors[a],c=this.molecule.halfBonds.get(h);i[c.end]||(i[c.end]=1,r.push(c.end))}}},rnd.ReRxnPlus=function(t){this.init(rnd.Visel.TYPE.PLUS),this.item=t},rnd.ReRxnPlus.prototype=new rnd.ReObject,rnd.ReRxnPlus.isSelectable=function(){return!0},rnd.ReRxnPlus.findClosest=function(t,e){var n,r;return t.ctab.rxnPluses.each(function(t,i){var o=i.item.pp,s=Math.max(Math.abs(e.x-o.x),Math.abs(e.y-o.y));s<.5&&(!r||s<n)&&(n=s,r={id:t,dist:n})}),r},rnd.ReRxnPlus.prototype.highlightPath=function(t){var e=t.ps(this.item.pp),n=t.settings.scaleFactor;return t.paper.rect(e.x-n/4,e.y-n/4,n/2,n/2,n/8)},rnd.ReRxnPlus.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReRxnPlus.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReRxnArrow=function(t){this.init(rnd.Visel.TYPE.ARROW),this.item=t},rnd.ReRxnArrow.prototype=new rnd.ReObject,rnd.ReRxnArrow.isSelectable=function(){return!0},rnd.ReRxnArrow.findClosest=function(t,e){var n,r;return t.ctab.rxnArrows.each(function(t,i){var o=i.item.pp;if(Math.abs(e.x-o.x)<1){var s=Math.abs(e.y-o.y);s<.3&&(!r||s<n)&&(n=s,r={id:t,dist:n})}}),r},rnd.ReRxnArrow.prototype.highlightPath=function(t){var e=t.ps(this.item.pp),n=t.settings.scaleFactor;return t.paper.rect(e.x-n,e.y-n/4,2*n,n/2,n/8)},rnd.ReRxnArrow.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReRxnArrow.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReFrag=function(t){this.init(rnd.Visel.TYPE.FRAGMENT),this.item=t},rnd.ReFrag.prototype=new rnd.ReObject,rnd.ReFrag.isSelectable=function(){return!1},rnd.ReFrag.findClosest=function(t,e,n,r){r=Math.min(r||t.opt.selectionDistanceCoefficient,t.opt.selectionDistanceCoefficient);var i;return t.ctab.frags.each(function(o,s){if(o!=n){var a=s.calcBBox(t,o);if(a.p0.y<e.y&&a.p1.y>e.y&&a.p0.x<e.x&&a.p1.x>e.x){var h=Math.min(Math.abs(a.p0.x-e.x),Math.abs(a.p1.x-e.x));(!i||h<r)&&(r=h,i={id:o,dist:r})}}}),i},rnd.ReFrag.prototype.fragGetAtoms=function(t,e){var n=[];return t.ctab.atoms.each(function(t,r){r.a.fragment==e&&n.push(t)},this),n},rnd.ReFrag.prototype.fragGetBonds=function(t,e){var n=[];return t.ctab.bonds.each(function(r,i){t.ctab.atoms.get(i.b.begin).a.fragment==e&&t.ctab.atoms.get(i.b.end).a.fragment==e&&n.push(r)},this),n},rnd.ReFrag.prototype.calcBBox=function(t,e){var n;return t.ctab.atoms.each(function(r,i){if(i.a.fragment==e){var o=i.visel.boundingBox;if(o)o=o.translate((t.offset||new Vec2).negated()).transform(t.scaled2obj,t);else{o=new Box2Abs(i.a.pp,i.a.pp);var s=new Vec2(.05*3,.05*3);o=o.extend(s,s)}n=n?Box2Abs.union(n,o):o}},this),n},rnd.ReFrag.prototype._draw=function(t,e,n){var r=this.calcBBox(t,e);if(r){var i=t.obj2scaled(new Vec2(r.p0.x,r.p0.y)),o=t.obj2scaled(new Vec2(r.p1.x,r.p1.y));return t.paper.rect(i.x,i.y,o.x-i.x,o.y-i.y,0).attr(n)}},rnd.ReFrag.prototype.draw=function(t){return null},rnd.ReFrag.prototype.drawHighlight=function(t){},rnd.ReFrag.prototype.setHighlight=function(t,e){var n=e.ctab.frags.keyOf(this);Object.isUndefined(n)||(e.ctab.atoms.each(function(r,i){i.a.fragment==n&&i.setHighlight(t,e)},this),e.ctab.bonds.each(function(r,i){e.ctab.atoms.get(i.b.begin).a.fragment==n&&i.setHighlight(t,e)},this))},rnd.ReRGroup=function(t){this.init(rnd.Visel.TYPE.RGROUP),this.labelBox=null,this.item=t},rnd.ReRGroup.prototype=new rnd.ReObject,rnd.ReRGroup.isSelectable=function(){return!1},rnd.ReRGroup.prototype.getAtoms=function(t){var e=[];return this.item.frags.each(function(n,r){e=e.concat(t.ctab.frags.get(r).fragGetAtoms(t,r))}),e},rnd.ReRGroup.prototype.getBonds=function(t){var e=[];return this.item.frags.each(function(n,r){e=e.concat(t.ctab.frags.get(r).fragGetBonds(t,r))}),e},rnd.ReRGroup.findClosest=function(t,e,n,r){r=Math.min(r||t.opt.selectionDistanceCoefficient,t.opt.selectionDistanceCoefficient);var i;return t.ctab.rgroups.each(function(t,o){if(t!=n&&o.labelBox&&o.labelBox.contains(e,.5)){var s=Vec2.dist(o.labelBox.centre(),e);(!i||s<r)&&(r=s,i={id:t,dist:r})}}),i},rnd.ReRGroup.prototype.calcBBox=function(t){var e;return this.item.frags.each(function(n,r){var i=t.ctab.frags.get(r).calcBBox(t,r);i&&(e=e?Box2Abs.union(e,i):i)}),e=e.extend(this.__ext,this.__ext)},rnd.ReRGroup.drawBrackets=function(t,e,n,r,i){r=r||new Vec2(1,0);var o=Math.min(.25,.3*n.sz().x),s=n.p1.y-n.p0.y,a=.5*(n.p1.y+n.p0.y),h=chem.SGroup.drawBracket(e,e.paper,e.styles,r.negated(),r.negated().rotateSC(1,0),new Vec2(n.p0.x,a),o,s),c=chem.SGroup.drawBracket(e,e.paper,e.styles,r,r.rotateSC(1,0),new Vec2(n.p1.x,a),o,s);t.push(h,c)},rnd.ReRGroup.prototype.draw=function(t){var e=this.calcBBox(t),n=t.settings;if(e){var r={data:[]},i=t.obj2scaled(e.p0),o=t.obj2scaled(e.p1),s=t.paper.set();rnd.ReRGroup.drawBrackets(s,t,e),r.data.push(s);var a=t.ctab.rgroups.keyOf(this),h=t.paper.set(),c=t.paper.text(i.x,(i.y+o.y)/2,"R"+a+"=").attr({font:n.font,"font-size":n.fontRLabel,fill:"black"}),l=rnd.relBox(c.getBBox());c.translateAbs(-l.width/2-n.lineWidth,0),h.push(c);var d={font:n.font,"font-size":n.fontRLogic,fill:"black"},p=[];p.push((this.item.ifthen>0?"IF ":"")+"R"+a.toString()+(this.item.range.length>0?this.item.range.startsWith(">")||this.item.range.startsWith("<")||this.item.range.startsWith("=")?this.item.range:"="+this.item.range:">0")+(this.item.resth?" (RestH)":"")+(this.item.ifthen>0?"\nTHEN R"+this.item.ifthen.toString():""));for(var u=l.height/2+n.lineWidth/2,g=0;g<p.length;++g){var f=t.paper.text(i.x,(i.y+o.y)/2,p[g]).attr(d),m=rnd.relBox(f.getBBox());u+=m.height/2,f.translateAbs(-m.width/2-6*n.lineWidth,u),u+=m.height/2+n.lineWidth/2,r.data.push(f),h.push(f)}return r.data.push(c),this.labelBox=Box2Abs.fromRelBox(h.getBBox()).transform(t.scaled2obj,t),r}return{}},rnd.ReRGroup.prototype._draw=function(t,e,n){var r=this.getVBoxObj(t).extend(this.__ext,this.__ext);if(r){var i=t.obj2scaled(r.p0),o=t.obj2scaled(r.p1);return t.paper.rect(i.x,i.y,o.x-i.x,o.y-i.y,0).attr(n)}},rnd.ReRGroup.prototype.drawHighlight=function(t){var e=t.ctab.rgroups.keyOf(this);if(!Object.isUndefined(e)){var n=this._draw(t,e,t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,n),this.item.frags.each(function(e,n){t.ctab.frags.get(n).drawHighlight(t)},this),n}},rnd.ReSGroup=function(t){this.init(rnd.Visel.TYPE.SGROUP),this.item=t},rnd.ReSGroup.prototype=new rnd.ReObject,rnd.ReSGroup.isSelectable=function(){return!1},rnd.ReSGroup.findClosest=function(t,e){var n=null,r=t.opt.selectionDistanceCoefficient;return t.ctab.molecule.sgroups.each(function(t,i){for(var o=i.bracketDir,s=o.rotateSC(1,0),a=new Vec2(Vec2.dot(e,o),Vec2.dot(e,s)),h=0;h<i.areas.length;++h){var c=i.areas[h],l=c.p0.y<a.y&&c.p1.y>a.y&&c.p0.x<a.x&&c.p1.x>a.x,d=Math.min(Math.abs(c.p0.x-a.x),Math.abs(c.p1.x-a.x));l&&(null==n||d<r)&&(n=t,r=d)}},this),null!=n?{id:n,dist:r}:null},rnd.ReSGroup.prototype.draw=function(t){return this.item.draw(t.ctab)},rnd.ReSGroup.prototype.drawHighlight=function(t){var e=t.styles,n=t.settings,r=t.paper,i=this.item,o=i.bracketBox.transform(t.obj2scaled,t),s=n.lineWidth,a=new Vec2(4*s,6*s);o=o.extend(a,a);var h=i.bracketDir,c=h.rotateSC(1,0),l=Vec2.lc2(h,o.p0.x,c,o.p0.y),d=Vec2.lc2(h,o.p0.x,c,o.p1.y),p=Vec2.lc2(h,o.p1.x,c,o.p0.y),u=Vec2.lc2(h,o.p1.x,c,o.p1.y),g=r.set();i.highlighting=r.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}L{0},{1}",tfx(l.x),tfx(l.y),tfx(d.x),tfx(d.y),tfx(u.x),tfx(u.y),tfx(p.x),tfx(p.y)).attr(e.highlightStyle),g.push(i.highlighting),chem.SGroup.getAtoms(t.ctab.molecule,i).each(function(e){g.push(t.ctab.atoms.get(e).makeHighlightPlate(t))},this),chem.SGroup.getBonds(t.ctab.molecule,i).each(function(e){g.push(t.ctab.bonds.get(e).makeHighlightPlate(t))},this),t.ctab.addReObjectPath("highlighting",this.visel,g)},rnd.ReDataSGroupData=function(t){this.init(rnd.Visel.TYPE.SGROUP_DATA),this.sgroup=t},rnd.ReDataSGroupData.prototype=new rnd.ReObject,rnd.ReDataSGroupData.isSelectable=function(){return!0},rnd.ReDataSGroupData.findClosest=function(t,e){var n=null,r=null;return t.ctab.sgroupData.each(function(t,i){if("DAT"!=i.sgroup.type)throw new Error("Data group expected");var o=i.sgroup.dataArea,s=o.p0.y<e.y&&o.p1.y>e.y&&o.p0.x<e.x&&o.p1.x>e.x,a=Math.min(Math.abs(o.p0.x-e.x),Math.abs(o.p1.x-e.x));s&&(null==r||a<n)&&(r={id:t,dist:a},n=a)}),r},rnd.ReDataSGroupData.prototype.highlightPath=function(t){var e=this.sgroup.dataArea,n=t.obj2scaled(e.p0),r=t.obj2scaled(e.p1).sub(n);return t.paper.rect(n.x,n.y,r.x,r.y)},rnd.ReDataSGroupData.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReDataSGroupData.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReChiralFlag=function(t){this.init(rnd.Visel.TYPE.CHIRAL_FLAG),this.pp=t},rnd.ReChiralFlag.prototype=new rnd.ReObject,rnd.ReChiralFlag.isSelectable=function(){return!0},rnd.ReChiralFlag.findClosest=function(t,e){var n,r;return t.ctab.chiralFlags.each(function(t,i){var o=i.pp;if(Math.abs(e.x-o.x)<1){var s=Math.abs(e.y-o.y);s<.3&&(!r||s<n)&&(n=s,r={id:t,dist:n})}}),r},rnd.ReChiralFlag.prototype.highlightPath=function(t){var e=Box2Abs.fromRelBox(this.path.getBBox()),n=e.p1.sub(e.p0),r=e.p0.sub(t.offset);return t.paper.rect(r.x,r.y,n.x,n.y)},rnd.ReChiralFlag.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReChiralFlag.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReChiralFlag.prototype.draw=function(t){var e=t.paper,n=t.settings,r=t.ps(this.pp);this.path=e.text(r.x,r.y,"Chiral").attr({font:n.font,"font-size":n.fontsz,fill:"#000"}),t.ctab.addReObjectPath("data",this.visel,this.path,null,!0)},rnd.ReStruct.maps={atoms:rnd.ReAtom,bonds:rnd.ReBond,rxnPluses:rnd.ReRxnPlus,rxnArrows:rnd.ReRxnArrow,frags:rnd.ReFrag,rgroups:rnd.ReRGroup,sgroupData:rnd.ReDataSGroupData,chiralFlags:rnd.ReChiralFlag,sgroups:rnd.ReSGroup,reloops:rnd.ReLoop};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../chem/element":10,"../util":39,"../util/box2abs":38,"../util/map":40,"../util/pool":41,"../util/set":42,"../util/vec2":43}],24:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Vec2=require("../util/vec2"),util=require("../util"),element=require("../chem/element");require("./restruct");var rnd=global.rnd=global.rnd||{},tfx=util.tfx;rnd.relBox=function(t){return{x:t.x,y:t.y,width:t.width,height:t.height}},rnd.ReStruct.prototype.drawArrow=function(t,e){var r=this.render.paper,a=this.render.styles;return r.path("M{0},{1}L{2},{3}L{4},{5}M{2},{3}L{4},{6}",tfx(t.x),tfx(t.y),tfx(e.x),tfx(e.y),tfx(e.x-7),tfx(e.y-5),tfx(e.y+5)).attr(a.lineattr)},rnd.ReStruct.prototype.drawPlus=function(t){var e=this.render.scale/5,r=this.render.paper,a=this.render.styles;return r.path("M{0},{4}L{0},{5}M{2},{1}L{3},{1}",tfx(t.x),tfx(t.y),tfx(t.x-e),tfx(t.x+e),tfx(t.y-e),tfx(t.y+e)).attr(a.lineattr)},rnd.ReStruct.prototype.drawBondSingle=function(t,e){var r=t.p,a=e.p,n=this.render.paper,d=this.render.styles;return n.path(rnd.ReStruct.makeStroke(r,a)).attr(d.lineattr)},rnd.ReStruct.prototype.drawBondSingleUp=function(t,e,r){var a=t.p,n=e.p,d=t.norm,i=this.render.settings,o=this.render.paper,s=this.render.styles,h=.7*i.bondSpace,l=n.addScaled(d,h),c=n.addScaled(d,-h);if(r.neihbid2>=0){var p=this.stereoUpBondGetCoordinates(e,r.neihbid2);l=p[0],c=p[1]}return o.path("M{0},{1}L{2},{3}L{4},{5}Z",tfx(a.x),tfx(a.y),tfx(l.x),tfx(l.y),tfx(c.x),tfx(c.y)).attr(s.lineattr).attr({fill:"#000"})},rnd.ReStruct.prototype.drawVec=function(t,e,r,a){var n=this.render.settings,d=this.render.paper,i=this.render.styles,o=n.bondSpace,s=t.addScaled(e,a||3*o);return d.path("M{0},{1}L{2},{3}",tfx(t.x),tfx(t.y),tfx(s.x),tfx(s.y)).attr(i.lineattr).attr({stroke:r||"#0F0"})},rnd.ReStruct.prototype.stereoUpBondGetCoordinates=function(t,e){var r=this.render.settings.bondSpace,a=this.molecule.halfBonds.get(e),n=Vec2.dot(t.dir,a.dir),d=Vec2.cross(t.dir,a.dir),i=Math.sqrt(.5*(1-n)),o=a.dir.rotateSC((d>=0?-1:1)*i,Math.sqrt(.5*(1+n))),s=t.p.addScaled(o,.7*r/(i+.3)),h=t.p.addScaled(o.negated(),.7*r/(i+.3));return d>0?[s,h]:[h,s]},rnd.ReStruct.prototype.drawBondSingleStereoBold=function(t,e,r,a){var n=this.render.paper,d=this.render.settings,i=this.render.styles,o=this.stereoUpBondGetCoordinates(t,r.neihbid1),s=this.stereoUpBondGetCoordinates(e,r.neihbid2),h=o[0],l=o[1],c=s[0],p=s[1],b=n.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}Z",tfx(h.x),tfx(h.y),tfx(l.x),tfx(l.y),tfx(c.x),tfx(c.y),tfx(p.x),tfx(p.y)).attr(i.lineattr).attr({stroke:"#000",fill:"#000"});if(a){var u=t.p,f=e.p,S=t.norm,x=r.doubleBondShift,g=1.5*d.bondSpace,B=u.addScaled(S,g*x),v=f.addScaled(S,g*x),R=!this.atoms.get(t.begin).showLabel,y=!this.atoms.get(e.begin).showLabel;return x>0?(R&&(B=B.addScaled(t.dir,g*this.getBondLineShift(t.rightCos,t.rightSin))),y&&(v=v.addScaled(t.dir,-g*this.getBondLineShift(e.leftCos,e.leftSin)))):x<0&&(R&&(B=B.addScaled(t.dir,g*this.getBondLineShift(t.leftCos,t.leftSin))),y&&(v=v.addScaled(t.dir,-g*this.getBondLineShift(e.rightCos,e.rightSin)))),n.set([b,n.path("M{0},{1}L{2},{3}",tfx(B.x),tfx(B.y),tfx(v.x),tfx(v.y)).attr(i.lineattr)])}return b},rnd.ReStruct.prototype.drawBondSingleDown=function(t,e){var r=t.p,a=e.p,n=t.norm,d=this.render.settings,i=this.render.paper,o=this.render.styles,s=.7*d.bondSpace,h=a.sub(r),l=h.length()+.2;h=h.normalized();for(var c,p,b=1.2*d.lineWidth,u=Math.max(Math.floor((l-d.lineWidth)/(d.lineWidth+b)),0)+2,f=l/(u-1),S="",x=r,g=0;g<u;++g)x=r.addScaled(h,f*g),c=x.addScaled(n,s*(g+.5)/(u-.5)),p=x.addScaled(n,-s*(g+.5)/(u-.5)),S+=rnd.ReStruct.makeStroke(c,p);return i.path(S).attr(o.lineattr)},rnd.ReStruct.prototype.drawBondSingleEither=function(t,e){var r=t.p,a=e.p,n=t.norm,d=this.render.settings,i=this.render.paper,o=this.render.styles,s=.7*d.bondSpace,h=a.sub(r),l=h.length();h=h.normalized();for(var c=.6*d.lineWidth,p=Math.max(Math.floor((l-d.lineWidth)/(d.lineWidth+c)),0)+2,b=l/(p-.5),u="M"+tfx(r.x)+","+tfx(r.y),f=r,S=0;S<p;++S)f=r.addScaled(h,b*(S+.5)).addScaled(n,(1&S?-1:1)*s*(S+.5)/(p-.5)),u+="L"+tfx(f.x)+","+tfx(f.y);return i.path(u).attr(o.lineattr)},rnd.ReStruct.prototype.getBondLineShift=function(t,e){return e<0||Math.abs(t)>.9?0:e/(1-t)},rnd.ReStruct.prototype.drawBondDouble=function(t,e,r,a){var n=t.p,d=e.p,i=t.norm,o=a?0:r.doubleBondShift,s=this.render.settings,h=this.render.paper,l=this.render.styles,c=s.bondSpace/2,p=c,b=-c;p+=o*c,b+=o*c;var u=n.addScaled(i,p),f=d.addScaled(i,p),S=n.addScaled(i,b),x=d.addScaled(i,b),g=!this.atoms.get(t.begin).showLabel,B=!this.atoms.get(e.begin).showLabel;return o>0?(g&&(u=u.addScaled(t.dir,s.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),B&&(f=f.addScaled(t.dir,-s.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):o<0&&(g&&(S=S.addScaled(t.dir,s.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),B&&(x=x.addScaled(t.dir,-s.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin)))),h.path(a?"M{0},{1}L{6},{7}M{4},{5}L{2},{3}":"M{0},{1}L{2},{3}M{4},{5}L{6},{7}",tfx(u.x),tfx(u.y),tfx(f.x),tfx(f.y),tfx(S.x),tfx(S.y),tfx(x.x),tfx(x.y)).attr(l.lineattr)},rnd.ReStruct.makeStroke=function(t,e){return"M"+tfx(t.x)+","+tfx(t.y)+"L"+tfx(e.x)+","+tfx(e.y)+"\t"},rnd.ReStruct.prototype.drawBondSingleOrDouble=function(t,e){var r=t.p,a=e.p,n=t.norm,d=this.render,i=d.settings,o=d.paper,s=d.styles,h=i.bondSpace/2,l=(Vec2.dist(r,a)/(i.bondSpace+i.lineWidth)).toFixed()-0;1&l||(l+=1);for(var c="",p=r,b=1;b<=l;++b){var u=Vec2.lc2(r,(l-b)/l,a,b/l);1&b?c+=rnd.ReStruct.makeStroke(p,u):(c+=rnd.ReStruct.makeStroke(p.addScaled(n,h),u.addScaled(n,h)),c+=rnd.ReStruct.makeStroke(p.addScaled(n,-h),u.addScaled(n,-h))),p=u}return o.path(c).attr(s.lineattr)},rnd.ReStruct.prototype.drawBondTriple=function(t,e){var r=t.p,a=e.p,n=t.norm,d=this.render,i=d.settings,o=d.paper,s=d.styles,h=r.addScaled(n,i.bondSpace),l=a.addScaled(n,i.bondSpace),c=r.addScaled(n,-i.bondSpace),p=a.addScaled(n,-i.bondSpace);return o.path(rnd.ReStruct.makeStroke(r,a)+rnd.ReStruct.makeStroke(h,l)+rnd.ReStruct.makeStroke(c,p)).attr(s.lineattr)},rnd.dashedPath=function(t,e,r){for(var a=0,n=Vec2.dist(t,e),d=Vec2.diff(e,t).normalized(),i=!0,o="",s=0;a<n;){var h=r[s%r.length],l=a+Math.min(h,n-a);i&&(o+="M "+t.addScaled(d,a).coordStr()+" L "+t.addScaled(d,l).coordStr()),a+=h,i=!i,s++}return o},rnd.ReStruct.prototype.drawBondAromatic=function(t,e,r,a){if(!a)return this.drawBondSingle(t,e);var n=r.doubleBondShift,d=this.render.paper,i=this.preparePathsForAromaticBond(t,e,n),o=i[0],s=i[1];return(n>0?o:s).attr({"stroke-dasharray":"- "}),d.set([o,s])},rnd.dashdotPattern=[.125,.125,.005,.125],rnd.ReStruct.prototype.drawBondSingleOrAromatic=function(t,e,r){var a=r.doubleBondShift,n=this.render.paper,d=this.render.settings.scaleFactor,i=util.map(rnd.dashdotPattern,function(t){return t*d}),o=this.preparePathsForAromaticBond(t,e,a,a>0?1:2,i),s=o[0],h=o[1];return n.set([s,h])},rnd.ReStruct.prototype.preparePathsForAromaticBond=function(t,e,r,a,n){var d=this.render.settings,i=this.render.paper,o=this.render.styles,s=t.p,h=e.p,l=t.norm,c=d.bondSpace/2,p=c,b=-c;p+=r*c,b+=r*c;var u=s.addScaled(l,p),f=h.addScaled(l,p),S=s.addScaled(l,b),x=h.addScaled(l,b),g=!this.atoms.get(t.begin).showLabel,B=!this.atoms.get(e.begin).showLabel;return r>0?(g&&(u=u.addScaled(t.dir,d.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),B&&(f=f.addScaled(t.dir,-d.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):r<0&&(g&&(S=S.addScaled(t.dir,d.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),B&&(x=x.addScaled(t.dir,-d.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin)))),[i.path(n&&1&a?rnd.dashedPath(u,f,n):rnd.ReStruct.makeStroke(u,f)).attr(o.lineattr),i.path(n&&2&a?rnd.dashedPath(S,x,n):rnd.ReStruct.makeStroke(S,x)).attr(o.lineattr)]},rnd.ReStruct.prototype.drawBondDoubleOrAromatic=function(t,e,r){var a=r.doubleBondShift,n=this.render.paper,d=this.render.settings.scaleFactor,i=util.map(rnd.dashdotPattern,function(t){return t*d}),o=this.preparePathsForAromaticBond(t,e,a,3,i),s=o[0],h=o[1];return n.set([s,h])},rnd.ReStruct.prototype.drawBondAny=function(t,e){var r=t.p,a=e.p,n=this.render.paper,d=this.render.styles;return n.path(rnd.ReStruct.makeStroke(r,a)).attr(d.lineattr).attr({"stroke-dasharray":"- "})},rnd.ReStruct.prototype.drawReactingCenter=function(t,e,r){var a=e.p,n=r.p,d=n.add(a).scaled(.5),i=n.sub(a).normalized(),o=i.rotateSC(1,0),s=this.render.paper,h=this.render.styles,l=this.render.settings,c=[],p=l.lineWidth,b=l.bondSpace/2,u=p,f=2*p,S=1.5*b,x=1.5*b,g=3*b;switch(t.b.reactingCenterStatus){case chem.Struct.BOND.REACTING_CENTER.NOT_CENTER:c.push(d.addScaled(o,g).addScaled(i,.2*g)),c.push(d.addScaled(o,-g).addScaled(i,-.2*g)),c.push(d.addScaled(o,g).addScaled(i,-.2*g)),c.push(d.addScaled(o,-g).addScaled(i,.2*g));break;case chem.Struct.BOND.REACTING_CENTER.CENTER:c.push(d.addScaled(o,g).addScaled(i,.2*g).addScaled(i,u)),c.push(d.addScaled(o,-g).addScaled(i,-.2*g).addScaled(i,u)),c.push(d.addScaled(o,g).addScaled(i,.2*g).addScaled(i,-u)),c.push(d.addScaled(o,-g).addScaled(i,-.2*g).addScaled(i,-u)),c.push(d.addScaled(i,S).addScaled(o,x)),c.push(d.addScaled(i,-S).addScaled(o,x)),c.push(d.addScaled(i,S).addScaled(o,-x)),c.push(d.addScaled(i,-S).addScaled(o,-x));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN:c.push(d.addScaled(o,g).addScaled(i,f)),c.push(d.addScaled(o,-g).addScaled(i,f)),c.push(d.addScaled(o,g).addScaled(i,-f)),c.push(d.addScaled(o,-g).addScaled(i,-f));break;case chem.Struct.BOND.REACTING_CENTER.ORDER_CHANGED:c.push(d.addScaled(o,g)),c.push(d.addScaled(o,-g));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN_AND_CHANGED:c.push(d.addScaled(o,g).addScaled(i,f)),c.push(d.addScaled(o,-g).addScaled(i,f)),c.push(d.addScaled(o,g).addScaled(i,-f)),c.push(d.addScaled(o,-g).addScaled(i,-f)),c.push(d.addScaled(o,g)),c.push(d.addScaled(o,-g));break;default:return null}for(var B="",v=0;v<c.length/2;++v)B+=rnd.ReStruct.makeStroke(c[2*v],c[2*v+1]);return s.path(B).attr(h.lineattr)},rnd.ReStruct.prototype.drawTopologyMark=function(t,e,r){var a=null;if(t.b.topology==chem.Struct.BOND.TOPOLOGY.RING)a="rng";else{if(t.b.topology!=chem.Struct.BOND.TOPOLOGY.CHAIN)return null;a="chn"}var n=this.render.paper,d=this.render.settings,i=e.p,o=r.p,s=o.add(i).scaled(.5),h=o.sub(i).normalized(),l=h.rotateSC(1,0),c=d.lineWidth;t.doubleBondShift>0?l=l.scaled(-t.doubleBondShift):0==t.doubleBondShift&&(c+=d.bondSpace/2);var p=new Vec2(2,1).scaled(d.bondSpace);t.b.type==chem.Struct.BOND.TYPE.TRIPLE&&(c+=d.bondSpace);var b=s.add(new Vec2(l.x*(p.x+c),l.y*(p.y+c))),u=n.text(b.x,b.y,a).attr({font:d.font,"font-size":d.fontszsub,fill:"#000"}),f=rnd.relBox(u.getBBox());return this.centerText(u,f),u},rnd.ReStruct.prototype.drawBond=function(t,e,r){var a=null,n=this.molecule;switch(t.b.type){case chem.Struct.BOND.TYPE.SINGLE:switch(t.b.stereo){case chem.Struct.BOND.STEREO.UP:this.findIncomingUpBonds(e.bid,t),a=t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,r,t):this.drawBondSingleUp(e,r,t);break;case chem.Struct.BOND.STEREO.DOWN:a=this.drawBondSingleDown(e,r,t);break;case chem.Struct.BOND.STEREO.EITHER:a=this.drawBondSingleEither(e,r,t);break;default:a=this.drawBondSingle(e,r)}break;case chem.Struct.BOND.TYPE.DOUBLE:this.findIncomingUpBonds(e.bid,t),a=t.b.stereo===chem.Struct.BOND.STEREO.NONE&&t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,r,t,!0):this.drawBondDouble(e,r,t,t.b.stereo===chem.Struct.BOND.STEREO.CIS_TRANS);break;case chem.Struct.BOND.TYPE.TRIPLE:a=this.drawBondTriple(e,r,t);break;case chem.Struct.BOND.TYPE.AROMATIC:var d=e.loop>=0&&n.loops.get(e.loop).aromatic||r.loop>=0&&n.loops.get(r.loop).aromatic;a=this.drawBondAromatic(e,r,t,!d);break;case chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE:a=this.drawBondSingleOrDouble(e,r,t);break;case chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC:a=this.drawBondSingleOrAromatic(e,r,t);break;case chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC:a=this.drawBondDoubleOrAromatic(e,r,t);break;case chem.Struct.BOND.TYPE.ANY:a=this.drawBondAny(e,r,t);break;default:throw new Error("Bond type "+t.b.type+" not supported")}return a},rnd.ReStruct.prototype.radicalCap=function(t){var e=this.render.settings,r=this.render.paper,a=.9*e.lineWidth,n=a,d=2*a;return r.path("M{0},{1}L{2},{3}L{4},{5}",tfx(t.x-n),tfx(t.y+d),tfx(t.x),tfx(t.y),tfx(t.x+n),tfx(t.y+d)).attr({stroke:"#000","stroke-width":.7*e.lineWidth,"stroke-linecap":"square","stroke-linejoin":"miter"})},rnd.ReStruct.prototype.radicalBullet=function(t){var e=this.render.settings;return this.render.paper.circle(t.x,t.y,e.lineWidth).attr({stroke:null,fill:"#000"})},rnd.ReStruct.prototype.centerText=function(t,e){this.render.paper.raphael.vml&&this.pathAndRBoxTranslate(t,e,0,.16*e.height)},rnd.ReStruct.prototype.showItemSelection=function(t,e,r){var a=null!=e.selectionPlate&&!e.selectionPlate.removed;if(a=a&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(e.selectionPlate)<0),r){if(!a){var n=this.render,d=n.styles,i=n.paper;e.selectionPlate=e.makeSelectionPlate(this,i,d),this.addReObjectPath("selection-plate",e.visel,e.selectionPlate)}e.selectionPlate&&e.selectionPlate.show()}else a&&e.selectionPlate&&e.selectionPlate.hide()},rnd.ReStruct.prototype.pathAndRBoxTranslate=function(t,e,r,a){t.translateAbs(r,a),e.x+=r,e.y+=a};var markerColors=["black","cyan","magenta","red","green","blue","green"];rnd.ReStruct.prototype.showLabels=function(){var t=this.render,e=t.settings,r=t.styles,a=t.opt,n=t.paper,d=.5*e.lineWidth;for(var i in this.atomsChanged){var o=this.atoms.get(i),s=t.ps(o.a.pp),h=null;a.showAtomIds&&(h={},h.text=i.toString(),h.path=n.text(s.x,s.y,h.text).attr({font:e.font,"font-size":e.fontszsub,fill:"#070"}),h.rbb=rnd.relBox(h.path.getBBox()),this.centerText(h.path,h.rbb),this.addReObjectPath("indices",o.visel,h.path,s)),o.setHighlight(o.highlight,t);var l="#000000";if(o.showLabel){var c=0,p=0,b={};if(null!=o.a.atomList)b.text=o.a.atomList.label();else if("R#"==o.a.label&&null!=o.a.rglabel){b.text="";for(var u=0;u<32;u++)o.a.rglabel&1<<u&&(b.text+="R"+(u+1).toString());""==b.text&&(b="R#")}else if(b.text=o.a.label,a.atomColoring){var f=element.getElementByLabel(b.text);f&&(l=element.get(f).color)}b.path=n.text(s.x,s.y,b.text).attr({font:e.font,"font-size":e.fontsz,fill:l}),b.rbb=rnd.relBox(b.path.getBBox()),this.centerText(b.path,b.rbb),null!=o.a.atomList&&this.pathAndRBoxTranslate(b.path,b.rbb,(o.hydrogenOnTheLeft?-1:1)*(b.rbb.width-b.rbb.height)/2,0),this.addReObjectPath("data",o.visel,b.path,s,!0),c=b.rbb.width/2,p=-b.rbb.width/2;var S=Math.floor(o.a.implicitH),x="H"==b.text,g={},B=null,v=o.hydrogenOnTheLeft;x&&S>0&&(B={},B.text=(S+1).toString(),B.path=n.text(s.x,s.y,B.text).attr({font:e.font,"font-size":e.fontszsub,fill:l}),B.rbb=rnd.relBox(B.path.getBBox()),this.centerText(B.path,B.rbb),this.pathAndRBoxTranslate(B.path,B.rbb,c+.5*B.rbb.width+d,.2*b.rbb.height),c+=B.rbb.width+d,this.addReObjectPath("data",o.visel,B.path,s,!0));var R={};if(0!=o.a.radical){var y;switch(o.a.radical){case 1:R.path=n.set(),y=1.6*e.lineWidth,R.path.push(this.radicalBullet(s.add(new Vec2(-y,0))),this.radicalBullet(s.add(new Vec2(y,0)))),R.path.attr("fill",l);break;case 2:R.path=this.radicalBullet(s).attr("fill",l);break;case 3:R.path=n.set(),y=1.6*e.lineWidth,R.path.push(this.radicalCap(s.add(new Vec2(-y,0))),this.radicalCap(s.add(new Vec2(y,0)))),R.path.attr("stroke",l)}R.rbb=rnd.relBox(R.path.getBBox());var m=-.5*(b.rbb.height+R.rbb.height);3==o.a.radical&&(m-=e.lineWidth/2),this.pathAndRBoxTranslate(R.path,R.rbb,0,m),this.addReObjectPath("data",o.visel,R.path,s,!0)}var w={};0!=o.a.isotope&&(w.text=o.a.isotope.toString(),w.path=n.text(s.x,s.y,w.text).attr({font:e.font,"font-size":e.fontszsub,fill:l}),w.rbb=rnd.relBox(w.path.getBBox()),this.centerText(w.path,w.rbb),this.pathAndRBoxTranslate(w.path,w.rbb,p-.5*w.rbb.width-d,-.3*b.rbb.height),p-=w.rbb.width+d,this.addReObjectPath("data",o.visel,w.path,s,!0)),!x&&S>0&&!t.opt.hideImplicitHydrogen&&(g.text="H",g.path=n.text(s.x,s.y,g.text).attr({font:e.font,"font-size":e.fontsz,fill:l}),g.rbb=rnd.relBox(g.path.getBBox()),this.centerText(g.path,g.rbb),v||(this.pathAndRBoxTranslate(g.path,g.rbb,c+.5*g.rbb.width+d,0),c+=g.rbb.width+d),S>1&&(B={},B.text=S.toString(),B.path=n.text(s.x,s.y,B.text).attr({font:e.font,"font-size":e.fontszsub,fill:l}),B.rbb=rnd.relBox(B.path.getBBox()),this.centerText(B.path,B.rbb),v||(this.pathAndRBoxTranslate(B.path,B.rbb,c+.5*B.rbb.width+d,.2*b.rbb.height),c+=B.rbb.width+d)),v&&(null!=B&&(this.pathAndRBoxTranslate(B.path,B.rbb,p-.5*B.rbb.width-d,.2*b.rbb.height),p-=B.rbb.width+d),this.pathAndRBoxTranslate(g.path,g.rbb,p-.5*g.rbb.width-d,0),p-=g.rbb.width+d),this.addReObjectPath("data",o.visel,g.path,s,!0),null!=B&&this.addReObjectPath("data",o.visel,B.path,s,!0));var O={};if(0!=o.a.charge){O.text="";var T=Math.abs(o.a.charge);1!=T&&(O.text=T.toString()),o.a.charge<0?O.text+="":O.text+="+",O.path=n.text(s.x,s.y,O.text).attr({font:e.font,"font-size":e.fontszsub,fill:l}),O.rbb=rnd.relBox(O.path.getBBox()),this.centerText(O.path,O.rbb),this.pathAndRBoxTranslate(O.path,O.rbb,c+.5*O.rbb.width+d,-.3*b.rbb.height),c+=O.rbb.width+d,this.addReObjectPath("data",o.visel,O.path,s,!0)}var E={},L={0:"0",1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI",7:"VII",8:"VIII",9:"IX",10:"X",11:"XI",12:"XII",13:"XIII",14:"XIV"};if(o.a.explicitValence>=0){if(E.text=L[o.a.explicitValence],!E.text)throw new Error("invalid valence "+o.a.explicitValence.toString());E.text="("+E.text+")",E.path=n.text(s.x,s.y,E.text).attr({font:e.font,"font-size":e.fontszsub,fill:l}),E.rbb=rnd.relBox(E.path.getBBox()),this.centerText(E.path,E.rbb),this.pathAndRBoxTranslate(E.path,E.rbb,c+.5*E.rbb.width+d,-.3*b.rbb.height),c+=E.rbb.width+d,this.addReObjectPath("data",o.visel,E.path,s,!0)}if(o.a.badConn&&a.showValenceWarnings){var C={},k=s.y+b.rbb.height/2+d;C.path=n.path("M{0},{1}L{2},{3}",tfx(s.x+p),tfx(k),tfx(s.x+c),tfx(k)).attr(this.render.styles.lineattr).attr({stroke:"#F00"}),C.rbb=rnd.relBox(C.path.getBBox()),this.addReObjectPath("warnings",o.visel,C.path,s,!0)}h&&this.pathAndRBoxTranslate(h.path,h.rbb,-.5*b.rbb.width-.5*h.rbb.width-d,.3*b.rbb.height)}var P=this.bisectLargestSector(o),I=Prototype.Browser.IE?"*":"";if(o.a.attpnt){var M,A;for(M=0,0;M<4;++M){var N="";if(o.a.attpnt&1<<M){for(N.length>0&&(N+=" "),N+=I,A=0;A<(0==M?0:M+1);++A)N+="'";var V=new Vec2(s),D=s.addScaled(P,.7*e.scaleFactor),z=n.text(D.x,D.y,N).attr({font:e.font,"font-size":e.fontsz,fill:l}),W=rnd.relBox(z.getBBox());this.centerText(z,W);var j=P.negated();D=D.addScaled(j,Vec2.shiftRayBox(D,j,Box2Abs.fromRelBox(W))+e.lineWidth/2),V=this.shiftBondEnd(o,V,P,e.lineWidth);var _=P.rotateSC(1,0),F=D.addScaled(_,.05*e.scaleFactor).addScaled(j,.09*e.scaleFactor),G=D.addScaled(_,-.05*e.scaleFactor).addScaled(j,.09*e.scaleFactor),U=n.set();U.push(z,n.path("M{0},{1}L{2},{3}M{4},{5}L{2},{3}L{6},{7}",tfx(V.x),tfx(V.y),tfx(D.x),tfx(D.y),tfx(F.x),tfx(F.y),tfx(G.x),tfx(G.y)).attr(r.lineattr).attr({"stroke-width":e.lineWidth/2})),this.addReObjectPath("indices",o.visel,U,s),P=P.rotate(Math.PI/6)}}}var Y="";if(o.a.aam>0&&(Y+=o.a.aam),o.a.invRet>0)if(Y.length>0&&(Y+=","),1==o.a.invRet)Y+="Inv";else{if(2!=o.a.invRet)throw new Error("Invalid value for the invert/retain flag");Y+="Ret"}var H="";if(0!=o.a.ringBondCount)if(o.a.ringBondCount>0)H+="rb"+o.a.ringBondCount.toString();else if(-1==o.a.ringBondCount)H+="rb0";else{if(-2!=o.a.ringBondCount)throw new Error("Ring bond count invalid");H+="rb*"}if(0!=o.a.substitutionCount)if(H.length>0&&(H+=","),o.a.substitutionCount>0)H+="s"+o.a.substitutionCount.toString();else if(-1==o.a.substitutionCount)H+="s0";else{if(-2!=o.a.substitutionCount)throw new Error("Substitution count invalid");H+="s*"}if(o.a.unsaturatedAtom>0){if(H.length>0&&(H+=","),1!=o.a.unsaturatedAtom)throw new Error("Unsaturated atom invalid value");H+="u"}if(o.a.hCount>0&&(H.length>0&&(H+=","),H+="H"+(o.a.hCount-1).toString()),o.a.exactChangeFlag>0){if(Y.length>0&&(Y+=","),1!=o.a.exactChangeFlag)throw new Error("Invalid value for the exact change flag");Y+="ext"}if(Y=(H.length>0?H+"\n":"")+(Y.length>0?"."+Y+".":""),Y.length>0){var q=n.text(s.x,s.y,Y).attr({font:e.font,"font-size":e.fontszsub,fill:l}),X=rnd.relBox(q.getBBox());this.centerText(q,X);var Z=this.bisectLargestSector(o),K=o.visel,J=3;for(M=0;M<K.exts.length;++M)J=Math.max(J,Vec2.shiftRayBox(s,Z,K.exts[M].translate(s)));J+=Vec2.shiftRayBox(s,Z.negated(),Box2Abs.fromRelBox(X)),Z=Z.scaled(8+J),this.pathAndRBoxTranslate(q,X,Z.x,Z.y),this.addReObjectPath("data",o.visel,q,s,!0)}}},rnd.ReStruct.prototype.shiftBondEnd=function(t,e,r,a){for(var n=0,d=t.visel,i=0;i<d.exts.length;++i){var o=d.exts[i].translate(e);n=Math.max(n,Vec2.shiftRayBox(e,r,o))}return n>0&&(e=e.addScaled(r,n+a)),e},rnd.ReStruct.prototype.bisectLargestSector=function(t){var e=[];t.a.neighbors.each(function(t){var r=this.molecule.halfBonds.get(t);e.push(r.ang)},this),e=e.sort(function(t,e){return t-e});for(var r=[],a=0;a<e.length-1;++a)r.push(e[(a+1)%e.length]-e[a]);r.push(e[0]-e[e.length-1]+2*Math.PI);var n=0,d=-Math.PI/2;for(a=0;a<e.length;++a)r[a]>n&&(n=r[a],d=e[a]+r[a]/2);return new Vec2(Math.cos(d),Math.sin(d))},rnd.ReStruct.prototype.bondRecalc=function(t,e){var r=this.render,a=this.atoms.get(e.b.begin),n=this.atoms.get(e.b.end),d=r.ps(a.a.pp),i=r.ps(n.a.pp),o=this.molecule.halfBonds.get(e.b.hb1),s=this.molecule.halfBonds.get(e.b.hb2);o.p=this.shiftBondEnd(a,d,o.dir,2*t.lineWidth),s.p=this.shiftBondEnd(n,i,s.dir,2*t.lineWidth),e.b.center=Vec2.lc2(a.a.pp,.5,n.a.pp,.5),e.b.len=Vec2.dist(d,i),e.b.sb=5*t.lineWidth,e.b.sa=Math.max(e.b.sb,e.b.len/2-2*t.lineWidth),e.b.angle=180*Math.atan2(o.dir.y,o.dir.x)/Math.PI},rnd.ReStruct.prototype.showBonds=function(){var t=this.render,e=t.settings,r=t.paper,a=t.opt;for(var n in this.bondsChanged){var d=this.bonds.get(n),i=this.molecule.halfBonds.get(d.b.hb1),o=this.molecule.halfBonds.get(d.b.hb2);this.bondRecalc(e,d),d.path=this.drawBond(d,i,o),d.rbb=rnd.relBox(d.path.getBBox()),this.addReObjectPath("data",d.visel,d.path,null,!0);var s={};s.path=this.drawReactingCenter(d,i,o),s.path&&(s.rbb=rnd.relBox(s.path.getBBox()),this.addReObjectPath("data",d.visel,s.path,null,!0));var h={};h.path=this.drawTopologyMark(d,i,o),h.path&&(h.rbb=rnd.relBox(h.path.getBBox()),this.addReObjectPath("data",d.visel,h.path,null,!0)),d.setHighlight(d.highlight,t);var l=.6*e.subFontSize,c=null,p=null;if(a.showBondIds){var b=Vec2.lc(i.p,.5,o.p,.5,i.norm,l);c=r.text(b.x,b.y,n.toString()),p=rnd.relBox(c.getBBox()),this.centerText(c,p),this.addReObjectPath("indices",d.visel,c)}if(a.showHalfBondIds){var u=Vec2.lc(i.p,.8,o.p,.2,i.norm,l);c=r.text(u.x,u.y,d.b.hb1.toString()),p=rnd.relBox(c.getBBox()),this.centerText(c,p),this.addReObjectPath("indices",d.visel,c);var f=Vec2.lc(i.p,.2,o.p,.8,o.norm,l);c=r.text(f.x,f.y,d.b.hb2.toString()),p=rnd.relBox(c.getBBox()),this.centerText(c,p),this.addReObjectPath("indices",d.visel,c)}if(a.showLoopIds&&!a.showBondIds){var S=Vec2.lc(i.p,.5,o.p,.5,o.norm,l);c=r.text(S.x,S.y,i.loop.toString()),p=rnd.relBox(c.getBBox()),this.centerText(c,p),this.addReObjectPath("indices",d.visel,c);var x=Vec2.lc(i.p,.5,o.p,.5,i.norm,l);c=r.text(x.x,x.y,o.loop.toString()),p=rnd.relBox(c.getBBox()),this.centerText(c,p),this.addReObjectPath("indices",d.visel,c)}}},rnd.ReStruct.prototype.labelIsVisible=function(t,e){if(0==e.a.neighbors.length||e.a.neighbors.length<2&&!this.render.opt.hideTerminalLabels||"c"!=e.a.label.toLowerCase()||e.a.badConn&&this.render.opt.showValenceWarnings||0!=e.a.isotope||0!=e.a.radical||0!=e.a.charge||e.a.explicitValence>=0||null!=e.a.atomList||null!=e.a.rglabel)return!0;if(2==e.a.neighbors.length){var r=e.a.neighbors[0],a=e.a.neighbors[1],n=this.molecule.halfBonds.get(r),d=this.molecule.halfBonds.get(a),i=this.bonds.get(n.bid),o=this.bonds.get(d.bid);if(i.b.type==o.b.type&&i.b.stereo==chem.Struct.BOND.STEREO.NONE&&o.b.stereo==chem.Struct.BOND.STEREO.NONE&&Math.abs(Vec2.cross(n.dir,d.dir))<.2)return!0}return!1},rnd.ReStruct.prototype.checkLabelsToShow=function(){for(var t in this.atomsChanged){var e=this.atoms.get(t);e.showLabel=this.labelIsVisible(t,e)}},rnd.ReStruct.layerMap={background:0,"selection-plate":1,highlighting:2,warnings:3,data:4,indices:5},rnd.ReStruct.prototype.addReObjectPath=function(t,e,r,a,n){if(r){var d=this.render.offset,i=n?Box2Abs.fromRelBox(rnd.relBox(r.getBBox())):null,o=a&&i?i.translate(a.negated()):null;null!==d&&(r.translateAbs(d.x,d.y),i=i?i.translate(d):null),e.add(r,i,o),this.insertInLayer(rnd.ReStruct.layerMap[t],r)}},rnd.ReStruct.prototype.clearVisel=function(t){for(var e=0;e<t.paths.length;++e)t.paths[e].remove();t.clear()},rnd.ReStruct.prototype.selectDoubleBondShift=function(t,e,r,a){return 6==t&&6!=e&&(r>1||1==a)?-1:6==e&&6!=t&&(a>1||1==r)?1:e*r>t*a?-1:e*r<t*a?1:e>t?-1:1},rnd.ReStruct.prototype.selectDoubleBondShift_Chain=function(t){var e=this.molecule,r=e.halfBonds.get(t.b.hb1),a=e.halfBonds.get(t.b.hb2),n=(r.leftSin>.3?1:0)+(a.rightSin>.3?1:0),d=(a.leftSin>.3?1:0)+(r.rightSin>.3?1:0);return n>d?-1:n<d?1:(r.leftSin>.3?1:0)+(r.rightSin>.3?1:0)==1?1:0},rnd.ReStruct.prototype.setDoubleBondShift=function(){var t=this.molecule;for(var e in this.bondsChanged){var r,a,n=this.bonds.get(e);if(r=t.halfBonds.get(n.b.hb1).loop,a=t.halfBonds.get(n.b.hb2).loop,r>=0&&a>=0){var d=t.loops.get(r).dblBonds,i=t.loops.get(a).dblBonds,o=t.loops.get(r).hbs.length,s=t.loops.get(a).hbs.length;n.doubleBondShift=this.selectDoubleBondShift(o,s,d,i)}else n.doubleBondShift=r>=0?-1:a>=0?1:this.selectDoubleBondShift_Chain(n)}},rnd.ReStruct.prototype.updateLoops=function(){this.reloops.each(function(t,e){this.clearVisel(e.visel)},this);var t=this.molecule.findLoops();util.each(t.bondsToMark,function(t){this.markBond(t,1)},this),util.each(t.newLoops,function(t){this.reloops.set(t,new rnd.ReLoop(this.molecule.loops.get(t)))},this)},rnd.ReStruct.prototype.renderLoops=function(){var t=this.render,e=t.settings,r=t.paper,a=this.molecule;this.reloops.each(function(n,d){var i=d.loop;d.centre=new Vec2,i.hbs.each(function(e){var r=a.halfBonds.get(e),n=this.bonds.get(r.bid),o=t.ps(this.atoms.get(r.begin).a.pp);n.b.type!=chem.Struct.BOND.TYPE.AROMATIC&&(i.aromatic=!1),d.centre.add_(o)},this),i.convex=!0;for(var o=0;o<d.loop.hbs.length;++o){var s=a.halfBonds.get(i.hbs[o]),h=a.halfBonds.get(i.hbs[(o+1)%i.hbs.length]),l=Math.atan2(Vec2.cross(s.dir,h.dir),Vec2.dot(s.dir,h.dir));l>0&&(i.convex=!1)}if(d.centre=d.centre.scaled(1/i.hbs.length),d.radius=-1,i.hbs.each(function(e){var r=a.halfBonds.get(e),n=t.ps(this.atoms.get(r.begin).a.pp),i=t.ps(this.atoms.get(r.end).a.pp),o=Vec2.diff(i,n).rotateSC(1,0).normalized(),s=Vec2.dot(Vec2.diff(n,d.centre),o);d.radius<0?d.radius=s:d.radius=Math.min(d.radius,s)},this),d.radius*=.7,i.aromatic){var c=null;if(i.convex)c=r.circle(d.centre.x,d.centre.y,d.radius).attr({stroke:"#000","stroke-width":e.lineWidth});else{var p="";for(o=0;o<i.hbs.length;++o){s=a.halfBonds.get(i.hbs[o]),h=a.halfBonds.get(i.hbs[(o+1)%i.hbs.length]),l=Math.atan2(Vec2.cross(s.dir,h.dir),Vec2.dot(s.dir,h.dir));var b=(Math.PI-l)/2,u=h.dir.rotate(b),f=t.ps(this.atoms.get(h.begin).a.pp),S=Math.sin(b);Math.abs(S)<.1&&(S=.1*S/Math.abs(S));var x=e.bondSpace/S,g=f.addScaled(u,-x);p+=0==o?"M":"L",p+=tfx(g.x)+","+tfx(g.y)}p+="Z",c=r.path(p).attr({stroke:"#000","stroke-width":e.lineWidth,"stroke-dasharray":"- "})}this.addReObjectPath("data",d.visel,c,null,!0)}},this)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem/element":10,"../util":39,"../util/box2abs":38,"../util/vec2":43,"./restruct":23}],25:[function(require,module,exports){
(function (global){
var Box2Abs=require("../util/box2abs"),Vec2=require("../util/vec2"),rnd=global.rnd=global.rnd||{};rnd.Visel=function(t){this.type=t,this.paths=[],this.boxes=[],this.boundingBox=null},rnd.Visel.TYPE={ATOM:1,BOND:2,LOOP:3,ARROW:4,PLUS:5,SGROUP:6,TMP:7,FRAGMENT:8,RGROUP:9,CHIRAL_FLAG:10},rnd.Visel.prototype.add=function(t,s,n){this.paths.push(t),s&&(this.boxes.push(s),this.boundingBox=null==this.boundingBox?s:Box2Abs.union(this.boundingBox,s)),n&&this.exts.push(n)},rnd.Visel.prototype.clear=function(){this.paths=[],this.boxes=[],this.exts=[],this.boundingBox=null},rnd.Visel.prototype.translate=function(t,s){if(arguments.length>2)throw new Error("One vector or two scalar arguments expected");if(void 0===s)this.translate(t.x,t.y);else{for(var n=new Vec2(t,s),i=0;i<this.paths.length;++i)this.paths[i].translateAbs(t,s);for(var o=0;o<this.boxes.length;++o)this.boxes[o]=this.boxes[o].translate(n);null!==this.boundingBox&&(this.boundingBox=this.boundingBox.translate(n))}};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../util/box2abs":38,"../util/vec2":43}],26:[function(require,module,exports){
(function (global){
function Action(){this.operations=[]}function fromMultipleMove(e,t){t=new Vec2(t);var r,o=new Action,n=ui.render,a=n.ctab,i=a.molecule,d=[],p=Set.empty(),m=Set.empty();if(e.atoms){var u=Set.fromList(e.atoms);for(a.bonds.each(function(e,t){Set.contains(u,t.b.begin)&&Set.contains(u,t.b.end)?(d.push(e),util.each(["hb1","hb2"],function(e){var r=i.halfBonds.get(t.b[e]).loop;r>=0&&Set.add(p,r)},this)):Set.contains(u,t.b.begin)?Set.add(m,t.b.begin):Set.contains(u,t.b.end)&&Set.add(m,t.b.end)},this),r=0;r<d.length;++r)o.addOp(new op.BondMove(d[r],t));for(Set.each(p,function(e){a.reloops.get(e)&&a.reloops.get(e).visel&&o.addOp(new op.LoopMove(e,t))},this),r=0;r<e.atoms.length;++r){var s=e.atoms[r];o.addOp(new op.AtomMove(s,t,!Set.contains(m,s)))}}if(e.rxnArrows)for(r=0;r<e.rxnArrows.length;++r)o.addOp(new op.RxnArrowMove(e.rxnArrows[r],t,!0));if(e.rxnPluses)for(r=0;r<e.rxnPluses.length;++r)o.addOp(new op.RxnPlusMove(e.rxnPluses[r],t,!0));if(e.sgroupData)for(r=0;r<e.sgroupData.length;++r)o.addOp(new op.SGroupDataMove(e.sgroupData[r],t));if(e.chiralFlags)for(r=0;r<e.chiralFlags.length;++r)o.addOp(new op.ChiralFlagMove(t));return o.perform()}function fromAtomsAttrs(e,t,r){var o=new Action;return("number"==typeof e?[e]:e).each(function(e){for(var n in chem.Struct.Atom.attrlist){var a;if(n in t)a=t[n];else{if(!r)continue;a=chem.Struct.Atom.attrGetDefault(n)}o.addOp(new op.AtomAttr(e,n,a))}!r&&"label"in t&&null!=t.label&&"L#"!=t.label&&!t.atomList&&o.addOp(new op.AtomAttr(e,"atomList",null))},this),o.perform()}function fromBondAttrs(e,t,r,o){var n=new Action;for(var a in chem.Struct.Bond.attrlist){var i;if(a in t)i=t[a];else{if(!o)continue;i=chem.Struct.Bond.attrGetDefault(a)}n.addOp(new op.BondAttr(e,a,i))}return r&&n.mergeWith(toBondFlipping(e)),n.perform()}function fromSelectedBondsAttrs(e,t){var r=new Action;return e=new Hash(e),ui.editor.getSelection().bonds.each(function(t){e.each(function(e){r.addOp(new op.BondAttr(t,e.key,e.value))},this)},this),t&&t.each(function(e){r.mergeWith(toBondFlipping(e))},this),r.perform()}function fromAtomAddition(e,t){t=Object.clone(t);var r=new Action;return t.fragment=r.addOp((new op.FragmentAdd).perform(ui.editor)).frid,r.addOp(new op.AtomAdd(t,e).perform(ui.editor)),r}function mergeFragments(e,t,r){if(r!=t&&Object.isNumber(r)){var o=chem.Struct.RGroup.findRGroupByFragment(ui.render.ctab.molecule.rgroups,r);Object.isUndefined(o)||e.mergeWith(fromRGroupFragment(null,r)),ui.render.ctab.molecule.atoms.each(function(o,n){n.fragment==r&&e.addOp(new op.AtomAttr(o,"fragment",t).perform(ui.editor))}),e.addOp(new op.FragmentDelete(r).perform(ui.editor))}}function atomForNewBond(e){var t=[],r=ui.render.atomGetPos(e);ui.render.atomGetNeighbors(e).each(function(e){var o=ui.render.atomGetPos(e.aid);Vec2.dist(r,o)<.1||t.push({id:e.aid,v:Vec2.diff(o,r)})}),t.sort(function(e,t){return Math.atan2(e.v.y,e.v.x)-Math.atan2(t.v.y,t.v.x)});var o,n,a=0,i=0;for(o=0;o<t.length;o++)n=Vec2.angle(t[o].v,t[(o+1)%t.length].v),n<0&&(n+=2*Math.PI),n>i&&(a=o,i=n);var d=new Vec2(1,0);if(t.length>0){if(1==t.length){i=-4*Math.PI/3;var p=ui.render.atomGetNeighbors(e)[0];if(ui.render.atomGetDegree(p.aid)>1){var m=[],u=ui.render.atomGetPos(p.aid),s=Vec2.diff(r,u),f=Math.atan2(s.y,s.x);ui.render.atomGetNeighbors(p.aid).each(function(e){var t=ui.render.atomGetPos(e.aid);if(!(e.bid==p.bid||Vec2.dist(u,t)<.1)){var r=Vec2.diff(t,u),o=Math.atan2(r.y,r.x)-f;o<0&&(o+=2*Math.PI),m.push(o)}}),m.sort(function(e,t){return e-t}),m[0]<=1.01*Math.PI&&m[m.length-1]<=1.01*Math.PI&&(i*=-1)}}n=i/2+Math.atan2(t[a].v.y,t[a].v.x),d=d.rotate(n)}d.add_(r);var c=ui.render.findClosestAtom(d,.1);return c=null==c?{label:"C"}:c.id,{atom:c,pos:d}}function fromBondAddition(e,t,r,o,n){if(void 0===r){var a=atomForNewBond(t);r=a.atom,o=a.pos}var i=new Action,d=null;if(Object.isNumber(t)){if(d=ui.render.atomGetAttr(t,"fragment"),Object.isNumber(r)){var p=ui.render.atomGetAttr(r,"fragment");mergeFragments(i,d,p)}}else Object.isNumber(r)&&(d=ui.render.atomGetAttr(r,"fragment"));null==d&&(d=i.addOp((new op.FragmentAdd).perform(ui.editor)).frid),Object.isNumber(t)?"*"==ui.render.atomGetAttr(t,"label")&&i.addOp(new op.AtomAttr(t,"label","C").perform(ui.editor)):(t.fragment=d,t=i.addOp(new op.AtomAdd(t,o).perform(ui.editor)).data.aid,o=n),Object.isNumber(r)?"*"==ui.render.atomGetAttr(r,"label")&&i.addOp(new op.AtomAttr(r,"label","C").perform(ui.editor)):(r.fragment=d,r=i.addOp(new op.AtomAdd(r,o).perform(ui.editor)).data.aid,Object.isNumber(t)&&ui.render.atomGetSGroups(t).each(function(e){i.addOp(new op.SGroupAtomAdd(e,r).perform(ui.editor))},this));var m=i.addOp(new op.BondAdd(t,r,e).perform(ui.editor)).data.bid;return i.operations.reverse(),[i,t,r,m]}function fromArrowAddition(e){var t=new Action;return ui.ctab.rxnArrows.count()<1&&t.addOp(new op.RxnArrowAdd(e).perform(ui.editor)),t}function fromArrowDeletion(e){var t=new Action;return t.addOp(new op.RxnArrowDelete(e)),t.perform()}function fromChiralFlagAddition(e){var t=new Action;return ui.render.ctab.chiralFlags.count()<1&&t.addOp(new op.ChiralFlagAdd(e).perform(ui.editor)),t}function fromChiralFlagDeletion(){var e=new Action;return e.addOp(new op.ChiralFlagDelete),e.perform()}function fromPlusAddition(e){var t=new Action;return t.addOp(new op.RxnPlusAdd(e).perform(ui.editor)),t}function fromPlusDeletion(e){var t=new Action;return t.addOp(new op.RxnPlusDelete(e)),t.perform()}function fromAtomDeletion(e){var t=new Action,r=new Array,o=ui.ctab.atoms.get(e).fragment;return ui.render.atomGetNeighbors(e).each(function(e){t.addOp(new op.BondDelete(e.bid)),1==ui.render.atomGetDegree(e.aid)&&(t.removeAtomFromSgroupIfNeeded(e.aid)&&r.push(e.aid),t.addOp(new op.AtomDelete(e.aid)))},this),t.removeAtomFromSgroupIfNeeded(e)&&r.push(e),t.addOp(new op.AtomDelete(e)),t.removeSgroupIfNeeded(r),t=t.perform(),t.mergeWith(fromFragmentSplit(o)),t}function fromBondDeletion(e){var t=new Action,r=ui.ctab.bonds.get(e),o=ui.ctab.atoms.get(r.begin).fragment,n=new Array;return t.addOp(new op.BondDelete(e)),1==ui.render.atomGetDegree(r.begin)&&(t.removeAtomFromSgroupIfNeeded(r.begin)&&n.push(r.begin),t.addOp(new op.AtomDelete(r.begin))),1==ui.render.atomGetDegree(r.end)&&(t.removeAtomFromSgroupIfNeeded(r.end)&&n.push(r.end),t.addOp(new op.AtomDelete(r.end))),t.removeSgroupIfNeeded(n),t=t.perform(),t.mergeWith(fromFragmentSplit(o)),t}function fromFragmentSplit(e){var t=new Action,r=chem.Struct.RGroup.findRGroupByFragment(ui.ctab.rgroups,e);return ui.ctab.atoms.each(function(o,n){if(n.fragment==e){var a=t.addOp((new op.FragmentAdd).perform(ui.editor)).frid,i=function(r){t.addOp(new op.AtomAttr(r,"fragment",a).perform(ui.editor)),ui.render.atomGetNeighbors(r).each(function(t){ui.ctab.atoms.get(t.aid).fragment==e&&i(t.aid)})};i(o),r&&t.mergeWith(fromRGroupFragment(r,a))}}),-1!=e&&(t.mergeWith(fromRGroupFragment(0,e)),t.addOp(new op.FragmentDelete(e).perform(ui.editor))),t}function fromFragmentAddition(e,t,r,o,n){var a=new Action;return r.each(function(e){a.addOp(new op.SGroupRemoveFromHierarchy(e)),a.addOp(new op.SGroupDelete(e))},this),t.each(function(e){a.addOp(new op.BondDelete(e))},this),e.each(function(e){a.addOp(new op.AtomDelete(e))},this),o.each(function(e){a.addOp(new op.RxnArrowDelete(e))},this),n.each(function(e){a.addOp(new op.RxnPlusDelete(e))},this),a.mergeWith(new fromFragmentSplit(-1)),a}function fromFragmentDeletion(e){e=e||ui.editor.getSelection();var t=new Action,r=new Array,o=[],n=new Action;for(e.sgroupData&&e.sgroupData.each(function(e){n.mergeWith(fromSgroupDeletion(e))},this),e.atoms.each(function(t){ui.render.atomGetNeighbors(t).each(function(t){-1==e.bonds.indexOf(t.bid)&&(e.bonds=e.bonds.concat([t.bid]))},this)},this),e.bonds.each(function(n){t.addOp(new op.BondDelete(n));var a=ui.ctab.bonds.get(n);if(-1==e.atoms.indexOf(a.begin)&&1==ui.render.atomGetDegree(a.begin)){var i=ui.ctab.atoms.get(a.begin).fragment;o.indexOf(i)<0&&o.push(i),t.removeAtomFromSgroupIfNeeded(a.begin)&&r.push(a.begin),t.addOp(new op.AtomDelete(a.begin))}if(-1==e.atoms.indexOf(a.end)&&1==ui.render.atomGetDegree(a.end)){var d=ui.ctab.atoms.get(a.end).fragment;o.indexOf(d)<0&&o.push(d),t.removeAtomFromSgroupIfNeeded(a.end)&&r.push(a.end),t.addOp(new op.AtomDelete(a.end))}},this),e.atoms.each(function(e){var n=ui.ctab.atoms.get(e).fragment;o.indexOf(n)<0&&o.push(n),t.removeAtomFromSgroupIfNeeded(e)&&r.push(e),t.addOp(new op.AtomDelete(e))},this),t.removeSgroupIfNeeded(r),e.rxnArrows.each(function(e){t.addOp(new op.RxnArrowDelete(e))},this),e.rxnPluses.each(function(e){t.addOp(new op.RxnPlusDelete(e))},this),e.chiralFlags.each(function(e){t.addOp(new op.ChiralFlagDelete(e))},this),t=t.perform();o.length>0;)t.mergeWith(new fromFragmentSplit(o.pop()));return t.mergeWith(n),t}function fromAtomMerge(e,t){var r=new Action,o=ui.render.atomGetAttr(e,"fragment"),n=ui.render.atomGetAttr(t,"fragment");o!=n&&mergeFragments(r,o,n);var a=new Action;ui.render.atomGetNeighbors(e).each(function(e){var r,o,n=ui.ctab.bonds.get(e.bid);n.begin==e.aid?(r=e.aid,o=t):(r=t,o=e.aid),t!=n.begin&&t!=n.end&&-1==ui.ctab.findBondId(r,o)&&a.addOp(new op.BondAdd(r,o,n)),a.addOp(new op.BondDelete(e.bid))},this);var i=chem.Struct.Atom.getAttrHash(ui.ctab.atoms.get(e));1==ui.render.atomGetDegree(e)&&"*"==i.get("label")&&i.set("label","C"),i.each(function(e){a.addOp(new op.AtomAttr(t,e.key,e.value))},this);var d=a.removeAtomFromSgroupIfNeeded(e);return a.addOp(new op.AtomDelete(e)),d&&a.removeSgroupIfNeeded([e]),a.perform().mergeWith(r)}function toBondFlipping(e){var t=ui.ctab.bonds.get(e),r=new Action;return r.addOp(new op.BondDelete(e)),r.addOp(new op.BondAdd(t.end,t.begin,t)).data.bid=e,r}function fromBondFlipping(e){return toBondFlipping(e).perform()}function fromTemplateOnCanvas(e,t,r){var o=new Action,n=r.molecule,a=(new op.FragmentAdd).perform(ui.editor),i={};return n.atoms.each(function(n,d){var p,m=chem.Struct.Atom.getAttrHash(d).toObject();m.fragment=a.frid,o.addOp(p=new op.AtomAdd(m,Vec2.diff(d.pp,r.xy0).rotate(t).add(e)).perform(ui.editor)),i[n]=p.data.aid}),n.bonds.each(function(e,t){o.addOp(new op.BondAdd(i[t.begin],i[t.end],t).perform(ui.editor))}),o.operations.reverse(),o.addOp(a),o}function atomAddToSGroups(e,t){var r=new Action;return util.each(e,function(e){r.addOp(new op.SGroupAtomAdd(e,t).perform(ui.editor))},this),r}function fromTemplateOnAtom(e,t,r,o,n){var a=new Action,i=o.molecule,d=ui.render,p=d.ctab,m=p.molecule,u=m.atoms.get(e),s=e,f=null,c=ui.render.atomGetSGroups(e),g=d.atomGetAttr(e,"fragment"),l={},h=i.atoms.get(o.aid).pp;if(r){if(null==t){var A=atomForNewBond(e),w=fromBondAddition({type:1},e,A.atom,A.pos);a=w[0],a.operations.reverse(),f=e=w[2]}else{var v;a.addOp(v=new op.AtomAdd({label:"C",fragment:g},new Vec2(1,0).rotate(t).add(u.pp)).perform(ui.editor)),a.addOp(new op.BondAdd(e,v.data.aid,{type:1}).perform(ui.editor)),f=e=v.data.aid,a.mergeWith(atomAddToSGroups(c,e))}var b=u;u=m.atoms.get(e);var O=n(b.pp,u.pp)-o.angle0}else null==t&&(A=atomForNewBond(e),t=n(u.pp,A.pos)),O=t-o.angle0;return i.atoms.each(function(t,r){var n=chem.Struct.Atom.getAttrHash(r).toObject();if(n.fragment=g,t==o.aid)a.mergeWith(fromAtomsAttrs(e,n,!0)),l[t]=e;else{var i;i=Vec2.diff(r.pp,h).rotate(O).add(u.pp),a.addOp(v=new op.AtomAdd(n,i).perform(ui.editor)),l[t]=v.data.aid}l[t]-0!=s-0&&l[t]-0!=f-0&&a.mergeWith(atomAddToSGroups(c,l[t]))}),i.bonds.each(function(e,t){a.addOp(new op.BondAdd(l[t.begin],l[t.end],t).perform(ui.editor))}),a.operations.reverse(),a}function fromTemplateOnBond(e,t,r,o){var n,a,i=new Action,d=t.molecule,p=ui.render,m=p.ctab,u=m.molecule,s=u.bonds.get(e),f=u.atoms.get(s.begin),c=u.atoms.get(s.end),g=Set.list(Set.intersection(Set.fromList(ui.render.atomGetSGroups(s.begin)),Set.fromList(ui.render.atomGetSGroups(s.end)))),l=d.bonds.get(t.bid),h=p.atomGetAttr(s.begin,"fragment"),A={};o?(n=d.atoms.get(l.end),a=d.atoms.get(l.begin),A[l.end]=s.begin,A[l.begin]=s.end):(n=d.atoms.get(l.begin),a=d.atoms.get(l.end),A[l.begin]=s.begin,A[l.end]=s.end);var w=r(f.pp,c.pp)-r(n.pp,a.pp),v=Vec2.dist(f.pp,c.pp)/Vec2.dist(n.pp,a.pp);n.pp;return d.atoms.each(function(e,t){var r=chem.Struct.Atom.getAttrHash(t).toObject();if(r.fragment=h,e==l.begin||e==l.end)return void i.mergeWith(fromAtomsAttrs(A[e],r,!0));var o;o=Vec2.diff(t.pp,n.pp).rotate(w).scaled(v).add(f.pp);var a=p.findClosestAtom(o,.1);if(null==a){var d;i.addOp(d=new op.AtomAdd(r,o).perform(ui.editor)),A[e]=d.data.aid,i.mergeWith(atomAddToSGroups(g,A[e]))}else A[e]=a.id,i.mergeWith(fromAtomsAttrs(A[e],r,!0))}),d.bonds.each(function(e,t){var r=u.findBondId(A[t.begin],A[t.end]);-1==r?i.addOp(new op.BondAdd(A[t.begin],A[t.end],t).perform(ui.editor)):i.mergeWith(fromBondAttrs(r,l,!1,!0))}),i.operations.reverse(),i}function fromChain(e,t,r,o){var n,a=Math.PI/6,i=Math.cos(a),d=Math.sin(a),p=new Action;n=null!=o?ui.render.atomGetAttr(o,"fragment"):p.addOp((new op.FragmentAdd).perform(ui.editor)).frid;var m=-1;return m=null!=o?o:p.addOp(new op.AtomAdd({label:"C",fragment:n},e).perform(ui.editor)).data.aid,p.operations.reverse(),r.times(function(r){var o=new Vec2(i*(r+1),1&r?0:d).rotate(t).add(e),n=ui.render.findClosestAtom(o,.1),a=fromBondAddition({},m,n?n.id:{},o);p=a[0].mergeWith(p),m=a[2]},this),p}function fromNewCanvas(e){var t=new Action;return t.addOp(new op.CanvasLoad(e)),t.perform()}function fromSgroupType(e,t){var r=ui.render,o=r.sGroupGetType(e);if(t&&t!=o){var n=util.array(r.sGroupGetAtoms(e)),a=r.sGroupGetAttrs(e),i=fromSgroupDeletion(e);return fromSgroupAddition(t,n,a,e).mergeWith(i)}return new Action}function fromSgroupAttrs(e,t){var r=new Action,o=ui.render,n=o.ctab;n.sgroups.get(e).item;return new Hash(t).each(function(t){r.addOp(new op.SGroupAttr(e,t.key,t.value))},this),r.perform()}function sGroupAttributeAction(e,t){var r=new Action;return new Hash(t).each(function(t){r.addOp(new op.SGroupAttr(e,t.key,t.value))},this),r}function fromSgroupDeletion(e){var t=new Action,r=ui.render,o=r.ctab,n=o.molecule;if("SRU"==ui.render.sGroupGetType(e)){ui.render.sGroupsFindCrossBonds();ui.render.sGroupGetNeighborAtoms(e).each(function(e){"*"==ui.render.atomGetAttr(e,"label")&&t.addOp(new op.AtomAttr(e,"label","C"))},this)}var a=n.sgroups.get(e),i=chem.SGroup.getAtoms(n,a),d=a.getAttrs();t.addOp(new op.SGroupRemoveFromHierarchy(e));for(var p=0;p<i.length;++p)t.addOp(new op.SGroupAtomRemove(e,i[p]));return t.addOp(new op.SGroupDelete(e)),t=t.perform(),t.mergeWith(sGroupAttributeAction(e,d)),t}function fromSgroupAddition(e,t,r,o,n){var a,i=new Action;for(o=o-0===o?o:ui.render.ctab.molecule.sgroups.newId(),i.addOp(new op.SGroupCreate(o,e,n)),a=0;a<t.length;a++)i.addOp(new op.SGroupAtomAdd(o,t[a]));if(i.addOp(new op.SGroupAddToHierarchy(o)),i=i.perform(),"SRU"==e){ui.render.sGroupsFindCrossBonds();var d=new Action;ui.render.sGroupGetNeighborAtoms(o).each(function(e){1==ui.render.atomGetDegree(e)&&ui.render.atomIsPlainCarbon(e)&&d.addOp(new op.AtomAttr(e,"label","*"))},this),d=d.perform(),d.mergeWith(i),i=d}return fromSgroupAttrs(o,r).mergeWith(i)}function fromRGroupAttrs(e,t){var r=new Action;return new Hash(t).each(function(t){r.addOp(new op.RGroupAttr(e,t.key,t.value))},this),r.perform()}function fromRGroupFragment(e,t){var r=new Action;return r.addOp(new op.RGroupFragment(e,t)),r.perform()}function getAnchorPosition(e){if(e.atoms.length){for(var t=1e50,r=t,o=-t,n=-r,a=0;a<e.atoms.length;a++)t=Math.min(t,e.atoms[a].pp.x),r=Math.min(r,e.atoms[a].pp.y),o=Math.max(o,e.atoms[a].pp.x),n=Math.max(n,e.atoms[a].pp.y);return new Vec2((t+o)/2,(r+n)/2)}return e.rxnArrows.length?e.rxnArrows[0].pp:e.rxnPluses.length?e.rxnPluses[0].pp:e.chiralFlags.length?e.chiralFlags[0].pp:null}function struct2Clipboard(e){console.assert(!e.isBlank(),"Empty struct");var t={atoms:e.atoms.keys(),bonds:e.bonds.keys(),rxnArrows:e.rxnArrows.keys(),rxnPluses:e.rxnPluses.keys()},r={atoms:[],bonds:[],sgroups:[],rxnArrows:[],rxnPluses:[],chiralFlags:[],rgmap:{},rgroups:{}},o={};t.atoms.each(function(t){var n=new chem.Struct.Atom(e.atoms.get(t));n.pos=n.pp,o[t]=r.atoms.push(new chem.Struct.Atom(n))-1}),t.bonds.each(function(t){var n=new chem.Struct.Bond(e.bonds.get(t));n.begin=o[n.begin],n.end=o[n.end],r.bonds.push(new chem.Struct.Bond(n))});var n=e.getSGroupsInAtomSet(t.atoms);util.each(n,function(t){for(var n=e.sgroups.get(t),a=chem.SGroup.getAtoms(e,n),i={type:n.type,attrs:n.getAttrs(),atoms:util.array(a),pp:n.pp},d=0;d<i.atoms.length;d++)i.atoms[d]=o[i.atoms[d]];r.sgroups.push(i)},this),t.rxnArrows.each(function(t){var o=new chem.Struct.RxnArrow(e.rxnArrows.get(t));o.pos=o.pp,r.rxnArrows.push(o)}),t.rxnPluses.each(function(t){var o=new chem.Struct.RxnPlus(e.rxnPluses.get(t));o.pos=o.pp,r.rxnPluses.push(o)});var a={},i=Set.empty();t.atoms.each(function(t){var r=e.atoms.get(t),o=r.fragment;a[t]=o,Set.add(i,o)});var d=Set.empty();return Set.each(i,function(t){for(var o=chem.Struct.Fragment.getAtoms(e,t),n=0;n<o.length;++n)if(!Set.contains(a,o[n]))return;var i=chem.Struct.RGroup.findRGroupByFragment(e.rgroups,t);r.rgmap[t]=i,Set.add(d,i)},this),Set.each(d,function(t){r.rgroups[t]=e.rgroups.get(t).getAttrs()},this),r}function fromPaste(e,t){for(var r=struct2Clipboard(e),o=t?Vec2.diff(t,getAnchorPosition(r)):new Vec2,n=new Action,a={},i={},d=0;d<r.atoms.length;d++){var p=Object.clone(r.atoms[d]);p.fragment in i||(i[p.fragment]=n.addOp((new op.FragmentAdd).perform(ui.editor)).frid),p.fragment=i[p.fragment],a[d]=n.addOp(new op.AtomAdd(p,p.pp.add(o)).perform(ui.editor)).data.aid}var m=[];for(var u in r.rgroups)ui.ctab.rgroups.has(u)||m.push(u);for(var s in r.rgmap)n.addOp(new op.RGroupFragment(r.rgmap[s],i[s]).perform(ui.editor));for(var f=0;f<m.length;++f)n.mergeWith(fromRGroupAttrs(m[f],r.rgroups[m[f]]));for(var c=0;c<r.bonds.length;c++){var g=Object.clone(r.bonds[c]);n.addOp(new op.BondAdd(a[g.begin],a[g.end],g).perform(ui.editor))}for(var l=0;l<r.sgroups.length;l++){for(var h=r.sgroups[l],A=h.atoms,w=[],v=0;v<A.length;v++)w.push(a[A[v]]);for(var b=ui.render.ctab.molecule.sgroups.newId(),O=fromSgroupAddition(h.type,w,h.attrs,b,h.pp?h.pp.add(o):null),S=O.operations.length-1;S>=0;S--)n.addOp(O.operations[S])}if(ui.editor.render.ctab.rxnArrows.count()<1)for(var G=0;G<r.rxnArrows.length;G++)n.addOp(new op.RxnArrowAdd(r.rxnArrows[G].pp.add(o)).perform(ui.editor));for(var D=0;D<r.rxnPluses.length;D++)n.addOp(new op.RxnPlusAdd(r.rxnPluses[D].pp.add(o)).perform(ui.editor));return n.operations.reverse(),n}function fromFlip(e,t){var r,o=ui.render,n=o.ctab,a=n.molecule,i=new Action,d={};if(e.atoms){for(r=0;r<e.atoms.length;r++){var p=e.atoms[r],m=a.atoms.get(p);m.fragment in d?d[m.fragment].push(p):d[m.fragment]=[p]}if(d=new Hash(d),d.detect(function(e){return!Set.eq(a.getFragmentIds(e[0]),Set.fromList(e[1]))}))return i;if(d.each(function(e){var r=Set.fromList(e[1]),o=a.getCoordBoundingBox(r);Set.each(r,function(e){var r=a.atoms.get(e),n=new Vec2;"horizontal"==t?n.x=o.min.x+o.max.x-2*r.pp.x:n.y=o.min.y+o.max.y-2*r.pp.y,i.addOp(new op.AtomMove(e,n))})}),e.bonds)for(r=0;r<e.bonds.length;r++){var u=e.bonds[r],s=a.bonds.get(u);s.type==chem.Struct.BOND.TYPE.SINGLE&&(s.stereo==chem.Struct.BOND.STEREO.UP?i.addOp(new op.BondAttr(u,"stereo",chem.Struct.BOND.STEREO.DOWN)):s.stereo==chem.Struct.BOND.STEREO.DOWN&&i.addOp(new op.BondAttr(u,"stereo",chem.Struct.BOND.STEREO.UP)))}}return i.perform()}function fromRotate(e,t,r){function o(e){var o=e.sub(t);return o=o.rotate(r),o.add_(t),o.sub(e)}var n=ui.render,a=n.ctab,i=a.molecule,d=new Action;return e.atoms&&e.atoms.each(function(e){var t=i.atoms.get(e);d.addOp(new op.AtomMove(e,o(t.pp)))}),e.rxnArrows&&e.rxnArrows.each(function(e){var t=i.rxnArrows.get(e);d.addOp(new op.RxnArrowMove(e,o(t.pp)))}),e.rxnPluses&&e.rxnPluses.each(function(e){var t=i.rxnPluses.get(e);d.addOp(new op.RxnPlusMove(e,o(t.pp)))}),e.sgroupData&&e.sgroupData.each(function(e){var t=i.sgroups.get(e);d.addOp(new op.SGroupDataMove(e,o(t.pp)))}),e.chiralFlags&&e.chiralFlags.each(function(e){var t=i.chiralFlags.get(e);d.addOp(new op.ChiralFlagMove(e,o(t.pp)))}),d.perform()}var Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),op=require("./op");require("../chem");var ui=global.ui,chem=global.chem;Action.prototype.addOp=function(e){return e.isDummy(ui.editor)||this.operations.push(e),e},Action.prototype.mergeWith=function(e){return this.operations=this.operations.concat(e.operations),this},Action.prototype.perform=function(){var e=new Action,t=0;return this.operations.each(function(r){e.addOp(r.perform(ui.editor)),t++},this),e.operations.reverse(),e},Action.prototype.isDummy=function(){return null==this.operations.detect(function(e){return!e.isDummy(ui.editor)},this)},Action.prototype.removeAtomFromSgroupIfNeeded=function(e){var t=ui.render.atomGetSGroups(e);return t.length>0&&(t.each(function(t){this.addOp(new op.SGroupAtomRemove(t,e))},this),!0)},Action.prototype.removeSgroupIfNeeded=function(e){var t=ui.render,r=t.ctab,o=r.molecule,n=new Hash;e.each(function(e){ui.render.atomGetSGroups(e).each(function(e){var t=n.get(e);Object.isUndefined(t)?t=1:t++,n.set(e,t)},this)},this),n.each(function(e){var t=parseInt(e.key);if(ui.render.sGroupGetAtoms(t).length==e.value){var r=o.sgroups.get(t);this.mergeWith(sGroupAttributeAction(t,r.getAttrs())),this.addOp(new op.SGroupRemoveFromHierarchy(t)),this.addOp(new op.SGroupDelete(t))}},this)},module.exports=util.extend(Action,{fromMultipleMove:fromMultipleMove,fromAtomAddition:fromAtomAddition,fromArrowAddition:fromArrowAddition,fromArrowDeletion:fromArrowDeletion,fromChiralFlagDeletion:fromChiralFlagDeletion,fromPlusAddition:fromPlusAddition,fromPlusDeletion:fromPlusDeletion,fromAtomDeletion:fromAtomDeletion,fromBondDeletion:fromBondDeletion,fromFragmentDeletion:fromFragmentDeletion,fromAtomMerge:fromAtomMerge,fromBondFlipping:fromBondFlipping,fromTemplateOnCanvas:fromTemplateOnCanvas,fromTemplateOnAtom:fromTemplateOnAtom,fromTemplateOnBond:fromTemplateOnBond,fromAtomsAttrs:fromAtomsAttrs,fromBondAttrs:fromBondAttrs,fromChain:fromChain,fromBondAddition:fromBondAddition,fromNewCanvas:fromNewCanvas,fromSgroupType:fromSgroupType,fromSgroupDeletion:fromSgroupDeletion,fromSgroupAttrs:fromSgroupAttrs,fromRGroupFragment:fromRGroupFragment,fromPaste:fromPaste,fromRGroupAttrs:fromRGroupAttrs,fromSgroupAddition:fromSgroupAddition,fromFlip:fromFlip,fromRotate:fromRotate});

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../util":39,"../util/set":42,"../util/vec2":43,"./op":35}],27:[function(require,module,exports){
(function (global){
function initDialogs(){$("input_label").observe("blur",function(){keymage.setScope("editor"),this.hide()}),$("input_label").observe("keypress",onKeyPress_InputLabel),$("input_label").observe("keyup",onKeyUp_InputLabel),$("atom_label").observe("change",onChange_AtomLabel),$("atom_charge").observe("change",onChange_AtomCharge),$("atom_isotope").observe("change",onChange_AtomIsotope),$("atom_valence").observe("change",onChange_AtomValence),$("atom_prop_cancel").observe("click",function(){ui.hideDialog("atom_properties")}),$("atom_prop_ok").observe("click",function(){applyAtomProperties()}),$("bond_prop_cancel").observe("click",function(){ui.hideDialog("bond_properties")}),$("bond_prop_ok").observe("click",function(){applyBondProperties()})}function showAtomAttachmentPoints(e){$("atom_ap1").checked=(1&(e.selection||0))>0,$("atom_ap2").checked=(2&(e.selection||0))>0,ui.showDialog("atom_attpoints");var t=new Event.Handler("atom_attpoints_ok","click",void 0,function(){t.stop(),o.stop(),ui.hideDialog("atom_attpoints"),"onOk"in e&&e.onOk(($("atom_ap1").checked?1:0)+($("atom_ap2").checked?2:0))}).start(),o=new Event.Handler("atom_attpoints_cancel","click",void 0,function(){t.stop(),o.stop(),ui.hideDialog("atom_attpoints"),"onCancel"in e&&e.onCancel()}).start();$("atom_attpoints_ok").focus()}function showAtomProperties(e){$("atom_properties").atom_id=e,$("atom_label").value=ui.render.atomGetAttr(e,"label"),onChange_AtomLabel.call($("atom_label"));var t=ui.render.atomGetAttr(e,"charge")-0;$("atom_charge").value=0==t?"":t,t=ui.render.atomGetAttr(e,"isotope")-0,$("atom_isotope").value=0==t?"":t,t=ui.render.atomGetAttr(e,"explicitValence")-0,$("atom_valence").value=t<0?"":t,$("atom_radical").value=ui.render.atomGetAttr(e,"radical"),$("atom_inversion").value=ui.render.atomGetAttr(e,"invRet"),$("atom_exactchange").value=ui.render.atomGetAttr(e,"exactChangeFlag")?1:0,$("atom_ringcount").value=ui.render.atomGetAttr(e,"ringBondCount"),$("atom_substitution").value=ui.render.atomGetAttr(e,"substitutionCount"),$("atom_unsaturation").value=ui.render.atomGetAttr(e,"unsaturatedAtom"),$("atom_hcount").value=ui.render.atomGetAttr(e,"hCount"),ui.showDialog("atom_properties"),$("atom_label").activate()}function applyAtomProperties(){ui.hideDialog("atom_properties");var e=$("atom_properties").atom_id;ui.addUndoAction(Action.fromAtomsAttrs(e,{label:$("atom_label").value,charge:""==$("atom_charge").value?0:parseInt($("atom_charge").value,10),isotope:""==$("atom_isotope").value?0:parseInt($("atom_isotope").value,10),explicitValence:""==$("atom_valence").value?-1:parseInt($("atom_valence").value,10),radical:parseInt($("atom_radical").value,10),invRet:parseInt($("atom_inversion").value,10),exactChangeFlag:!!parseInt($("atom_exactchange").value,10),ringBondCount:parseInt($("atom_ringcount").value,10),substitutionCount:parseInt($("atom_substitution").value,10),unsaturatedAtom:parseInt($("atom_unsaturation").value,10),hCount:parseInt($("atom_hcount").value,10)}),!0),ui.render.update()}function onChange_AtomLabel(){this.value=this.value.strip().capitalize();var e=element.getElementByLabel(this.value);null==e&&"A"!==this.value&&"*"!==this.value&&"Q"!==this.value&&"X"!==this.value&&"R"!==this.value&&(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"label"),"A"!==this.value&&"*"!==this.value&&(e=element.getElementByLabel(this.value))),"A"==this.value||"*"==this.value?$("atom_number").value="any":$("atom_number").value=e?e.toString():""}function onChange_AtomCharge(){""===this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,1}[-+]$/)?this.value=(this.value.endsWith("-")?"-":"")+this.value.substr(0,this.value.length-1):this.value.match(/^[+-]?[1-9][0-9]{0,1}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"charge"))}function onChange_AtomIsotope(){this.value==util.getElementTextContent($("atom_number"))||""==this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"isotope"))}function onChange_AtomValence(){}function showBondProperties(e){var t;$("bond_properties").bond_id=e;var o=ui.render.bondGetAttr(e,"type"),a=ui.render.bondGetAttr(e,"stereo");for(t in ui.bondTypeMap)if(ui.bondTypeMap[t].type==o&&ui.bondTypeMap[t].stereo==a)break;$("bond_type").value=t,$("bond_topology").value=ui.render.bondGetAttr(e,"topology")||0,$("bond_center").value=ui.render.bondGetAttr(e,"reactingCenterStatus")||0,ui.showDialog("bond_properties"),$("bond_type").activate()}function applyBondProperties(){ui.hideDialog("bond_properties");var e=$("bond_properties").bond_id,t=Object.clone(ui.bondTypeMap[$("bond_type").value]);t.topology=parseInt($("bond_topology").value,10),t.reactingCenterStatus=parseInt($("bond_center").value,10),ui.addUndoAction(Action.fromBondAttrs(e,t),!0),ui.render.update()}function showAutomapProperties(e){ui.showDialog("automap_properties");var t,o;t=new Event.Handler("automap_ok","click",void 0,function(){t.stop(),o.stop(),e&&"onOk"in e&&e.onOk($("automap_mode").value),ui.hideDialog("automap_properties")}).start(),o=new Event.Handler("automap_cancel","click",void 0,function(){t.stop(),o.stop(),ui.hideDialog("automap_properties"),e&&"onCancel"in e&&e.onCancel()}).start(),$("automap_mode").activate()}function showRLogicTable(e){var t=e||{};t.rlogic=t.rlogic||{},$("rlogic_occurrence").value=t.rlogic.occurrence||">0",$("rlogic_resth").value=t.rlogic.resth?"1":"0";for(var o='<option value="0">Always</option>',a=1;a<=32;a++)a!=t.rgid&&0!=(t.rgmask&1<<a-1)&&(o+='<option value="'+a+'">IF R'+t.rgid+" THEN R"+a+"</option>");$("rlogic_if").outerHTML='<select id="rlogic_if">'+o+"</select>",$("rlogic_if").value=t.rlogic.ifthen,ui.showDialog("rlogic_table");var i=new Event.Handler("rlogic_ok","click",void 0,function(){var e={occurrence:$("rlogic_occurrence").value.replace(/\s*/g,"").replace(/,+/g,",").replace(/^,/,"").replace(/,$/,""),resth:"1"==$("rlogic_resth").value,ifthen:parseInt($("rlogic_if").value,10)};t&&"onOk"in t&&!t.onOk(e)||(i.stop(),n.stop(),ui.hideDialog("rlogic_table"))}).start(),n=new Event.Handler("rlogic_cancel","click",void 0,function(){i.stop(),n.stop(),ui.hideDialog("rlogic_table"),t&&"onCancel"in t&&t.onCancel()}).start();$("rlogic_occurrence").activate()}function onKeyPress_Dialog(e){if(util.stopEventPropagation(e),27===e.keyCode)return ui.hideDialog(this.id),util.preventDefault(e)}function onKeyPress_InputLabel(e){if(util.stopEventPropagation(e),13==e.keyCode){keymage.setScope("editor"),this.hide();var t="",o=0,a=this.value.toArray();if("*"==this.value)t="A";else if(this.value.match(/^[*][1-9]?[+-]$/i))t="A",o=2==this.value.length?1:parseInt(a[1]),"-"==a[2]&&(o*=-1);else if(this.value.match(/^[A-Z]{1,2}$/i))t=this.value.capitalize();else if(this.value.match(/^[A-Z]{1,2}[0][+-]?$/i))t=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():a[0].capitalize();else if(this.value.match(/^[A-Z]{1,2}[1-9]?[+-]$/i)){t=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():a[0].capitalize();var i=this.value.match(/[0-9]/i);o=null!=i?parseInt(i[0]):1,"-"==a[this.value.length-1]&&(o*=-1)}return"A"!=t&&"Q"!=t&&"X"!=t&&"R"!=t&&null==element.getElementByLabel(t)||(ui.addUndoAction(Action.fromAtomsAttrs(this.atom_id,{label:t,charge:o}),!0),ui.render.update()),util.preventDefault(e)}if(27==e.keyCode)return this.hide(),keymage.setScope("editor"),util.preventDefault(e)}function onKeyUp_InputLabel(e){if(util.stopEventPropagation(e),27==e.keyCode)return this.hide(),keymage.setScope("editor"),util.preventDefault(e)}function showLabelEditor(e){var t=$("input_label");keymage.setScope("label");var o=Math.min(7*ui.render.zoom,16);t.atom_id=e,t.value=ui.render.atomGetAttr(e,"label"),t.style.fontSize=2*o+"px",t.show();var a=ui.render.obj2view(ui.render.atomGetPos(e)),i={left:0,top:0},n=Element.cumulativeOffset(t.offsetParent);t.style.left=a.x+i.left-n.left-o-0+"px",t.style.top=a.y+i.top-n.top-o-0+"px",t.activate()}var keymage=require("keymage"),element=require("../../chem/element"),util=require("../../util"),Action=require("../action"),ui=global.ui;module.exports={initDialogs:initDialogs,showAtomAttachmentPoints:showAtomAttachmentPoints,showAtomProperties:showAtomProperties,showBondProperties:showBondProperties,showAutomapProperties:showAutomapProperties,showRLogicTable:showRLogicTable,showLabelEditor:showLabelEditor};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../chem/element":10,"../../util":39,"../action":26,"keymage":2}],28:[function(require,module,exports){
(function (global){
function dialog(e){var n,i=ui.showDialog("open-file"),t=i.select("input[value=OK]")[0],o=i.select("textarea")[0],l=i.select("input[type=file]")[0],a=i.select("input[name=fragment]")[0],r=[];r[0]=i.on("click","input[type=button]",function(n,i){r.forEach(function(e){e.stop()}),ui.hideDialog("open-file");var t="on"+i.value.capitalize();e&&t in e&&e[t]({fragment:a.checked,value:o.value})}),r[1]=l.on("change",function(e,t){console.assert(n,"No valid file opener"),t.files.length&&(i.select("input").each(function(e){e.disabled=!0}),n(t.files[0]).then(function(e){o.value=e,i.select("input").each(function(e){e.disabled=!1})},ui.echo))}),r[2]=o.on("input",function(e,n){var i=o.value.trim();t.disabled=!i}),o.value="",a.checked=!1,t.disabled=!0,l.disabled=!0,l.parentNode.addClassName("disabled"),fileOpener().then(function(e){n=e,l.disabled=!1,l.parentNode.removeClassName("disabled")})}function fileOpener(){function e(e){return new Promise(function(n,i){var t=new FileReader;t.onload=function(e){n(e.target.result)},t.onerror=function(e){i(e)},t.readAsText(e,"UTF-8")})}function n(e,n){var i=e.OpenTextFile(n.name,1),t=i.ReadAll();return i.Close(),t}function i(e){}return new Promise(function(t,o){if(global.FileReader)return t(e);if(global.ActiveXObject)try{var l=new global.ActiveXObject("Scripting.FileSystemObject");return t(function(e){return Promise.resolve(n(l,e))})}catch(e){}return ui.standalone?o("Standalone mode!"):t(i)})}function loadHook(){}var Promise=require("promise-polyfill"),ui=global.ui;dialog.loadHook=loadHook,module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"promise-polyfill":3}],29:[function(require,module,exports){
(function (global){
function saveDialog(e,l){function i(e,l){l=l||"mol",n.value=e,n.className=l,n.activate()}var a,o=ui.showDialog("save-file"),n=o.select("textarea")[0],t=o.select("select")[0],c=o.select(".save")[0],s=[];s[0]=o.on("click","input[type=button]",function(l,i){s.forEach(function(e){e.stop()}),ui.hideDialog("save-file");var a="on"+i.value.capitalize();e&&a in e&&e[a]({})}),s[1]=t.on("change",function(a,o){var n=t.value;convertMolecule(l,e.molecule,n).then(function(e){i(e,n)},ui.echo)}),s[2]=c.on("click",function(e){a&&(a(n.value,t.value),o.select("input[type=button]")[0].click()),e.preventDefault()}),i((new chem.MolfileSaver).saveMolecule(e.molecule)),c.addClassName("disabled"),fileSaver(l).then(function(e){a=e,c.removeClassName("disabled")}),t.select("[value=inchi]")[0].disabled=ui.standalone}function fileSaver(e){var l={smi:"chemical/x-daylight-smiles",mol:"chemical/x-mdl-molfile",rxn:"chemical/x-mdl-rxnfile",inchi:"chemical/x-inchi"};return new Promise(function(i,a){global.Blob&&fs.saveAs?i(function(e,i){"mol"==i&&0==e.indexOf("$RXN")&&(i="rxn"),console.assert(l[i],"Unknown chemical file type");var a=new Blob([e],{type:l[i]});fs.saveAs(a,"ketcher."+i)}):ui.standalone?a("Standalone mode!"):i(function(l,i){e.save({filedata:[i,l].join("\n")})})})}function convertMolecule(e,l,i){return new Promise(function(a,o){var n=(new chem.MolfileSaver).saveMolecule(l);if("mol"==i)a(n);else if("smi"==i)a(ui.standalone?(new chem.SmilesSaver).saveMolecule(l):e.smiles({moldata:n}));else if("inchi"==i){if(ui.standalone)throw Error("InChI is not supported in the standalone mode");0!==l.rgroups.count()&&ui.echo("R-group fragments are not supported and will be discarded"),l=l.getScaffold(),0===l.atoms.count()?a(""):(l=l.clone(),l.sgroups.each(function(e,l){if("MUL"!=l.type&&!/^INDIGO_.+_DESC$/i.test(l.data.fieldName))throw Error("InChi data format doesn't support s-groups")}),a(e.inchi({moldata:n})))}})}var Promise=require("promise-polyfill"),fs=require("filesaver.js");require("../../chem");var chem=global.chem,ui=global.ui;module.exports=saveDialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../chem":11,"filesaver.js":1,"promise-polyfill":3}],30:[function(require,module,exports){
(function (global){
function dialog(e,n){function t(e){a.select(".selected").each(function(e){e.removeClassName("selected")}),e?a.select("button").each(function(n){var t=n.value||n.textContent||n.innerText;e.indexOf(t)>=0&&n.addClassName("selected")}):n.required&&(i.disabled=!0)}function l(){var e=[];return a.select(".selected").each(function(n){var t=n.value||n.textContent||n.innerText;e.push(t)}),e}var a=ui.showDialog(e),i=a.select("input[value=OK]")[0],c=n.mode||"single",o=[];o[0]=a.on("click","input[type=button]",function(t,a){o.forEach(function(e){e.stop()}),ui.hideDialog(e);var i="on"+a.value.capitalize();console.assert("onOk"!=i||!n.required||0!=l().length,"No elements selected"),n&&i in n&&n[i]({mode:c,values:l()})}),o[1]=a.on("click","button",function(e,l){"single"===c&&(l.hasClassName("selected")?n.required&&i.click():t(null)),l.toggleClassName("selected"),n.required&&(i.disabled=0===a.select(".selected").length),e.stop()}),o[2]=a.on("click","input[name=mode]",function(e,n){n.value!=c&&("single"==n.value&&t(null),c=n.value)}),t(n.values),a.select("input[name=mode]").each(function(e){e.value==c&&(e.checked=!0)})}var ui=global.ui;module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],31:[function(require,module,exports){
(function (global){
function dialog(e){var t=ui.showDialog("sgroup_special"),a={},l=[];console.assert(!e.type||"DAT"==e.type),console.assert(!e.type||e.attrs.fieldName),setContext(e.type&&matchContext(e.attrs.fieldName,e.attrs.fieldValue)||e.context||"Fragment",a,!0),e.attrs.fieldName&&setField(e.attrs.fieldName,a,!0),$("sgroup_special_value").value=e.attrs.fieldValue,e.attrs.attached?$("sgroup_special_attached").checked=!0:e.attrs.absolute?$("sgroup_special_absolute").checked=!0:$("sgroup_special_relative").checked=!0,l[0]=t.on("click","input[type=button]",function(t,a){var n="on"+a.value.capitalize(),i="onOk"!=n||getValidateAttrs();i&&(l.forEach(function(e){e.stop()}),ui.hideDialog("sgroup_special"),n in e&&i&&e[n](i))}),l[1]=t.on("change","select",function(e,t){"sgroup_context"==t.id&&setContext($("sgroup_context").value,a),"sgroup_special_name"==t.id&&setField($("sgroup_special_name").value,a)})}function getValidateAttrs(){var e={mul:null,connectivity:"",name:"",subscript:""};return e.fieldName=$("sgroup_special_name").value.strip(),e.fieldValue=$("sgroup_special_value").value.strip(),e.absolute=$("sgroup_special_absolute").checked,e.attached=$("sgroup_special_attached").checked,""==e.fieldValue?(alert("Please, specify data field value."),null):{type:"DAT",attrs:e}}function setContext(e,t,a){if(console.info("set context:",e,t),console.assert(t.context||a,"Field setup should be forced"),a||e!=t.context.name){t.context=util.find(special_choices,function(t){return t.name==e}),console.assert(t.context,"Can't find such context");var l=t.context.value.reduce(function(e,t){return e+'<option value="'+t.name+'">'+t.name+"</option>"},"");$("sgroup_special_name").update(l),setField(t.context.value[0].name,t,!0),a&&($("sgroup_context").value=e)}}function setField(e,t,a){if(console.info("set field:",e,t),console.assert(t.field||a,"Field setup should be forced"),e||e!=t.field.name){if(t.field=util.find(t.context.value,function(t){return t.name==e}),console.assert(t.field,"Can't find such field"),t.field.value){var l=t.field.value.reduce(function(e,t){return e+'<option value="'+t+'">'+t+"</option>"},"");$("sgroup_special_value").outerHTML='<select size="10" id="sgroup_special_value">'+l+"</select>"}else $("sgroup_special_value").outerHTML='<textarea id="sgroup_special_value"></textarea>';$("sgroup_special_name").value=e}}function matchContext(e,t){console.info("search:",util.unicodeLiteral(e),util.unicodeLiteral(t));var a=util.find(special_choices,function(a){var l=util.find(a.value,function(t){return t.name==e});return!!l&&(!t||!l.value||!!util.find(l.value,function(e){return e==t}))});return a&&a.name}var util=require("../../util"),ui=global.ui,special_choices=[{name:"Fragment",value:[{name:"MDLBG_FRAGMENT_STEREO",value:["abs","(+)-enantiomer","(-)-enantiomer","steric","rel","R(a)","S(a)","R(p)","S(p)"]},{name:"MDLBG_FRAGMENT_COEFFICIENT",value:null},{name:"MDLBG_FRAGMENT_CHARGE",value:null},{name:"MDLBG_FRAGMENT_RADICALS",value:null}]},{name:"Single Bond",value:[{name:"MDLBG_STEREO_KEY",value:["erythro","threo","alpha","beta","endo","exo","anti","syn","ECL","STG"]},{name:"MDLBG_BOND_KEY",value:["Value=4"]}]},{name:"Atom",value:[{name:"MDLBG_STEREO_KEY",value:["RS","SR","P-3","P-3-PI","SP-4","SP-4-PI","T-4","T-4-PI","SP-5","SP-5-PI","TB-5","TB-5-PI","OC-6","TB-5-PI","TP-6","PB-7","CU-8","SA-8","DD-8","HB-9","TPS-9","HB-9"]}]},{name:"Group",value:[{name:"MDLBG_STEREO_KEY",value:["cis","trans"]}]}];dialog.match=function(e){return!e.type||"DAT"==e.type&&!!matchContext(e.attrs.fieldName,e.attrs.fieldValue)},module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../util":39}],32:[function(require,module,exports){
(function (global){
function dialog(e){var a=ui.showDialog("sgroup_properties"),t=e.type||"GEN";switch($("sgroup_type").value=t,$("sgroup_type").activate(),onChange_SGroupType.call($("sgroup_type")),t){case"SRU":$("sgroup_connection").value=e.attrs.connectivity,$("sgroup_label").value=e.attrs.subscript;break;case"MUL":$("sgroup_label").value=e.attrs.mul;break;case"SUP":$("sgroup_label").value=e.attrs.name;break;case"DAT":$("sgroup_field_name").value=e.attrs.fieldName,$("sgroup_field_value").value=e.attrs.fieldValue,e.attrs.attached?$("sgroup_pos_attached").checked=!0:e.attrs.absolute?$("sgroup_pos_absolute").checked=!0:$("sgroup_pos_relative").checked=!0}"DAT"!=t&&($("sgroup_field_name").value="",$("sgroup_field_value").value="");var s=[];s[0]=a.on("click","input[type=button]",function(a,t){var l="on"+t.value.capitalize(),u="onOk"!=l||getValidateAttrs();u&&(s.forEach(function(e){e.stop()}),ui.hideDialog("sgroup_properties"),l in e&&u&&e[l](u))}),s[1]=$("sgroup_type").on("change",onChange_SGroupType),s[2]=$("sgroup_label").on("change",onChange_SGroupLabel)}function getValidateAttrs(){var e=$("sgroup_type").value,a={mul:null,connectivity:"",name:"",subscript:"",fieldName:"",fieldValue:"",attached:!1,absolute:!1};switch(e){case"SRU":if(a.connectivity=$("sgroup_connection").value.strip(),a.subscript=$("sgroup_label").value.strip(),1!=a.subscript.length||!a.subscript.match(/^[a-zA-Z]$/))return alert(a.subscript.length?"SRU subscript should consist of a single letter.":"Please provide an SRU subscript."),null;break;case"MUL":a.mul=parseInt($("sgroup_label").value);break;case"SUP":if(a.name=$("sgroup_label").value.strip(),!a.name)return alert("Please provide a name for the superatom."),null;break;case"DAT":if(a.fieldName=$("sgroup_field_name").value.strip(),a.fieldValue=$("sgroup_field_value").value.strip(),a.absolute=$("sgroup_pos_absolute").checked,a.attached=$("sgroup_pos_attached").checked,""==a.fieldName||""==a.fieldValue)return alert("Please, specify data field name and value."),null}return{type:e,attrs:a}}function onChange_SGroupLabel(){"MUL"!=$("sgroup_type").value||this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value="1")}function onChange_SGroupType(){var e=$("sgroup_type").value;if("DAT"==e)return $$("#sgroup_properties .base")[0].hide(),void $$("#sgroup_properties .data")[0].show();$$("#sgroup_properties .base")[0].show(),$$("#sgroup_properties .data")[0].hide(),$("sgroup_label").disabled="SRU"!=e&&"MUL"!=e&&"SUP"!=e,$("sgroup_connection").disabled="SRU"!=e,"MUL"!=e||$("sgroup_label").value.match(/^[1-9][0-9]{0,2}$/)?"SRU"==e?$("sgroup_label").value="n":"GEN"!=e&&"SUP"!=e||($("sgroup_label").value=""):$("sgroup_label").value="1"}var ui=global.ui;module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],33:[function(require,module,exports){
(function (global){
function parseSdf(e){var t=e.split(/^[$][$][$][$]$/m),i=[];return t.each(function(e){e=e.replace(/\r/g,""),e=e.strip();var t=e.indexOf("M  END");if(-1!=t){var n={};n.molfile=e.substring(0,t+6),n.name=e.substring(0,e.indexOf("\n")).strip(),e=e.substr(t+7).strip();e.split(/^$/m).each(function(e){if(e=e.strip(),e.startsWith("> <")){var t=e.split("\n"),i=t[0].strip().substring(3,t[0].lastIndexOf(">")).strip();n[i]=parseInt(t[1].strip())||t[1].strip()}}),i.push(n)}}),i}function fetchTemplateCustom(e){return ajax(e+"templates.sdf").then(function(e){var t=parseSdf(e.responseText),i=[],n=0;return t.each(function(e){i.push({name:(e.name||"customtemplate "+ ++n).capitalize(),molfile:e.molfile,aid:(e.atomid||1)-1,bid:(e.bondid||1)-1})}),i})}function initTemplateCustom(e,t){return fetchTemplateCustom(t).then(function(t){return custom_templates=t,eachAsync(t,function(t,i){var n=new Element("li");n.title=t.name,e.insert({bottom:n});var a=chem.Molfile.parseCTFile(t.molfile),l=new rnd.Render(n,0,{autoScale:!0,autoScaleMargin:0,ignoreMouseEvents:!0,hideChiralFlag:!0,maxBondLength:30});l.setMolecule(a),l.update()},50)})}function eachAsync(e,t,i,n){return new Promise(function(a){function l(){s<o?(t(e[s],s++),setTimeout(l,i)):a()}var s=0,o=e.length;setTimeout(l,n||i)})}function dialog(e,t){var i=ui.showDialog("custom_templates"),n=i.select(".selected")[0],a=i.select("[value=OK]")[0],l=i.select("ul")[0];if(0===l.children.length){$("loading").style.display="",i.addClassName("loading");initTemplateCustom(l,e).then(function(){$("loading").style.display="none",i.removeClassName("loading")}).then(function(){a.disabled=!0,i.on("click","li",function(e,t){n==t?a.click():(n?n.removeClassName("selected"):a.disabled=!1,t.addClassName("selected"),n=t)}),i.on("click","input",function(e,i){var a,l=i.value,s="on"+i.value.capitalize();if("OK"==l){console.assert(n,"No element selected");var o=n.previousSiblings().size();a=custom_templates[o]}ui.hideDialog("custom_templates"),t&&s in t&&t[s](a)})})}}var Promise=require("promise-polyfill");require("../../chem"),require("../../rnd");var ajax=require("../../util/ajax.js"),ui=global.ui,rnd=global.rnd,chem=global.chem,custom_templates;module.exports=dialog;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../../chem":11,"../../rnd":21,"../../util/ajax.js":37,"promise-polyfill":3}],34:[function(require,module,exports){
(function (global){
function init(e,t){ketcherWindow=$$("[role=application]")[0]||$$("body")[0],toolbar=ketcherWindow.select("[role=toolbar]")[0],clientArea=$("canvas"),server=t,updateServerButtons(),server&&server.knocknock().then(function(e){ui.standalone=!1,updateServerButtons()},function(e){document.title+=" (standalone)"}).then(function(){e.mol&&loadMolecule(e.mol)}),obsolete.initDialogs();var o={};toolbar.select("button").each(function(e){var t=e.textContent||e.innerText,n=e.dataset?e.dataset.keys:e.getAttribute("data-keys");if(n){var r=n.split(",").map(function(e){return e.strip()}),i=shortcutStr(r[0]),l=e.parentNode.id;e.title=(e.title||t)+" ("+i+")",e.innerHTML+=" <kbd>"+i+"</kbd>",r.forEach(function(e){var t=e.toLowerCase();Array.isArray(o[t])?o[t].push(l):o[t]=[l]})}else e.title=e.title||t}),o=util.extend(o,{a:["atom-any"],"defmod-a":["select-all"],"defmod-shift-a":["deselect-all"],"ctrl-alt-r":["force-update"]}),Object.keys(o).forEach(function(e){keymage("editor",e,1==o[e].length?function(t){var n=o[e][0];-1==clipActions.indexOf(n)&&(selectAction(o[e][0]),t.preventDefault())}:function(){console.info("actions",o[e])})}),keymage.setScope("editor"),toolbar.select("li").each(function(e){e.on("click",function(e){"BUTTON"==e.target.tagName&&e.target.parentNode==this&&(this.hasClassName("selected")||e.stop(),selectAction(this.id)),hideBlurredControls()?e.stop():"hidden"==this.getStyle("overflow")&&(this.addClassName("opened"),dropdownOpened=this,e.stop())})}),initCliparea(ketcherWindow),initZoom(),updateHistoryButtons(),clientArea.on("scroll",onScroll_ClientArea),clientArea.on("mousedown",function(){keymage.setScope("editor")});var n=new rnd.RenderOptions(e);n.atomColoring=!0,ui.render=new rnd.Render(clientArea,SCALE,n),ui.editor=new rnd.Editor(ui.render),ui.render.onCanvasOffsetChanged=onOffsetChanged,selectAction("select-lasso"),setScrollOffset(0,0),ui.render.setMolecule(ui.ctab),ui.render.update()}function shortcutStr(e){var t=navigator.platform.toUpperCase().indexOf("MAC")>=0;return e.replace(/Defmod/g,t?"":"Ctrl").replace(/-(?!$)/g,"+")}function subEl(e){return $(e).children[0]}function hideBlurredControls(){if(!dropdownOpened)return!1;dropdownOpened.removeClassName("opened");var e=dropdownOpened.select(".selected");if(1==e.length){var t=subEl(dropdownOpened);t.style.marginTop=-e[0].offsetTop+t.offsetTop+"px"}return clientArea.style.visibility="hidden",setTimeout(function(){clientArea.style.visibility="visible"},0),dropdownOpened=null,!0}function selectAction(e){e=e||lastSelected;var t=$(e),o=[].slice.call(arguments,1);if(console.assert(e.startsWith,"id is not a string",e),-1!=clipActions.indexOf(e)&&0==o.length)return delegateCliparea(e);if(!t||!subEl(t).disabled){o.unshift(e);var n=mapTool.apply(null,o);if(n instanceof rnd.Editor.EditorTool){var r=toolbar.select(".selected")[0];t==r&&t||(ui.render.current_tool&&ui.render.current_tool.OnCancel(),ui.render.current_tool=n,e.startsWith("select-")&&(lastSelected=e),t&&t.addClassName("selected"),r&&r.removeClassName("selected"))}return n}return null}function delegateCliparea(e){var t=document.queryCommandSupported(e);if(t)try{document.execCommand(e)}catch(e){t=!1}if(!t){var o=subEl(e);echo("These action is unavailble via menu.\nInstead, use "+shortcutStr(o.dataset?o.dataset.keys:o.getAttribute("data-keys"))+" to "+e+".")}return null}function initCliparea(e){var t=new Element("input",{type:"text",class:"cliparea",autofocus:!0}),o=window.clipboardData,n=["chemical/x-mdl-molfile","chemical/x-mdl-rxnfile","chemical/x-cml","text/plain","chemical/x-daylight-smiles","chemical/x-inchi"],r=function(){return"editor"==keymage.getScope()&&(t.value=" ",t.focus(),t.select(),!0)},i=function(e,t){var n=(new chem.MolfileSaver).saveMolecule(e);if(!t&&o)o.setData("text",n);else{t.setData("text/plain",n);try{t.setData(e.isReaction?"chemical/x-mdl-rxnfile":"chemical/x-mdl-molfile",n),t.setData("chemical/x-daylight-smiles",(new chem.SmilesSaver).saveMolecule(e))}catch(e){console.info("Could not write exact type",e)}}},l=function(e){var t="";if(!e&&o)t=o.getData("text");else for(var r=0;r<n.length&&!(t=e.getData(n[r]));r++);return console.info("paste",r>=0&&n[r],t.slice(0,50),".."),t};e.insert(t),e.on("mouseup",r),["copy","cut"].forEach(function(t){e.on(t,function(e){if(r()){var o=selectAction(t,!0);o&&i(o,e.clipboardData),e.preventDefault()}})}),e.on("paste",function(e){if(r()){var t=l(e.clipboardData);t&&loadFragment(t),e.preventDefault()}})}function updateClipboardButtons(){subEl("copy").disabled=subEl("cut").disabled=!ui.editor.hasSelection(!0)}function updateHistoryButtons(){subEl("undo").disabled=0==undoStack.length,subEl("redo").disabled=0==redoStack.length}function updateServerButtons(){serverActions.forEach(function(e){subEl(e).disabled=ui.standalone})}function transitionEndEvent(){var e,t=document.createElement("transitionTest"),o={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(e in o)if(void 0!==t.style[e])return o[e];return!1}function animateToggle(e,t){ketcherWindow.addClassName("animate");var o=transitionEndEvent(),n=function(e){setTimeout(function(){e&&e(),ketcherWindow.removeClassName("animate")},0)};if(t&&o){var r=function(){n(t),e.removeEventListener(o,r,!1)};e.addEventListener(o,r,!1)}else n(t),t||e()}function showDialog(e){var t=$(e);return keymage.setScope("dialog"),animateToggle(function(){$$(".overlay")[0].show(),t.style.display=""}),t}function hideDialog(e){var t=$$(".overlay")[0];animateToggle(t,function(){$(e).style.display="none",t.hide(),keymage.setScope("editor")})}function showElemTable(e){e.required=!0,selectDialog("elem-table",e)}function showRGroupTable(e){selectDialog("rgroup-table",e)}function showReaGenericsTable(e){e.required=!0,selectDialog("generics-table",e)}function echo(e){alert(e)}function updateMolecule(e){if(void 0!==e&&null!=e){ui.editor.deselectAll(),addUndoAction(Action.fromNewCanvas(e)),showDialog("loading");try{ui.render.onResize(),ui.render.update(),setZoomCentered(null,ui.render.getStructCenter())}catch(e){alert(e.message)}finally{hideDialog("loading")}}}function addUndoAction(e,t){null!=e&&(1==t&&e.isDummy()||(undoStack.push(e),redoStack.clear(),undoStack.length>HISTORY_LENGTH&&undoStack.splice(0,1),updateHistoryButtons()))}function onClick_NewFile(){selectAction(null),ui.ctab.isBlank()||(addUndoAction(Action.fromNewCanvas(new chem.Struct)),ui.render.update())}function onClick_OpenFile(){openDialog({onOk:function(e){e.fragment?loadFragment(e.value,!0):loadMolecule(e.value,!0)}})}function onClick_SaveFile(){saveDialog({molecule:ui.ctab},server)}function aromatize(e,t){e=e.clone();var o=e.addRxnArrowIfNecessary(),n=(new chem.MolfileSaver).saveMolecule(e);if(ui.standalone)throw new Error("Aromatization and dearomatization are not supported in the standalone mode.");server[t?"aromatize":"dearomatize"]({moldata:n}).then(function(e){var t=parseMayBeCorruptedCTFile(e);o&&t.rxnArrows.clear(),updateMolecule(t)},echo)}function calculateCip(){util.assert(!ui.standalone,"Can't calculate in standalone mode!");var e=ui.ctab.clone(),t=e.addRxnArrowIfNecessary(),o=(new chem.MolfileSaver).saveMolecule(e);server.calculateCip({moldata:o}).then(function(e){var o=parseMayBeCorruptedCTFile(e);t&&o.rxnArrows.clear(),updateMolecule(o)},echo)}function initZoom(){var e=subEl("zoom-list");e.on("focus",function(){keymage.pushScope("zoom")}),e.on("blur",function(){keymage.popScope("zoom")}),e.on("change",updateZoom),updateZoom(!0)}function onClick_ZoomIn(){subEl("zoom-list").selectedIndex++,updateZoom()}function onClick_ZoomOut(){subEl("zoom-list").selectedIndex--,updateZoom()}function updateZoom(e){var t=subEl("zoom-list"),o=t.selectedIndex,n=t.length;console.assert(0<=o&&o<n,"Zoom out of range"),subEl("zoom-in").disabled=o==n-1,subEl("zoom-out").disabled=0==o;var r=parseFloat(t.options[o].innerHTML)/100;ui.zoom=r,e||(setZoomCentered(r,ui.render.getStructCenter(ui.editor.getSelection())),ui.render.update())}function setZoomRegular(e){e<.1||e>10||(ui.zoom=e,ui.render.setZoom(ui.zoom))}function getViewSz(){return new Vec2(ui.render.viewSz)}function setZoomCentered(e,t){if(!t)throw new Error("Center point not specified");e&&setZoomRegular(e),setScrollOffset(0,0);var o=ui.render.obj2view(t).sub(ui.render.viewSz.scaled(.5));setScrollOffset(o.x,o.y)}function setZoomStaticPointInit(e){zspObj=new Vec2(e)}function setZoomStaticPoint(e,t){setZoomRegular(e),setScrollOffset(0,0);var o=ui.render.obj2view(zspObj),n=o.sub(t);setScrollOffset(n.x,n.y)}function setScrollOffset(e,t){var o=clientArea.clientWidth,n=clientArea.clientHeight;ui.render.extendCanvas(e,t,o+e,n+t),clientArea.scrollLeft=e,clientArea.scrollTop=t,scrollLeft=clientArea.scrollLeft,scrollTop=clientArea.scrollTop}function setScrollOffsetRel(e,t){setScrollOffset(clientArea.scrollLeft+e,clientArea.scrollTop+t)}function onClick_CleanUp(){var e=util.array(ui.editor.getSelection(!0).atoms),t=e.length>0;if(t){var o=Set.fromList(e),n=Set.empty();ui.ctab.loops.each(function(e,t){util.findIndex(t.hbs,function(e){return Set.contains(o,ui.ctab.halfBonds.get(e).begin)})>=0&&util.each(t.hbs,function(e){Set.add(n,ui.ctab.halfBonds.get(e).begin)},this)},this),Set.mergeIn(n,o),e=Set.list(n)}ui.editor.deselectAll();try{var r={},i=ui.ctab.clone(null,null,!1,r);t&&util.each(e,function(e){e=r[e];var t=new chem.SGroup("DAT"),o=i.sgroups.add(t);t.id=o,t.pp=new Vec2,t.data.fieldName="_ketcher_selective_layout",t.data.fieldValue="1",i.atomAddToSGroup(o,e)},this);var l=i.addRxnArrowIfNecessary();server.layout({moldata:(new chem.MolfileSaver).saveMolecule(i)},t?{selective:1}:null).then(function(e){var t=parseMayBeCorruptedCTFile(e);l&&t.rxnArrows.clear(),updateMolecule(t)})}catch(e){alert("ERROR: "+e.message)}}function onClick_Aromatize(){try{aromatize(ui.ctab,!0)}catch(e){alert("Molfile: "+e.message)}}function onClick_Dearomatize(){try{aromatize(ui.ctab,!1)}catch(e){alert("Molfile: "+e.message)}}function onClick_Automap(){obsolete.showAutomapProperties({onOk:function(e){var t=ui.ctab,o=t.addRxnArrowIfNecessary();if(0==t.rxnArrows.count())return void echo("Auto-Mapping can only be applied to reactions");var n=(new chem.MolfileSaver).saveMolecule(t,!0);server.automap({moldata:n,mode:e}).then(function(e){var t=parseMayBeCorruptedCTFile(e);o&&t.rxnArrows.clear(),updateMolecule(t)},echo)}})}function loadMolecule(e,t){return getStruct(e,t).then(updateMolecule)}function loadFragment(e,t){return getStruct(e,t).then(function(e){e.rescale(),selectAction("paste",e)})}function guessType(e,t){var o=e.trim(),n=o.match(/^(M  END|\$END MOL)$/m);if(n){var r=n.index+n[0].length;if(r==o.length||-1!=o.slice(r,r+20).search(/^\$(MOL|END CTAB)$/m))return"mol"}return"<"==o[0]&&-1!=o.indexOf("<molecule")?"cml":"InChI"==o.slice(0,5)?"inchi":-1==o.indexOf("\n")?"smiles":t?null:"mol"}function getStruct(e,t){return new Promise(function(o,n){var r=guessType(e);if("mol"==r){o(parseMayBeCorruptedCTFile(e,t))}else{if(ui.standalone)throw r?r.toUpperCase():"Format is not supported in a standalone mode.";o(("smiles"==r?server.layout_smiles(null,{smiles:e.trim()}):server.molfile({moldata:e})).then(function(e){return parseMayBeCorruptedCTFile(e)}))}})}function page2canvas2(e){var t=clientArea.cumulativeOffset();return new Vec2(e.pageX-t.left,e.pageY-t.top)}function page2obj(e){return ui.render.view2obj(page2canvas2(e))}function scrollPos(){return new Vec2(clientArea.scrollLeft,clientArea.scrollTop)}function onScroll_ClientArea(e){scrollLeft=clientArea.scrollLeft,scrollTop=clientArea.scrollTop,util.stopEventPropagation(e)}function onOffsetChanged(e,t){if(null!=t){var o=new Vec2(e.x-t.x,e.y-t.y);clientArea.scrollLeft+=o.x,clientArea.scrollTop+=o.y}}function removeSelected(){addUndoAction(Action.fromFragmentDeletion()),ui.editor.deselectAll(),ui.render.update()}function undo(){ui.render.current_tool&&ui.render.current_tool.OnCancel(),ui.editor.deselectAll(),redoStack.push(undoStack.pop().perform()),ui.render.update(),updateHistoryButtons()}function redo(){ui.render.current_tool&&ui.render.current_tool.OnCancel(),ui.editor.deselectAll(),undoStack.push(redoStack.pop().perform()),ui.render.update(),updateHistoryButtons()}function onClick_ElemTableButton(){showElemTable({onOk:function(e){var t;return t="single"==e.mode?{label:element.get(e.values[0]).label}:{label:"L#",atomList:new chem.Struct.AtomList({notList:"not-list"==e.mode,ids:e.values})},current_elemtable_props=t,selectAction("atom-table"),!0},onCancel:function(){}})}function onClick_ReaGenericsTableButton(){showReaGenericsTable({onOk:function(e){return current_reagenerics={label:e.values[0]},selectAction("atom-reagenerics"),!0}})}function onClick_TemplateCustom(){templatesDialog("",{onOk:function(e){return current_template_custom=e,selectAction("template-custom-select"),!0}})}function showSgroupDialog(e){return sgroupDialog(e)}function parseMayBeCorruptedCTFile(e,t){var o=util.splitNewlines(e);try{return chem.Molfile.parseCTFile(o)}catch(e){if(t){try{return chem.Molfile.parseCTFile(o.slice(1))}catch(e){}try{return chem.Molfile.parseCTFile([""].concat(o))}catch(e){}}throw e}}function mapTool(e){console.assert(e,"The null tool");var t=[].slice.call(arguments,1);if(actionMap[e])return actionMap[e].apply(null,t);if(ui.editor.hasSelection()){if("erase"==e)return removeSelected(),null;if(e.startsWith("atom-"))return addUndoAction(Action.fromAtomsAttrs(ui.editor.getSelection().atoms,atomLabel(e)),!0),ui.render.update(),null;if(e.startsWith("transform-flip"))return addUndoAction(Action.fromFlip(ui.editor.getSelection(),e.endsWith("h")?"horizontal":"vertical"),!0),ui.render.update(),null}return"transform-rotate"!=e&&ui.editor.deselectAll(),"select-lasso"==e?new rnd.Editor.LassoTool(ui.editor,0):"select-rectangle"==e?new rnd.Editor.LassoTool(ui.editor,1):"select-fragment"==e?new rnd.Editor.LassoTool(ui.editor,1,!0):"erase"==e?new rnd.Editor.EraserTool(ui.editor,1):e.startsWith("atom-")?new rnd.Editor.AtomTool(ui.editor,atomLabel(e)):e.startsWith("bond-")?new rnd.Editor.BondTool(ui.editor,bondType(e)):"chain"==e?new rnd.Editor.ChainTool(ui.editor):e.startsWith("template-custom")?new rnd.Editor.TemplateTool(ui.editor,current_template_custom):e.startsWith("template")?new rnd.Editor.TemplateTool(ui.editor,templates[parseInt(e.split("-")[1])]):"charge-plus"==e?new rnd.Editor.ChargeTool(ui.editor,1):"charge-minus"==e?new rnd.Editor.ChargeTool(ui.editor,-1):"sgroup"==e?new rnd.Editor.SGroupTool(ui.editor):"reaction-arrow"==e?new rnd.Editor.ReactionArrowTool(ui.editor):"reaction-plus"==e?new rnd.Editor.ReactionPlusTool(ui.editor):"reaction-map"==e?new rnd.Editor.ReactionMapTool(ui.editor):"reaction-unmap"==e?new rnd.Editor.ReactionUnmapTool(ui.editor):"rgroup-label"==e?new rnd.Editor.RGroupAtomTool(ui.editor):"rgroup-fragment"==e?new rnd.Editor.RGroupFragmentTool(ui.editor):"rgroup-attpoints"==e?new rnd.Editor.APointTool(ui.editor):e.startsWith("transform-rotate")?new rnd.Editor.RotateTool(ui.editor):null}function bondType(e){var t=e.substr(5);return bondTypeMap[t]}function atomLabel(e){var t=e.substr(5);switch(t){case"table":return current_elemtable_props;case"reagenerics":return current_reagenerics;case"any":return{label:"A"};default:return t=t.capitalize(),console.assert(element.getElementByLabel(t),"No such atom exist"),{label:t}}}function clean(){Action.fromNewCanvas(new chem.Struct),ui.render.update(),undoStack.clear(),redoStack.clear(),updateHistoryButtons(),selectAction(null)}var ui=global.ui={};require("../chem"),require("../rnd");var chem=global.chem,rnd=global.rnd,Promise=require("promise-polyfill"),keymage=require("keymage"),Set=require("../util/set"),Vec2=require("../util/vec2"),util=require("../util"),Action=require("./action.js"),templates=require("./templates"),element=require("../chem/element"),openDialog=require("./dialog/open.js"),saveDialog=require("./dialog/save.js"),selectDialog=require("./dialog/select"),templatesDialog=require("./dialog/templates"),sgroupDialog=require("./dialog/sgroup"),sgroupSpecialDialog=require("./dialog/sgroup-special"),obsolete=require("./dialog/obsolete"),SCALE=40,HISTORY_LENGTH=32,undoStack=[],redoStack=[],ketcherWindow,toolbar,lastSelected,clientArea=null,dropdownOpened,zspObj,server,serverActions=["cleanup","arom","dearom","calc-cip","reaction-automap","template-custom"],clipActions=["cut","copy","paste"],scrollLeft=null,scrollTop=null,current_elemtable_props=null,current_reagenerics=null,current_template_custom=null,actionMap={new:onClick_NewFile,open:onClick_OpenFile,save:onClick_SaveFile,undo:undo,redo:redo,"zoom-in":onClick_ZoomIn,"zoom-out":onClick_ZoomOut,cleanup:onClick_CleanUp,arom:onClick_Aromatize,dearom:onClick_Dearomatize,"period-table":onClick_ElemTableButton,"generic-groups":onClick_ReaGenericsTableButton,"template-custom":onClick_TemplateCustom,cut:function(){var e=ui.editor.getSelectionStruct();return removeSelected(),e.isBlank()?null:e},copy:function(){var e=ui.editor.getSelectionStruct();return ui.editor.deselectAll(),e.isBlank()?null:e},paste:function(e){if(e.isBlank())throw"Not a valid structure to paste";return ui.editor.deselectAll(),new rnd.Editor.PasteTool(ui.editor,e)},info:function(e){showDialog("about_dialog")},"select-all":function(){ui.editor.selectAll()},"deselect-all":function(){ui.editor.deselectAll()},"force-update":function(){ui.render.update(!0)},"reaction-automap":onClick_Automap,"calc-cip":calculateCip},bondTypeMap={single:{type:1,stereo:chem.Struct.BOND.STEREO.NONE},up:{type:1,stereo:chem.Struct.BOND.STEREO.UP},down:{type:1,stereo:chem.Struct.BOND.STEREO.DOWN},updown:{type:1,stereo:chem.Struct.BOND.STEREO.EITHER},double:{type:2,stereo:chem.Struct.BOND.STEREO.NONE},crossed:{type:2,stereo:chem.Struct.BOND.STEREO.CIS_TRANS},triple:{type:3,stereo:chem.Struct.BOND.STEREO.NONE},aromatic:{type:4,stereo:chem.Struct.BOND.STEREO.NONE},singledouble:{type:5,stereo:chem.Struct.BOND.STEREO.NONE},singlearomatic:{type:6,stereo:chem.Struct.BOND.STEREO.NONE},doublearomatic:{type:7,stereo:chem.Struct.BOND.STEREO.NONE},any:{type:8,stereo:chem.Struct.BOND.STEREO.NONE}};module.exports={init:init,clean:clean,loadMolecule:loadMolecule,loadFragment:loadFragment},util.extend(ui,module.exports),util.extend(ui,{standalone:!0,ctab:new chem.Struct,render:null,editor:null,hideBlurredControls:hideBlurredControls,updateClipboardButtons:updateClipboardButtons,selectAction:selectAction,addUndoAction:addUndoAction,loadMoleculeFromFile:openDialog.loadHook,echo:echo,showDialog:showDialog,hideDialog:hideDialog,bondTypeMap:bondTypeMap,zoom:1,setZoomStaticPointInit:setZoomStaticPointInit,setZoomStaticPoint:setZoomStaticPoint,page2canvas2:page2canvas2,scrollPos:scrollPos,page2obj:page2obj,showSGroupProperties:showSgroupDialog,showRGroupTable:showRGroupTable,showElemTable:showElemTable,showReaGenericsTable:showReaGenericsTable,showAtomAttachmentPoints:obsolete.showAtomAttachmentPoints,showAtomProperties:obsolete.showAtomProperties,showBondProperties:obsolete.showBondProperties,showRLogicTable:obsolete.showRLogicTable,showLabelEditor:obsolete.showLabelEditor});

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../chem/element":10,"../rnd":21,"../util":39,"../util/set":42,"../util/vec2":43,"./action.js":26,"./dialog/obsolete":27,"./dialog/open.js":28,"./dialog/save.js":29,"./dialog/select":30,"./dialog/sgroup":32,"./dialog/sgroup-special":31,"./dialog/templates":33,"./templates":36,"keymage":2,"promise-polyfill":3}],35:[function(require,module,exports){
(function (global){
function Base(){this.type="OpBase",this._execute=function(){throw new Error("Operation._execute() is not implemented")},this._invert=function(){throw new Error("Operation._invert() is not implemented")},this.perform=function(t){return this._execute(t),this.__inverted||(this.__inverted=this._invert(),this.__inverted.__inverted=this),this.__inverted},this.isDummy=function(t){return!!this._isDummy&&this._isDummy(t)}}function AtomAdd(t,e){this.data={aid:null,atom:t,pos:e},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r={};if(this.data.atom)for(var d in this.data.atom)r[d]=this.data.atom[d];r.label=r.label||"C",Object.isNumber(this.data.aid)?i.atoms.set(this.data.aid,new chem.Struct.Atom(r)):this.data.aid=i.atoms.add(new chem.Struct.Atom(r)),a.notifyAtomAdded(this.data.aid),i._atomSetPos(this.data.aid,new Vec2(this.data.pos))},this._invert=function(){var t=new AtomDelete;return t.data=this.data,t}}function AtomDelete(t){this.data={aid:t,atom:null,pos:null},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;this.data.atom||(this.data.atom=i.atoms.get(this.data.aid),this.data.pos=e.atomGetPos(this.data.aid)),a.notifyAtomRemoved(this.data.aid),i.atoms.remove(this.data.aid)},this._invert=function(){var t=new AtomAdd;return t.data=this.data,t}}function AtomAttr(t,e,a){this.data={aid:t,attribute:e,value:a},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.atoms.get(this.data.aid);this.data2||(this.data2={aid:this.data.aid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateAtom(this.data.aid)},this._isDummy=function(t){return t.render.ctab.molecule.atoms.get(this.data.aid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new AtomAttr;return t.data=this.data2,t.data2=this.data,t}}function AtomMove(t,e,a){this.data={aid:t,d:e,noinvalidate:a},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.aid,d=this.data.d;i.atoms.get(r).pp.add_(d),a.atoms.get(r).visel.translate(e.ps(d)),this.data.d=d.negated(),this.data.noinvalidate||e.invalidateAtom(r,1)},this._isDummy=function(t){return 0==this.data.d.x&&0==this.data.d.y},this._invert=function(){var t=new AtomMove;return t.data=this.data,t}}function BondMove(t,e){this.data={bid:t,d:e},this._execute=function(t){var e=t.render;e.ctab.bonds.get(this.data.bid).visel.translate(e.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var t=new BondMove;return t.data=this.data,t}}function LoopMove(t,e){this.data={id:t,d:e},this._execute=function(t){var e=t.render,a=e.ctab;a.reloops.get(this.data.id)&&a.reloops.get(this.data.id).visel&&a.reloops.get(this.data.id).visel.translate(e.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var t=new LoopMove;return t.data=this.data,t}}function SGroupAtomAdd(t,e){this.type="OpSGroupAtomAdd",this.data={aid:e,sgid:t},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.aid,d=this.data.sgid,n=i.atoms.get(r);if(i.sgroups.get(d).atoms.indexOf(r)>=0)throw new Error("The same atom cannot be added to an S-group more than once");if(!n)throw new Error("OpSGroupAtomAdd: Atom "+r+" not found");i.atomAddToSGroup(d,r),e.invalidateAtom(r)},this._invert=function(){var t=new SGroupAtomRemove;return t.data=this.data,t}}function SGroupAtomRemove(t,e){this.type="OpSGroupAtomRemove",this.data={aid:e,sgid:t},this._execute=function(t){var e=this.data.aid,a=this.data.sgid,i=t.render,r=i.ctab,d=r.molecule,n=d.atoms.get(e),s=d.sgroups.get(a);chem.SGroup.removeAtom(s,e),Set.remove(n.sgs,a),i.invalidateAtom(e)},this._invert=function(){var t=new SGroupAtomAdd;return t.data=this.data,t}}function SGroupAttr(t,e,a){this.type="OpSGroupAttr",this.data={sgid:t,attr:e,value:a},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.sgid,d=i.sgroups.get(r);"DAT"==d.type&&a.sgroupData.has(r)&&(a.clearVisel(a.sgroupData.get(r).visel),a.sgroupData.unset(r)),this.data.value=d.setAttr(this.data.attr,this.data.value)},this._invert=function(){var t=new SGroupAttr;return t.data=this.data,t}}function SGroupCreate(t,e,a){this.type="OpSGroupCreate",this.data={sgid:t,type:e,pp:a},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=new chem.SGroup(this.data.type),d=this.data.sgid;r.id=d,i.sgroups.set(d,r),this.data.pp&&(i.sgroups.get(d).pp=new Vec2(this.data.pp)),a.sgroups.set(d,new rnd.ReSGroup(i.sgroups.get(d))),this.data.sgid=d},this._invert=function(){var t=new SGroupDelete;return t.data=this.data,t}}function SGroupDelete(t){this.type="OpSGroupDelete",this.data={sgid:t},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.sgid,d=a.sgroups.get(r);if(this.data.type=d.item.type,this.data.pp=d.item.pp,"DAT"==d.item.type&&a.sgroupData.has(r)&&(a.clearVisel(a.sgroupData.get(r).visel),a.sgroupData.unset(r)),a.clearVisel(d.visel),0!=d.item.atoms.length)throw new Error("S-Group not empty!");a.sgroups.unset(r),i.sgroups.remove(r)},this._invert=function(){var t=new SGroupCreate;return t.data=this.data,t}}function SGroupAddToHierarchy(t){this.type="OpSGroupAddToHierarchy",this.data={sgid:t},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.sgid,d=i.sGroupForest.insert(r,this.data.parent,this.data.children);this.data.parent=d.parent,this.data.children=d.children},this._invert=function(){var t=new SGroupRemoveFromHierarchy;return t.data=this.data,t}}function SGroupRemoveFromHierarchy(t){this.type="OpSGroupRemoveFromHierarchy",this.data={sgid:t},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.sgid;this.data.parent=i.sGroupForest.parent.get(r),this.data.children=i.sGroupForest.children.get(r),i.sGroupForest.remove(r)},this._invert=function(){var t=new SGroupAddToHierarchy;return t.data=this.data,t}}function BondAdd(t,e,a){this.data={bid:null,bond:a,begin:t,end:e},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;if(this.data.begin==this.data.end)throw new Error("Distinct atoms expected");if(rnd.DEBUG&&this.molecule.checkBondExists(this.data.begin,this.data.end))throw new Error("Bond already exists");e.invalidateAtom(this.data.begin,1),e.invalidateAtom(this.data.end,1);var r={};if(this.data.bond)for(var d in this.data.bond)r[d]=this.data.bond[d];r.type=r.type||chem.Struct.BOND.TYPE.SINGLE,r.begin=this.data.begin,r.end=this.data.end,Object.isNumber(this.data.bid)?i.bonds.set(this.data.bid,new chem.Struct.Bond(r)):this.data.bid=i.bonds.add(new chem.Struct.Bond(r)),i.bondInitHalfBonds(this.data.bid),i.atomAddNeighbor(i.bonds.get(this.data.bid).hb1),i.atomAddNeighbor(i.bonds.get(this.data.bid).hb2),a.notifyBondAdded(this.data.bid)},this._invert=function(){var t=new BondDelete;return t.data=this.data,t}}function BondDelete(t){this.data={bid:t,bond:null,begin:null,end:null},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;this.data.bond||(this.data.bond=i.bonds.get(this.data.bid),this.data.begin=this.data.bond.begin,this.data.end=this.data.bond.end),e.invalidateBond(this.data.bid),a.notifyBondRemoved(this.data.bid);var r=i.bonds.get(this.data.bid);[r.hb1,r.hb2].each(function(t){var e=i.halfBonds.get(t),a=i.atoms.get(e.begin),r=a.neighbors.indexOf(t),d=(r+a.neighbors.length-1)%a.neighbors.length,n=(r+1)%a.neighbors.length;i.setHbNext(a.neighbors[d],a.neighbors[n]),a.neighbors.splice(r,1)},this),i.halfBonds.unset(r.hb1),i.halfBonds.unset(r.hb2),i.bonds.remove(this.data.bid)},this._invert=function(){var t=new BondAdd;return t.data=this.data,t}}function BondAttr(t,e,a){this.data={bid:t,attribute:e,value:a},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.bonds.get(this.data.bid);this.data2||(this.data2={bid:this.data.bid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateBond(this.data.bid),"type"==this.data.attribute&&t.render.invalidateLoop(this.data.bid)},this._isDummy=function(t){return t.render.ctab.molecule.bonds.get(this.data.bid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new BondAttr;return t.data=this.data2,t.data2=this.data,t}}function FragmentAdd(t){this.frid=Object.isUndefined(t)?null:t,this._execute=function(t){var e=t.render.ctab,a=e.molecule,i=new chem.Struct.Fragment;null==this.frid?this.frid=a.frags.add(i):a.frags.set(this.frid,i),e.frags.set(this.frid,new rnd.ReFrag(i))},this._invert=function(){return new FragmentDelete(this.frid)}}function FragmentDelete(t){this.frid=t,this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;e.invalidateItem("frags",this.frid,1),a.frags.unset(this.frid),i.frags.remove(this.frid)},this._invert=function(){return new FragmentAdd(this.frid)}}function RGroupAttr(t,e,a){this.data={rgid:t,attribute:e,value:a},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.rgroups.get(this.data.rgid);this.data2||(this.data2={rgid:this.data.rgid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateItem("rgroups",this.data.rgid)},this._isDummy=function(t){return t.render.ctab.molecule.rgroups.get(this.data.rgid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new RGroupAttr;return t.data=this.data2,t.data2=this.data,t}}function RGroupFragment(t,e,a){this.rgid_new=t,this.rg_new=a,this.rgid_old=null,this.rg_old=null,this.frid=e,this._execute=function(t){var e=t.render.ctab,a=e.molecule;if(this.rgid_old=this.rgid_old||chem.Struct.RGroup.findRGroupByFragment(a.rgroups,this.frid),this.rg_old=this.rgid_old?a.rgroups.get(this.rgid_old):null,this.rg_old&&(this.rg_old.frags.remove(this.rg_old.frags.keyOf(this.frid)),e.clearVisel(e.rgroups.get(this.rgid_old).visel),0==this.rg_old.frags.count()?(e.rgroups.unset(this.rgid_old),a.rgroups.unset(this.rgid_old),e.markItemRemoved()):e.markItem("rgroups",this.rgid_old,1)),this.rgid_new){var i=a.rgroups.get(this.rgid_new);i?e.markItem("rgroups",this.rgid_new,1):(i=this.rg_new||new chem.Struct.RGroup,a.rgroups.set(this.rgid_new,i),e.rgroups.set(this.rgid_new,new rnd.ReRGroup(i))),i.frags.add(this.frid)}},this._invert=function(){return new RGroupFragment(this.rgid_old,this.frid,this.rg_old)}}function RxnArrowAdd(t){this.data={arid:null,pos:t},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;Object.isNumber(this.data.arid)?i.rxnArrows.set(this.data.arid,new chem.Struct.RxnArrow):this.data.arid=i.rxnArrows.add(new chem.Struct.RxnArrow),a.notifyRxnArrowAdded(this.data.arid),i._rxnArrowSetPos(this.data.arid,new Vec2(this.data.pos)),e.invalidateItem("rxnArrows",this.data.arid,1)},this._invert=function(){var t=new RxnArrowDelete;return t.data=this.data,t}}function RxnArrowDelete(t){this.data={arid:t,pos:null},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;this.data.pos||(this.data.pos=e.rxnArrowGetPos(this.data.arid)),a.notifyRxnArrowRemoved(this.data.arid),i.rxnArrows.remove(this.data.arid)},this._invert=function(){var t=new RxnArrowAdd;return t.data=this.data,t}}function RxnArrowMove(t,e,a){this.data={id:t,d:e,noinvalidate:a},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.id,d=this.data.d;i.rxnArrows.get(r).pp.add_(d),a.rxnArrows.get(r).visel.translate(e.ps(d)),this.data.d=d.negated(),this.data.noinvalidate||t.render.invalidateItem("rxnArrows",r,1)},this._invert=function(){var t=new RxnArrowMove;return t.data=this.data,t}}function RxnPlusAdd(t){this.data={plid:null,pos:t},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;Object.isNumber(this.data.plid)?i.rxnPluses.set(this.data.plid,new chem.Struct.RxnPlus):this.data.plid=i.rxnPluses.add(new chem.Struct.RxnPlus),a.notifyRxnPlusAdded(this.data.plid),i._rxnPlusSetPos(this.data.plid,new Vec2(this.data.pos)),e.invalidateItem("rxnPluses",this.data.plid,1)},this._invert=function(){var t=new RxnPlusDelete;return t.data=this.data,t}}function RxnPlusDelete(t){this.data={plid:t,pos:null},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;this.data.pos||(this.data.pos=e.rxnPlusGetPos(this.data.plid)),a.notifyRxnPlusRemoved(this.data.plid),i.rxnPluses.remove(this.data.plid)},this._invert=function(){var t=new RxnPlusAdd;return t.data=this.data,t}}function RxnPlusMove(t,e,a){this.data={id:t,d:e,noinvalidate:a},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule,r=this.data.id,d=this.data.d;i.rxnPluses.get(r).pp.add_(d),a.rxnPluses.get(r).visel.translate(e.ps(d)),this.data.d=d.negated(),this.data.noinvalidate||t.render.invalidateItem("rxnPluses",r,1)},this._invert=function(){var t=new RxnPlusMove;return t.data=this.data,t}}function SGroupDataMove(t,e){this.data={id:t,d:e},this._execute=function(t){ui.ctab.sgroups.get(this.data.id).pp.add_(this.data.d),this.data.d=this.data.d.negated(),t.render.invalidateItem("sgroupData",this.data.id,1)},this._invert=function(){var t=new SGroupDataMove;return t.data=this.data,t}}function CanvasLoad(t){this.data={ctab:t,norescale:!1},this._execute=function(t){var e=t.render;e.ctab.clearVisels();var a=ui.ctab;ui.ctab=this.data.ctab,e.setMolecule(ui.ctab,this.data.norescale),this.data.ctab=a,this.data.norescale=!0},this._invert=function(){var t=new CanvasLoad;return t.data=this.data,t}}function ChiralFlagAdd(t){this.data={pos:t},this._execute=function(e){var a=e.render,i=a.ctab,r=i.molecule;if(i.chiralFlags.count()>0)throw new Error("Cannot add more than one Chiral flag");i.chiralFlags.set(0,new rnd.ReChiralFlag(t)),r.isChiral=!0,a.invalidateItem("chiralFlags",0,1)},this._invert=function(){var t=new ChiralFlagDelete;return t.data=this.data,t}}function ChiralFlagDelete(){this.data={pos:null},this._execute=function(t){var e=t.render,a=e.ctab,i=a.molecule;if(a.chiralFlags.count()<1)throw new Error("Cannot remove chiral flag");a.clearVisel(a.chiralFlags.get(0).visel),this.data.pos=a.chiralFlags.get(0).pp,a.chiralFlags.unset(0),i.isChiral=!1},this._invert=function(){var t=new ChiralFlagAdd(this.data.pos);return t.data=this.data,t}}function ChiralFlagMove(t){this.data={d:t},this._execute=function(t){var e=t.render;e.ctab.chiralFlags.get(0).pp.add_(this.data.d),this.data.d=this.data.d.negated(),e.invalidateItem("chiralFlags",0,1)},this._invert=function(){var t=new ChiralFlagMove;return t.data=this.data,t}}var Vec2=require("../util/vec2"),Set=require("../util/set");require("../chem"),require("../rnd");var ui=global.ui,chem=global.chem,rnd=global.rnd;AtomAdd.prototype=new Base,AtomDelete.prototype=new Base,AtomAttr.prototype=new Base,AtomMove.prototype=new Base,BondMove.prototype=new Base,LoopMove.prototype=new Base,SGroupAtomAdd.prototype=new Base,SGroupAtomRemove.prototype=new Base,SGroupAttr.prototype=new Base,SGroupCreate.prototype=new Base,SGroupDelete.prototype=new Base,SGroupAddToHierarchy.prototype=new Base,SGroupRemoveFromHierarchy.prototype=new Base,BondAdd.prototype=new Base,BondDelete.prototype=new Base,BondAttr.prototype=new Base,FragmentAdd.prototype=new Base,FragmentDelete.prototype=new Base,RGroupAttr.prototype=new Base,RGroupFragment.prototype=new Base,RxnArrowAdd.prototype=new Base,RxnArrowDelete.prototype=new Base,RxnArrowMove.prototype=new Base,RxnPlusAdd.prototype=new Base,RxnPlusDelete.prototype=new Base,RxnPlusMove.prototype=new Base,SGroupDataMove.prototype=new Base,CanvasLoad.prototype=new Base,ChiralFlagAdd.prototype=new Base,ChiralFlagDelete.prototype=new Base,ChiralFlagMove.prototype=new Base,module.exports={AtomAdd:AtomAdd,AtomDelete:AtomDelete,AtomAttr:AtomAttr,AtomMove:AtomMove,BondMove:BondMove,LoopMove:LoopMove,SGroupAtomAdd:SGroupAtomAdd,SGroupAtomRemove:SGroupAtomRemove,SGroupAttr:SGroupAttr,SGroupCreate:SGroupCreate,SGroupDelete:SGroupDelete,SGroupAddToHierarchy:SGroupAddToHierarchy,SGroupRemoveFromHierarchy:SGroupRemoveFromHierarchy,BondAdd:BondAdd,BondDelete:BondDelete,BondAttr:BondAttr,FragmentAdd:FragmentAdd,FragmentDelete:FragmentDelete,RGroupAttr:RGroupAttr,RGroupFragment:RGroupFragment,RxnArrowAdd:RxnArrowAdd,RxnArrowDelete:RxnArrowDelete,RxnArrowMove:RxnArrowMove,RxnPlusAdd:RxnPlusAdd,RxnPlusDelete:RxnPlusDelete,RxnPlusMove:RxnPlusMove,SGroupDataMove:SGroupDataMove,CanvasLoad:CanvasLoad,ChiralFlagAdd:ChiralFlagAdd,ChiralFlagDelete:ChiralFlagDelete,ChiralFlagMove:ChiralFlagMove};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"../chem":11,"../rnd":21,"../util/set":42,"../util/vec2":43}],36:[function(require,module,exports){
module.exports=[{name:"benzene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  6  1  0     0  0\n  6  1  2  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentadiene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.0000    1.4257    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclohexane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  6  1  0     0  0\n  6  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.8090    1.5389    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.6180    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopropane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  3  3  0     0  0            999 V2000\n   -3.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.7250    0.5910    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  1  3  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclobutane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  4  4  0     0  0            999 V2000\n   -3.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -3.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  1  3  1  0     0  0\n  3  4  1  0     0  0\n  4  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cycloheptane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  7  7  0     0  0            999 V2000\n    0.0000    1.6293    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    2.2465    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7559    2.0242    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.1897    1.1289    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.6228    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7566    0.2224    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n  6  7  1  0     0  0\n  5  7  1  0     0  0\n  1  5  1  0     0  0\n  4  6  1  0     0  0\n  3  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclooctane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  8  8  0     0  0            999 V2000\n    0.0000    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7053    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7056    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n  8  3  1  0     0  0\n  7  8  1  0     0  0\n  6  7  1  0     0  0\n  5  6  1  0     0  0\n  4  5  1  0     0  0\n  1  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0}];

},{}],37:[function(require,module,exports){
function ajax(e,t){var r=getXHR(),n=e.headers||{};r.open(e.method,e.url,!!t,e.user,e.password);for(var u in n)n.hasOwnProperty(u)&&r.setRequestHeader(u,n[u]);if("function"==typeof e.config){var a=e.config(r,e);void 0!==a&&(r=a)}return e.timeout>0&&setTimeout(function(){r.status=-1,r.abort()},e.timeout),t&&(r.onreadystatechange=function(){4===r.readyState&&t(r)}),r.send(e.data),r}function successful(e){return e.status>=200&&e.status<300}function queryString(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}function request(e){var t=util.extend({method:"GET",headers:{},timeout:6e3},util.isObject(e)?e:{url:e});if(util.isObject(t.data)&&(t.data=JSON.stringify(t.data),t.headers["Content-Type"]="application/json; charset=utf-8"),t.params&&(t.url=t.url+(t.url.indexOf("?")<0?"?":"&")+queryString(t.params)),!t.sync)return new Promise(function(e,r){ajax(t,function(t){(successful(t)?e:r)(t)})});var r=ajax(t);if(!successful(r))throw r;return r}var getXHR=require("xhrpolyfill"),Promise=require("promise-polyfill"),util=require("./index.js");module.exports=request;

},{"./index.js":39,"promise-polyfill":3,"xhrpolyfill":6}],38:[function(require,module,exports){
var util=require("./index"),Vec2=require("./vec2"),Box2Abs=function(){1==arguments.length&&"min"in arguments[0]&&"max"in arguments[0]&&(this.p0=arguments[0].min,this.p1=arguments[0].max),2==arguments.length&&arguments[0]instanceof Vec2&&arguments[1]instanceof Vec2?(this.p0=arguments[0],this.p1=arguments[1]):4==arguments.length?(this.p0=new Vec2(arguments[0],arguments[1]),this.p1=new Vec2(arguments[2],arguments[3])):0==arguments.length?(this.p0=new Vec2,this.p1=new Vec2):new Error("Box2Abs constructor only accepts 4 numbers or 2 vectors or no arguments!")};Box2Abs.prototype.toString=function(){return this.p0.toString()+" "+this.p1.toString()},Box2Abs.fromRelBox=function(t){return util.assertDefined(t),new Box2Abs(t.x,t.y,t.x+t.width,t.y+t.height)},Box2Abs.prototype.clone=function(){return new Box2Abs(this.p0,this.p1)},Box2Abs.union=function(t,e){return util.assertDefined(t),util.assertDefined(e),new Box2Abs(Vec2.min(t.p0,e.p0),Vec2.max(t.p1,e.p1))},Box2Abs.prototype.extend=function(t,e){return util.assertDefined(t),e=e||t,new Box2Abs(this.p0.sub(t),this.p1.add(e))},Box2Abs.prototype.include=function(t){return util.assertDefined(t),new Box2Abs(this.p0.min(t),this.p1.max(t))},Box2Abs.prototype.contains=function(t,e){return e=(e||0)-0,util.assertDefined(t),t.x>=this.p0.x-e&&t.x<=this.p1.x+e&&t.y>=this.p0.y-e&&t.y<=this.p1.y+e},Box2Abs.prototype.translate=function(t){return util.assertDefined(t),new Box2Abs(this.p0.add(t),this.p1.add(t))},Box2Abs.prototype.transform=function(t,e){return util.assert(!util.isNullOrUndefined(t)),new Box2Abs(t.call(e,this.p0),t.call(e,this.p1))},Box2Abs.prototype.sz=function(){return this.p1.sub(this.p0)},Box2Abs.prototype.centre=function(){return Vec2.centre(this.p0,this.p1)},Box2Abs.prototype.pos=function(){return this.p0},module.exports=Box2Abs;

},{"./index":39,"./vec2":43}],39:[function(require,module,exports){
function find(e,n){for(var t=0;t<e.length;t++)if(n(e[t],t,e))return e[t]}function findIndex(e,n,t){for(var r=0;r<e.length;++r)if(n.call(t,e[r],r))return r;return-1}function normalizeNewlines(e){return e.replace(nlRe,"\n")}function splitNewlines(e){return e.split(nlRe)}function unicodeLiteral(e){var n,t="";for(n=0;n<e.length;++n)e.charCodeAt(n)>126||e.charCodeAt(n)<32?t+="\\u"+function(e,n){for(var t=e.toString(16).toUpperCase();t.length<n;)t="0"+t;return t}(e.charCodeAt(n),4):t+=e[n];return t}Array.prototype.swap=function(e,n){var t=this[e];this[e]=this[n],this[n]=t};var tfx=function(e){return(e-0).toFixed(8)},each=function(e,n,t){assert(!isNullOrUndefined(e),"array must be defined");for(var r=0;r<e.length;++r)n.call(t,e[r],r)},map_each=function(e,n,t){assert(!isNullOrUndefined(e),"map must be defined");for(var r in e)e.hasOwnProperty(r)&&n.call(t,r,e[r])},findAll=function(e,n,t){var r,i=[];for(r=0;r<e.length;++r)n.call(t,e[r],r)&&i.push(e[r]);return i},array=function(e){for(var n=[],t=e.length;--t>=0;)n[t]=e[t];return n},isEmpty=function(e){for(var n in e)if(e.hasOwnProperty(n))return!1;return!0},stopEventPropagation=function(e){if("stopPropagation"in e)e.stopPropagation();else{if(!("cancelBubble"in e))throw Error("Browser unrecognized");e.cancelBubble=!0}},preventDefault=function(e){return"preventDefault"in e&&e.preventDefault(),Prototype.Browser.IE&&(e.returnValue=!1,e.keyCode=0),!1},setElementTextContent=function(e,n){if("textContent"in e)e.textContent=n;else{if(!("innerText"in e))throw Error("Browser unrecognized");e.innerText=n}},getElementTextContent=function(e){if("textContent"in e)return e.textContent;if("innerText"in e)return e.innerText;throw Error("Browser unrecognized")},stringPadded=function(e,n,t){for(var r=e+"",i="";r.length+i.length<n;)i+=" ";return t?e+i:i+e},nlRe=/\r\n|[\n\r]/g,idList=function(e){var n=[];for(var t in e)e.hasOwnProperty(t)&&n.push(t);return n},mapArray=function(e,n){for(var t=[],r=0;r<e.length;++r)t.push(n[e[r]]);return t},arrayMax=function(e){return Math.max.apply(Math,e)},arrayMin=function(e){return Math.min.apply(Math,e)},map=function(e,n,t){for(var r=[],i=0;i<e.length;++i)r.push(n.call(t,e[i]));return r},apply=function(e,n){for(var t=0;t<e.length;++t)e[t]=n(e[t])},ifDef=function(e,n,t,r){e[t]=Object.isUndefined(n[t])?r:n[t]},ifDefList=function(e,n,t,r){e[t]=Object.isUndefined(n[t])||null===n[t]?r:array(n[t])},identityMap=function(e){for(var n={},t=0;t<e.length;++t)n[e[t]]=e[t];return n},strip=function(e){return e.replace(/\s*$/,"").replace(/^\s*/,"")},stripRight=function(e){return e.replace(/\s*$/,"")},stripQuotes=function(e){return'"'===e[0]&&'"'===e[e.length-1]?e.substr(1,e.length-2):e},paddedFloat=function(e,n,t){var r=e.toFixed(t).replace(",",".");if(r.length>n)throw new Error("number does not fit");return stringPadded(r,n)},paddedInt=function(e,n){var t=e.toFixed(0);if(t.length>n)throw new Error("number does not fit");return stringPadded(t,n)},arrayAddIfMissing=function(e,n){for(var t=0;t<e.length;++t)if(e[t]===n)return!1;return e.push(n),!0},assert=function(e,n){if(!e)throw new Error(n?"Assertion failed: "+n:"Assertion failed")},assertDefined=function(e){assert(!isNullOrUndefined(e))},isUndefined=function(e){return Object.isUndefined(e)},isNull=function(e){return null===e},isNullOrUndefined=function(e){return isUndefined(e)||isNull(e)},arrayRemoveByValue=function(e,n){assert(!isUndefined(e)&&!isNull(e),"array must be defined");for(var t=e.indexOf(n),r=0;t>=0;)e.splice(t,1),r+=1,t=e.indexOf(n);return r},listNextRotate=function(e,n){return e[(e.indexOf(n)+1)%e.length]},extend=function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t]);return e},isObject=function(e){return e===Object(e)};module.exports={tfx:tfx,each:each,find:find,findIndex:findIndex,findAll:findAll,array:array,isEmpty:isEmpty,stopEventPropagation:stopEventPropagation,preventDefault:preventDefault,setElementTextContent:setElementTextContent,getElementTextContent:getElementTextContent,stringPadded:stringPadded,normalizeNewlines:normalizeNewlines,splitNewlines:splitNewlines,unicodeLiteral:unicodeLiteral,idList:idList,mapArray:mapArray,arrayMax:arrayMax,arrayMin:arrayMin,map:map,apply:apply,ifDef:ifDef,ifDefList:ifDefList,identityMap:identityMap,strip:strip,stripRight:stripRight,stripQuotes:stripQuotes,paddedFloat:paddedFloat,paddedInt:paddedInt,arrayAddIfMissing:arrayAddIfMissing,assert:assert,assertDefined:assertDefined,isUndefined:isUndefined,isNull:isNull,isNullOrUndefined:isNullOrUndefined,arrayRemoveByValue:arrayRemoveByValue,listNextRotate:listNextRotate,extend:extend,isObject:isObject};

},{}],40:[function(require,module,exports){
var util=require("./index"),Map=function(t){if(void 0!==t&&t.constructor!==Object)throw Error('Passed object is not an instance of "Object"!');this._obj=t||{},this._count=0};Map.prototype.each=function(t,o){var i,r,n;for(i in this._obj)n=parseInt(i,10),r=this._obj[i],isNaN(n)||(i=n),t.call(o,i,r)},Map.prototype.map=function(t,o){var i=new Map;return this.each(function(r,n){i.set(r,t.call(o,r,n))},this),i},Map.prototype.find=function(t,o){var i,r,n;for(i in this._obj)if(r=parseInt(i,10),n=this._obj[i],isNaN(r)||(i=r),t.call(o,i,n))return i},Map.prototype.findAll=function(t,o){var i,r,n,e=[];for(i in this._obj)r=parseInt(i,10),n=this._obj[i],isNaN(r)||(i=r),t.call(o,i,n)&&e.push(i);return e},Map.prototype.keys=function(){var t,o=[];for(t in this._obj)o.push(t);return o},Map.prototype.ikeys=function(){var t=[];for(var o in this._obj)t.push(o-0);return t},Map.prototype.set=function(t,o){var i;return this._count+=(void 0!==o?1:0)-(void 0!==this._obj[t]?1:0),void 0===o?(i=this._obj[t],delete this._obj[t],i):(this._obj[t]=o,o)},Map.prototype.get=function(t){if(this._obj[t]!==Object.prototype[t])return this._obj[t]},Map.prototype.has=function(t){return this._obj[t]!==Object.prototype[t]},Map.prototype.unset=function(t){return this.set(t,void 0)},Map.prototype.update=function(t){for(var o in t)this.set(o,t[o])},Map.prototype.clear=function(){this._obj={},this._count=0},Map.prototype.count=function(){return this._count},Map.prototype.idList=function(){return util.idList(this._obj)},Map.prototype.keyOf=function(t){for(var o in this._obj)if(this._obj[o]===t)return o},module.exports=Map;

},{"./index":39}],41:[function(require,module,exports){
var Map=require("./map.js"),Pool=function(){this._map=new Map,this._nextId=0};Pool.prototype.newId=function(){return this._nextId++},Pool.prototype.add=function(t){var o=this._nextId++;return this._map.set(o,t),o},Pool.prototype.set=function(t,o){this._map.set(t,o)},Pool.prototype.get=function(t){return this._map.get(t)},Pool.prototype.has=function(t){return this._map.has(t)},Pool.prototype.remove=function(t){return this._map.unset(t)},Pool.prototype.clear=function(){this._map.clear()},Pool.prototype.keys=function(){return this._map.keys()},Pool.prototype.ikeys=function(){return this._map.ikeys()},Pool.prototype.each=function(t,o){this._map.each(t,o)},Pool.prototype.map=function(t,o){return this._map.map(t,o)},Pool.prototype.find=function(t,o){return this._map.find(t,o)},Pool.prototype.count=function(){return this._map.count()},Pool.prototype.keyOf=function(t){return this._map.keyOf(t)},module.exports=Pool;

},{"./map.js":40}],42:[function(require,module,exports){
var Set={empty:function(){return{}},single:function(t){var r={};return Set.add(r,t),r},size:function(t){var r=0;for(var n in t)t[n]!==Object.prototype[n]&&r++;return r},contains:function(t,r){return void 0!==t[r]&&t[r]!==Object.prototype[r]},subset:function(t,r){for(var n in t)if(t[n]!==Object.prototype[n]&&r[n]!==t[n])return!1;return!0},intersection:function(t,r){var n={};for(var e in t)t[e]!==Object.prototype[e]&&r[e]===t[e]&&Set.add(n,e);return n},disjoint:function(t,r){for(var n in t)if(t[n]!==Object.prototype[n]&&r[n]===t[n])return!1;return!0},eq:function(t,r){return Set.subset(t,r)&&Set.subset(r,t)},each:function(t,r,n){for(var e in t)t[e]!==Object.prototype[e]&&r.call(n,t[e])},filter:function(t,r,n){var e={};for(var o in t)t[o]!==Object.prototype[o]&&r.call(n,t[o])&&(e[t[o]]=t[o]);return e},pick:function(t){for(var r in t)if(t[r]!==Object.prototype[r])return t[r];return null},list:function(t){var r=[];for(var n in t)t[n]!==Object.prototype[n]&&r.push(t[n]);return r},add:function(t,r){t[r]=r},mergeIn:function(t,r){Set.each(r,function(r){Set.add(t,r)})},remove:function(t,r){var n=t[r];return delete t[r],n},clone:function(t){var r={};return Set.mergeIn(r,t),r},fromList:function(t){var r={};if(t)for(var n=0;n<t.length;++n)r[t[n]-0]=t[n]-0;return r},keySetInt:function(t){var r={};return t.each(function(t){r[t-0]=t-0}),r},find:function(t,r,n){for(var e in t)if(t[e]!==Object.prototype[e]&&r.call(n,t[e]))return e;return null}};module.exports=Set;

},{}],43:[function(require,module,exports){
var util=require("./index"),Vec2=function(e,t){if(0==arguments.length)this.x=0,this.y=0;else if(1==arguments.length)this.x=parseFloat(e.x),this.y=parseFloat(e.y);else{if(2!=arguments.length)throw new Error("Vec2(): invalid arguments");this.x=parseFloat(e),this.y=parseFloat(t)}};Vec2.ZERO=new Vec2(0,0),Vec2.UNIT=new Vec2(1,1),Vec2.segmentIntersection=function(e,t,n,i){var r=(e.x-n.x)*(t.y-n.y)-(e.y-n.y)*(t.x-n.x),s=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x),c=(n.x-e.x)*(i.y-e.y)-(n.y-e.y)*(i.x-e.x),o=(n.x-t.x)*(i.y-t.y)-(n.y-t.y)*(i.x-t.x);return r*s<=0&&c*o<=0},Vec2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vec2.prototype.equals=function(e){return util.assertDefined(e),this.x==e.x&&this.y==e.y},Vec2.prototype.add=function(e){return util.assertDefined(e),new Vec2(this.x+e.x,this.y+e.y)},Vec2.prototype.add_=function(e){util.assertDefined(e),this.x+=e.x,this.y+=e.y},Vec2.prototype.sub=function(e){return util.assertDefined(e),new Vec2(this.x-e.x,this.y-e.y)},Vec2.prototype.scaled=function(e){return util.assertDefined(e),new Vec2(this.x*e,this.y*e)},Vec2.prototype.negated=function(){return new Vec2(-this.x,-this.y)},Vec2.prototype.yComplement=function(e){return e=e||0,new Vec2(this.x,e-this.y)},Vec2.prototype.addScaled=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(this.x+e.x*t,this.y+e.y*t)},Vec2.prototype.normalized=function(){return this.scaled(1/this.length())},Vec2.prototype.normalize=function(){var e=this.length();return!(e<1e-6)&&(this.x/=e,this.y/=e,!0)},Vec2.prototype.turnLeft=function(){return new Vec2(-this.y,this.x)},Vec2.prototype.coordStr=function(){return this.x.toString()+" , "+this.y.toString()},Vec2.prototype.toString=function(){return"("+this.x.toFixed(2)+","+this.y.toFixed(2)+")"},Vec2.dist=function(e,t){return util.assertDefined(e),util.assertDefined(t),Vec2.diff(e,t).length()},Vec2.max=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(Math.max(e.x,t.x),Math.max(e.y,t.y))},Vec2.min=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(Math.min(e.x,t.x),Math.min(e.y,t.y))},Vec2.prototype.max=function(e){return util.assertDefined(e),new Vec2.max(this,e)},Vec2.prototype.min=function(e){return util.assertDefined(e),new Vec2.min(this,e)},Vec2.prototype.ceil=function(){return new Vec2(Math.ceil(this.x),Math.ceil(this.y))},Vec2.prototype.floor=function(){return new Vec2(Math.floor(this.x),Math.floor(this.y))},Vec2.sum=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(e.x+t.x,e.y+t.y)},Vec2.dot=function(e,t){return util.assertDefined(e),util.assertDefined(t),e.x*t.x+e.y*t.y},Vec2.cross=function(e,t){return util.assertDefined(e),util.assertDefined(t),e.x*t.y-e.y*t.x},Vec2.prototype.rotate=function(e){util.assertDefined(e);var t=Math.sin(e),n=Math.cos(e);return this.rotateSC(t,n)},Vec2.prototype.rotateSC=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(this.x*t-this.y*e,this.x*e+this.y*t)},Vec2.angle=function(e,t){return util.assertDefined(e),util.assertDefined(t),Math.atan2(Vec2.cross(e,t),Vec2.dot(e,t))},Vec2.prototype.oxAngle=function(){return Math.atan2(this.y,this.x)},Vec2.diff=function(e,t){return util.assertDefined(e),util.assertDefined(t),new Vec2(e.x-t.x,e.y-t.y)},Vec2.lc=function(){for(var e=new Vec2,t=0;t<arguments.length/2;++t)e=e.addScaled(arguments[2*t],arguments[2*t+1]);return e},Vec2.lc2=function(e,t,n,i){return util.assertDefined(e),util.assertDefined(n),util.assertDefined(t),util.assertDefined(i),new Vec2(e.x*t+n.x*i,e.y*t+n.y*i)},Vec2.centre=function(e,t){return new Vec2.lc2(e,.5,t,.5)},Vec2.shiftRayBox=function(e,t,n){util.assertDefined(e),util.assertDefined(t),util.assertDefined(n);var i=[n.p0,new Vec2(n.p1.x,n.p0.y),n.p1,new Vec2(n.p0.x,n.p1.y)],r=i.map(function(t){return t.sub(e)});t=t.normalized();for(var s=r.map(function(e){return Vec2.cross(e,t)}),c=r.map(function(e){return Vec2.dot(e,t)}),o=-1,u=-1,a=0;a<4;++a)s[a]>0?(o<0||c[o]<c[a])&&(o=a):(u<0||c[u]<c[a])&&(u=a);if(u<0||o<0)return 0;var f,y;return c[o]>c[u]?(f=u,y=o):(f=o,y=u),c[f]+Math.abs(s[f])*(c[y]-c[f])/(Math.abs(s[f])+Math.abs(s[y]))},module.exports=Vec2;

},{"./index":39}]},{},[18])(18)
});